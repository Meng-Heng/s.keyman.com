"use strict";(()=>{var nQ=Object.create;var He=Object.defineProperty,sQ=Object.defineProperties,Br=Object.getOwnPropertyDescriptor,iQ=Object.getOwnPropertyDescriptors,BQ=Object.getOwnPropertyNames,sr=Object.getOwnPropertySymbols,cr=Object.getPrototypeOf,lr=Object.prototype.hasOwnProperty,cQ=Object.prototype.propertyIsEnumerable,lQ=Reflect.get;var ir=(Q,e,t)=>e in Q?He(Q,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):Q[e]=t,h=(Q,e)=>{for(var t in e||(e={}))lr.call(e,t)&&ir(Q,t,e[t]);if(sr)for(var t of sr(e))cQ.call(e,t)&&ir(Q,t,e[t]);return Q},V=(Q,e)=>sQ(Q,iQ(e)),r=(Q,e)=>He(Q,"name",{value:e,configurable:!0});var rQ=(Q,e)=>()=>(e||Q((e={exports:{}}).exports,e),e.exports),Vn=(Q,e)=>{for(var t in e)He(Q,t,{get:e[t],enumerable:!0})},QQ=(Q,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of BQ(e))!lr.call(Q,s)&&s!==t&&He(Q,s,{get:()=>e[s],enumerable:!(n=Br(e,s))||n.enumerable});return Q};var aQ=(Q,e,t)=>(t=Q!=null?nQ(cr(Q)):{},QQ(e||!Q||!Q.__esModule?He(t,"default",{value:Q,enumerable:!0}):t,Q));var Ct=(Q,e,t,n)=>{for(var s=n>1?void 0:n?Br(e,t):e,i=Q.length-1,B;i>=0;i--)(B=Q[i])&&(s=(n?B(e,t,s):B(s))||s);return n&&s&&He(e,t,s),s};var As=(Q,e,t)=>lQ(cr(Q),t,e);var L=(Q,e,t)=>new Promise((n,s)=>{var i=l=>{try{c(t.next(l))}catch(a){s(a)}},B=l=>{try{c(t.throw(l))}catch(a){s(a)}},c=l=>l.done?n(l.value):Promise.resolve(l.value).then(i,B);c((t=t.apply(Q,e)).next())});var Qr=rQ((Fa,Pi)=>{"use strict";var FQ=Object.prototype.hasOwnProperty,K="~";function Ln(){}r(Ln,"Events");Object.create&&(Ln.prototype=Object.create(null),new Ln().__proto__||(K=!1));function oQ(Q,e,t){this.fn=Q,this.context=e,this.once=t||!1}r(oQ,"EE");function rr(Q,e,t,n,s){if(typeof t!="function")throw new TypeError("The listener must be a function");var i=new oQ(t,n||Q,s),B=K?K+e:e;return Q._events[B]?Q._events[B].fn?Q._events[B]=[Q._events[B],i]:Q._events[B].push(i):(Q._events[B]=i,Q._eventsCount++),Q}r(rr,"addListener");function Hs(Q,e){--Q._eventsCount===0?Q._events=new Ln:delete Q._events[e]}r(Hs,"clearEvent");function k(){this._events=new Ln,this._eventsCount=0}r(k,"EventEmitter");k.prototype.eventNames=r(function(){var e=[],t,n;if(this._eventsCount===0)return e;for(n in t=this._events)FQ.call(t,n)&&e.push(K?n.slice(1):n);return Object.getOwnPropertySymbols?e.concat(Object.getOwnPropertySymbols(t)):e},"eventNames");k.prototype.listeners=r(function(e){var t=K?K+e:e,n=this._events[t];if(!n)return[];if(n.fn)return[n.fn];for(var s=0,i=n.length,B=new Array(i);s<i;s++)B[s]=n[s].fn;return B},"listeners");k.prototype.listenerCount=r(function(e){var t=K?K+e:e,n=this._events[t];return n?n.fn?1:n.length:0},"listenerCount");k.prototype.emit=r(function(e,t,n,s,i,B){var c=K?K+e:e;if(!this._events[c])return!1;var l=this._events[c],a=arguments.length,F,o;if(l.fn){switch(l.once&&this.removeListener(e,l.fn,void 0,!0),a){case 1:return l.fn.call(l.context),!0;case 2:return l.fn.call(l.context,t),!0;case 3:return l.fn.call(l.context,t,n),!0;case 4:return l.fn.call(l.context,t,n,s),!0;case 5:return l.fn.call(l.context,t,n,s,i),!0;case 6:return l.fn.call(l.context,t,n,s,i,B),!0}for(o=1,F=new Array(a-1);o<a;o++)F[o-1]=arguments[o];l.fn.apply(l.context,F)}else{var d=l.length,U;for(o=0;o<d;o++)switch(l[o].once&&this.removeListener(e,l[o].fn,void 0,!0),a){case 1:l[o].fn.call(l[o].context);break;case 2:l[o].fn.call(l[o].context,t);break;case 3:l[o].fn.call(l[o].context,t,n);break;case 4:l[o].fn.call(l[o].context,t,n,s);break;default:if(!F)for(U=1,F=new Array(a-1);U<a;U++)F[U-1]=arguments[U];l[o].fn.apply(l[o].context,F)}}return!0},"emit");k.prototype.on=r(function(e,t,n){return rr(this,e,t,n,!1)},"on");k.prototype.once=r(function(e,t,n){return rr(this,e,t,n,!0)},"once");k.prototype.removeListener=r(function(e,t,n,s){var i=K?K+e:e;if(!this._events[i])return this;if(!t)return Hs(this,i),this;var B=this._events[i];if(B.fn)B.fn===t&&(!s||B.once)&&(!n||B.context===n)&&Hs(this,i);else{for(var c=0,l=[],a=B.length;c<a;c++)(B[c].fn!==t||s&&!B[c].once||n&&B[c].context!==n)&&l.push(B[c]);l.length?this._events[i]=l.length===1?l[0]:l:Hs(this,i)}return this},"removeListener");k.prototype.removeAllListeners=r(function(e){var t;return e?(t=K?K+e:e,this._events[t]&&Hs(this,t)):(this._events=new Ln,this._eventsCount=0),this},"removeAllListeners");k.prototype.off=k.prototype.removeListener;k.prototype.addListener=k.prototype.on;k.prefixed=K;k.EventEmitter=k;typeof Pi!="undefined"&&(Pi.exports=k)});var X=aQ(Qr(),1);var mt={modifierCodes:{LCTRL:1,RCTRL:2,LALT:4,RALT:8,SHIFT:16,CTRL:32,ALT:64,META:128,CAPS:256,NO_CAPS:512,NUM_LOCK:1024,NO_NUM_LOCK:2048,SCROLL_LOCK:4096,NO_SCROLL_LOCK:8192,VIRTUAL_KEY:16384,VIRTUAL_CHAR_KEY:32768},modifierBitmasks:{ALL:127,ALT_GR_SIM:5,CHIRAL:31,IS_CHIRAL:15,NON_CHIRAL:112,NON_LEGACY:111},stateBitmasks:{ALL:16128,CAPS:768,NUM_LOCK:3072,SCROLL_LOCK:12288},keyCodes:{K_BKSP:8,K_TAB:9,K_ENTER:13,K_SHIFT:16,K_CONTROL:17,K_ALT:18,K_PAUSE:19,K_CAPS:20,K_ESC:27,K_SPACE:32,K_PGUP:33,K_PGDN:34,K_END:35,K_HOME:36,K_LEFT:37,K_UP:38,K_RIGHT:39,K_DOWN:40,K_SEL:41,K_PRINT:42,K_EXEC:43,K_INS:45,K_DEL:46,K_HELP:47,K_0:48,K_1:49,K_2:50,K_3:51,K_4:52,K_5:53,K_6:54,K_7:55,K_8:56,K_9:57,K_A:65,K_B:66,K_C:67,K_D:68,K_E:69,K_F:70,K_G:71,K_H:72,K_I:73,K_J:74,K_K:75,K_L:76,K_M:77,K_N:78,K_O:79,K_P:80,K_Q:81,K_R:82,K_S:83,K_T:84,K_U:85,K_V:86,K_W:87,K_X:88,K_Y:89,K_Z:90,K_NP0:96,K_NP1:97,K_NP2:98,K_NP3:99,K_NP4:100,K_NP5:101,K_NP6:102,K_NP7:103,K_NP8:104,K_NP9:105,K_NPSTAR:106,K_NPPLUS:107,K_SEPARATOR:108,K_NPMINUS:109,K_NPDOT:110,K_NPSLASH:111,K_F1:112,K_F2:113,K_F3:114,K_F4:115,K_F5:116,K_F6:117,K_F7:118,K_F8:119,K_F9:120,K_F10:121,K_F11:122,K_F12:123,K_NUMLOCK:144,K_SCROLL:145,K_LSHIFT:160,K_RSHIFT:161,K_LCONTROL:162,K_RCONTROL:163,K_LALT:164,K_RALT:165,K_COLON:186,K_EQUAL:187,K_COMMA:188,K_HYPHEN:189,K_PERIOD:190,K_SLASH:191,K_BKQUOTE:192,K_LBRKT:219,K_BKSLASH:220,K_RBRKT:221,K_QUOTE:222,K_oE2:226,K_OE2:226,K_LOPT:50001,K_ROPT:50002,K_NUMERALS:50003,K_SYMBOLS:50004,K_CURRENCIES:50005,K_UPPER:50006,K_LOWER:50007,K_ALPHA:50008,K_SHIFTED:50009,K_ALTGR:50010,K_TABBACK:50011,K_TABFWD:50012},codesUS:[["0123456789",";=,-./`","[\\]'"],[")!@#$%^&*(",":+<_>?~",'{|}"']],isFrameKey(Q){switch(Q){case"K_SHIFT":case"K_LOPT":case"K_ROPT":case"K_NUMLOCK":case"K_CAPS":return!0;default:if(mt.keyCodes[Q]>=5e4)return!0}return!1},getModifierState(Q){var e=0;Q.indexOf("shift")>=0&&(e|=mt.modifierCodes.SHIFT);var t=!1;Q.indexOf("leftctrl")>=0&&(e|=mt.modifierCodes.LCTRL,t=!0),Q.indexOf("rightctrl")>=0&&(e|=mt.modifierCodes.RCTRL,t=!0),Q.indexOf("ctrl")>=0&&!t&&(e|=mt.modifierCodes.CTRL);var n=!1;return Q.indexOf("leftalt")>=0&&(e|=mt.modifierCodes.LALT,n=!0),Q.indexOf("rightalt")>=0&&(e|=mt.modifierCodes.RALT,n=!0),Q.indexOf("alt")>=0&&!n&&(e|=mt.modifierCodes.ALT),e},getStateFromLayer(Q){var e=0;return Q.indexOf("caps")>=0?e|=mt.modifierCodes.CAPS:e|=mt.modifierCodes.NO_CAPS,e}},y=mt;var ji=class ji{constructor(){}codeForEvent(e){return y.keyCodes[e.kName]||e.Lcode}forAny(e,t,n){var s="";if((s=this.forSpecialEmulation(e))!=null)return s;if(!t&&(s=this.forNumpadKeys(e))!=null)return s;if((s=this.forUnicodeKeynames(e,n))!=null)return s;if((s=this.forBaseKeys(e,n))!=null)return s;switch(this.codeForEvent(e)){default:return null}}isCommand(e){switch(this.codeForEvent(e)){default:return!1}}applyCommand(e,t){}forSpecialEmulation(e){switch(this.codeForEvent(e)){case y.keyCodes.K_BKSP:return"\b";case y.keyCodes.K_ENTER:return`
`;default:return null}}forNumpadKeys(e){if(e.Lcode>=y.keyCodes.K_NP0&&e.Lcode<=y.keyCodes.K_NPSLASH){if(e.Lcode<106)var t=e.Lcode-48;else t=e.Lcode-64;return String._kmwFromCharCode(t)}else return null}forUnicodeKeynames(e,t){let n=e.kName;if(!n||n.substr(0,2)!="U_")return null;let s="",i=n.substr(2).split("_");for(let B of i){let c=parseInt(B,16);if(0<=c&&c<=31||128<=c&&c<=159||isNaN(c)){t&&(t.errorLog="Suppressing Unicode control code in "+n);continue}else s+=String.kmwFromCharCode(c)}return s||null}forBaseKeys(e,t){let n=e.Lcode,s=e.Lmodifiers;if(s==y.modifierCodes.SHIFT)s=1;else if(s!=0)return t&&(t.warningLog="KMW only defines default key output for the 'default' and 'shift' layers!"),null;try{if(n==y.keyCodes.K_SPACE)return" ";if(n>=y.keyCodes.K_0&&n<=y.keyCodes.K_9)return y.codesUS[s][0][n-y.keyCodes.K_0];if(n>=y.keyCodes.K_A&&n<=y.keyCodes.K_Z)return String.fromCharCode(n+(s?0:32));if(n>=y.keyCodes.K_COLON&&n<=y.keyCodes.K_BKQUOTE)return y.codesUS[s][1][n-y.keyCodes.K_COLON];if(n>=y.keyCodes.K_LBRKT&&n<=y.keyCodes.K_QUOTE)return y.codesUS[s][2][n-y.keyCodes.K_LBRKT];if(n==y.keyCodes.K_oE2)return s?"|":"\\"}catch(i){t&&(t.errorLog="Error detected with default mapping for key:  code = "+n+", shift state = "+(s==1?"shift":"default"))}return null}};r(ji,"DefaultRules");var Lt=ji;var UQ=new Lt,En=class En{constructor(e){this.isSynthetic=!0;for(let t in e)e[t]!==void 0&&(this[t]=e[t])}static constructNullKeyEvent(e){return new En({Lcode:0,kName:"",device:e,Lstates:void 0,Lmodifiers:void 0,vkCode:void 0,LisVirtualKey:void 0})}get isModifier(){switch(this.Lcode){case 16:case 17:case 18:case 20:case 144:case 145:return!0;default:return!1}}setMnemonicCode(e,t){if(this.Lcode!=y.keyCodes.K_SPACE){let s=new En(this);for(let i in this)s[i]=this[i];s.kName="K_xxxx",s.Lmodifiers=e?16:0;var n=UQ.forAny(s,!0);this.vkCode=this.Lcode,n?this.Lcode=n.charCodeAt(0):this.isModifier||delete this.Lcode}t&&(this.Lcode>=65&&this.Lcode<=90||this.Lcode>=97&&this.Lcode<=122)&&(this.Lmodifiers^=16,this.Lcode^=32)}};r(En,"KeyEvent");var _=En;var $i=class $i{};r($i,"KeyMap");var ft=$i,tB=class tB{constructor(){this.FF=new ft;this.Safari=new ft;this.Opera=new ft;this.FF.k61=187,this.FF.k59=186,this.FF.k173=189}};r(tB,"BrowserKeyMaps");var _i=tB,eB=class eB{constructor(){this.se=new ft,this.se.k220=192,this.se.k187=189,this.se.k219=187,this.se.k221=219,this.se.k186=221,this.se.k191=220,this.se.k192=186,this.se.k189=191,this.uk=new ft,this.uk.k223=192,this.uk.k192=222,this.uk.k222=226,this.uk.k220=220}};r(eB,"LanguageKeyMaps");var qi=eB,Et=class Et{constructor(){}static _usCodeInit(){var e=new ft,t=new ft;e.k192=96,e.k49=49,e.k50=50,e.k51=51,e.k52=52,e.k53=53,e.k54=54,e.k55=55,e.k56=56,e.k57=57,e.k48=48,e.k189=45,e.k187=61,e.k81=113,e.k87=119,e.k69=101,e.k82=114,e.k84=116,e.k89=121,e.k85=117,e.k73=105,e.k79=111,e.k80=112,e.k219=91,e.k221=93,e.k220=92,e.k65=97,e.k83=115,e.k68=100,e.k70=102,e.k71=103,e.k72=104,e.k74=106,e.k75=107,e.k76=108,e.k186=59,e.k222=39,e.k90=122,e.k88=120,e.k67=99,e.k86=118,e.k66=98,e.k78=110,e.k77=109,e.k188=44,e.k190=46,e.k191=47,t.k192=126,t.k49=33,t.k50=64,t.k51=35,t.k52=36,t.k53=37,t.k54=94,t.k55=38,t.k56=42,t.k57=40,t.k48=41,t.k189=95,t.k187=43,t.k81=81,t.k87=87,t.k69=69,t.k82=82,t.k84=84,t.k89=89,t.k85=85,t.k73=73,t.k79=79,t.k80=80,t.k219=123,t.k221=125,t.k220=124,t.k65=65,t.k83=83,t.k68=68,t.k70=70,t.k71=71,t.k72=72,t.k74=74,t.k75=75,t.k76=76,t.k186=58,t.k222=34,t.k90=90,t.k88=88,t.k67=67,t.k86=86,t.k66=66,t.k78=78,t.k77=77,t.k188=60,t.k190=62,t.k191=63,Et._usCharCodes=[e,t]}static _USKeyCodeToCharCode(e){return Et.usCharCodes[e.Lmodifiers&16?1:0]["k"+e.Lcode]}static get usCharCodes(){return Et._usCharCodes||Et._usCodeInit(),Et._usCharCodes}};r(Et,"KeyMapping"),Et.browserMap=new _i,Et.languageMap=new qi;var q=Et;function Bt(Q){if(typeof Q!="object"||!Q)return Q;{let e=Array.isArray(Q)?[]:{},t=Object.keys(Q);for(let n of t)Q[n]!==void 0&&(e[n]=Bt(Q[n]));return e}}r(Bt,"deepCopy");var v=class v{constructor(e,t,n,s){switch(e.toLowerCase()){case v.Browser.Chrome:case v.Browser.Edge:case v.Browser.Firefox:case v.Browser.Native:case v.Browser.Opera:case v.Browser.Safari:this.browser=e.toLowerCase();break;default:this.browser=v.Browser.Other}switch(t.toLowerCase()){case v.FormFactor.Desktop:case v.FormFactor.Phone:case v.FormFactor.Tablet:this.formFactor=t.toLowerCase();break;default:throw"Invalid form factor specified for device: "+t}switch(n.toLowerCase()){case v.OperatingSystem.Windows.toLowerCase():case v.OperatingSystem.macOS.toLowerCase():case v.OperatingSystem.Linux.toLowerCase():case v.OperatingSystem.Android.toLowerCase():case v.OperatingSystem.iOS.toLowerCase():this.OS=n.toLowerCase();break;default:this.OS=v.OperatingSystem.Other}this.touchable=s}};r(v,"DeviceSpec");var ue=v;(n=>{let Q;(o=>(o.Chrome="chrome",o.Edge="edge",o.Firefox="firefox",o.Native="native",o.Opera="opera",o.Safari="safari",o.Other="other"))(Q=n.Browser||(n.Browser={}));let e;(F=>(F.Windows="windows",F.macOS="macosx",F.Linux="linux",F.Android="android",F.iOS="ios",F.Other="other"))(e=n.OperatingSystem||(n.OperatingSystem={}));let t;(c=>(c.Desktop="desktop",c.Phone="phone",c.Tablet="tablet"))(t=n.FormFactor||(n.FormFactor={}))})(ue||(ue={}));function nB(Q){return new ue(Q.browser,"desktop",Q.OS,!1)}r(nB,"physicalKeyDeviceAlias");var S=ue;var ct=class ct{};r(ct,"KEYMAN_VERSION"),ct.VERSION="18.0.70",ct.VERSION_RELEASE="18.0",ct.VERSION_MAJOR="18",ct.VERSION_MINOR="0",ct.VERSION_PATCH="70",ct.TIER="alpha",ct.VERSION_TAG="-alpha",ct.VERSION_WITH_TAG="18.0.70-alpha",ct.VERSION_ENVIRONMENT="alpha",ct.VERSION_GIT_TAG="release@18.0.70-alpha";var Zn=ct,$t=Zn;var ot=class ot{constructor(e){if(e==null){this.components=[].concat(ot.DEVELOPER_VERSION_FALLBACK.components);return}if(Array.isArray(e)){let s=e;if(s.length<2)throw new Error("Version string must have at least a major and minor component!");this.components=[].concat(s);return}let t=e.split("."),n=[];if(t.length<2)throw new Error("Version string must have at least a major and minor component!");for(let s=0;s<t.length;s++){let i=parseInt(t[s],10);if(isNaN(i))throw new Error("Version string components must be numerical!");n.push(i)}this.components=n}get major(){return this.components[0]}get minor(){return this.components[1]}toString(){return this.components.join(".")}toJSON(){return this.toString()}equals(e){return this.compareTo(e)==0}precedes(e){return this.compareTo(e)<0}compareTo(e){var t=this.components.length<e.components.length,n=this.components.length<e.components.length?this.components.length:e.components.length,s;for(s=0;s<n;s++){let B=this.components[s]-e.components[s];if(B!=0)return B}var i=t?e.components:this.components;do{if(i[s]>0)return t?-1:1;s++}while(s<i.length);return 0}};r(ot,"Version"),ot.CURRENT=new ot($t.VERSION_RELEASE),ot.DEVELOPER_VERSION_FALLBACK=new ot([9,0,0]),ot.NO_DEFAULT_KEYCAPS=new ot([12,0]),ot.MAC_POSSIBLE_IPAD_ALIAS=new ot([10,15]);var N=ot;function We(){return typeof globalThis!="undefined"?globalThis:typeof window!="undefined"?window:typeof self!="undefined"?self:global}r(We,"getGlobalObject");function Jn(){String.kmwFromCharCode=function(Q){var e=[],t;for(t=0;t<arguments.length;t++){var n=Number(arguments[t]);if(!isFinite(n)||n<0||n>1114111||Math.floor(n)!==n)throw new RangeError("Invalid code point "+n);n<65536?e.push(n):(n-=65536,e.push((n>>10)+55296),e.push(n%1024+56320))}return String.fromCharCode.apply(void 0,e)},String.prototype.kmwCharCodeAt=function(Q){var e=String(this),t=0;if(Q<0||Q>=e.length)return NaN;for(var n=0;n<Q;n++)if(t=e.kmwNextChar(t),t===null)return NaN;var s=e.charCodeAt(t);if(s>=55296&&s<=56319&&e.length>t+1){var i=e.charCodeAt(t+1);if(i>=56320&&i<=57343)return(s-55296<<10)+(i-56320)+65536}return s},String.prototype.kmwIndexOf=function(Q,e){var t=String(this),n=t.indexOf(Q,e);if(n<0)return n;for(var s=0,i=0;i!==null&&i<n;i=t.kmwNextChar(i))s++;return s},String.prototype.kmwLastIndexOf=function(Q,e){var t=String(this),n=t.lastIndexOf(Q,e);if(n<0)return n;for(var s=0,i=0;i!==null&&i<n;i=t.kmwNextChar(i))s++;return s},String.prototype.kmwLength=function(){var Q=String(this);if(Q.length==0)return 0;for(var e=0,t=0;t!==null;e++)t=Q.kmwNextChar(t);return e},String.prototype.kmwSlice=function(Q,e){var t=String(this),n=t.kmwCodePointToCodeUnit(Q),s=t.kmwCodePointToCodeUnit(e);return n===null||s===null?"":t.slice(n,s)},String.prototype.kmwSubstr=function(Q,e){var t=String(this);Q<0&&(Q=t.kmwLength()+Q),Q<0&&(Q=0);var n=t.kmwCodePointToCodeUnit(Q),s=n;if(n===null)return"";if(arguments.length<2)s=t.length;else for(var i=0;i<e;i++)s=t.kmwNextChar(s);return s===null?t.substring(n):t.substring(n,s)},String.prototype.kmwSubstring=function(Q,e){var t=String(this),n,s;if(typeof e=="undefined")n=t.kmwCodePointToCodeUnit(Q),s=t.length;else{if(Q>e){var i=Q;Q=e,e=i}n=t.kmwCodePointToCodeUnit(Q),s=t.kmwCodePointToCodeUnit(e)}return(isNaN(n)||n===null)&&(n=0),(isNaN(s)||s===null)&&(s=t.length),t.substring(n,s)},String.prototype.kmwNextChar=function(Q){var e=String(this);if(Q===null||Q<0||Q>=e.length-1)return null;var t=e.charCodeAt(Q);if(t>=55296&&t<=56319&&e.length>Q+1){var n=e.charCodeAt(Q+1);if(n>=56320&&n<=57343)return Q==e.length-2?null:Q+2}return Q+1},String.prototype.kmwPrevChar=function(Q){var e=String(this);if(Q==null||Q<=0||Q>e.length)return null;var t=e.charCodeAt(Q-1);if(t>=56320&&t<=57343&&Q>1){var n=e.charCodeAt(Q-2);if(n>=55296&&n<=56319)return Q-2}return Q-1},String.prototype.kmwCodePointToCodeUnit=function(Q){if(Q===null)return null;var e=String(this),t=0;if(Q<0){t=e.length;for(var n=0;n>Q;n--)t=e.kmwPrevChar(t);return t}if(Q==e.kmwLength())return e.length;for(var n=0;n<Q;n++)t=e.kmwNextChar(t);return t},String.prototype.kmwCodeUnitToCodePoint=function(Q){var e=String(this);return Q===null?null:Q==0?0:Q<0?e.substr(Q).kmwLength():e.substr(0,Q).kmwLength()},String.prototype.kmwCharAt=function(Q){var e=String(this);return Q>=0?e.kmwSubstr(Q,1):""},String.prototype.kmwBMPNextChar=function(Q){var e=String(this);return Q<0||Q>=e.length-1?null:Q+1},String.prototype.kmwBMPPrevChar=function(Q){var e=String(this);return Q<=0||Q>e.length?null:Q-1},String.prototype.kmwBMPCodePointToCodeUnit=function(Q){return Q},String.prototype.kmwBMPCodeUnitToCodePoint=function(Q){return Q},String.prototype.kmwBMPLength=function(){var Q=String(this);return Q.length},String.prototype.kmwBMPSubstr=function(Q,e){var t=String(this);return Q>-1?t.substr(Q,e):t.substr(t.length+Q,-Q)},String.kmwEnableSupplementaryPlane=function(Q){var e=String.prototype;String._kmwFromCharCode=Q?String.kmwFromCharCode:String.fromCharCode,e._kmwCharAt=Q?e.kmwCharAt:e.charAt,e._kmwCharCodeAt=Q?e.kmwCharCodeAt:e.charCodeAt,e._kmwIndexOf=Q?e.kmwIndexOf:e.indexOf,e._kmwLastIndexOf=Q?e.kmwLastIndexOf:e.lastIndexOf,e._kmwSlice=Q?e.kmwSlice:e.slice,e._kmwSubstring=Q?e.kmwSubstring:e.substring,e._kmwSubstr=Q?e.kmwSubstr:e.kmwBMPSubstr,e._kmwLength=Q?e.kmwLength:e.kmwBMPLength,e._kmwNextChar=Q?e.kmwNextChar:e.kmwBMPNextChar,e._kmwPrevChar=Q?e.kmwPrevChar:e.kmwBMPPrevChar,e._kmwCodePointToCodeUnit=Q?e.kmwCodePointToCodeUnit:e.kmwBMPCodePointToCodeUnit,e._kmwCodeUnitToCodePoint=Q?e.kmwCodeUnitToCodePoint:e.kmwBMPCodeUnitToCodePoint},String._kmwFromCharCode||String.kmwEnableSupplementaryPlane(!1)}r(Jn,"extendString");Jn();var sB=class sB{constructor(e){this._isFulfilled=!1;this._isRejected=!1;this._promise=new Promise((t,n)=>{this._resolve=s=>{this._isFulfilled=!0,t(s)},this._reject=s=>{this._isRejected=!0,n(s)},e&&e(this._resolve,this._reject)})}get resolve(){return this._resolve}get reject(){return this._reject}get isFulfilled(){return this._isFulfilled}get isRejected(){return this._isRejected}get isResolved(){return this.isFulfilled||this.isRejected}then(e,t){return this._promise.then(e,t)}catch(e){return this._promise.catch(e)}finally(e){return this._promise.finally(e)}get corePromise(){return this._promise}};r(sB,"ManagedPromise");var E=sB;var iB=class iB extends E{constructor(t){let n=null;super(B=>{n=setTimeout(()=>{this.isResolved||B(!0)},t)});this.timerHandle=n;let s=this._resolve;this._resolve=B=>{clearTimeout(this.timerHandle),s(B)};let i=this._reject;this._reject=B=>{clearTimeout(this.timerHandle),i(B)}}};r(iB,"TimeoutPromise");var Tt=iB,lt=r(Q=>new Tt(Q).corePromise,"timedPromise");function Ws(Q){return Q>=55296&&Q<=56319}r(Ws,"Uni_IsSurrogate1");function vs(Q){return Q>=56320&&Q<=57343}r(vs,"Uni_IsSurrogate2");var gQ={};Vn(gQ,{PRIVATE_USE_IDS:()=>dQ,TouchLayoutKeySp:()=>ar});var dQ=["T_*_MT_SHIFT_TO_SHIFT","T_*_MT_SHIFT_TO_CAPS","T_*_MT_SHIFT_TO_DEFAULT"],ar=(l=>(l[l.normal=0]="normal",l[l.special=1]="special",l[l.specialActive=2]="specialActive",l[l.customSpecial=3]="customSpecial",l[l.customSpecialActive=4]="customSpecialActive",l[l.deadkey=8]="deadkey",l[l.blank=9]="blank",l[l.spacer=10]="spacer",l))(ar||{});var H=gQ.TouchLayoutKeySp;var uQ=200,R=class R{static buildDefaultLayout(e,t,n){var Sn;let s=n;typeof R.dfltLayout[s]!="object"&&(s="desktop");let i=y.modifierBitmasks.NON_CHIRAL,B=N.CURRENT;t&&(i=t.modifierBitmask,B=t.compilerVersion),e||(e=this.DEFAULT_RAW_SPEC);var c=Bt(R.dfltLayout[s]),l,a=c.layer,F=e.KLS,o=e.K102,d,U,u,g,I,C,x=(i&y.modifierBitmasks.IS_CHIRAL)!=0;if(e.F){let vt=/^(?:(?:italic|bold) )* *[0-9.eE-]+(?:[a-z]+) "(.+)"$/.exec(e.F);vt&&(c.font=vt[1])}var m=!(typeof F=="undefined"||!F);m||(F=e.KLS=R.processLegacyDefinitions(e.BK));var b=Object.getOwnPropertyNames(F),p=[];if(b.splice(b.indexOf("default"),1),b=["default"].concat(b),t&&t.emulatesAltGr&&(b.indexOf("leftctrl-leftalt")==-1&&b.indexOf("rightalt")!=-1&&(b.push("leftctrl-leftalt"),F["leftctrl-leftalt"]=F.rightalt),b.indexOf("leftctrl-leftalt-shift")==-1&&b.indexOf("rightalt-shift")!=-1&&(b.push("leftctrl-leftalt-shift"),F["leftctrl-leftalt-shift"]=F["rightalt-shift"])),c.displayUnderlying=t?!!t.scriptObject.KDU:!1,n=="desktop")for(p=R.generateLayerIds(x),l=0;l<p.length;l++)b.indexOf(p[l])!=-1&&p.splice(l--,1);var J=b.concat(p);if(m&&n!="desktop"){var Z=null;g=a[0].row;for(var it=0;it<g.length;it++){C=g[it].key;for(var jt=0;jt<C.length;jt++)I=C[jt],I.id=="K_SHIFT"&&(Z=I)}if(Z){Z.sk=[];for(let vt in F){if(vt=="default"||vt=="shift")continue;var Rs=R.modifierSpecials[vt];let qt={id:`K_${Rs}`,text:Rs,sp:1,nextlayer:vt};Z.sk.push(qt)}}else console.warn("Error in default layout - cannot find default Shift key!")}for(l=0;l<J.length;l++)l>0&&(a[l]=Bt(a[0])),a[l].id=J[l],a[l].nextlayer=J[l],R.formatDefaultLayer(a[l],x,n,!!o);for(l=0;l<a.length;l++){var bt=a[l],Wt,Z=null,Gn=null,ge=null,pn=null,_t=F[bt.id],Ae=bt.id=="shift"?1:0,Xn=bt.id=="default"||Ae?1:0;for(g=bt.row,d=0;d<g.length;d++)for(C=g[d].key,U=0;U<C.length;U++){switch(I=C[U],Wt=R.dfltCodes.indexOf(I.id),(_t||Xn)&&(_t&&Wt>=0&&Wt<_t.length&&(I.text=_t[Wt]),Xn&&B.precedes(N.NO_DEFAULT_KEYCAPS)&&I.id!="K_SPACE"&&Wt+65*Ae<R.dfltText.length&&I.text!==null&&(I.text=I.text||R.dfltText[Wt+65*Ae])),I.text!==null&&(I.text=I.text||""),I.id){case"K_SHIFT":Z=I;break;case"K_CAPS":Gn=I;break;case"K_NUMLOCK":ge=I;break;case"K_SCROLL":pn=I;break}if(I.sk!=null){for(u=0;u<I.sk.length;u++)b.indexOf(I.sk[u].nextlayer)==-1&&I.sk.splice(u--,1);I.sk.length==0&&(I.sk=null)}}bt.shiftKey=Z,bt.capsKey=Gn,bt.numKey=ge,bt.scrollKey=pn;let qt=a[l].id;n!="desktop"&&l>0&&Z!=null&&(Z.sp=H.specialActive,Z.sk=null,Z.text=(Sn=R.modifierSpecials[qt])!=null?Sn:"*Shift*")}return c}static getLayerId(e){let t=y.modifierCodes;var n="";return e==0?"default":(e&t.LCTRL&&(n=(n.length>0?n+"-":"")+"leftctrl"),e&t.RCTRL&&(n=(n.length>0?n+"-":"")+"rightctrl"),e&t.LALT&&(n=(n.length>0?n+"-":"")+"leftalt"),e&t.RALT&&(n=(n.length>0?n+"-":"")+"rightalt"),e&t.SHIFT&&(n=(n.length>0?n+"-":"")+"shift"),e&t.CTRL&&(n=(n.length>0?n+"-":"")+"ctrl"),e&t.ALT&&(n=(n.length>0?n+"-":"")+"alt"),n)}static generateLayerIds(e){var t,n;e?(t=32,n=1):(t=8,n=16);for(var s=[],i=0;i<t;i++)s.push(R.getLayerId(i*n));return s}static formatDefaultLayer(e,t,n,s){for(var i=e.id,B=0;B<e.row.length;B++)for(var c=e.row[B],l=c.key,a=0;a<l.length;a++){var F=l[a];switch(F.id){case"K_SHIFT":case"K_LSHIFT":case"K_RSHIFT":i.indexOf("shift")!=-1&&(F.sp=H.specialActive),n!="desktop"&&(i!="default"?F.nextlayer="default":F.nextlayer="shift");break;case"K_LCTRL":case"K_LCONTROL":if(t){i.indexOf("leftctrl")!=-1&&(F.sp=H.specialActive);break}case"K_RCTRL":case"K_RCONTROL":if(t){i.indexOf("rightctrl")!=-1&&(F.sp=H.specialActive);break}case"K_CONTROL":i.indexOf("ctrl")!=-1&&(!t||i.indexOf("leftctrl")!=-1&&i.indexOf("rightctrl")!=-1)&&(F.sp=H.specialActive);break;case"K_LALT":if(t){i.indexOf("leftalt")!=-1&&(F.sp=H.specialActive);break}case"K_RALT":if(t){i.indexOf("rightalt")!=-1&&(F.sp=H.specialActive);break}case"K_ALT":i.indexOf("alt")!=-1&&(!t||i.indexOf("leftalt")!=-1&&i.indexOf("rightalt")!=-1)&&(F.sp=H.specialActive);break;case"K_oE2":(typeof s=="undefined"||!s)&&(n=="desktop"?(l.splice(a--,1),l[0].width=uQ):l[a].sp=H.spacer);break}}}static processLegacyDefinitions(e){for(var t=R.generateLayerIds(!1),n={},s=0;s<t.length;s++){for(var i=t[s],B=[],c=!1,l=0;l<65;l++){var a=l+65*s;B.push(e[a]),a<e.length&&e[a]!=""&&l!=R.dfltCodes.indexOf("K_SPACE")&&(c=!0)}c&&(n[i]=B)}return(typeof n.default=="undefined"||!n.default)&&(n.default=[""]),(typeof n.shift=="undefined"||!n.shift)&&(n.shift=[""]),n}};r(R,"Layouts"),R.dfltCodes=["K_BKQUOTE","K_1","K_2","K_3","K_4","K_5","K_6","K_7","K_8","K_9","K_0","K_HYPHEN","K_EQUAL","K_*","K_*","K_*","K_Q","K_W","K_E","K_R","K_T","K_Y","K_U","K_I","K_O","K_P","K_LBRKT","K_RBRKT","K_BKSLASH","K_*","K_*","K_*","K_A","K_S","K_D","K_F","K_G","K_H","K_J","K_K","K_L","K_COLON","K_QUOTE","K_*","K_*","K_*","K_*","K_*","K_oE2","K_Z","K_X","K_C","K_V","K_B","K_N","K_M","K_COMMA","K_PERIOD","K_SLASH","K_*","K_*","K_*","K_*","K_*","K_SPACE"],R.dfltText="`1234567890-=\xA7~~qwertyuiop[]\\~~~asdfghjkl;'~~~~~?zxcvbnm,./~~~~~ ~!@#$%^&*()_+\xA7~~QWERTYUIOP{}\\~~~ASDFGHJKL:\"~~~~~?ZXCVBNM<>?~~~~~ ",R.DEFAULT_RAW_SPEC={F:"Tahoma",BK:R.dfltText.split("")},R.modifierSpecials={leftalt:"*LAlt*",rightalt:"*RAlt*",alt:"*Alt*",leftctrl:"*LCtrl*",rightctrl:"*RCtrl*",ctrl:"*Ctrl*","ctrl-alt":"*AltGr*","leftctrl-leftalt":"*LAltCtrl*","rightctrl-rightalt":"*RAltCtrl*","leftctrl-leftalt-shift":"*LAltCtrlShift*","rightctrl-rightalt-shift":"*RAltCtrlShift*",shift:"*Shift*","shift-alt":"*AltShift*","shift-ctrl":"*CtrlShift*","shift-ctrl-alt":"*AltCtrlShift*","leftalt-shift":"*LAltShift*","rightalt-shift":"*RAltShift*","leftctrl-shift":"*LCtrlShift*","rightctrl-shift":"*RCtrlShift*"},R.dfltShiftToCaps={id:"T_*_MT_SHIFT_TO_CAPS",text:"*ShiftLock*",sp:1,nextlayer:"caps"},R.dfltShiftToDefault={id:"T_*_MT_SHIFT_TO_DEFAULT",text:"*Shift*",sp:1,nextlayer:"default"},R.dfltShiftToShift={id:"T_*_MT_SHIFT_TO_SHIFT",text:"*Shift*",sp:1,nextlayer:"shift"},R.dfltLayout={desktop:{defaultHint:"dot",font:"Tahoma,Helvetica",layer:[{id:"default",row:[{id:1,key:[{id:"K_BKQUOTE"},{id:"K_1"},{id:"K_2"},{id:"K_3"},{id:"K_4"},{id:"K_5"},{id:"K_6"},{id:"K_7"},{id:"K_8"},{id:"K_9"},{id:"K_0"},{id:"K_HYPHEN"},{id:"K_EQUAL"},{id:"K_BKSP",text:"*BkSp*",sp:1,width:130}]},{id:2,key:[{id:"K_TAB",text:"*Tab*",sp:1,width:130},{id:"K_Q"},{id:"K_W"},{id:"K_E"},{id:"K_R"},{id:"K_T"},{id:"K_Y"},{id:"K_U"},{id:"K_I"},{id:"K_O"},{id:"K_P"},{id:"K_LBRKT"},{id:"K_RBRKT"},{id:"K_BKSLASH"}]},{id:3,key:[{id:"K_CAPS",text:"*Caps*",sp:1,width:165},{id:"K_A"},{id:"K_S"},{id:"K_D"},{id:"K_F"},{id:"K_G"},{id:"K_H"},{id:"K_J"},{id:"K_K"},{id:"K_L"},{id:"K_COLON"},{id:"K_QUOTE"},{id:"K_ENTER",text:"*Enter*",sp:1,width:165}]},{id:4,key:[{id:"K_SHIFT",text:"*Shift*",sp:1,width:130},{id:"K_oE2"},{id:"K_Z"},{id:"K_X"},{id:"K_C"},{id:"K_V"},{id:"K_B"},{id:"K_N"},{id:"K_M"},{id:"K_COMMA"},{id:"K_PERIOD"},{id:"K_SLASH"},{id:"K_RSHIFT",text:"*Shift*",sp:1,width:130}]},{id:5,key:[{id:"K_LCONTROL",text:"*Ctrl*",sp:1,width:170},{id:"K_LALT",text:"*Alt*",sp:1,width:160},{id:"K_SPACE",text:"",width:770},{id:"K_RALT",text:"*Alt*",sp:1,width:160},{id:"K_RCONTROL",text:"*Ctrl*",sp:1,width:170}]}]}]},tablet:{defaultHint:"dot",font:"Tahoma,Helvetica",layer:[{id:"default",row:[{id:0,key:[{id:"K_1"},{id:"K_2"},{id:"K_3"},{id:"K_4"},{id:"K_5"},{id:"K_6"},{id:"K_7"},{id:"K_8"},{id:"K_9"},{id:"K_0"},{id:"K_HYPHEN"},{id:"K_EQUAL"},{sp:10,width:1}]},{id:1,key:[{id:"K_Q",pad:25},{id:"K_W"},{id:"K_E"},{id:"K_R"},{id:"K_T"},{id:"K_Y"},{id:"K_U"},{id:"K_I"},{id:"K_O"},{id:"K_P"},{id:"K_LBRKT"},{id:"K_RBRKT"},{sp:10,width:1}]},{id:2,key:[{id:"K_A",pad:50},{id:"K_S"},{id:"K_D"},{id:"K_F"},{id:"K_G"},{id:"K_H"},{id:"K_J"},{id:"K_K"},{id:"K_L"},{id:"K_COLON"},{id:"K_QUOTE"},{id:"K_BKSLASH",width:90}]},{id:3,key:[{id:"K_oE2",width:90},{id:"K_Z"},{id:"K_X"},{id:"K_C"},{id:"K_V"},{id:"K_B"},{id:"K_N"},{id:"K_M"},{id:"K_COMMA"},{id:"K_PERIOD"},{id:"K_SLASH"},{id:"K_BKQUOTE"},{sp:10,width:1}]},{id:4,key:[{id:"K_SHIFT",text:"*Shift*",sp:1,width:200,sk:[{id:"K_LCONTROL",text:"*Ctrl*",sp:1,width:50,nextlayer:"ctrl"},{id:"K_LCONTROL",text:"*LCtrl*",sp:1,width:50,nextlayer:"leftctrl"},{id:"K_RCONTROL",text:"*RCtrl*",sp:1,width:50,nextlayer:"rightctrl"},{id:"K_LALT",text:"*Alt*",sp:1,width:50,nextlayer:"alt"},{id:"K_LALT",text:"*LAlt*",sp:1,width:50,nextlayer:"leftalt"},{id:"K_RALT",text:"*RAlt*",sp:1,width:50,nextlayer:"rightalt"},{id:"K_ALTGR",text:"*AltGr*",sp:1,width:50,nextlayer:"ctrl-alt"}]},{id:"K_LOPT",text:"*Menu*",sp:1,width:150},{id:"K_SPACE",text:"",width:570},{id:"K_BKSP",text:"*BkSp*",sp:1,width:150},{id:"K_ENTER",text:"*Enter*",sp:1,width:200}]}]}]},phone:{defaultHint:"dot",font:"Tahoma,Helvetica",layer:[{id:"default",row:[{id:0,key:[{id:"K_1"},{id:"K_2"},{id:"K_3"},{id:"K_4"},{id:"K_5"},{id:"K_6"},{id:"K_7"},{id:"K_8"},{id:"K_9"},{id:"K_0"},{id:"K_HYPHEN"},{id:"K_EQUAL"},{sp:10,width:1}]},{id:1,key:[{id:"K_Q",pad:25},{id:"K_W"},{id:"K_E"},{id:"K_R"},{id:"K_T"},{id:"K_Y"},{id:"K_U"},{id:"K_I"},{id:"K_O"},{id:"K_P"},{id:"K_LBRKT"},{id:"K_RBRKT"},{sp:10,width:1}]},{id:2,key:[{id:"K_A",pad:50},{id:"K_S"},{id:"K_D"},{id:"K_F"},{id:"K_G"},{id:"K_H"},{id:"K_J"},{id:"K_K"},{id:"K_L"},{id:"K_COLON"},{id:"K_QUOTE"},{id:"K_BKSLASH",width:90}]},{id:3,key:[{id:"K_oE2",width:90},{id:"K_Z"},{id:"K_X"},{id:"K_C"},{id:"K_V"},{id:"K_B"},{id:"K_N"},{id:"K_M"},{id:"K_COMMA"},{id:"K_PERIOD"},{id:"K_SLASH"},{id:"K_BKQUOTE"},{sp:10,width:1}]},{id:4,key:[{id:"K_SHIFT",text:"*Shift*",sp:1,width:200,sk:[{id:"K_LCONTROL",text:"*Ctrl*",sp:1,width:50,nextlayer:"ctrl"},{id:"K_LCONTROL",text:"*LCtrl*",sp:1,width:50,nextlayer:"leftctrl"},{id:"K_RCONTROL",text:"*RCtrl*",sp:1,width:50,nextlayer:"rightctrl"},{id:"K_LALT",text:"*Alt*",sp:1,width:50,nextlayer:"alt"},{id:"K_LALT",text:"*LAlt*",sp:1,width:50,nextlayer:"leftalt"},{id:"K_RALT",text:"*RAlt*",sp:1,width:50,nextlayer:"rightalt"},{id:"K_ALTGR",text:"*AltGr*",sp:1,width:50,nextlayer:"ctrl-alt"}]},{id:"K_LOPT",text:"*Menu*",width:150,sp:1},{id:"K_SPACE",width:570,text:""},{id:"K_BKSP",text:"*BkSp*",width:150,sp:1},{id:"K_ENTER",text:"*Enter*",width:200,sp:1}]}]}]}};var f=R;function Zt(Q,e,t){t.enumerable=!0}r(Zt,"Enumerable");var Fr={id:"string",text:"string",layer:"string",nextlayer:"string",font:"string",fontsize:"string",sp:"number",pad:"number",width:"number",sk:"subkeys",flick:"flicks",multitap:"subkeys",hint:"string",default:"boolean"},or=["n","ne","e","se","s","sw","w","nw"];function BB(Q,e){let t=Object.getPrototypeOf(e);for(let n in e)if(!Q.hasOwnProperty(n)){let s=Object.getOwnPropertyDescriptor(t,n);s?Object.defineProperty(Q,n,s):Q[n]=e[n]}return Q}r(BB,"assignDefaultsWithPropDefs");var P=class P{constructor(e,t,n){this.isMnemonic=!1;Object.assign(this,e),!this.text&&typeof this.id=="string"&&(this.text=$.unicodeIDToText(this.id)),this.displayLayer=n,this.layer=this.layer||n,this._baseKeyEvent=()=>this.constructBaseKeyEvent(t,n)}get baseKeyID(){if(typeof this.id!="undefined")return this.id}get isPadding(){return this.sp==H.spacer}get coreID(){if(typeof this.id=="undefined")return;let e=this.id||"";return this.displayLayer!=this.layer&&(e=e+"+"+this.layer),e}get elementID(){if(typeof this.id!="undefined")return this.displayLayer+"-"+this.coreID}get baseKeyEvent(){let e=this._baseKeyEvent;return typeof e=="function"&&(e=e()),new _(e)}static unicodeIDToText(e,t){if(!e||e.substring(0,2)!="U_")return null;let n="",s=e.substring(2).split("_");for(let i of s){let B=parseInt(i,16);if(0<=B&&B<=31||128<=B&&B<=159||isNaN(B)){t&&t(i);continue}else n+=String.kmwFromCharCode(B)}return n||null}static sanitize(e){typeof e.width=="string"&&(e.width=parseInt(e.width,10)),e.width||(e.width=$.DEFAULT_KEY_WIDTH),typeof e.pad=="string"&&(e.pad=parseInt(e.pad,10)),e.pad||(e.pad=$.DEFAULT_PAD),typeof e.sp=="string"&&(e.sp=Number.parseInt(e.sp,10)),e.sp||(e.sp=$.DEFAULT_KEY.sp);for(let t of Object.keys(Fr)){let n=Fr[t];switch(n){case"subkeys":let s=e[t];if(s===void 0)break;if(!Array.isArray(s))delete e[t];else for(let c=0;c<s.length;c++){let l=s[c];typeof l!="object"?s.splice(c--,1):$.sanitize(l)}break;case"flicks":let i=e[t];if(i===void 0)break;if(typeof i!="object")delete e[t];else for(let c of or){let l=i[c];if(l===void 0)break;typeof l!="object"?delete i[c]:$.sanitize(l)}break;default:let B=e[t];B!==void 0&&typeof B!=n&&delete e[t]}}e.text||(e.text=$.DEFAULT_KEY.text)}constructBaseKeyEvent(e,t){let n=this.layer||t||"",s=this.id?this.id.toUpperCase():null,i={Lmodifiers:y.getModifierState(n),Lstates:y.getStateFromLayer(n),Lcode:s?y.keyCodes[s]:0,LisVirtualKey:!0,vkCode:0,kName:s,kLayer:n,kbdLayer:t,kNextLayer:this.nextlayer,device:null,isSynthetic:!0},B=new _(i);if(e.keyboard){let c=e.keyboard;c.isMnemonic&&!(e.isDefault&&e.formFactor!="desktop")?B.Lcode!=y.keyCodes.K_SPACE&&(B.vkCode=B.Lcode,this.isMnemonic=!0):B.vkCode=B.Lcode,c.definesPositionalOrMnemonic||(B.Lcode=q._USKeyCodeToCharCode(B),B.LisVirtualKey=!1)}return B}};r(P,"ActiveKeyBase"),P.DEFAULT_PAD=15,P.DEFAULT_RIGHT_MARGIN=15,P.DEFAULT_KEY_WIDTH=100,P.DEFAULT_KEY={text:"",width:P.DEFAULT_KEY_WIDTH,sp:H.normal,pad:P.DEFAULT_PAD},Ct([Zt],P.prototype,"baseKeyID",1),Ct([Zt],P.prototype,"isPadding",1),Ct([Zt],P.prototype,"coreID",1),Ct([Zt],P.prototype,"elementID",1),Ct([Zt],P.prototype,"baseKeyEvent",1),Ct([Zt],P.prototype,"constructBaseKeyEvent",1);var Rn=P,ks=class ks extends Rn{getSubkey(e){if(this.sk){for(let t of this.sk)if(t.coreID==e)return t}return null}constructor(e,t,n){super(e,t,n);let s=this.sk;if(s)for(let c=0;c<s.length;c++)s[c]=new ye(s[c],t,n);let i=this.multitap;if(i)for(let c=0;c<i.length;c++)i[c]=new ye(i[c],t,n);let B=this.flick;if(B)for(let c in B)B[c]=new ye(B[c],t,n);ks.determineHint(this,t.defaultHint)}static determineHint(e,t){var n;if(e.hint){e.hintSrc=e;return}if(t!=null&&t.includes("flick-")){if(e.flick){let s=t.substring(6);(n=e.flick[s])!=null&&n.text&&(e.hintSrc=e.flick[s])}return}switch(t){case"none":return;case"multitap":e.multitap&&(e.hintSrc=e.multitap[0]);return;case"flick":if(e.flick){for(let s of or)if(e.flick[s]){e.hintSrc=e.flick[s];return}}return;case"longpress":e.sk&&(e.hintSrc=e.sk[0]);return;case"dot":default:e.sk&&(e.hint="\u2022",e.hintSrc=e);return}}};r(ks,"ActiveKey");var $=ks,cB=class cB extends Rn{};r(cB,"ActiveSubKey");var ye=cB,te=class te{constructor(){}static sanitize(e){for(let t of e.key)t==null?e.key.length=e.key.length-1:$.sanitize(t);typeof e.id=="string"&&(e.id=Number.parseInt(e.id,10))}static polyfill(e,t,n,s,i){let B=e.key,c=Rn.DEFAULT_KEY;for(let d=0;d<B.length;d++){let U=B[d],u=Object.keys(c);for(let I of u){let C=I;typeof U[C]!="string"&&typeof U[C]!="number"&&(U[C]=c[C])}switch(U.sp){case H.special:!te.SPECIAL_LABEL.test(U.text)&&U.text!=""&&(U.sp=H.customSpecial);break;case H.specialActive:!te.SPECIAL_LABEL.test(U.text)&&U.text!=""&&(U.sp=H.customSpecialActive);break}let g=new $(U,t,n);B[d]=g}let l=r(function(d,U,u,g){d.proportionalPad=U,d.proportionalWidth=u,d.proportionalX=g+U+u/2},"setProportions"),a=0;for(let d=0;d<B.length-1;d++){let U=B[d];l(U,U.pad/s,U.width/s,a),a+=U.proportionalPad,a+=U.proportionalWidth}let F=$.DEFAULT_RIGHT_MARGIN/s;if(B.length>0){let d=B[B.length-1];if(B.length==1&&d.pad<0){let U=d.width/s,u=1-(a+U+F);l(d,u,U,a)}else{let U=d.pad/s,u=1-(a+U+F);l(d,U,u,a)}}BB(e,new te);let o=e;o.proportionalY=i}populateKeyMap(e){this.key.forEach(function(t){t.coreID&&(e[t.coreID]=t)})}};r(te,"ActiveRow"),te.SPECIAL_LABEL=/\*\w+\*/,Ct([Zt],te.prototype,"populateKeyMap",1);var fs=te,ve=class ve{constructor(){}static sanitize(e){for(let t of e.row)fs.sanitize(t)}static polyfill(e,t){e.aligned=!1;let n=e.row,s=0;for(let c of n){let l=0,a=c.key;for(let F of a)l+=F.width+F.pad;l>s&&(s=l)}t.formFactor=="desktop"?s+=5:s+=$.DEFAULT_RIGHT_MARGIN;let i=e.row.length;for(let c=0;c<i;c++){let l=(c+.5)/i;fs.polyfill(e.row[c],t,e.id,s,l)}BB(e,new ve);let B=e;B.totalWidth=s,B.defaultKeyProportionalWidth=$.DEFAULT_KEY.width/s,B.rowProportionalHeight=1/i,B.keyMap=B.constructKeyMap()}constructKeyMap(){let e={};return this.row.forEach(function(t){t.populateKeyMap(e)}),e}getKey(e){e.indexOf(this.id+"-")==0&&(e=e.replace(this.id+"-",""));let t=e.split("::");return t.length>1?this.keyMap[t[0]].getSubkey(t[1]):this.keyMap[e]}};r(ve,"ActiveLayer"),Ct([Zt],ve.prototype,"constructKeyMap",1),Ct([Zt],ve.prototype,"getKey",1);var Ts=ve,fe=class fe{constructor(){this.hasFlicks=!1;this.hasLongpresses=!1;this.hasMultitaps=!1}getLayer(e){if(!this.layerMap[e]){let t=this.layer.find(n=>n.id==e);if(!t)return null;Ts.sanitize(t),Ts.polyfill(t,this),this.layerMap[e]=t}return this.layerMap[e]}static correctLayerEmptyRowBug(e){for(let t=0;t<e.length;t++){let s=e[t].row,i;for(i=s.length-1;i>=0;i--)(!Array.isArray(s[i].key)||s[i].key.length==0)&&s.splice(i,1)}}static sanitize(e){fe.correctLayerEmptyRowBug(e.layer)}static polyfill(e,t,n){if(e==null)throw new Error("Cannot build an ActiveLayout for a null specification.");let s={hasFlicks:!1,hasLongpresses:!1,hasMultitaps:!1};this.sanitize(e);for(let c of e.layer)for(let l of c.row)for(let a of l.key)s.hasLongpresses||(s.hasLongpresses=!!a.sk),s.hasFlicks||(s.hasFlicks=!!a.flick),s.hasMultitaps||(s.hasMultitaps=!!a.multitap);let i={};BB(e,new fe);let B=e;if(B.keyboard=t,B.formFactor=n,B.layerMap=i,n!="desktop"&&e.layer.find(c=>c.id=="caps")){let c=B.getLayer("default"),l=B.getLayer("shift"),a=c.getKey("K_SHIFT"),F=l==null?void 0:l.getKey("K_SHIFT");a&&F&&!a.multitap&&!F.multitap&&!a.sk&&!F.sk&&(s.hasMultitaps=!0,a.multitap=[h({},f.dfltShiftToCaps),h({},f.dfltShiftToDefault)],F.multitap=[h({},f.dfltShiftToCaps),h({},f.dfltShiftToShift)],a.multitap.forEach((o,d)=>a.multitap[d]=new ye(o,B,"default")),F.multitap.forEach((o,d)=>F.multitap[d]=new ye(o,B,"shift")))}return B.hasFlicks=s.hasFlicks,B.hasLongpresses=s.hasLongpresses,B.hasMultitaps=s.hasMultitaps,B}};r(fe,"ActiveLayout"),Ct([Zt],fe.prototype,"getLayer",1);var Te=fe;var rB=class rB{constructor(){this.stores={}}};r(rB,"CacheTag");var lB=rB,Ns=(n=>(n[n.NOT_LOADED=void 0]="NOT_LOADED",n[n.POLYFILLED=1]="POLYFILLED",n[n.CALIBRATED=2]="CALIBRATED",n))(Ns||{}),ke=class ke{constructor(e){e?this.scriptObject=e:this.scriptObject=ke.DEFAULT_SCRIPT_OBJECT,this.layoutStates={}}process(e,t){return this.scriptObject.gs(e,t)}processNewContextEvent(e,t){return this.scriptObject.gn?this.scriptObject.gn(e,t):!1}processPostKeystroke(e,t){return this.scriptObject.gpk?this.scriptObject.gpk(e,t):!1}get isHollow(){return this.scriptObject==ke.DEFAULT_SCRIPT_OBJECT}get id(){return this.scriptObject.KI}get name(){return this.scriptObject.KN}get variableStores(){let e=this.scriptObject.KVS,t={};if(Array.isArray(e))for(let n of e)t[n]=this.scriptObject[n];return t}set variableStores(e){let t=this.scriptObject.KVS;if(Array.isArray(t))for(let n of t)typeof e[n]=="string"&&(this.scriptObject[n]=e[n])}get _legacyLayoutSpec(){return this.scriptObject.KV}get _layouts(){return this.scriptObject.KVKL}set _layouts(e){this.scriptObject.KVKL=e}get compilerVersion(){return new N(this.scriptObject.KVER)}get isMnemonic(){return!!this.scriptObject.KM}get definesPositionalOrMnemonic(){return typeof this.scriptObject.KM!="undefined"}get helpText(){return this.scriptObject.KH}get hasScript(){return!!this.scriptObject.KHF}embedScript(e){this.scriptObject.KHF(e)}get oskStyling(){return this.scriptObject.KCSS}get isCJK(){var e;return typeof this.scriptObject.KLC!="undefined"?e=this.scriptObject.KLC:typeof this.scriptObject.LanguageCode!="undefined"&&(e=this.scriptObject.LanguageCode),e=="cmn"||e=="jpn"||e=="kor"}get isRTL(){return!!this.scriptObject.KRTL}get modifierBitmask(){return this.scriptObject.KMBM||y.modifierBitmasks.NON_CHIRAL}get isChiral(){return!!(this.modifierBitmask&y.modifierBitmasks.IS_CHIRAL)}get desktopFont(){return this.scriptObject.KV?this.scriptObject.KV.F:null}get cacheTag(){let e=this.scriptObject._kmw;return e||(e=new lB,this.scriptObject._kmw=e),e}get explodedStores(){return this.cacheTag.stores}get emulatesAltGr(){let e=y.modifierCodes;if(!this.isChiral||this._legacyLayoutSpec==null)return!1;let t=this._legacyLayoutSpec.KLS;if(!t)return!1;var n=e.LCTRL|e.LALT,s=t[f.getLayerId(n)],i=t[f.getLayerId(e.SHIFT|n)];if(s!=null&&s!=t[f.getLayerId(e.RALT)]||i!=null&&i!=t[f.getLayerId(e.RALT|e.SHIFT)])return!1;var B=this.modifierBitmask;return(B&n)!=n||s==null&&i==null,!0}get usesSupplementaryPlaneChars(){let e=this.scriptObject;return e&&(e.KS&&e.KS==1||e.KN=="Hieroglyphic")}get version(){return this.scriptObject.KBVER||""}usesDesktopLayoutOnDevice(e){return this.scriptObject.KVKL?e.formFactor==S.FormFactor.Desktop:!0}notify(e,t,n){typeof this.scriptObject.KNS=="function"&&this.scriptObject.KNS(e,t,n)}findOrConstructLayout(e){if(this._layouts){if(this._layouts[e]!==void 0)return this._layouts[e];if(e==S.FormFactor.Phone&&this._layouts[S.FormFactor.Tablet])return this._layouts[S.FormFactor.Phone]=this._layouts[S.FormFactor.Tablet];if(e==S.FormFactor.Tablet&&this._layouts[S.FormFactor.Phone])return this._layouts[S.FormFactor.Tablet]=this._layouts[S.FormFactor.Phone]}let t=null;if(this._legacyLayoutSpec!=null&&this._legacyLayoutSpec.KLS)t=this._legacyLayoutSpec;else if(this._legacyLayoutSpec!=null&&this._legacyLayoutSpec.BK!=null){for(var n=this._legacyLayoutSpec.BK,s=0;s<n.length;s++)if(n[s].length>0){t=this._legacyLayoutSpec;break}}if(!t&&(this.helpText==""||e!=S.FormFactor.Desktop)&&(t={F:"Tahoma",BK:f.dfltText}),this._layouts||(this._layouts={}),t){let i=this._layouts[e]=f.buildDefaultLayout(t,this,e);return i.isDefault=!0,i}else return this._layouts[e]=null,null}layout(e){let t=this.findOrConstructLayout(e);if(t)if(this.layoutStates[e]==Ns.NOT_LOADED){let n=Te.polyfill(t,this,e);return this.layoutStates[e]=1,n}else return t;else return null}refreshLayouts(){let e=[S.FormFactor.Desktop,S.FormFactor.Phone,S.FormFactor.Tablet],t=this;e.forEach(function(n){t.layoutStates[n]=Ns.NOT_LOADED})}markLayoutCalibrated(e){this.layoutStates[e]!=Ns.NOT_LOADED&&(this.layoutStates[e]=2)}getLayoutState(e){return this.layoutStates[e]}constructNullKeyEvent(e,t){t=t||{K_CAPS:!1,K_NUMLOCK:!1,K_SCROLL:!1};let n=_.constructNullKeyEvent(e);return this.setSyntheticEventDefaults(n,t),n}constructKeyEvent(e,t,n){let s=e.baseKeyEvent;s.device=t,this.isMnemonic&&s.setMnemonicCode(e.layer.indexOf("shift")!=-1,n.K_CAPS),this.setSyntheticEventDefaults(s,n);let B={K_CAPS:y.stateBitmasks.CAPS,K_NUMLOCK:y.stateBitmasks.NUM_LOCK,K_SCROLL:y.stateBitmasks.SCROLL_LOCK}[s.kName];return B&&(s.Lstates^=B,s.LmodifierChange=!0),s}setSyntheticEventDefaults(e,t){e.device.touchable||(e.Lstates=0,e.Lstates|=t.K_CAPS?y.modifierCodes.CAPS:y.modifierCodes.NO_CAPS,e.Lstates|=t.K_NUMLOCK?y.modifierCodes.NUM_LOCK:y.modifierCodes.NO_NUM_LOCK,e.Lstates|=t.K_SCROLL?y.modifierCodes.SCROLL_LOCK:y.modifierCodes.NO_SCROLL_LOCK),e.kName&&e.kName.substr(0,2)=="U_"&&(e.LisVirtualKey=!1),typeof e.Lcode=="undefined"&&(e.Lcode=this.getVKDictionaryCode(e.kName),e.Lcode||(e.Lcode=1)),(e.Lmodifiers&y.modifierBitmasks.ALT_GR_SIM)==y.modifierBitmasks.ALT_GR_SIM&&this.emulatesAltGr&&(e.Lmodifiers&=~y.modifierBitmasks.ALT_GR_SIM,e.Lmodifiers|=y.modifierCodes.RALT)}getVKDictionaryCode(e){let t=this.scriptObject.VKDictionary||{};if(!this.scriptObject.VKDictionary){if(typeof this.scriptObject.KVKD=="string"){let i=this.scriptObject.KVKD.split(" ");for(var n=0;n<i.length;n++)t[i[n].toUpperCase()]=n+256}this.scriptObject.VKDictionary=t}let s=t[e.toUpperCase()];return s||0}};r(ke,"Keyboard"),ke.DEFAULT_SCRIPT_OBJECT={gs:function(e,t){return!1},KI:"",KN:"",KV:f.DEFAULT_RAW_SPEC,KM:0};var T=ke;var An={osk:y},QB=class QB{constructor(e,t){this.loadedKeyboard=null;this._jsGlobal=e,this.keymanGlobal=t,this.install()}KR(e){if(this.loadedKeyboard)throw new Error("Unexpected state:  the most-recently loaded keyboard field was not properly reset.");this.loadedKeyboard=new T(e)}KLOAD(e,t,n){return n}install(){this._jsGlobal.KeymanWeb=this,this._jsGlobal.keyman=this.keymanGlobal}uninstall(){this._jsGlobal.KeymanWeb==this&&delete this._jsGlobal.KeymanWeb,this._jsGlobal.keyman==this.keymanGlobal&&delete this._jsGlobal.keyman}};r(QB,"KeyboardHarness");var Ie=QB;var oB=class oB extends Error{constructor(t,n){super(t);this.cause=n}};r(oB,"KeyboardScriptError");var he=oB,UB=class UB extends Error{constructor(t,n){super(t);this.cause=n}};r(UB,"KeyboardMissingError");var Hn=UB,dB=class dB{constructor(e){this.uri=e}missingError(e){let t=`Cannot find the keyboard at ${this.uri}.`;return new Hn(t,e)}scriptError(e){let t=`Error registering the keyboard script at ${this.uri}; it may contain an error.`;return new he(t,e)}};r(dB,"UriBasedErrorBuilder");var aB=dB,gB=class gB{constructor(e){this.stub=e}missingError(e){let t=this.stub,n=`Cannot find the ${t.name} keyboard for ${t.langName} at ${t.filename}.`;return new Hn(n,e)}scriptError(e){let t=this.stub,n=`Error registering the ${t.name} keyboard for ${t.langName}; keyboard script at ${t.filename} may contain an error.`;return new he(n,e)}};r(gB,"StubBasedErrorBuilder");var FB=gB,uB=class uB{get harness(){return this._harness}constructor(e){this._harness=e}loadKeyboardFromPath(e){return this.harness.install(),this.loadKeyboardInternal(e,new aB(e))}loadKeyboardFromStub(e){return this.harness.install(),this.loadKeyboardInternal(e.filename,new FB(e),e.id)}};r(uB,"KeyboardLoaderBase");var Ne=uB;var Ur=(s=>(s.KEYBOARD="keyboard",s.LANGUAGE="language",s.LANGUAGE_KEYBOARD="languageKeyboard",s.BLANK="blank",s))(Ur||{}),xt=Ur;function yB(Q,e){if(Q)return{family:Q.family,path:e,files:Q.filename||Q.source}}r(yB,"internalizeFont");var ee=class ee{static get spacebarTextMode(){return typeof this.spacebarTextModeSrc=="string"?this.spacebarTextModeSrc:this.spacebarTextModeSrc()}static set spacebarTextMode(e){this.spacebarTextModeSrc=e}constructor(e,t){if(typeof e!="string")if(e.KI||e.KL||e.KLC||e.KFont||e.KOskFont){let n=e;this.KI=n.KI,this.KN=n.KN,this.KL=n.KL,this.KLC=n.KLC,this.KFont=n.KFont,this.KOskFont=n.KOskFont,this._displayName=n instanceof ee?n._displayName:n.displayName}else{let n=e;n.languages||(n.languages=n.language),this.KI=n.id,this.KN=n.name,this.KL=n.languages.name,this.KLC=n.languages.id,this.KFont=yB(n.languages.font,t),this.KOskFont=yB(n.languages.oskFont,t)}else this.KI=e,this.KLC=t}static fromMultilanguageAPIStub(e){let t=[];e.languages||(e.languages=e.language);for(let n of e.languages){let s={id:e.id,name:e.name,languages:n};t.push(new ee(s))}return t}get id(){return this.KI}get name(){return this.KN}get langId(){return this.KLC}get langName(){return this.KL}get displayName(){if(this._displayName)return this._displayName;let e=this.KN,t=this.KL;switch(ee.spacebarTextMode){case xt.KEYBOARD:return e;case xt.LANGUAGE:return t;case xt.LANGUAGE_KEYBOARD:return e==t?t:t+" - "+e;case xt.BLANK:return"";default:return e}}set displayName(e){this._displayName=e}get textFont(){return this.KFont}get oskFont(){return this.KOskFont}validateForOSK(){return this.KLC?this.displayName===void 0||ee.spacebarTextMode!=xt.BLANK&&!this.displayName?new Error("A display name is missing for this keyboard and cannot be generated under current settings."):null:this.KI||this.KN?new Error(`No language code was specified for use with the ${this.KI||this.KN} keyboard`):new Error("No language code was specified for use with the corresponding keyboard")}validateForCustomKeyboard(){return!this.KI||!this.KN||!this.KL||!this.KLC?new Error("To use a custom keyboard, you must specify keyboard id, keyboard name, language and language code."):null}};r(ee,"KeyboardProperties"),ee.spacebarTextModeSrc=xt.KEYBOARD;var kt=ee;var be=class be{constructor(e,t){this.p=e,this.d=t,this.o=be.ordinalSeed++}match(e,t){var n=this.p==e&&this.d==t;return n}set(){this.matched=1}reset(){this.matched=0}before(e){return this.o<e.o}clone(){let e=new be(this.p,this.d);return e.o=this.o,e}equal(e){return this.d==e.d&&this.p==e.d&&this.o==e.o}};r(be,"Deadkey"),be.ordinalSeed=0,be.sortFunc=r(function(e,t){return e.p!=t.p?t.p-e.p:t.o-e.o},"sortFunc");var Wn=be,Ys=class Ys{constructor(){this.dks=[]}toSortedArray(){return this.dks=this.dks.sort(Wn.sortFunc),[].concat(this.dks)}clone(){let e=new Ys,t=this.toSortedArray();return e.dks=[],t.forEach(function(n){e.dks.push(n.clone())}),e}isMatch(e,t,n){if(this.dks.length==0)return!1;var s=e;t=s-t;for(var i=0;i<this.dks.length;i++)if(this.dks[i].match(t,n)&&!this.dks[i].matched)return this.dks[i].set(),!0;return this.resetMatched(),!1}add(e){this.dks=this.dks.concat(e)}remove(e){var t=this.dks.indexOf(e);this.dks.splice(t,1)}clear(){this.dks=[]}resetMatched(){for(let e of this.dks)e.reset()}deleteMatched(){for(var e=0;e<this.dks.length;e++)this.dks[e].matched&&this.dks.splice(e--,1)}adjustPositions(e,t){if(t!=0)for(let n of this.dks)n.p>e&&(n.p+=t)}equal(e){if(this.dks.length!=e.dks.length)return!1;let t=e.dks,n=[];for(let s of this.dks)if(!t.find(B=>s.equal(B)))return!1;return n.length==t.length}count(){return this.dks.length}};r(Ys,"DeadkeyTracker");var Ms=Ys;var IB=class IB{constructor(e){this.id=e}set(e){throw new Error("System store with ID "+this.id+" may not be directly set.")}};r(IB,"SystemStore");var Os=IB,hB=class hB extends Os{constructor(t,n){super(t);this.handler=null;this._value=n}get value(){return this._value}matches(t){return this._value==t}set(t){this.handler&&this.handler(this,t)||(this._value=t)}};r(hB,"MutableSystemStore");var Me=hB,bB=class bB extends Os{constructor(t){super(31);this.kbdInterface=t}matches(t){var n,s,i=t.split(" ");let B=this.kbdInterface.activeDevice;for(n=0;n<i.length;n++)switch(s=i[n].toLowerCase(),s){case"touch":case"hardware":if(B.touchable!=(s=="touch"))return!1;break;case"macos":case"mac":s="macosx";case"macosx":case"windows":case"android":case"ios":case"linux":if(B.OS!=s)return!1;break;case"tablet":case"phone":case"desktop":if(B.formFactor!=s)return!1;break;case"web":if(B.browser=="native")return!1;break;case"native":case"chrome":case"firefox":case"safari":case"edge":case"opera":if(B.browser!=s)return!1;break;default:return!1}return!0}};r(bB,"PlatformSystemStore");var ws=bB;function CB(Q,e,t){let n=Math.min(Q.length,e.length),s,i,B,c,l;for(t?(s=i=Q.length-1,B=i-n,c=-1,l=e.length-Q.length):(s=i=0,B=n,c=1,l=0);i!=B&&Q.charAt(i)==e.charAt(i+l);i+=c);if(i!=s&&i!=B){let a=Q.charCodeAt(i-c),F=Q.charCodeAt(i),o=e.charCodeAt(i+l),d=t?vs:Ws,U=t?Ws:vs;if(d(a)&&(U(F)||U(o)))return i-c}return i}r(CB,"findCommonSubstringEndIndex");Jn();function me(Q){var e;return Q?Q.insert===""&&Q.deleteLeft===0&&((e=Q.deleteRight)!=null?e:0)===0:!0}r(me,"isEmptyTransform");var vn=class vn{constructor(e,t,n,s){this.insert=e,this.deleteLeft=t,this.deleteRight=n,this.erasedSelection=s}};r(vn,"TextTransform"),vn.nil=new vn("",0,0,!1);var mB=vn,fn=class fn{constructor(e,t,n,s){let i=this.token=fn.tokenSeed++;this.keystroke=e,this.transform=t,this.alternates=s,this.preInput=n,this.transform.id=this.token,s&&s.forEach(function(B){B.sample.id=i})}};r(fn,"Transcription"),fn.tokenSeed=0;var xB=fn,GB=class GB{constructor(){this._dks=new Ms}get isSynthetic(){return!0}resetContext(){this.deadkeys().clear()}deadkeys(){return this._dks}hasDeadkeyMatch(e,t){return this.deadkeys().isMatch(this.getDeadkeyCaret(),e,t)}insertDeadkeyBeforeCaret(e){var t=new Wn(this.getDeadkeyCaret(),e);this.deadkeys().add(t)}adjustDeadkeys(e){this.deadkeys().adjustPositions(this.getDeadkeyCaret(),e)}setDeadkeys(e){this._dks=e.clone()}buildTransformFrom(e){let t=this.getTextBeforeCaret(),n=e.getTextBeforeCaret(),s=CB(n,t,!1),i=n.substring(s)._kmwLength(),B=t.substring(s),c=this.getTextAfterCaret(),l=e.getTextAfterCaret(),a=CB(l,c,!0),F=l.substring(0,a+1)._kmwLength();return new mB(B,i,F,e.getSelectedText()&&!this.getSelectedText())}buildTranscriptionFrom(e,t,n,s){let i=this.buildTransformFrom(e);return new xB(t,i,W.from(e,n),s)}restoreTo(e){this.clearSelection(),this.setTextBeforeCaret(e.getTextBeforeCaret()),this.setTextAfterCaret(e.getTextAfterCaret()),this._dks=e._dks.clone()}apply(e){this.clearSelection(),e.deleteRight&&this.setTextAfterCaret(this.getTextAfterCaret()._kmwSubstr(e.deleteRight)),e.deleteLeft&&this.deleteCharsBeforeCaret(e.deleteLeft),e.insert&&this.insertTextBeforeCaret(e.insert),this._dks.clear()}setTextBeforeCaret(e){this.deleteCharsBeforeCaret(this.getTextBeforeCaret()._kmwLength()),this.insertTextBeforeCaret(e)}saveProperties(){}restoreProperties(){}};r(GB,"OutputTarget");var Ce=GB,Ye=class Ye extends Ce{constructor(t,n,s){super();this.selForward=!0;this.text=t||"";var i=this.text._kmwLength();this.selStart=typeof n=="number"?n:i,this.selEnd=typeof s=="number"?s:this.selStart,this.selForward=this.selEnd>=this.selStart}static from(t,n){let s;if(t instanceof Ye){let i=t;s=new Ye(i.text,i.selStart,i.selEnd)}else{let i=t.getText(),B=i._kmwLength(),c=B,l=0;if(t.hasSelection()){let a=t.getTextBeforeCaret(),F=t.getTextAfterCaret();c=a._kmwLength(),l=B-F._kmwLength()}s=new Ye(i,c,l)}return s.setDeadkeys(t.deadkeys()),s}clearSelection(){this.text=this.getTextBeforeCaret()+this.getTextAfterCaret(),this.selEnd=this.selStart,this.selForward=!0}invalidateSelection(){}isSelectionEmpty(){return this.selStart==this.selEnd}hasSelection(){return!0}getDeadkeyCaret(){return this.selStart}setSelection(t,n){if(this.selStart=t,this.selEnd=typeof n=="number"?n:t,this.selForward=n>=t,!this.selForward){let s=this.selStart;this.selStart=this.selEnd,this.selEnd=s}}getTextBeforeCaret(){return this.text.kmwSubstr(0,this.selStart)}getSelectedText(){return this.text.kmwSubstr(this.selStart,this.selEnd-this.selStart)}getTextAfterCaret(){return this.text.kmwSubstr(this.selEnd)}getText(){return this.text}deleteCharsBeforeCaret(t){t>=0&&(t>this.selStart&&(t=this.selStart),this.adjustDeadkeys(-t),this.text=this.text.kmwSubstr(0,this.selStart-t)+this.text.kmwSubstr(this.selStart),this.selStart-=t,this.selEnd-=t)}insertTextBeforeCaret(t){this.adjustDeadkeys(t._kmwLength()),this.text=this.getTextBeforeCaret()+t+this.text.kmwSubstr(this.selStart),this.selStart+=t.kmwLength(),this.selEnd+=t.kmwLength()}handleNewlineAtCaret(){this.insertTextBeforeCaret(`
`)}setTextAfterCaret(t){this.text=this.getTextBeforeCaret()+t}isEqual(t){return this.text==t.text&&this.selStart==t.selStart&&this.selEnd==t.selEnd&&this.deadkeys().equal(t.deadkeys())}doInputEvent(){}};r(Ye,"Mock");var W=Ye;var pB=class pB{constructor(){this.transcription=null;this.setStore={};this.saveStore={};this.variableStores={};this.triggersDefaultCommand=!1}finalize(e,t,n){if(!this.transcription)throw"Cannot finalize a RuleBehavior with no transcription.";e.beepHandler&&this.beep&&e.beepHandler(t);for(let s in this.setStore){let i=e.keyboardInterface.systemStores[s];if(i)try{i.set(this.setStore[s])}catch(B){e.errorLogger&&e.errorLogger("Rule attempted to perform illegal operation - 'platform' may not be changed.")}else e.warningLogger&&e.warningLogger("Unknown store affected by keyboard rule: "+s)}if(e.keyboardInterface.applyVariableStores(this.variableStores),e.keyboardInterface.variableStoreSerializer)for(let s in this.saveStore)e.keyboardInterface.variableStoreSerializer.saveStore(e.activeKeyboard.id,s,this.saveStore[s]);if(this.triggersDefaultCommand){let s=this.transcription.keystroke;e.defaultRules.applyCommand(s,t)}e.warningLogger&&this.warningLog?e.warningLogger(this.warningLog):e.errorLogger&&this.errorLog&&e.errorLogger(this.errorLog)}mergeInDefaults(e){let t=this.transcription.keystroke,n=e.transcription.keystroke;if(t.Lcode!=n.Lcode||t.Lmodifiers!=n.Lmodifiers)throw"RuleBehavior default-merge not supported unless keystrokes are identical!";this.triggersDefaultCommand=this.triggersDefaultCommand||e.triggersDefaultCommand;let s=W.from(this.transcription.preInput,!1);s.apply(this.transcription.transform),s.apply(e.transcription.transform),this.transcription=s.buildTranscriptionFrom(this.transcription.preInput,t,!1,this.transcription.alternates)}};r(pB,"RuleBehavior");var tt=pB;var LB=class LB{};r(LB,"KeyInformation");var XB=LB;var EB=class EB{reset(){this._cache=[]}get(e,t){return typeof this._cache[e]=="undefined"||typeof this._cache[e][t]=="undefined"?null:this._cache[e][t]}set(e,t,n){typeof this._cache[e]=="undefined"&&(this._cache[e]=[]),this._cache[e][t]=n}};r(EB,"CachedContext");var SB=EB,zs=class zs{reset(){this._cache=[]}get(e,t){return typeof this._cache[e]=="undefined"||typeof this._cache[e][t]=="undefined"?null:this._cache[e][t]}set(e,t,n){typeof this._cache[e]=="undefined"&&(this._cache[e]=[]),this._cache[e][t]=n}clone(){let e=new zs;return e._cache=this._cache,e}};r(zs,"CachedContextEx");var VB=zs;var Tn=class Tn extends Ie{constructor(t,n,s=null){super(t,n);this.cachedContext=new SB;this.cachedContextEx=new VB;this._AnyIndices=[];this.systemStores={},this.systemStores[31]=new ws(this),this.systemStores[33]=new Me(33,"default"),this.systemStores[42]=new Me(42,""),this.systemStores[43]=new Me(43,""),this.variableStoreSerializer=s}get Codes(){return y}saveFocus(){}registerKeyboard(t){let n=new T(t);this.loadedKeyboard=n}context(t,n,s){var i=this.cachedContext.get(t,n);if(i!==null)return i;var B=this.KC_(t,n,s);return this.cachedContext.set(t,n,B),B}KC_(t,n,s){var i="";return i=s.isSelectionEmpty()?s.getTextBeforeCaret():"",i._kmwLength()<t&&(i=Array(t-i._kmwLength()+1).join("\uFFFE")+i),i._kmwSubstr(-t)._kmwSubstr(0,n)}nul(t,n){var s=this.context(t+1,1,n);return s==="\uFFFE"}contextMatch(t,n,s,i){var B=this.context(t,i,n);return B===s?!0:(n.deadkeys().resetMatched(),!1)}_BuildExtendedContext(t,n,s){var i=this.cachedContextEx.get(t,n);if(i!==null)return i;if(i=this.cachedContextEx.get(t,t),i===null){let d=s.deadkeys().toSortedArray();var B=0;for(i={valContext:[],deadContext:[]};i.valContext.length<t;){var c=s.getDeadkeyCaret(),l=c-B;if(d.length>0&&d[0].p>l){d.splice(0,1);continue}else if(d.length>0&&d[0].p==l)i.deadContext[t-i.valContext.length-1]=d[0],i.valContext=[d[0].d].concat(i.valContext),d.splice(0,1);else{var a=this.context(++B,1,s);i.valContext=[a].concat(i.valContext)}}this.cachedContextEx.set(t,t,i)}var F=i;F.valContext=F.valContext.slice(0,n);for(var o=0;o<F.valContext.length;o++)F.valContext[o]=="\uFFFE"&&(F.valContext.splice(0,1),F.deadContext.splice(0,1));return F.valContext.length==0&&(F.valContext=["\uFFFE"],F.deadContext=[]),this.cachedContextEx.set(t,n,F),F}fullContextMatch(t,n,s){var i=this._BuildExtendedContext(t,s.length,n);this.ruleContextEx=this.cachedContextEx.clone();var B=i.valContext,c=i.deadContext,l=!1;let a="\uFFFE";for(var F=r(function(C){throw new Error("Unexpected object in fullContextMatch specification: "+C)},"assertNever"),o=0;o<s.length;o++)if(typeof s[o]=="string"){var d=s[o];if(d!==B[o]){l=!0;break}}else{var U=s[o];switch(U.t){case"d":U.d!==B[o]?l=!0:c[o].set();break;case"a":var u;typeof B[o]=="string"?u=B[o]:u={t:"d",d:B[o]};var g=this.any(o,u,U.a);U.n?U.n&&(g||B[o]===a)&&(l=!0):g?c[o]!==void 0&&c[o].set():l=!0;break;case"i":var I=this._Index(U.i,U.o);I!==void 0&&(typeof I=="string"?I:I.d)!==B[o]?l=!0:c[o]!==void 0&&c[o].set();break;case"c":B[U.c-1]!==B[o]?l=!0:c[o]!==void 0&&c[o].set();break;case"n":B[o]!=a&&(l=!0);break;default:F(U)}}return l&&(n.deadkeys().resetMatched(),this._AnyIndices=[]),!l}isKeypress(t){return this.activeKeyboard.isMnemonic?!t.LisVirtualKey:!!q._USKeyCodeToCharCode(t)}static matchModifiersToRuleChirality(t,n){let s=y.modifierCodes.LALT|y.modifierCodes.RALT,i=y.modifierCodes.LCTRL|y.modifierCodes.RCTRL,B=t;if(!(n&s)){let c=B&s;c&&(B^=c|y.modifierCodes.ALT)}if(!(n&i)){let c=B&i;c&&(B^=c|y.modifierCodes.CTRL)}return B}keyMatch(t,n,s){var i=!1,B=t.Lcode==173?189:t.Lcode;let c=this.activeKeyboard.modifierBitmask;var l=c&y.modifierBitmasks.ALL,a=c&y.stateBitmasks.ALL;let F=Tn.matchModifiersToRuleChirality(t.Lmodifiers,n);return t.vkCode>255&&(B=t.vkCode),t.LisVirtualKey||B>255?((n&16384)==16384||B>255)&&(i=s==B&&(n&l)==F,i=i&&this.stateMatch(t,n&a)):n&16384||(i=B==s),i||this.activeTargetOutput.deadkeys().resetMatched(),i}stateMatch(t,n){return(n&t.Lstates)==n}keyInformation(t){var n=new XB;return n.vk=t.LisVirtualKey,n.code=t.Lcode,n.modifiers=t.Lmodifiers,n}deadkeyMatch(t,n,s){return n.hasDeadkeyMatch(t,s)}beep(t){this.resetContextCache(),this.ruleBehavior.beep=!0}_ExplodeStore(t){if(typeof t=="string"){let i=this.activeKeyboard.explodedStores;if(i[t])return i[t];for(var n=[],s=0;s<t._kmwLength();s++)n.push(t._kmwCharAt(s));return i[t]=n,n}else return t}any(t,n,s){if(n=="")return!1;s=this._ExplodeStore(s);for(var i=-1,B=0;B<s.length;B++){let c=s[B];if(typeof c=="string"){if(s[B]==n){i=B;break}}else if(c.d===n.d){i=B;break}}return this._AnyIndices[t]=i,i>=0}_Index(t,n){return t=this._ExplodeStore(t),this._AnyIndices[n-1]<t.length?t[this._AnyIndices[n-1]]:(console.warn("Unmatched contextual index() statement detected in rule with index "+n+"!"),"")}indexOutput(t,n,s,i){this.resetContextCache();var B=r(function(l){throw new Error("Unexpected object in fullContextMatch specification: "+l)},"assertNever"),c=this._Index(n,s);if(c!=="")if(typeof c=="string")this.output(t,i,c);else if(c.t)switch(c.t){case"b":this.beep(i);break;case"d":this.deadkeyOutput(t,i,c.d);break;default:B(c)}else this.deadkeyOutput(t,i,c.d)}deleteContext(t,n){var s;if(t>0){s=this._BuildExtendedContext(t,t,n);let c=0;for(var i=0;i<s.valContext.length;i++){var B=s.deadContext[i];B?(n.deadkeys().remove(B),t--):s.valContext[i]=="\uFFFE"&&c++}let l=s.valContext.length-c;t>l&&(t=l)}n.deadkeys().resetMatched(),this.output(t,n,"")}output(t,n,s){this.resetContextCache(),n.saveProperties(),n.clearSelection(),n.deadkeys().deleteMatched(),t>=0&&n.deleteCharsBeforeCaret(t),n.insertTextBeforeCaret(s),n.restoreProperties()}contextExOutput(t,n,s,i){this.resetContextCache(),t>=0&&this.output(t,n,"");let B=this.ruleContextEx.get(s,s),c=B.deadContext[i-1],l=B.valContext[i-1];if(c)n.insertDeadkeyBeforeCaret(c.d);else if(typeof l=="string")this.output(-1,n,l);else throw new Error("contextExOutput: should never be a numeric valContext with no corresponding deadContext")}deadkeyOutput(t,n,s){this.resetContextCache(),t>=0&&this.output(t,n,""),n.insertDeadkeyBeforeCaret(s)}ifStore(t,n,s){var i=!0;let B=this.systemStores[t];return B&&(i=B.matches(n)),i}setStore(t,n,s){return this.resetContextCache(),t==33&&this.activeDevice.touchable?(this.ruleBehavior.setStore[t]=n,!0):!1}loadStore(t,n,s){return this.resetContextCache(),this.variableStoreSerializer&&this.variableStoreSerializer.loadStore(t,n)[n]||s}saveStore(t,n){this.resetContextCache();var s=this.activeKeyboard;if(!s||typeof s.id=="undefined"||s.id=="")return!1;let i={};return i[t]=n,this.ruleBehavior?this.ruleBehavior.saveStore[t]=i:this.variableStoreSerializer.saveStore(this.activeKeyboard.id,t,i),!0}resetContextCache(){this.cachedContext.reset(),this.cachedContextEx.reset()}defaultBackspace(t){t.isSelectionEmpty()?this.output(1,t,""):this.output(0,t,"")}processNewContextEvent(t,n){if(!this.activeKeyboard)throw"No active keyboard for keystroke processing!";return this.process(this.activeKeyboard.processNewContextEvent.bind(this.activeKeyboard),t,n,!0)}processPostKeystroke(t,n){if(!this.activeKeyboard)throw"No active keyboard for keystroke processing!";return this.process(this.activeKeyboard.processPostKeystroke.bind(this.activeKeyboard),t,n,!0)}processKeystroke(t,n){if(!this.activeKeyboard)throw"No active keyboard for keystroke processing!";return this.process(this.activeKeyboard.process.bind(this.activeKeyboard),t,n,!1)}process(t,n,s,i){if(n)if(this.activeKeyboard){if(!t)throw"No callee for keystroke processing!"}else throw"No active keyboard for keystroke processing!";else throw"No target specified for keyboard output!";n.invalidateSelection(),n.deadkeys().resetMatched(),this.resetContextCache();let B=W.from(n,!0),c=this.activeKeyboard.variableStores;this.ruleBehavior=new tt,this.activeDevice=s.device,this.activeTargetOutput=n;var l=t(n,s);this.activeTargetOutput=null,this.ruleBehavior.transcription=n.buildTranscriptionFrom(B,s,i),this.ruleBehavior.variableStores=this.activeKeyboard.variableStores,this.activeKeyboard.variableStores=c,this.ruleBehavior.triggerKeyDefault=!l;let a=this.ruleBehavior;return this.ruleBehavior=null,a}applyVariableStores(t){this.activeKeyboard.variableStores=t}static __publishShorthandAPI(){let t=this.prototype;var n=r(function(s,i){t[i]&&(t[s]=t[i])},"exportKBCallback");n("KSF","saveFocus"),n("KBR","beepReset"),n("KT","insertText"),n("KR","registerKeyboard"),n("KRS","registerStub"),n("KC","context"),n("KN","nul"),n("KCM","contextMatch"),n("KFCM","fullContextMatch"),n("KIK","isKeypress"),n("KKM","keyMatch"),n("KSM","stateMatch"),n("KKI","keyInformation"),n("KDM","deadkeyMatch"),n("KB","beep"),n("KA","any"),n("KDC","deleteContext"),n("KO","output"),n("KDO","deadkeyOutput"),n("KCXO","contextExOutput"),n("KIO","indexOutput"),n("KIFS","ifStore"),n("KSETS","setStore"),n("KLOAD","loadStore"),n("KSAVE","saveStore")}};r(Tn,"KeyboardInterface"),Tn.GLOBAL_NAME="KeymanWeb";var Nt=Tn;(function(){Nt.__publishShorthandAPI()})();var xe=class xe extends X.default{constructor(t,n){super();this.stateKeys={K_CAPS:!1,K_NUMLOCK:!1,K_SCROLL:!1};this.modStateFlags=0;n||(n=xe.DEFAULT_OPTIONS),this.contextDevice=t,this.baseLayout=n.baseLayout||xe.DEFAULT_OPTIONS.baseLayout,this.keyboardInterface=n.keyboardInterface||new Nt(We(),An),this.defaultRules=n.defaultOutputRules||xe.DEFAULT_OPTIONS.defaultOutputRules}get activeKeyboard(){return this.keyboardInterface.activeKeyboard}set activeKeyboard(t){this.keyboardInterface.activeKeyboard=t,this.resetContext()}get layerStore(){return this.keyboardInterface.systemStores[33]}get newLayerStore(){return this.keyboardInterface.systemStores[42]}get oldLayerStore(){return this.keyboardInterface.systemStores[43]}get layerId(){return this.layerStore.value}set layerId(t){this.layerStore.set(t)}defaultRuleBehavior(t,n,s){let i=W.from(n,s),B=new tt,c=!1;var l="",a;if(t.isSynthetic||n.isSynthetic)if(c=!0,this.defaultRules.isCommand(t))B.triggersDefaultCommand=!0;else if((a=this.defaultRules.forSpecialEmulation(t))!=null)switch(a){case"\b":this.keyboardInterface.defaultBackspace(n);break;case`
`:n.handleNewlineAtCaret();break;default:B.errorLog="Unexpected 'special emulation' character (\\u"+a.kmwCharCodeAt(0).toString(16)+") went unhandled!"}else c=!1;let F=this.activeKeyboard&&this.activeKeyboard.isMnemonic;if(!c)if((l=this.defaultRules.forAny(t,F))!=null)if(a=this.defaultRules.forSpecialEmulation(t),a=="\b")this.keyboardInterface.defaultBackspace(n);else{if(a||this.defaultRules.isCommand(t))return null;this.keyboardInterface.output(0,n,l)}else return null;if(B.errorLog)return B;let o=n.buildTranscriptionFrom(i,t,s);return B.transcription=o,B}processNewContextEvent(t,n){return this.activeKeyboard?this.keyboardInterface.processNewContextEvent(n,this.activeKeyboard.constructNullKeyEvent(t,this.stateKeys)):null}processPostKeystroke(t,n){return this.activeKeyboard?this.keyboardInterface.processPostKeystroke(n,this.activeKeyboard.constructNullKeyEvent(t,this.stateKeys)):null}processKeystroke(t,n){var s;let i=n.getTextBeforeCaret().kmwLength()==0&&n.isSelectionEmpty();if(this.activeKeyboard&&t.Lcode!=0&&(s=this.keyboardInterface.processKeystroke(n,t)),i&&t.Lcode==y.keyCodes.K_BKSP&&s.triggerKeyDefault)s=this.defaultRuleBehavior(t,n,!1),s.triggerKeyDefault=!0,s.transcription.transform.deleteLeft=1;else if(!s||s.triggerKeyDefault){t.Lcode=t.vkCode||t.Lcode,this.keyboardInterface.activeTargetOutput=n;let B=this.defaultRuleBehavior(t,n,!1);B&&(s?s.mergeInDefaults(B):s=B,s.triggerKeyDefault=!1),this.keyboardInterface.activeTargetOutput=null}return s}_UpdateVKShift(t){let n=0,s=["CAPS","NUM_LOCK","SCROLL_LOCK"],i=["K_CAPS","K_NUMLOCK","K_SCROLL"];if(!this.activeKeyboard)return!0;if(t){n=t.Lmodifiers,this.activeKeyboard.isChiral&&this.activeKeyboard.emulatesAltGr&&(this.modStateFlags&y.modifierBitmasks.ALT_GR_SIM)==y.modifierBitmasks.ALT_GR_SIM&&(n|=y.modifierBitmasks.ALT_GR_SIM,n&=~y.modifierCodes.RALT);let B=!1;for(let c=0;c<s.length;c++)t.Lstates&y.stateBitmasks[s[c]]&&(this.stateKeys[i[c]]=!!(t.Lstates&y.modifierCodes[s[c]]),B=!0);B&&this.emit("statekeychange",this.stateKeys)}return this.updateStates(),this.activeKeyboard.isMnemonic&&this.stateKeys.K_CAPS&&(!t||!t.isModifier)&&(n^=y.modifierCodes.SHIFT),this.layerId=this.getLayerId(n),!0}updateStates(){var t=["CAPS","NUM_LOCK","SCROLL_LOCK"],n=["K_CAPS","K_NUMLOCK","K_SCROLL"];for(let s=0;s<n.length;s++){let i=n[s],B=this.stateKeys[i],c=t[s],l="NO_"+t[s];B?(this.modStateFlags|=y.modifierCodes[c],this.modStateFlags&=~y.modifierCodes[l]):(this.modStateFlags&=~y.modifierCodes[c],this.modStateFlags|=y.modifierCodes[l])}}getLayerId(t){return f.getLayerId(t)}selectLayer(t){let n=t.kName;var s=t.kNextLayer,i=this.activeKeyboard&&this.activeKeyboard.isChiral;if(typeof s=="number"&&(s=this.getLayerId(s*16)),!s)switch(n){case"K_LSHIFT":case"K_RSHIFT":case"K_SHIFT":s="shift";break;case"K_LCONTROL":case"K_LCTRL":if(i){s="leftctrl";break}case"K_RCONTROL":case"K_RCTRL":if(i){s="rightctrl";break}case"K_CTRL":s="ctrl";break;case"K_LMENU":case"K_LALT":if(i){s="leftalt";break}case"K_RMENU":case"K_RALT":if(i){s="rightalt";break}case"K_ALT":s="alt";break;case"K_ALTGR":i?s="leftctrl-rightalt":s="ctrl-alt";break;case"K_CURRENCIES":case"K_NUMERALS":case"K_SHIFTED":case"K_UPPER":case"K_LOWER":case"K_SYMBOLS":s="default";break}return s?(this.updateLayer(t,s),!0):!1}updateLayer(t,n){let s=this.layerId;var i=s;if(n==s&&t.device.formFactor!=S.FormFactor.Desktop)return;var B=n,c;if(t.device.formFactor==S.FormFactor.Desktop){var l=["leftctrl","rightctrl","ctrl","leftalt","rightalt","alt","shift"];for(c=0;c<l.length;c++)B=B.replace(l[c]+"-",""),B=B.replace(l[c],"");if(s=="default"||s=="numeric"||s=="symbol"||s=="currency"||B!="")i=n;else{var a=y.getModifierState(i);for(c=0;c<l.length;c++)i=i.replace(l[c]+"-",""),i=i.replace(l[c],"");switch(n){case"shift":a^=y.modifierCodes.SHIFT;break;case"leftctrl":a^=y.modifierCodes.LCTRL;break;case"rightctrl":a^=y.modifierCodes.RCTRL;break;case"ctrl":a^=y.modifierCodes.CTRL;break;case"leftalt":a^=y.modifierCodes.LALT;break;case"rightalt":a^=y.modifierCodes.RALT;break;case"alt":a^=y.modifierCodes.ALT;break;default:i=n}i!="default"&&(i==""?i=this.getLayerId(a):i=this.getLayerId(a)+"-"+i)}i==""&&(i="default")}else i=n;this.activeKeyboard.layout(t.device.formFactor).getLayer(i)?this.layerId=i:this.layerId="default";let o=y.getModifierState(this.layerId);this.modStateFlags=o|t.Lstates}doModifierPress(t,n,s){return this.activeKeyboard?t.isModifier?(this.activeKeyboard.notify(t.Lcode,n,s?1:0),t.device.touchable?!0:this._UpdateVKShift(t)):(t.LmodifierChange&&(this.activeKeyboard.notify(0,n,1),t.device.touchable||this._UpdateVKShift(t)),!1):!1}performNewContextEvent(t){let n=this.processNewContextEvent(this.contextDevice,t);return n&&n.finalize(this,t,!0),n}resetContext(t){this.layerId="default",t==null||t.resetContext(),this.keyboardInterface.resetContextCache(),t&&this.performNewContextEvent(t),this.contextDevice.touchable||this._UpdateVKShift(null)}setNumericLayer(t){this.activeKeyboard&&this.activeKeyboard.layout(t.formFactor).getLayer("numeric")&&(this.layerId="numeric")}};r(xe,"KeyboardProcessor"),xe.DEFAULT_OPTIONS={baseLayout:"us",defaultOutputRules:new Lt};var Oe=xe;var gr=r(Q=>Q.substring(Q.length-1)!="/"?Q+"/":Q,"addDelimiter"),ZB=class ZB{constructor(e,t){t=gr(t),this.sourcePath=t,this.protocol=t.replace(/(.{3,5}:)(.*)/,"$1"),this.updateFromOptions(e)}updateFromOptions(e){let t=this.sourcePath.replace(/(https?:\/\/)([^\/]*)(.*)/,"$1$2/");this._root=t,e.root!=""?this._root=this.fixPath(e.root):this._root=this.fixPath(t);let n=e.resources;n==""&&(n=this.sourcePath),this._resources=this.fixPath(n),this._keyboards=this.fixPath(e.keyboards),this._fonts=this.fixPath(e.fonts)}fixPath(e){return e.length==0||(e=gr(e),e.replace(/^(http)s?:.*/,"$1")=="http"||e.replace(/^(file):.*/,"$1")=="file")?e:e.substring(0,2)=="//"?this.protocol+e:e.substring(0,1)=="/"?this.root+e.substring(1):this.sourcePath+e}get fonts(){return this._fonts}updateFontPath(e){this._fonts=this.fixPath(e)}get root(){return this._root}get resources(){return this._resources}get keyboards(){return this._keyboards}};r(ZB,"PathConfiguration");var we=ZB;var JB={root:"",resources:"",keyboards:"",fonts:""};var Ds=class Ds{constructor(e){e.OS==S.OperatingSystem.Android?this.popupCanvasBackgroundColor="#999":this.popupCanvasBackgroundColor=Ds.prefersDarkMode()?"#0f1319":"#ffffff"}static prefersDarkMode(){return window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches}};r(Ds,"StyleConstants");var kn=Ds;var RB=class RB{constructor(){this.touchable="ontouchstart"in window,this.OS="",this.formFactor="desktop",this.browser="",this.dyPortrait=0,this.dyLandscape=0,this.version="0",this.orientation=window.orientation}getDPI(){var e=document.createElement("DIV"),t=e.style,n=96;return document.readyState!=="complete"||(e.id="calculateDPI",t.position="absolute",t.display="block",t.visibility="hidden",t.left="10px",t.top="10px",t.width="1in",t.height="10px",document.body.appendChild(e),n=typeof window.devicePixelRatio=="undefined"?e.offsetWidth:e.offsetWidth*window.devicePixelRatio,document.body.removeChild(e)),n}detect(){var e=!1;if(navigator&&navigator.userAgent){var t=navigator.userAgent;if(t.indexOf("iPad")>=0)this.OS="iOS",this.formFactor="tablet",this.dyPortrait=this.dyLandscape=0;else if(t.indexOf("iPhone")>=0)this.OS="iOS",this.formFactor="phone",this.dyPortrait=this.dyLandscape=25;else if(t.indexOf("Android")>=0){this.OS="Android",this.formFactor="phone",this.dyPortrait=75,this.dyLandscape=25;try{var n=new RegExp("(?:Android\\s+)(\\d+\\.\\d+\\.\\d+)");this.version=t.match(n)[1]}catch(a){}}else if(t.indexOf("Linux")>=0)this.OS="Linux";else if(t.indexOf("Macintosh")>=0){let F=/Intel Mac OS X (\d+(?:[_\.]\d+)+)/i.exec(t);if(!F)console.warn("KMW could not properly parse the user agent string.A suboptimal keyboard layout may result."),this.OS="MacOSX";else if(F.length>1&&F[1]){let o=F[1].replace("_","."),d=new N(o);e=N.MAC_POSSIBLE_IPAD_ALIAS.compareTo(d)<=0,this.OS="MacOSX"}}else t.indexOf("Windows NT")>=0&&(this.OS="Windows",t.indexOf("Touch")>=0&&(this.formFactor="phone"),typeof navigator.msMaxTouchPoints=="number"&&navigator.msMaxTouchPoints>0&&(this.touchable=!0))}let s=Math.min(screen.width,screen.height),i=Math.max(screen.width,screen.height),B=s/i;this.OS!="iOS"&&this.formFactor=="phone"&&(s>=600&&B>.5625||B>=.625)&&(this.formFactor="tablet");let c=navigator.platform=="Win32"||navigator.platform=="MacIntel";this.OS=="iOS"&&!("ongesturestart"in window)&&!c&&(this.OS="Android"),this.browser="web",(this.OS=="iOS"||this.OS.toLowerCase()=="macosx")&&(this.browser="safari");var l=/Firefox|Chrome|OPR|Safari|Edge/;if(l.test(navigator.userAgent)&&(navigator.userAgent.indexOf("Firefox")>=0&&"onmozorientationchange"in screen?this.browser="firefox":navigator.userAgent.indexOf("OPR")>=0?this.browser="opera":navigator.userAgent.indexOf(" Edge/")>=0?this.browser="edge":navigator.userAgent.indexOf("Chrome")>=0?this.browser="chrome":navigator.userAgent.indexOf("Safari")>=0&&(this.browser="safari")),e&&this.browser=="safari"&&window.TouchEvent){this.OS="iOS",this.formFactor="tablet",this.dyPortrait=this.dyLandscape=0;let a=screen.height/screen.width;a<1&&(a=1/a),a>1.6&&(this.formFactor="phone",this.dyPortrait=this.dyLandscape=25)}return this.colorScheme=kn.prefersDarkMode()?"dark":"light",this.coreSpec}get coreSpec(){return new S(this.browser,this.formFactor,this.OS,this.touchable)}};r(RB,"Device");var ze=RB;var HB=class HB extends X.default{constructor(t,n){super();this.applyCacheBusting=!1;if(!n){let s=new ze;s.detect(),n=s.coreSpec}this.sourcePath=t,this.hostDevice=n,this.deferForInitialization=new E}initialize(t){this._paths?this._paths.updateFromOptions(t):this._paths=new we(t,this.sourcePath),typeof t.setActiveOnRegister=="boolean"?this.activateFirstKeyboard=t.setActiveOnRegister:this.activateFirstKeyboard=!0,this._spacebarText=t.spacebarText,kt.spacebarTextMode=()=>this.spacebarText}finalizeInit(){this.deferForInitialization.resolve()}get paths(){return this._paths}get spacebarText(){return this._spacebarText}set spacebarText(t){this._spacebarText!=t&&(this._spacebarText=t,this.emit("spacebartext",t))}get softDevice(){return this.hostDevice}get hardDevice(){return nB(this.hostDevice)}get stubNamespacer(){return this._stubNamespacer}set stubNamespacer(t){this._stubNamespacer=t}debugReport(){return{hostDevice:this.hostDevice,initialized:this.deferForInitialization.isResolved}}onRuleFinalization(t,n){}};r(HB,"EngineConfiguration");var Nn=HB,AB=h({setActiveOnRegister:!0,spacebarText:xt.LANGUAGE_KEYBOARD},JB);var Mn=class Mn extends X.default{constructor(t){super();this.pendingActivations=[];this.engineConfig=t}get predictionContext(){return this._predictionContext}configure(t){this._resetContext=t.resetContext,this._predictionContext=t.predictionContext,this.keyboardCache=t.keyboardCache}insertText(t,n,s){let i=this.activeTarget;return i!=null?(n!=null&&t.output(0,i,n),typeof s!="undefined"&&s!==null&&t.deadkeyOutput(0,i,s),i.invalidateSelection(),!0):!1}resetContext(){this._resetContext(this.activeTarget),this.predictionContext.resetContext()}findAndPopActivation(t){let n;for(n=0;n<this.pendingActivations.length&&this.pendingActivations[n].target!=t;n++);return n==this.pendingActivations.length?null:this.pendingActivations.splice(n,1)[0]}deferredKeyboardActivation(t,n,s){return L(this,null,function*(){let i={target:s,keyboard:t,stub:n};this.findAndPopActivation(s),this.pendingActivations.push(i),yield t;let B=this.findAndPopActivation(s);return B==i?i:(B&&this.pendingActivations.push(B),null)})}activateKeyboard(t,n,s){return L(this,null,function*(){let i=!this.activeKeyboard;this.findAndPopActivation(this.currentKeyboardSrcTarget());let B=this.prepareKeyboardForActivation(t,n),c=this.currentKeyboardSrcTarget(),l=yield B.keyboard;if(l==null&&B.metadata)return!1;this.currentKeyboardSrcTarget()==c&&this.emit("beforekeyboardchange",B.metadata);let a=null;return l&&(a={keyboard:l,metadata:B.metadata}),this.activateKeyboardForTarget(a,c),this.currentKeyboardSrcTarget()==c&&(!i||l)&&this.emit("keyboardchange",this.activeKeyboard),!0})}prepareKeyboardForActivation(t,n){var B;n||(n="");let s=null;if(t?s=this.keyboardCache.getStub(t,n):n=="",!s){if(t)throw new Error("No matching stub has been registered.");return{keyboard:Promise.resolve(null),metadata:null}}if((B=this.activeKeyboard)!=null&&B.metadata&&t==this.activeKeyboard.metadata.id){let c=this.activeKeyboard.keyboard;return{keyboard:Promise.resolve(c),metadata:s}}let i;if(i=this.keyboardCache.getKeyboardForStub(s))return{keyboard:Promise.resolve(i),metadata:s};{this.emit("beforekeyboardchange",s);let c=this.engineConfig.deferForInitialization.then(()=>{let a=new E;this.emit("keyboardasyncload",s,a.corePromise);let F=this.keyboardCache.fetchKeyboardForStub(s),o=new Promise((U,u)=>{let g=`Sorry, the ${s.name} keyboard for ${s.langName} is not currently available.`;window.setTimeout(()=>u(new Error(g)),Mn.TIMEOUT_THRESHOLD)}),d=Promise.race([F,o]);return d.then(()=>{a.resolve(null),o.catch(()=>{})}),d.catch(U=>{throw a.resolve(U),U}),d});return{keyboard:this.deferredKeyboardActivation(c,s,this.currentKeyboardSrcTarget()).then(a=>L(this,null,function*(){return a?c:Promise.resolve(null)})),metadata:s}}}};r(Mn,"ContextManagerBase"),Mn.TIMEOUT_THRESHOLD=1e4;var Yn=Mn;var vB=class vB extends X.default{};r(vB,"HardKeyboard");var De=vB;function WB(Q,e,t){let n=y.modifierCodes;if(e&&e.isMnemonic&&Q.setMnemonicCode(!!(Q.Lmodifiers&n.SHIFT),!!(Q.Lmodifiers&n.CAPS)),e&&!e.isMnemonic){var s=q.languageMap[t];s&&s["k"+Q.Lcode]&&(Q.Lcode=s["k"+Q.Lcode]),!e.definesPositionalOrMnemonic&&!(Q.Lmodifiers&y.modifierBitmasks.NON_LEGACY)&&!Q.isModifier&&(Q=new _({Lcode:q._USKeyCodeToCharCode(Q),Lmodifiers:0,LisVirtualKey:!1,vkCode:Q.Lcode,Lstates:Q.Lstates,kName:"",device:Q.device,isSynthetic:!1}))}return Q}r(WB,"processForMnemonicsAndLegacy");function Ks(Q,e){let t=new Map;return e.keys.forEach(n=>{let s=Math.abs(Q.x-n.centerX),i=Math.abs(Q.y-n.centerY),B,c;s>.5*n.width?(B=s-.5*n.width,s=.5):(B=0,s/=n.width),i>.5*n.height?(c=i-.5*n.height,i=.5):(c=0,i/=n.height),B*=e.kbdScaleRatio,B+=s*n.height,c+=i*n.height;let l=B*B+c*c;t.set(n.keySpec,l)}),t}r(Ks,"keyTouchDistances");function ne(Q){var s;let e=new Map,t=0;Array.isArray(Q)||(Q=[Q]);for(let i of Q)for(let B of i.keys()){let c=1/(Math.pow(i.get(B),2)+3e-5);t+=c,e.set(B,(s=e.get(B))!=null?s:0+c)}let n=[];for(let i of e.keys())n.push({keySpec:i,p:e.get(i)/t});return n.sort(function(i,B){return B.p-i.p})}r(ne,"distributionFromDistanceMaps");var TB=class TB{constructor(e,t,n){this.keySpec=n,this.centerX=n.proportionalX,this.centerY=t.proportionalY,this.width=n.proportionalWidth,this.height=e.rowProportionalHeight}};r(TB,"CorrectiveBaseKeyLayout");var fB=TB;function yQ(Q){return Q.baseKeyID?y.isFrameKey(Q.baseKeyID)?!1:!Q.isPadding:!1}r(yQ,"correctionKeyFilter");function ur(Q,e){return{keys:Q.row.map(t=>t.key.map(n=>new fB(Q,t,n))).reduce((t,n)=>t.concat(n),[]).filter(t=>yQ(t.keySpec)),kbdScaleRatio:e}}r(ur,"buildCorrectiveLayout");var Ps=class Ps{constructor(e,t,n){this.left=e.getTextBeforeCaret(),this.startOfBuffer=this.left._kmwLength()<=t.leftContextCodePoints,this.startOfBuffer||(this.left=this.left._kmwSubstr(-t.leftContextCodePoints)),this.right=e.getTextAfterCaret(),this.endOfBuffer=this.right._kmwLength()<=t.rightContextCodePoints,this.endOfBuffer||(this.right=this.right._kmwSubstr(0,t.rightContextCodePoints)),this.casingForm=n=="shift"?"initial":n=="caps"?"upper":null}toMock(){let e=this.left._kmwLength();return new W(this.left+(this.right||""),e)}};r(Ps,"ContextWindow"),Ps.ENGINE_RULE_WINDOW={leftContextCodePoints:64,rightContextCodePoints:32};var Ut=Ps;var kB=class kB{constructor(){this._promises=new Map}get length(){return this._promises.size}make(e,t,n){if(this._promises.has(e))return n(`Existing request with token ${e}`);this._promises.set(e,{reject:n,resolve:t})}keep(e,t){let n=this._promises.get(e);if(!n)throw new Error(`No promise associated with token: ${e}`);let s=n.resolve;return this._promises.delete(e),s(t)}break(e,t){let n=this._promises.get(e);if(!n)throw new Error(`No promise associated with token: ${e}`);this._promises.delete(e),n.reject(t)}};r(kB,"PromiseStore");var se=kB;var NB=class NB{constructor(e,t,n){this._worker=t,this._worker.onmessage=this.onMessage.bind(this),this._declareLMLayerReady=null,this._predictPromises=new se,this._wordbreakPromises=new se,this._acceptPromises=new se,this._revertPromises=new se,this._nextToken=Number.MIN_SAFE_INTEGER,this.sendConfig(e,!!n)}sendConfig(e,t){this._worker.postMessage({message:"config",capabilities:e,testMode:t})}loadModel(e,t="file"){return new Promise((n,s)=>{this._declareLMLayerReady=n;let i={type:t};t=="file"?i.file=e:i.code=e,this._worker.postMessage({message:"load",source:i})})}unloadModel(){this._worker.postMessage({message:"unload"})}predict(e,t){let n=this._nextToken++;return new Promise((s,i)=>{this._predictPromises.make(n,s,i),this._worker.postMessage({message:"predict",token:n,transform:e,context:t})})}wordbreak(e){let t=this._nextToken++;return new Promise((n,s)=>{this._wordbreakPromises.make(t,n,s),this._worker.postMessage({message:"wordbreak",token:t,context:e})})}acceptSuggestion(e,t,n){let s=this._nextToken++;return new Promise((i,B)=>{this._acceptPromises.make(s,i,B),this._worker.postMessage({message:"accept",token:s,suggestion:e,context:t,postTransform:n})})}revertSuggestion(e,t){let n=this._nextToken++;return new Promise((s,i)=>{this._revertPromises.make(n,s,i),this._worker.postMessage({message:"revert",token:n,reversion:e,context:t})})}resetContext(e){this._worker.postMessage({message:"reset-context",context:e})}onMessage(e){let t=e.data;if(t.message==="error")console.error(t.log),t.error&&console.error(t.error);else if(t.message==="ready")this._declareLMLayerReady(e.data.configuration);else if(t.message==="suggestions")this._predictPromises.keep(t.token,t.suggestions);else if(t.message==="currentword")this._wordbreakPromises.keep(t.token,t.word);else if(t.message==="postaccept")this._acceptPromises.keep(t.token,t.reversion);else if(t.message==="postrevert")this._revertPromises.keep(t.token,t.suggestions);else throw new Error(`Message not implemented: ${t.message}`)}shutdown(){this._worker.terminate()}};r(NB,"LMLayer");var Ke=NB;function js(Q){return Q}r(js,"unwrap");var yr=`"use strict";(()=>{var vr=Object.defineProperty,Te=Object.defineProperties;var be=Object.getOwnPropertyDescriptors;var We=Object.getOwnPropertySymbols;var we=Object.prototype.hasOwnProperty,ve=Object.prototype.propertyIsEnumerable;var ce=(i,r)=>{if(r=Symbol[i])return r;throw Error("Symbol."+i+" is not defined")};var Ae=(i,r,e)=>r in i?vr(i,r,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[r]=e,v=(i,r)=>{for(var e in r||(r={}))we.call(r,e)&&Ae(i,e,r[e]);if(We)for(var e of We(r))ve.call(r,e)&&Ae(i,e,r[e]);return i},Nr=(i,r)=>Te(i,be(r)),x=(i,r)=>vr(i,"name",{value:r,configurable:!0});var Mr=(i,r)=>{for(var e in r)vr(i,e,{get:r[e],enumerable:!0})};var V=(i,r,e)=>new Promise((t,o)=>{var a=p=>{try{d(e.next(p))}catch(s){o(s)}},n=p=>{try{d(e.throw(p))}catch(s){o(s)}},d=p=>p.done?t(p.value):Promise.resolve(p.value).then(a,n);d((e=e.apply(i,r)).next())}),cr=function(i,r){this[0]=i,this[1]=r},me=(i,r,e)=>{var t=(n,d,p,s)=>{try{var l=e[n](d),B=(d=l.value)instanceof cr,h=l.done;Promise.resolve(B?d[0]:d).then(k=>B?t(n==="return"?n:"next",d[1]?{done:k.done,value:k.value}:k,p,s):p({value:k,done:h})).catch(k=>t("throw",k,p,s))}catch(k){s(k)}},o=n=>a[n]=d=>new Promise((p,s)=>t(n,d,p,s)),a={};return e=e.apply(i,r),a[Symbol.asyncIterator]=()=>a,o("next"),o("throw"),o("return"),a};var fe=(i,r,e)=>(r=i[ce("asyncIterator")])?r.call(i):(i=i[ce("iterator")](),r={},e=(t,o)=>(o=i[t])&&(r[t]=a=>new Promise((n,d,p)=>(a=o.call(i,a),p=a.done,Promise.resolve(a.value).then(s=>n({value:s,done:p}),d)))),e("next"),e("return"),r);function N(){String.kmwFromCharCode=function(i){var r=[],e;for(e=0;e<arguments.length;e++){var t=Number(arguments[e]);if(!isFinite(t)||t<0||t>1114111||Math.floor(t)!==t)throw new RangeError("Invalid code point "+t);t<65536?r.push(t):(t-=65536,r.push((t>>10)+55296),r.push(t%1024+56320))}return String.fromCharCode.apply(void 0,r)},String.prototype.kmwCharCodeAt=function(i){var r=String(this),e=0;if(i<0||i>=r.length)return NaN;for(var t=0;t<i;t++)if(e=r.kmwNextChar(e),e===null)return NaN;var o=r.charCodeAt(e);if(o>=55296&&o<=56319&&r.length>e+1){var a=r.charCodeAt(e+1);if(a>=56320&&a<=57343)return(o-55296<<10)+(a-56320)+65536}return o},String.prototype.kmwIndexOf=function(i,r){var e=String(this),t=e.indexOf(i,r);if(t<0)return t;for(var o=0,a=0;a!==null&&a<t;a=e.kmwNextChar(a))o++;return o},String.prototype.kmwLastIndexOf=function(i,r){var e=String(this),t=e.lastIndexOf(i,r);if(t<0)return t;for(var o=0,a=0;a!==null&&a<t;a=e.kmwNextChar(a))o++;return o},String.prototype.kmwLength=function(){var i=String(this);if(i.length==0)return 0;for(var r=0,e=0;e!==null;r++)e=i.kmwNextChar(e);return r},String.prototype.kmwSlice=function(i,r){var e=String(this),t=e.kmwCodePointToCodeUnit(i),o=e.kmwCodePointToCodeUnit(r);return t===null||o===null?"":e.slice(t,o)},String.prototype.kmwSubstr=function(i,r){var e=String(this);i<0&&(i=e.kmwLength()+i),i<0&&(i=0);var t=e.kmwCodePointToCodeUnit(i),o=t;if(t===null)return"";if(arguments.length<2)o=e.length;else for(var a=0;a<r;a++)o=e.kmwNextChar(o);return o===null?e.substring(t):e.substring(t,o)},String.prototype.kmwSubstring=function(i,r){var e=String(this),t,o;if(typeof r=="undefined")t=e.kmwCodePointToCodeUnit(i),o=e.length;else{if(i>r){var a=i;i=r,r=a}t=e.kmwCodePointToCodeUnit(i),o=e.kmwCodePointToCodeUnit(r)}return(isNaN(t)||t===null)&&(t=0),(isNaN(o)||o===null)&&(o=e.length),e.substring(t,o)},String.prototype.kmwNextChar=function(i){var r=String(this);if(i===null||i<0||i>=r.length-1)return null;var e=r.charCodeAt(i);if(e>=55296&&e<=56319&&r.length>i+1){var t=r.charCodeAt(i+1);if(t>=56320&&t<=57343)return i==r.length-2?null:i+2}return i+1},String.prototype.kmwPrevChar=function(i){var r=String(this);if(i==null||i<=0||i>r.length)return null;var e=r.charCodeAt(i-1);if(e>=56320&&e<=57343&&i>1){var t=r.charCodeAt(i-2);if(t>=55296&&t<=56319)return i-2}return i-1},String.prototype.kmwCodePointToCodeUnit=function(i){if(i===null)return null;var r=String(this),e=0;if(i<0){e=r.length;for(var t=0;t>i;t--)e=r.kmwPrevChar(e);return e}if(i==r.kmwLength())return r.length;for(var t=0;t<i;t++)e=r.kmwNextChar(e);return e},String.prototype.kmwCodeUnitToCodePoint=function(i){var r=String(this);return i===null?null:i==0?0:i<0?r.substr(i).kmwLength():r.substr(0,i).kmwLength()},String.prototype.kmwCharAt=function(i){var r=String(this);return i>=0?r.kmwSubstr(i,1):""},String.prototype.kmwBMPNextChar=function(i){var r=String(this);return i<0||i>=r.length-1?null:i+1},String.prototype.kmwBMPPrevChar=function(i){var r=String(this);return i<=0||i>r.length?null:i-1},String.prototype.kmwBMPCodePointToCodeUnit=function(i){return i},String.prototype.kmwBMPCodeUnitToCodePoint=function(i){return i},String.prototype.kmwBMPLength=function(){var i=String(this);return i.length},String.prototype.kmwBMPSubstr=function(i,r){var e=String(this);return i>-1?e.substr(i,r):e.substr(e.length+i,-i)},String.kmwEnableSupplementaryPlane=function(i){var r=String.prototype;String._kmwFromCharCode=i?String.kmwFromCharCode:String.fromCharCode,r._kmwCharAt=i?r.kmwCharAt:r.charAt,r._kmwCharCodeAt=i?r.kmwCharCodeAt:r.charCodeAt,r._kmwIndexOf=i?r.kmwIndexOf:r.indexOf,r._kmwLastIndexOf=i?r.kmwLastIndexOf:r.lastIndexOf,r._kmwSlice=i?r.kmwSlice:r.slice,r._kmwSubstring=i?r.kmwSubstring:r.substring,r._kmwSubstr=i?r.kmwSubstr:r.kmwBMPSubstr,r._kmwLength=i?r.kmwLength:r.kmwBMPLength,r._kmwNextChar=i?r.kmwNextChar:r.kmwBMPNextChar,r._kmwPrevChar=i?r.kmwPrevChar:r.kmwBMPPrevChar,r._kmwCodePointToCodeUnit=i?r.kmwCodePointToCodeUnit:r.kmwBMPCodePointToCodeUnit,r._kmwCodeUnitToCodePoint=i?r.kmwCodeUnitToCodePoint:r.kmwBMPCodeUnitToCodePoint},String._kmwFromCharCode||String.kmwEnableSupplementaryPlane(!1)}x(N,"extendString");N();var Ir=class Ir{constructor(r){this._isFulfilled=!1;this._isRejected=!1;this._promise=new Promise((e,t)=>{this._resolve=o=>{this._isFulfilled=!0,e(o)},this._reject=o=>{this._isRejected=!0,t(o)},r&&r(this._resolve,this._reject)})}get resolve(){return this._resolve}get reject(){return this._reject}get isFulfilled(){return this._isFulfilled}get isRejected(){return this._isRejected}get isResolved(){return this.isFulfilled||this.isRejected}then(r,e){return this._promise.then(r,e)}catch(r){return this._promise.catch(r)}finally(r){return this._promise.finally(r)}get corePromise(){return this._promise}};x(Ir,"ManagedPromise");var rr=Ir;var _r=class _r extends rr{constructor(e){let t=null;super(n=>{t=setTimeout(()=>{this.isResolved||n(!0)},e)});this.timerHandle=t;let o=this._resolve;this._resolve=n=>{clearTimeout(this.timerHandle),o(n)};let a=this._reject;this._reject=n=>{clearTimeout(this.timerHandle),a(n)}}};x(_r,"TimeoutPromise");var er=_r,Rr=x(i=>new er(i).corePromise,"timedPromise");var S=class S{constructor(r,e){if(typeof r!="function"){this.comparator=r.comparator,this.heap=[].concat(r.heap);return}let t=r;this.comparator=t,this.heap=(e!=null?e:[]).slice(0),this.heapify()}static leftChildIndex(r){return r*2+1}static rightChildIndex(r){return r*2+2}static parentIndex(r){return Math.floor((r-1)/2)}heapify(r,e){if(r==null||e==null){this.heapify(0,this.count-1);return}let t=[],o=-1;for(let a=e;a>=r;a--){let n=S.parentIndex(a);this.siftDown(a)&&n<r&&o!=n&&(t.push(n),o=n)}for(o=-1;t.length>0;){let a=t.shift(),n=S.parentIndex(a);this.siftDown(a)&&n>=0&&o!=n&&(t.push(n),o=n)}}get count(){return this.heap.length}peek(){return this.heap[0]}enqueue(r){let e=this.heap.length;this.heap.push(r);let t=S.parentIndex,o=t(e);for(;e!==0&&this.comparator(this.heap[e],this.heap[o])<0;){let a=this.heap[e];this.heap[e]=this.heap[o],this.heap[o]=a,e=o,o=t(e)}}enqueueAll(r){if(r.length==0)return;let e=this.count;this.heap=this.heap.concat(r);let t=S.parentIndex(e);this.heapify(t>=0?t:0,S.parentIndex(this.count-1))}dequeue(){if(this.count==0)return;let r=this.heap[0],e=this.heap.pop();return this.heap.length>0&&(this.heap[0]=e,this.siftDown(0)),r}siftDown(r){let e=S.leftChildIndex(r),t=S.rightChildIndex(r),o=r;if(e<this.heap.length&&this.comparator(this.heap[e],this.heap[o])<0&&(o=e),t<this.heap.length&&this.comparator(this.heap[t],this.heap[o])<0&&(o=t),o!=r){let a=this.heap[r];return this.heap[r]=this.heap[o],this.heap[o]=a,this.siftDown(o),!0}else return!1}toArray(){return this.heap.slice(0)}};x(S,"PriorityQueue");var m=S;var gr={};Mr(gr,{DummyModel:()=>dr,QuoteBehavior:()=>G,SENTINEL_CODE_UNIT:()=>D,TrieModel:()=>ir,applyTransform:()=>g,buildMergedTransform:()=>tr,defaultApplyCasing:()=>mr,getLastPreCaretToken:()=>ar,isHighSurrogate:()=>R,isLowSurrogate:()=>Ur,isSentinel:()=>Ar,tokenize:()=>q,transformToSuggestion:()=>_,wordbreak:()=>z});N();var D="\\uFDD0";function g(i,r){var l,B;let e=r.left||"",t=e.kmwLength(),o=t<i.deleteLeft?t:i.deleteLeft,a=e.kmwSubstr(0,t-o)+(i.insert||""),n=r.right||"",d=n.kmwLength(),p=d<((l=i.deleteRight)!=null?l:0)?d:(B=i.deleteRight)!=null?B:0,s=n.kmwSubstr(p);return{left:a,right:s,startOfBuffer:r.startOfBuffer,endOfBuffer:r.endOfBuffer,casingForm:r.casingForm}}x(g,"applyTransform");function tr(i,r){let e=i.insert,t=r.deleteLeft;if(r.deleteLeft){let o=i.insert.kmwLength();o<=r.deleteLeft?(e="",t=r.deleteLeft-o):(e=i.insert.kmwSubstr(0,o-r.deleteLeft),t=0)}return{insert:e+r.insert,deleteLeft:i.deleteLeft+t,deleteRight:(i.deleteRight||0)+(r.deleteRight||0)}}x(tr,"buildMergedTransform");function R(i){return typeof i=="string"&&(i=i.charCodeAt(0)),i>=55296&&i<=56319}x(R,"isHighSurrogate");function Ur(i){return typeof i=="string"&&(i=i.charCodeAt(0)),i>=56320&&i<=57343}x(Ur,"isLowSurrogate");function Ar(i){return i==D}x(Ar,"isSentinel");function _(i,r){let e={transform:i,transformId:i.id,displayAs:i.insert};return(r===0||r)&&(e.p=r),e}x(_,"transformToSuggestion");function mr(i,r){switch(i){case"lower":return r.toLowerCase();case"upper":return r.toUpperCase();case"initial":let e=1;return r.length>1&&R(r.charAt(0))&&Ur(r.charCodeAt(1))&&(e=2),r.substring(0,e).toUpperCase().concat(r.substring(e))}}x(mr,"defaultApplyCasing");var or=(t=>(t.noQuotes="no-quotes",t.useQuotes="use-quotes",t.default="default-quotes",t))(or||{});(r=>{function i(e,t,o,a){if(a=="default-quotes"||!a)throw"Specified quote behavior may be ambiguous - default behavior not specified (may not be .default)";switch(e=="default-quotes"&&(e=a),e){case"no-quotes":return t;case"use-quotes":let{open:n,close:d}=o.quotesForKeepSuggestion;return n+t+d;default:throw"Unsupported quote behavior state detected; implementation missing!"}}r.apply=i,x(i,"apply")})(or||(or={}));var G=or;function q(i,r){r=r||{left:void 0,startOfBuffer:void 0,endOfBuffer:void 0};let e=i(r.left||"")||[],t=i(r.right||"")||[],o;if(e.length>0&&(o=e[e.length-1]),e.length>1){let n=e[e.length-2];if(n.end==o.start&&o.text=="'"){let d={text:n.text+o.text,start:n.start,end:o.end,length:n.length+o.length};e.pop(),e.pop(),e.push(d),o=d}}let a={left:e.map(n=>n.text),right:t.map(n=>n.text),caretSplitsToken:!1};if(e.length>0&&t.length>0){let n=t[0],d=o.end!=r.left.length,p=n.start!=0;if(d||p)return a;i(o.text+n.text).length==1&&(a.caretSplitsToken=!0)}return a}x(q,"tokenize");function ar(i,r){let e=q(i,r);return e.left.length>0?e.left.pop():""}x(ar,"getLastPreCaretToken");function z(i,r){return ar(i,r)}x(z,"wordbreak");var nr={};Mr(nr,{ascii:()=>Qr,default:()=>C,defaultWordbreaker:()=>C,placeholder:()=>qr});function qr(i){let r=0;return i.split(/\\s+/).map(e=>{let t={start:r,end:r+e.length,text:e,length:e.length};return r=t.end,t})}x(qr,"placeholder");function Qr(i){let r=/[A-Za-z0-9']+/g,e=[],t;for(;(t=r.exec(i))!==null;)e.push(new Kr(t[0],t.index));return e}x(Qr,"ascii");var Hr=class Hr{constructor(r,e){this.text=r,this.start=e}get length(){return this.text.length}get end(){return this.start+this.text.length}};x(Hr,"RegExpDerivedSpan");var Kr=Hr;var Ee=["Other","LF","Newline","CR","WSegSpace","Double_Quote","Single_Quote","MidNum","MidNumLet","Numeric","MidLetter","ALetter","ExtendNumLet","Format","Extend","Hebrew_Letter","ZWJ","Katakana","Regional_Indicator","sot","eot"];var fr=[[0,0],[10,1],[11,2],[13,3],[14,0],[32,4],[33,0],[34,5],[35,0],[39,6],[40,0],[44,7],[45,0],[46,8],[47,0],[48,9],[58,10],[59,7],[60,0],[65,11],[91,0],[95,12],[96,0],[97,11],[123,0],[133,2],[134,0],[170,11],[171,0],[173,13],[174,0],[181,11],[182,0],[183,10],[184,0],[186,11],[187,0],[192,11],[215,0],[216,11],[247,0],[248,11],[728,0],[734,11],[768,14],[880,11],[885,0],[886,11],[888,0],[890,11],[894,7],[895,11],[896,0],[902,11],[903,10],[904,11],[907,0],[908,11],[909,0],[910,11],[930,0],[931,11],[1014,0],[1015,11],[1154,0],[1155,14],[1162,11],[1328,0],[1329,11],[1367,0],[1369,11],[1373,0],[1374,11],[1375,10],[1376,11],[1417,7],[1418,11],[1419,0],[1425,14],[1470,0],[1471,14],[1472,0],[1473,14],[1475,0],[1476,14],[1478,0],[1479,14],[1480,0],[1488,15],[1515,0],[1519,15],[1523,11],[1524,10],[1525,0],[1536,13],[1542,0],[1548,7],[1550,0],[1552,14],[1563,0],[1564,13],[1565,0],[1568,11],[1611,14],[1632,9],[1642,0],[1643,9],[1644,7],[1645,0],[1646,11],[1648,14],[1649,11],[1748,0],[1749,11],[1750,14],[1757,13],[1758,0],[1759,14],[1765,11],[1767,14],[1769,0],[1770,14],[1774,11],[1776,9],[1786,11],[1789,0],[1791,11],[1792,0],[1807,13],[1808,11],[1809,14],[1810,11],[1840,14],[1867,0],[1869,11],[1958,14],[1969,11],[1970,0],[1984,9],[1994,11],[2027,14],[2036,11],[2038,0],[2040,7],[2041,0],[2042,11],[2043,0],[2045,14],[2046,0],[2048,11],[2070,14],[2074,11],[2075,14],[2084,11],[2085,14],[2088,11],[2089,14],[2094,0],[2112,11],[2137,14],[2140,0],[2144,11],[2155,0],[2208,11],[2229,0],[2230,11],[2248,0],[2259,14],[2274,13],[2275,14],[2308,11],[2362,14],[2365,11],[2366,14],[2384,11],[2385,14],[2392,11],[2402,14],[2404,0],[2406,9],[2416,0],[2417,11],[2433,14],[2436,0],[2437,11],[2445,0],[2447,11],[2449,0],[2451,11],[2473,0],[2474,11],[2481,0],[2482,11],[2483,0],[2486,11],[2490,0],[2492,14],[2493,11],[2494,14],[2501,0],[2503,14],[2505,0],[2507,14],[2510,11],[2511,0],[2519,14],[2520,0],[2524,11],[2526,0],[2527,11],[2530,14],[2532,0],[2534,9],[2544,11],[2546,0],[2556,11],[2557,0],[2558,14],[2559,0],[2561,14],[2564,0],[2565,11],[2571,0],[2575,11],[2577,0],[2579,11],[2601,0],[2602,11],[2609,0],[2610,11],[2612,0],[2613,11],[2615,0],[2616,11],[2618,0],[2620,14],[2621,0],[2622,14],[2627,0],[2631,14],[2633,0],[2635,14],[2638,0],[2641,14],[2642,0],[2649,11],[2653,0],[2654,11],[2655,0],[2662,9],[2672,14],[2674,11],[2677,14],[2678,0],[2689,14],[2692,0],[2693,11],[2702,0],[2703,11],[2706,0],[2707,11],[2729,0],[2730,11],[2737,0],[2738,11],[2740,0],[2741,11],[2746,0],[2748,14],[2749,11],[2750,14],[2758,0],[2759,14],[2762,0],[2763,14],[2766,0],[2768,11],[2769,0],[2784,11],[2786,14],[2788,0],[2790,9],[2800,0],[2809,11],[2810,14],[2816,0],[2817,14],[2820,0],[2821,11],[2829,0],[2831,11],[2833,0],[2835,11],[2857,0],[2858,11],[2865,0],[2866,11],[2868,0],[2869,11],[2874,0],[2876,14],[2877,11],[2878,14],[2885,0],[2887,14],[2889,0],[2891,14],[2894,0],[2901,14],[2904,0],[2908,11],[2910,0],[2911,11],[2914,14],[2916,0],[2918,9],[2928,0],[2929,11],[2930,0],[2946,14],[2947,11],[2948,0],[2949,11],[2955,0],[2958,11],[2961,0],[2962,11],[2966,0],[2969,11],[2971,0],[2972,11],[2973,0],[2974,11],[2976,0],[2979,11],[2981,0],[2984,11],[2987,0],[2990,11],[3002,0],[3006,14],[3011,0],[3014,14],[3017,0],[3018,14],[3022,0],[3024,11],[3025,0],[3031,14],[3032,0],[3046,9],[3056,0],[3072,14],[3077,11],[3085,0],[3086,11],[3089,0],[3090,11],[3113,0],[3114,11],[3130,0],[3133,11],[3134,14],[3141,0],[3142,14],[3145,0],[3146,14],[3150,0],[3157,14],[3159,0],[3160,11],[3163,0],[3168,11],[3170,14],[3172,0],[3174,9],[3184,0],[3200,11],[3201,14],[3204,0],[3205,11],[3213,0],[3214,11],[3217,0],[3218,11],[3241,0],[3242,11],[3252,0],[3253,11],[3258,0],[3260,14],[3261,11],[3262,14],[3269,0],[3270,14],[3273,0],[3274,14],[3278,0],[3285,14],[3287,0],[3294,11],[3295,0],[3296,11],[3298,14],[3300,0],[3302,9],[3312,0],[3313,11],[3315,0],[3328,14],[3332,11],[3341,0],[3342,11],[3345,0],[3346,11],[3387,14],[3389,11],[3390,14],[3397,0],[3398,14],[3401,0],[3402,14],[3406,11],[3407,0],[3412,11],[3415,14],[3416,0],[3423,11],[3426,14],[3428,0],[3430,9],[3440,0],[3450,11],[3456,0],[3457,14],[3460,0],[3461,11],[3479,0],[3482,11],[3506,0],[3507,11],[3516,0],[3517,11],[3518,0],[3520,11],[3527,0],[3530,14],[3531,0],[3535,14],[3541,0],[3542,14],[3543,0],[3544,14],[3552,0],[3558,9],[3568,0],[3570,14],[3572,0],[3633,14],[3634,0],[3636,14],[3643,0],[3655,14],[3663,0],[3664,9],[3674,0],[3761,14],[3762,0],[3764,14],[3773,0],[3784,14],[3790,0],[3792,9],[3802,0],[3840,11],[3841,0],[3864,14],[3866,0],[3872,9],[3882,0],[3893,14],[3894,0],[3895,14],[3896,0],[3897,14],[3898,0],[3902,14],[3904,11],[3912,0],[3913,11],[3949,0],[3953,14],[3973,0],[3974,14],[3976,11],[3981,14],[3992,0],[3993,14],[4029,0],[4038,14],[4039,0],[4139,14],[4159,0],[4160,9],[4170,0],[4182,14],[4186,0],[4190,14],[4193,0],[4194,14],[4197,0],[4199,14],[4206,0],[4209,14],[4213,0],[4226,14],[4238,0],[4239,14],[4240,9],[4250,14],[4254,0],[4256,11],[4294,0],[4295,11],[4296,0],[4301,11],[4302,0],[4304,11],[4347,0],[4348,11],[4681,0],[4682,11],[4686,0],[4688,11],[4695,0],[4696,11],[4697,0],[4698,11],[4702,0],[4704,11],[4745,0],[4746,11],[4750,0],[4752,11],[4785,0],[4786,11],[4790,0],[4792,11],[4799,0],[4800,11],[4801,0],[4802,11],[4806,0],[4808,11],[4823,0],[4824,11],[4881,0],[4882,11],[4886,0],[4888,11],[4955,0],[4957,14],[4960,0],[4992,11],[5008,0],[5024,11],[5110,0],[5112,11],[5118,0],[5121,11],[5741,0],[5743,11],[5760,4],[5761,11],[5787,0],[5792,11],[5867,0],[5870,11],[5881,0],[5888,11],[5901,0],[5902,11],[5906,14],[5909,0],[5920,11],[5938,14],[5941,0],[5952,11],[5970,14],[5972,0],[5984,11],[5997,0],[5998,11],[6001,0],[6002,14],[6004,0],[6068,14],[6100,0],[6109,14],[6110,0],[6112,9],[6122,0],[6155,14],[6158,13],[6159,0],[6160,9],[6170,0],[6176,11],[6265,0],[6272,11],[6277,14],[6279,11],[6313,14],[6314,11],[6315,0],[6320,11],[6390,0],[6400,11],[6431,0],[6432,14],[6444,0],[6448,14],[6460,0],[6470,9],[6480,0],[6608,9],[6618,0],[6656,11],[6679,14],[6684,0],[6741,14],[6751,0],[6752,14],[6781,0],[6783,14],[6784,9],[6794,0],[6800,9],[6810,0],[6832,14],[6849,0],[6912,14],[6917,11],[6964,14],[6981,11],[6988,0],[6992,9],[7002,0],[7019,14],[7028,0],[7040,14],[7043,11],[7073,14],[7086,11],[7088,9],[7098,11],[7142,14],[7156,0],[7168,11],[7204,14],[7224,0],[7232,9],[7242,0],[7245,11],[7248,9],[7258,11],[7294,0],[7296,11],[7305,0],[7312,11],[7355,0],[7357,11],[7360,0],[7376,14],[7379,0],[7380,14],[7401,11],[7405,14],[7406,11],[7412,14],[7413,11],[7415,14],[7418,11],[7419,0],[7424,11],[7616,14],[7674,0],[7675,14],[7680,11],[7958,0],[7960,11],[7966,0],[7968,11],[8006,0],[8008,11],[8014,0],[8016,11],[8024,0],[8025,11],[8026,0],[8027,11],[8028,0],[8029,11],[8030,0],[8031,11],[8062,0],[8064,11],[8117,0],[8118,11],[8125,0],[8126,11],[8127,0],[8130,11],[8133,0],[8134,11],[8141,0],[8144,11],[8148,0],[8150,11],[8156,0],[8160,11],[8173,0],[8178,11],[8181,0],[8182,11],[8189,0],[8192,4],[8199,0],[8200,4],[8203,0],[8204,14],[8205,16],[8206,13],[8208,0],[8216,8],[8218,0],[8228,8],[8229,0],[8231,10],[8232,2],[8234,13],[8239,12],[8240,0],[8255,12],[8257,0],[8260,7],[8261,0],[8276,12],[8277,0],[8287,4],[8288,13],[8293,0],[8294,13],[8304,0],[8305,11],[8306,0],[8319,11],[8320,0],[8336,11],[8349,0],[8400,14],[8433,0],[8450,11],[8451,0],[8455,11],[8456,0],[8458,11],[8468,0],[8469,11],[8470,0],[8473,11],[8478,0],[8484,11],[8485,0],[8486,11],[8487,0],[8488,11],[8489,0],[8490,11],[8494,0],[8495,11],[8506,0],[8508,11],[8512,0],[8517,11],[8522,0],[8526,11],[8527,0],[8544,11],[8585,0],[9398,11],[9450,0],[11264,11],[11311,0],[11312,11],[11359,0],[11360,11],[11493,0],[11499,11],[11503,14],[11506,11],[11508,0],[11520,11],[11558,0],[11559,11],[11560,0],[11565,11],[11566,0],[11568,11],[11624,0],[11631,11],[11632,0],[11647,14],[11648,11],[11671,0],[11680,11],[11687,0],[11688,11],[11695,0],[11696,11],[11703,0],[11704,11],[11711,0],[11712,11],[11719,0],[11720,11],[11727,0],[11728,11],[11735,0],[11736,11],[11743,0],[11744,14],[11776,0],[11823,11],[11824,0],[12288,4],[12289,0],[12293,11],[12294,0],[12330,14],[12336,0],[12337,17],[12342,0],[12347,11],[12349,0],[12441,14],[12443,17],[12445,0],[12448,17],[12539,0],[12540,17],[12544,0],[12549,11],[12592,0],[12593,11],[12687,0],[12704,11],[12736,0],[12784,17],[12800,0],[13008,17],[13055,0],[13056,17],[13144,0],[40960,11],[42125,0],[42192,11],[42238,0],[42240,11],[42509,0],[42512,11],[42528,9],[42538,11],[42540,0],[42560,11],[42607,14],[42611,0],[42612,14],[42622,0],[42623,11],[42654,14],[42656,11],[42736,14],[42738,0],[42760,11],[42944,0],[42946,11],[42955,0],[42997,11],[43010,14],[43011,11],[43014,14],[43015,11],[43019,14],[43020,11],[43043,14],[43048,0],[43052,14],[43053,0],[43072,11],[43124,0],[43136,14],[43138,11],[43188,14],[43206,0],[43216,9],[43226,0],[43232,14],[43250,11],[43256,0],[43259,11],[43260,0],[43261,11],[43263,14],[43264,9],[43274,11],[43302,14],[43310,0],[43312,11],[43335,14],[43348,0],[43360,11],[43389,0],[43392,14],[43396,11],[43443,14],[43457,0],[43471,11],[43472,9],[43482,0],[43493,14],[43494,0],[43504,9],[43514,0],[43520,11],[43561,14],[43575,0],[43584,11],[43587,14],[43588,11],[43596,14],[43598,0],[43600,9],[43610,0],[43643,14],[43646,0],[43696,14],[43697,0],[43698,14],[43701,0],[43703,14],[43705,0],[43710,14],[43712,0],[43713,14],[43714,0],[43744,11],[43755,14],[43760,0],[43762,11],[43765,14],[43767,0],[43777,11],[43783,0],[43785,11],[43791,0],[43793,11],[43799,0],[43808,11],[43815,0],[43816,11],[43823,0],[43824,11],[43882,0],[43888,11],[44003,14],[44011,0],[44012,14],[44014,0],[44016,9],[44026,0],[44032,11],[55204,0],[55216,11],[55239,0],[55243,11],[55292,0],[64256,11],[64263,0],[64275,11],[64280,0],[64285,15],[64286,14],[64287,15],[64297,0],[64298,15],[64311,0],[64312,15],[64317,0],[64318,15],[64319,0],[64320,15],[64322,0],[64323,15],[64325,0],[64326,15],[64336,11],[64434,0],[64467,11],[64830,0],[64848,11],[64912,0],[64914,11],[64968,0],[65008,11],[65020,0],[65024,14],[65040,7],[65041,0],[65043,10],[65044,7],[65045,0],[65056,14],[65072,0],[65075,12],[65077,0],[65101,12],[65104,7],[65105,0],[65106,8],[65107,0],[65108,7],[65109,10],[65110,0],[65136,11],[65141,0],[65142,11],[65277,0],[65279,13],[65280,0],[65287,8],[65288,0],[65292,7],[65293,0],[65294,8],[65295,0],[65296,9],[65306,10],[65307,7],[65308,0],[65313,11],[65339,0],[65343,12],[65344,0],[65345,11],[65371,0],[65382,17],[65438,14],[65440,11],[65471,0],[65474,11],[65480,0],[65482,11],[65488,0],[65490,11],[65496,0],[65498,11],[65501,0],[65529,13],[65532,0],[65536,11],[65548,0],[65549,11],[65575,0],[65576,11],[65595,0],[65596,11],[65598,0],[65599,11],[65614,0],[65616,11],[65630,0],[65664,11],[65787,0],[65856,11],[65909,0],[66045,14],[66046,0],[66176,11],[66205,0],[66208,11],[66257,0],[66272,14],[66273,0],[66304,11],[66336,0],[66349,11],[66379,0],[66384,11],[66422,14],[66427,0],[66432,11],[66462,0],[66464,11],[66500,0],[66504,11],[66512,0],[66513,11],[66518,0],[66560,11],[66718,0],[66720,9],[66730,0],[66736,11],[66772,0],[66776,11],[66812,0],[66816,11],[66856,0],[66864,11],[66916,0],[67072,11],[67383,0],[67392,11],[67414,0],[67424,11],[67432,0],[67584,11],[67590,0],[67592,11],[67593,0],[67594,11],[67638,0],[67639,11],[67641,0],[67644,11],[67645,0],[67647,11],[67670,0],[67680,11],[67703,0],[67712,11],[67743,0],[67808,11],[67827,0],[67828,11],[67830,0],[67840,11],[67862,0],[67872,11],[67898,0],[67968,11],[68024,0],[68030,11],[68032,0],[68096,11],[68097,14],[68100,0],[68101,14],[68103,0],[68108,14],[68112,11],[68116,0],[68117,11],[68120,0],[68121,11],[68150,0],[68152,14],[68155,0],[68159,14],[68160,0],[68192,11],[68221,0],[68224,11],[68253,0],[68288,11],[68296,0],[68297,11],[68325,14],[68327,0],[68352,11],[68406,0],[68416,11],[68438,0],[68448,11],[68467,0],[68480,11],[68498,0],[68608,11],[68681,0],[68736,11],[68787,0],[68800,11],[68851,0],[68864,11],[68900,14],[68904,0],[68912,9],[68922,0],[69248,11],[69290,0],[69291,14],[69293,0],[69296,11],[69298,0],[69376,11],[69405,0],[69415,11],[69416,0],[69424,11],[69446,14],[69457,0],[69552,11],[69573,0],[69600,11],[69623,0],[69632,14],[69635,11],[69688,14],[69703,0],[69734,9],[69744,0],[69759,14],[69763,11],[69808,14],[69819,0],[69821,13],[69822,0],[69837,13],[69838,0],[69840,11],[69865,0],[69872,9],[69882,0],[69888,14],[69891,11],[69927,14],[69941,0],[69942,9],[69952,0],[69956,11],[69957,14],[69959,11],[69960,0],[69968,11],[70003,14],[70004,0],[70006,11],[70007,0],[70016,14],[70019,11],[70067,14],[70081,11],[70085,0],[70089,14],[70093,0],[70094,14],[70096,9],[70106,11],[70107,0],[70108,11],[70109,0],[70144,11],[70162,0],[70163,11],[70188,14],[70200,0],[70206,14],[70207,0],[70272,11],[70279,0],[70280,11],[70281,0],[70282,11],[70286,0],[70287,11],[70302,0],[70303,11],[70313,0],[70320,11],[70367,14],[70379,0],[70384,9],[70394,0],[70400,14],[70404,0],[70405,11],[70413,0],[70415,11],[70417,0],[70419,11],[70441,0],[70442,11],[70449,0],[70450,11],[70452,0],[70453,11],[70458,0],[70459,14],[70461,11],[70462,14],[70469,0],[70471,14],[70473,0],[70475,14],[70478,0],[70480,11],[70481,0],[70487,14],[70488,0],[70493,11],[70498,14],[70500,0],[70502,14],[70509,0],[70512,14],[70517,0],[70656,11],[70709,14],[70727,11],[70731,0],[70736,9],[70746,0],[70750,14],[70751,11],[70754,0],[70784,11],[70832,14],[70852,11],[70854,0],[70855,11],[70856,0],[70864,9],[70874,0],[71040,11],[71087,14],[71094,0],[71096,14],[71105,0],[71128,11],[71132,14],[71134,0],[71168,11],[71216,14],[71233,0],[71236,11],[71237,0],[71248,9],[71258,0],[71296,11],[71339,14],[71352,11],[71353,0],[71360,9],[71370,0],[71453,14],[71468,0],[71472,9],[71482,0],[71680,11],[71724,14],[71739,0],[71840,11],[71904,9],[71914,0],[71935,11],[71943,0],[71945,11],[71946,0],[71948,11],[71956,0],[71957,11],[71959,0],[71960,11],[71984,14],[71990,0],[71991,14],[71993,0],[71995,14],[71999,11],[72e3,14],[72001,11],[72002,14],[72004,0],[72016,9],[72026,0],[72096,11],[72104,0],[72106,11],[72145,14],[72152,0],[72154,14],[72161,11],[72162,0],[72163,11],[72164,14],[72165,0],[72192,11],[72193,14],[72203,11],[72243,14],[72250,11],[72251,14],[72255,0],[72263,14],[72264,0],[72272,11],[72273,14],[72284,11],[72330,14],[72346,0],[72349,11],[72350,0],[72384,11],[72441,0],[72704,11],[72713,0],[72714,11],[72751,14],[72759,0],[72760,14],[72768,11],[72769,0],[72784,9],[72794,0],[72818,11],[72848,0],[72850,14],[72872,0],[72873,14],[72887,0],[72960,11],[72967,0],[72968,11],[72970,0],[72971,11],[73009,14],[73015,0],[73018,14],[73019,0],[73020,14],[73022,0],[73023,14],[73030,11],[73031,14],[73032,0],[73040,9],[73050,0],[73056,11],[73062,0],[73063,11],[73065,0],[73066,11],[73098,14],[73103,0],[73104,14],[73106,0],[73107,14],[73112,11],[73113,0],[73120,9],[73130,0],[73440,11],[73459,14],[73463,0],[73648,11],[73649,0],[73728,11],[74650,0],[74752,11],[74863,0],[74880,11],[75076,0],[77824,11],[78895,0],[78896,13],[78905,0],[82944,11],[83527,0],[92160,11],[92729,0],[92736,11],[92767,0],[92768,9],[92778,0],[92880,11],[92910,0],[92912,14],[92917,0],[92928,11],[92976,14],[92983,0],[92992,11],[92996,0],[93008,9],[93018,0],[93027,11],[93048,0],[93053,11],[93072,0],[93760,11],[93824,0],[93952,11],[94027,0],[94031,14],[94032,11],[94033,14],[94088,0],[94095,14],[94099,11],[94112,0],[94176,11],[94178,0],[94179,11],[94180,14],[94181,0],[94192,14],[94194,0],[110592,17],[110593,0],[110948,17],[110952,0],[113664,11],[113771,0],[113776,11],[113789,0],[113792,11],[113801,0],[113808,11],[113818,0],[113821,14],[113823,0],[113824,13],[113828,0],[119141,14],[119146,0],[119149,14],[119155,13],[119163,14],[119171,0],[119173,14],[119180,0],[119210,14],[119214,0],[119362,14],[119365,0],[119808,11],[119893,0],[119894,11],[119965,0],[119966,11],[119968,0],[119970,11],[119971,0],[119973,11],[119975,0],[119977,11],[119981,0],[119982,11],[119994,0],[119995,11],[119996,0],[119997,11],[120004,0],[120005,11],[120070,0],[120071,11],[120075,0],[120077,11],[120085,0],[120086,11],[120093,0],[120094,11],[120122,0],[120123,11],[120127,0],[120128,11],[120133,0],[120134,11],[120135,0],[120138,11],[120145,0],[120146,11],[120486,0],[120488,11],[120513,0],[120514,11],[120539,0],[120540,11],[120571,0],[120572,11],[120597,0],[120598,11],[120629,0],[120630,11],[120655,0],[120656,11],[120687,0],[120688,11],[120713,0],[120714,11],[120745,0],[120746,11],[120771,0],[120772,11],[120780,0],[120782,9],[120832,0],[121344,14],[121399,0],[121403,14],[121453,0],[121461,14],[121462,0],[121476,14],[121477,0],[121499,14],[121504,0],[121505,14],[121520,0],[122880,14],[122887,0],[122888,14],[122905,0],[122907,14],[122914,0],[122915,14],[122917,0],[122918,14],[122923,0],[123136,11],[123181,0],[123184,14],[123191,11],[123198,0],[123200,9],[123210,0],[123214,11],[123215,0],[123584,11],[123628,14],[123632,9],[123642,0],[124928,11],[125125,0],[125136,14],[125143,0],[125184,11],[125252,14],[125259,11],[125260,0],[125264,9],[125274,0],[126464,11],[126468,0],[126469,11],[126496,0],[126497,11],[126499,0],[126500,11],[126501,0],[126503,11],[126504,0],[126505,11],[126515,0],[126516,11],[126520,0],[126521,11],[126522,0],[126523,11],[126524,0],[126530,11],[126531,0],[126535,11],[126536,0],[126537,11],[126538,0],[126539,11],[126540,0],[126541,11],[126544,0],[126545,11],[126547,0],[126548,11],[126549,0],[126551,11],[126552,0],[126553,11],[126554,0],[126555,11],[126556,0],[126557,11],[126558,0],[126559,11],[126560,0],[126561,11],[126563,0],[126564,11],[126565,0],[126567,11],[126571,0],[126572,11],[126579,0],[126580,11],[126584,0],[126585,11],[126589,0],[126590,11],[126591,0],[126592,11],[126602,0],[126603,11],[126620,0],[126625,11],[126628,0],[126629,11],[126634,0],[126635,11],[126652,0],[127280,11],[127306,0],[127312,11],[127338,0],[127344,11],[127370,0],[127462,18],[127488,0],[127995,14],[128e3,0],[130032,9],[130042,0],[917505,13],[917506,0],[917536,14],[917632,0],[917760,14],[918e3,0]];function C(i,r){let e=Me(i,r);if(e.length==0)return[];let t=[];for(let o=0;o<e.length-1;o++){let a=e[o],n=e[o+1],d=new Er(i,a,n);Ne(d.text,r)?t.push(d):o==e.length-2&&(d=new Er(i,n,n),t.push(d))}return t}x(C,"default_");var jr=class jr{constructor(r,e,t){this._source=r,this.start=e,this.end=t}get text(){return this._source.substring(this.start,this.end)}get length(){return this.end-this.start}};x(jr,"LazySpan");var Er=jr,j=class j{constructor(r,e,t,o,a,n){this.lookbehind=19;this.left=19;this.right=19;this.text=r,this.options=e,arguments.length==3?this.lookahead=this.wordbreakPropertyAt(t):(this.lookbehind=t,this.left=o,this.right=a,this.lookahead=n)}next(r){let e=this.wordbreakPropertyAt(r);return new j(this.text,this.options,this.left,this.right,this.lookahead,e)}ignoringRight(r){let e=this.wordbreakPropertyAt(r);return new j(this.text,this.options,this.lookbehind,this.left,this.lookahead,e)}ignoringLookahead(r){let e=this.wordbreakPropertyAt(r);return new j(this.text,this.options,this.lookbehind,this.left,this.right,e)}wordbreakPropertyAt(r){return r<0?19:r>=this.text.length?20:ge(this.text[r])?Gr(this.text[r]+this.text[r+1]):Gr(this.text[r],this.options)}match(r,e,t,o){var n,d,p,s;let a=(n=r==null?void 0:r.includes(this.lookbehind))!=null?n:!0;return a=a&&((d=e==null?void 0:e.includes(this.left))!=null?d:!0),a=a&&((p=t==null?void 0:t.includes(this.right))!=null?p:!0),a&&((s=o==null?void 0:o.includes(this.lookahead))!=null?s:!0)}propertyMatch(r,e,t,o){let a=x(n=>Oe(n,this.options),"propMapper");return this.match(r==null?void 0:r.map(a),e==null?void 0:e.map(a),t==null?void 0:t.map(a),o==null?void 0:o.map(a))}};x(j,"BreakerContext");var Vr=j;function Ne(i,r){return!i.split("").map(e=>Gr(e,r)).every(e=>e===3||e===1||e===2||e===4)}x(Ne,"isNonSpace");function Me(i,r){if(i.length===0)return[];r&&!r.rules&&(r.rules=[]);let e=[],t,o=0,a=new Vr(i,r,o),n=0;do{if(t=o,o=d(o),a=a.next(o),a.match(null,[19],null,null)){e.push(t);continue}if(a.match(null,null,[20],null)){e.push(t);break}if(a.match(null,[3],[1],null))continue;let p=[2,3,1];if(a.match(null,p,null,null)){e.push(t);continue}if(a.match(null,null,p,null)){e.push(t);continue}if(a.match(null,[4],[4],null))continue;let s=[13,14,16];for(;a.match(null,null,s,null);)[t,o]=[o,d(o)],a=a.ignoringRight(o);if(a.right===20){e.push(t);break}for(;a.match(null,null,null,s);)o=d(o),a=a.ignoringLookahead(o);let l=[11,15],B=[8,6];if(r!=null&&r.rules){let L=!1;for(let F of r.rules)if(L=F.match(a),L){F.breakIfMatch&&e.push(t);break}if(L)continue}if(a.match(null,l,l,null))continue;let h=[10].concat(B);if(a.match(null,l,h,l)||a.match(l,h,l,null)||a.match(null,[15],[6],null)||a.match(null,[15],[5],[15])||a.match([15],[5],[15],null)||a.match(null,[9],[9],null)||a.match(null,l,[9],null)||a.match(null,[9],l,null))continue;let k=[7].concat(B);if(a.match([9],k,[9],null)||a.match(null,[9],k,[9])||a.match(null,[17],[17],null))continue;let c=[17,9].concat(l);if(!a.match(null,c,[12],null)&&!a.match(null,[12],[12],null)&&!a.match(null,[12],c,null)){if(a.right===18){if(n+=1,n%2==1)continue}else n=0;e.push(t)}}while(t<i.length);return e;function d(p){return p>=i.length?i.length:ge(i[p])?p+2:p+1}}x(Me,"findBoundaries");function ge(i){let r=i.charCodeAt(0);return r>=55296&&r<=56319}x(ge,"isStartOfSurrogatePair");function Gr(i,r){if(r!=null&&r.propertyMapping){let t=r.propertyMapping(i);if(t)return Oe(t,r)}let e=i.codePointAt(0);return zr(e,0,fr.length-1)}x(Gr,"property");function Oe(i,r){var o,a;let e=x(n=>n.toLowerCase()==i.toLowerCase(),"matcher"),t=(a=(o=r==null?void 0:r.customProperties)==null?void 0:o.findIndex(e))!=null?a:-1;return t!=-1?-t-1:Ee.findIndex(e)}x(Oe,"propertyVal");function zr(i,r,e){if(e<r)return 0;let t=r+~~((e-r)/2),o=fr[t],a=fr[t+1],n=a?a[0]:1/0;return i<o[0]?zr(i,r,t-1):i>=n?zr(i,t+1,e):o[1]}x(zr,"searchForProperty");N();var Le=12,M=class M{constructor(r,e,t){this.root=r,this.prefix=e,this.totalWeight=t}child(r){if(r=="")return;let e=r.split(""),t=this;for(;e.length>0&&t;){let o=e.shift();t=t._child(o)}return t}_child(r){let e=this.root,t=this.totalWeight,o=this.prefix+r;if(e.type=="internal"){let a=e.children[r];return a?new M(a,o,t):void 0}else return e.entries.filter(function(n){return n.key.indexOf(o)==0}).length?new M(e,o,t):void 0}*children(){let r=this.root,e=this.totalWeight;if(r.type=="internal"){for(let t of r.values){let o=r.children[t];if(R(t))if(o.type=="internal"){let a=o;for(let n of a.values){let d=this.prefix+t+n;yield{char:t+n,traversal:function(){return new M(a.children[n],d,e)}}}}else{let a=o.entries[0].key;t=t+a[this.prefix.length+1];let n=this.prefix+t;yield{char:t,traversal:function(){return new M(o,n,e)}}}else{if(Ar(t))continue;if(t){let a=this.prefix+t;yield{char:t,traversal:function(){return new M(o,a,e)}}}else continue}}return}else{let t=this.prefix,o=r.entries.filter(function(a){return a.key!=t&&t.length<a.key.length});for(let{key:a}of o){let n=a[t.length];R(n)&&(n=n+a[t.length+1]),yield{char:n,traversal:function(){return new M(r,t+n,e)}}}return}}get entries(){let r=x(e=>({text:e.content,p:e.weight/this.totalWeight}),"entryMapper");if(this.root.type=="leaf"){let e=this.prefix;return this.root.entries.filter(function(o){return o.key==e}).map(r)}else{let e=this.root.children[D];return e&&e.type=="leaf"?e.entries.map(r):[]}}get p(){return this.root.weight/this.totalWeight}};x(M,"Traversal");var Xr=M,Zr=class Zr{constructor(r,e={}){this.languageUsesCasing=e.languageUsesCasing,this.applyCasing=e.applyCasing,this._trie=new Yr(r.root,r.totalWeight,e.searchTermToKey||Ie),this.breakWords=e.wordBreaker||C,this.punctuation=e.punctuation}configure(r){var e;return this.configuration={leftContextCodePoints:r.maxLeftContextCodePoints,rightContextCodePoints:(e=r.maxRightContextCodePoints)!=null?e:0}}toKey(r){return this._trie.toKey(r)}predict(r,e){if(!r.insert&&!e.left&&!e.right&&e.startOfBuffer&&e.endOfBuffer)return n(this._trie.firstN(Le).map(({text:d,p})=>({transform:{insert:d,deleteLeft:0},displayAs:d,p})));let t=g(r,e),o=r.deleteLeft-r.insert.kmwLength(),a=ar(this.breakWords,t);return n(this._trie.lookup(a).map(({text:d,p})=>_({insert:d,deleteLeft:o+a.kmwLength()},p)));function n(d){let p=[];for(let s of d)p.push({sample:s,p:s.p});return p}}get wordbreaker(){return this.breakWords}traverseFromRoot(){return this._trie.traverseFromRoot()}};x(Zr,"TrieModel");var ir=Zr,Jr=class Jr{constructor(r,e,t){this.root=r,this.toKey=t,this.totalWeight=e}traverseFromRoot(){return new Xr(this.root,"",this.totalWeight)}lookup(r){let e=this.toKey(r),t=this.traverseFromRoot().child(e);return t?Ce(t):[]}firstN(r){return Ce(this.traverseFromRoot(),r)}};x(Jr,"Trie");var Yr=Jr;function Ce(i,r=Le){let e=new m(function(o,a){return(a?a.p:0)-(o?o.p:0)}),t=[];for(e.enqueue(i);e.count>0;){let o=e.dequeue();if(o.text!==void 0){let a=o;if(t.push(a),t.length>=r)return t}else{let a=o;e.enqueueAll(a.entries);let n=[];for(let d of a.children())n.push(d.traversal());e.enqueueAll(n)}}return t}x(Ce,"getSortedResults");function Ie(i){return i.normalize("NFD").replace(/[\\u0300-\\u036f]/g,"").toLowerCase()}x(Ie,"defaultSearchTermToKey");var $r=class $r{constructor(r){r=r||{},this._futureSuggestions=r.futureSuggestions?r.futureSuggestions.slice():[],r.punctuation&&(this.punctuation=r.punctuation)}configure(r){return this.configuration={leftContextCodePoints:r.maxLeftContextCodePoints,rightContextCodePoints:r.maxRightContextCodePoints},this.configuration}predict(r,e,t){let o=x(function(n){let d=[];for(let p of n)d.push({sample:p,p:1});return d},"makeUniformDistribution");if(t)return o(t);let a=this._futureSuggestions.shift();return a?o(a):[]}};x($r,"DummyModel");var dr=$r;var hr={};Mr(hr,{ClassicalDistanceCalculation:()=>K,ContextTracker:()=>ur,ExecutionBucket:()=>pr,ExecutionSpan:()=>Q,ExecutionTimer:()=>sr,QUEUE_NODE_COMPARATOR:()=>Cr,STANDARD_TIME_BETWEEN_DEFERS:()=>Or,SearchNode:()=>Lr,SearchResult:()=>lr,SearchSpace:()=>O,TrackedContextState:()=>X,TrackedContextSuggestion:()=>ie,TrackedContextToken:()=>T});var P=class P{constructor(r){this.diagonalWidth=2;this.inputSequence=[];this.matchSequence=[];if(r){let e=r.resolvedDistances.length;this.resolvedDistances=Array(e);for(let t=0;t<e;t++)this.resolvedDistances[t]=r.resolvedDistances[t].slice(0);this.inputSequence=r.inputSequence.slice(0),this.matchSequence=r.matchSequence.slice(0),this.diagonalWidth=r.diagonalWidth}else this.resolvedDistances=[]}getTrueIndex(r,e,t){let o={row:r,col:e-r+t,sparse:!1};return(o.col<0||o.col>2*t)&&(o.sparse=!0),o}getCostAt(r,e,t=this.diagonalWidth){if(r<0||e<0)return r==-1&&e>=-1?e+1:e==-1&&r>=-1?r+1:Number.MAX_VALUE;let o=this.getTrueIndex(r,e,t);return o.sparse?Number.MAX_VALUE:this.resolvedDistances[o.row][o.col]}getFinalCost(){let r=this,e=r.getHeuristicFinalCost();for(;e>r.diagonalWidth;)r=r.increaseMaxDistance(),e=r.getHeuristicFinalCost();return e}getHeuristicFinalCost(){return this.getCostAt(this.inputSequence.length-1,this.matchSequence.length-1)}hasFinalCostWithin(r){let e=this,t=e.getHeuristicFinalCost(),o=this.diagonalWidth;do{if(t<=r)return!0;if(o<r)e=e.increaseMaxDistance(),o++,t=e.getHeuristicFinalCost();else break}while(!0);return!1}editPath(r=this.inputSequence.length-1,e=this.matchSequence.length-1){let t=this.getCostAt(r,e),o=null,a=null,n=this.getCostAt(r,e-1),d=this.getCostAt(r-1,e),p=this.getCostAt(r-1,e-1),[s,l]=P.getTransposeParent(this,r,e);if(s>=0&&l>=0){let B=1;if(o=["transpose-start"],s!=r-1){let h=r-s-1;o=o.concat(Array(h).fill("transpose-delete")),B+=h}else{let h=e-l-1;o=o.concat(Array(h).fill("transpose-insert")),B+=h}o.push("transpose-end"),this.getCostAt(s-1,l-1)!=t-B&&(o=null),a=[s-1,l-1]}return o||(p==t-1?(o=["substitute"],a=[r-1,e-1]):n==t-1?(o=["insert"],a=[r,e-1]):d==t-1?(o=["delete"],a=[r-1,e]):(o=["match"],a=[r-1,e-1])),a[0]>=0&&a[1]>=0?this.editPath(a[0],a[1]).concat(o):a[0]>-1?Array(a[0]+1).fill("delete").concat(o):a[1]>-1?Array(a[1]+1).fill("insert").concat(o):o}static getTransposeParent(r,e,t){if(e<0||t<0||r.inputSequence[e].key==r.matchSequence[t].key)return[-1,-1];let o=-1;for(let n=e-1;n>=0;n--)if(r.inputSequence[n].key==r.matchSequence[t].key){o=n;break}let a=-1;for(let n=t-1;n>=0;n--)if(r.matchSequence[n].key==r.inputSequence[e].key){a=n;break}return[o,a]}static initialCostAt(r,e,t,o,a){var n=r.inputSequence[e].key==r.matchSequence[t].key?0:1,d=r.getCostAt(e-1,t-1)+n,p=o||r.getCostAt(e,t-1)+1,s=a||r.getCostAt(e-1,t)+1,l=Number.MAX_VALUE;if(e>0&&t>0){let[B,h]=P.getTransposeParent(r,e,t);l=r.getCostAt(B-1,h-1)+(e-B-1)+1+(t-h-1)}return Math.min(d,s,p,l)}getSubset(r,e){let t=new P(this);if(r>this.inputSequence.length||e>this.matchSequence.length)throw"Invalid dimensions specified for trim operation";t.inputSequence.splice(r),t.matchSequence.splice(e),t.resolvedDistances.splice(r);let o=this.getTrueIndex(r-1,e-1,this.diagonalWidth);for(let a=o.col;a<=2*this.diagonalWidth;a++){let n=o.row-(a-o.col);if(n<0)break;if(a<0)t.resolvedDistances[n]=Array(2*t.diagonalWidth+1).fill(Number.MAX_VALUE);else{let d=2*this.diagonalWidth-a,p=t.resolvedDistances[n].splice(0,a+1),s=Array(d).fill(Number.MAX_VALUE);t.resolvedDistances[n]=p.concat(s)}}return t}static forDiagonalOfAxis(r,e,t,o){let a=t-e<r?t-e+r:2*r,n=e-r,d=n<0?0:n;for(let p=d-n;p<=a;p++)o(n+p,p)}addInputChar(r){let e=new P(this),t=e.inputSequence.length;e.inputSequence.push(r);let o=Array(2*e.diagonalWidth+1).fill(Number.MAX_VALUE);return e.resolvedDistances[t]=o,e.matchSequence.length==0||P.forDiagonalOfAxis(e.diagonalWidth,t,e.matchSequence.length-1,function(a,n){o[n]=P.initialCostAt(e,t,a)}),e}addMatchChar(r){let e=new P(this),t=e.matchSequence.length;return e.matchSequence.push(r),e.inputSequence.length==0||P.forDiagonalOfAxis(e.diagonalWidth,t,e.inputSequence.length-1,function(o,a){var n=e.resolvedDistances[o];n[2*e.diagonalWidth-a]=P.initialCostAt(e,o,t)}),e}increaseMaxDistance(){let r=new P(this);if(r.diagonalWidth++,r.inputSequence.length<1||r.matchSequence.length<1)return r;function e(o,a,n,d){let p=2*(r.diagonalWidth-1),s=n.length-1;p=p<s-o?p:s-o;for(let l=0;l<=p;l++)a==n[o+l].key&&d(o+l,l)}x(e,"forPossibleTranspositionsInDiagonal");for(let o=0;o<r.inputSequence.length;o++){let a=Number.MAX_VALUE,n=o-r.diagonalWidth;if(n>=0){let p=n==0?o+2:Number.MAX_VALUE;a=P.initialCostAt(r,o,n,p,void 0);let s=a;if(n<r.matchSequence.length-1){P.propagateUpdateFrom(r,o,n+1,s+1,0);let l=o+2;if(o+2<this.inputSequence.length){let B=r.inputSequence[o+1].key;e(n+3,B,r.matchSequence,function(h,k){P.propagateUpdateFrom(r,l,h,s+k+2,k)})}}}let d=Number.MAX_VALUE;if(n=o+r.diagonalWidth,n<r.matchSequence.length){let p=o==0?n+2:Number.MAX_VALUE;var t=r.getCostAt(o,n-1,this.diagonalWidth)+1;d=P.initialCostAt(r,o,n,t,p);let s=d;if(o<r.inputSequence.length-1){P.propagateUpdateFrom(r,o+1,n,s+1,2*this.diagonalWidth);let l=n+2;if(n+2<this.matchSequence.length){let B=r.matchSequence[o+1].key;e(o+3,B,r.inputSequence,function(h,k){let c=2*(r.diagonalWidth-1)-k;P.propagateUpdateFrom(r,h,l,s+k+2,c)})}}}r.resolvedDistances[o]=[a].concat(r.resolvedDistances[o],d)}return r}static propagateUpdateFrom(r,e,t,o,a){if(o<r.resolvedDistances[e][a])r.resolvedDistances[e][a]=o;else return;let n=e<r.inputSequence.length-1,d=t<r.matchSequence.length-1;if(a<2*(r.diagonalWidth-1)&&d){let p=o+1;this.propagateUpdateFrom(r,e,t+1,p,a+1)}if(a>0&&n){let p=o+1;this.propagateUpdateFrom(r,e+1,t,p,a-1)}if(n&&d){let p=o+(r.inputSequence[e+1].key==r.matchSequence[t+1].key?0:1);this.propagateUpdateFrom(r,e+1,t+1,p,a);let s=-1;for(let B=e+2;B<r.inputSequence.length;B++)if(r.inputSequence[B].key==r.matchSequence[t+1].key){s=B;break}let l=-1;for(let B=t+2;B<r.matchSequence.length;B++)if(r.matchSequence[B].key==r.inputSequence[e+1].key){l=B;break}if(s>0&&l>0){let B=o+(s-e-2)+1+(l-t-2);this.propagateUpdateFrom(r,s,l,B,r.diagonalWidth-1+l-s)}}}get mapKey(){let r=this.inputSequence.map(t=>t.key).join(""),e=this.matchSequence.map(t=>t.key).join("");return r+D+e+D+this.diagonalWidth}get lastInputEntry(){return this.inputSequence[this.inputSequence.length-1]}get lastMatchEntry(){return this.matchSequence[this.matchSequence.length-1]}static computeDistance(r,e,t=1){let o=new P;t=t||1,o.diagonalWidth=t;for(let a=0;a<r.length;a++)o=o.addInputChar(r[a]);for(let a=0;a<e.length;a++)o=o.addMatchChar(e[a]);return o}};x(P,"ClassicalDistanceCalculation");var K=P;var _e=1,Fe=5,Or=5,re=class re{constructor(r){this.timeSpent=0;this.eventCount=0;this.timeSquared=0;this.nearOutliers=[];this.outliers=[];this.preventOutliers=!1;this.preventOutliers=!!r}add(r){if(r<0)throw new Error("time may not be negative");this.eventCount++,this.timeSpent+=r,this.timeSquared+=r*r,r>=_e&&(this.nearOutliers.length<Fe||this.nearOutliers[Fe-1]<r)&&(this.nearOutliers.push(r),this.nearOutliers.sort((e,t)=>t-e)),this.checkForOutlier()}checkForOutlier(){if(this.preventOutliers||this.eventCount<4||this.nearOutliers.length==0)return;let r=this.nearOutliers[0];this.timeSpent-=r,this.timeSquared-=r*r,this.eventCount--;let e=this.average,t=r-e,o=this.variance,a=t*t/o;a>=49||this.eventCount>=8&&a>=9?(this.nearOutliers.shift(),this.outliers.push(r)):(this.timeSpent+=r,this.timeSquared+=r*r,this.eventCount++)}get average(){return this.timeSpent/this.eventCount}get variance(){let r=this.eventCount;return r<=1?NaN:this.timeSquared/r-this.timeSpent*this.timeSpent/(r*r)}get outlierTime(){let r=0;for(let e=0;e<this.outliers.length;e++)r+=this.outliers[e];return r}};x(re,"ExecutionBucket");var pr=re,ee=class ee{constructor(r,e){this.bucket=r,this.finalizer=e,this.start=performance.now()}end(){var r,e;this.finish=performance.now(),(r=this.bucket)==null||r.add(this.duration),(e=this.finalizer)==null||e.call(this)}get duration(){var r;return((r=this.finish)!=null?r:performance.now())-this.start}};x(ee,"ExecutionSpan");var Q=ee,te=class te{constructor(r,e){this.buckets={};this.deferBucket=new pr(!0);this.activeSpan=null;this.spanSinceLastDefer=null;this.trueStart=performance.now(),this.maxExecutionTime=r,this.maxTrueTime=e,this.spanSinceLastDefer=new Q}validateStart(){if(this.activeSpan)throw new Error("illegal state - span-based timer still pending")}getBucket(r){r!=null||(r=-1);let e=this.buckets[r];return e||(e=this.buckets[r]=new pr),e}get executionTime(){let r=Object.values(this.buckets),e=0;for(let t of r)e+=t.timeSpent;return e}get deferredTime(){let r=Object.values(this.buckets),e=0;for(let t of r)e+=t.outlierTime;return e+=this.deferBucket.timeSpent,e}time(r,e){this.validateStart();let t=performance.now(),o=r(),a=performance.now()-t;return this.getBucket(e).add(a),o}defer(r){return V(this,null,function*(){this.validateStart(),r!=null||(r=0),this.activeSpan=new Q(this.deferBucket,()=>this.activeSpan=null),yield Rr(r),this.activeSpan.end(),this.spanSinceLastDefer=new Q})}get timeSinceLastDefer(){return this.spanSinceLastDefer.duration}start(r){this.validateStart();let e=this.getBucket(r);return this.activeSpan=new Q(e,()=>{this.activeSpan=null}),this.activeSpan}terminate(){this.maxTrueTime=0}get elapsed(){return performance.now()-this.trueStart>=this.maxTrueTime?!0:this.executionTime>=this.maxExecutionTime}};x(te,"ExecutionTimer");var sr=te;var Cr=x(function(i,r){return i.currentCost-r.currentCost},"QUEUE_NODE_COMPARATOR");var H=class H{constructor(r,e){this.toKey=x(r=>r,"toKey");if(e=e||(t=>t),r instanceof H){let t=r;this.calculation=t.calculation,this.currentTraversal=t.currentTraversal,this.priorInput=t.priorInput,this.toKey=t.toKey}else this.calculation=new K,this.currentTraversal=r,this.priorInput=[],this.toKey=e}get knownCost(){return this.calculation.getHeuristicFinalCost()}get inputSamplingCost(){if(this._inputCost!==void 0)return this._inputCost;{let r=O.MIN_KEYSTROKE_PROBABILITY;return this._inputCost=this.priorInput.map(e=>e.p>r?e.p:r).reduce((e,t)=>e-Math.log(t),0),this._inputCost}}get currentCost(){return O.EDIT_DISTANCE_COST_SCALE*this.knownCost+this.inputSamplingCost}buildInsertionEdges(){let r=[];for(let e of this.currentTraversal.children()){let t=e.traversal(),o={key:e.char,traversal:t},a=this.calculation.addMatchChar(o),n=new H(this);n.calculation=a,n.priorInput=this.priorInput,n.currentTraversal=t,r.push(n)}return r}buildDeletionEdges(r){let e=[];for(let t of r){if(t.p<r[0].p*Math.exp(-O.EDIT_DISTANCE_COST_SCALE))break;let o=this.calculation,a=t.sample;a.deleteLeft&&(o=o.getSubset(o.inputSequence.length-a.deleteLeft,o.matchSequence.length));let n=this.priorInput.slice(0);n.push(t);for(let p=0;p<a.insert.length;p++){let s=a.insert[p];R(s)&&(p++,s=s+a.insert[p]);let l=this.toKey(s);l&&(o=o.addInputChar({key:l}))}let d=new H(this);d.calculation=o,d.priorInput=n,e.push(d)}return e}buildSubstitutionEdges(r){let e=this.buildDeletionEdges(r),t=[];for(let o of this.currentTraversal.children())for(let a of e){let n=o.traversal(),d={key:o.char,traversal:n},p=a.calculation.addMatchChar(d),s=new H(this);s.calculation=p,s.priorInput=a.priorInput,s.currentTraversal=n,t.push(s)}return t}get pathKey(){let r=this.priorInput.map(t=>"+"+t.sample.insert+"-"+t.sample.deleteLeft).join(""),e=this.calculation.matchSequence.map(t=>t.key).join("");return r+D+e}get resultKey(){return this.calculation.matchSequence.map(r=>r.key).join("")}get isFullReplacement(){return this.knownCost&&this.knownCost==this.priorInput.length}};x(H,"SearchNode");var Lr=H,oe=class oe{constructor(r,e){this.processed=[];if(typeof r=="number"){this.index=r,this.correctionQueue=new m(Cr,e);return}else this.index=r.index,this.processed=[].concat(r.processed),this.correctionQueue=new m(r.correctionQueue)}increaseMaxEditDistance(){let r=this.correctionQueue.toArray();r.forEach(function(e){e.calculation=e.calculation.increaseMaxDistance()}),this.correctionQueue=new m(Cr,r)}};x(oe,"SearchSpaceTier");var xr=oe,ae=class ae{constructor(r){this.resultNode=r}get inputSequence(){return this.resultNode.priorInput}get matchSequence(){return this.resultNode.calculation.matchSequence}get matchString(){return this.resultNode.resultKey}get knownCost(){return this.resultNode.knownCost}get inputSamplingCost(){return this.resultNode.inputSamplingCost}get totalCost(){return this.resultNode.currentCost}get finalTraversal(){return this.resultNode.currentTraversal}};x(ae,"SearchResult");var lr=ae,U=class U{constructor(r){this.tierOrdering=[];this.inputSequence=[];this.minInputCost=[];this.returnedValues={};this.processedEdgeSet={};if(this.buildQueueSpaceComparator(),r instanceof U){this.inputSequence=[].concat(r.inputSequence),this.minInputCost=[].concat(r.minInputCost),this.rootNode=r.rootNode,this.completedPaths=[].concat(r.completedPaths),this.returnedValues=v({},r.returnedValues),this.processedEdgeSet=v({},r.processedEdgeSet),this.tierOrdering=r.tierOrdering.map(o=>new xr(o)),this.selectionQueue=new m(this.QUEUE_SPACE_COMPARATOR,this.tierOrdering);return}let e=r;if(e){if(!e.traverseFromRoot)throw"The provided model does not implement the \`traverseFromRoot\` function, which is needed to support robust correction searching."}else throw"The LexicalModel parameter must not be null / undefined.";this.selectionQueue=new m(this.QUEUE_SPACE_COMPARATOR),this.rootNode=new Lr(e.traverseFromRoot(),e.toKey?e.toKey.bind(e):null),this.completedPaths=[this.rootNode];let t=new xr(0,[this.rootNode]);this.tierOrdering.push(t),this.selectionQueue.enqueue(t)}buildQueueSpaceComparator(){let r=this;this.QUEUE_SPACE_COMPARATOR=function(e,t){let o=e.correctionQueue.peek(),a=t.correctionQueue.peek(),n=e.index,d=t.index,p=0,s=1;if(d<n){let l=d;d=n,n=l,s=-1}for(let l=n;l<d;l++)p=p+r.minInputCost[l];return o&&a?o.currentCost-a.currentCost+s*p:a?1:-1}}increaseMaxEditDistance(){this.tierOrdering.forEach(function(r){r.increaseMaxEditDistance()})}addInput(r){this.inputSequence.push(r),this.minInputCost.push(-Math.log(r[0].p));let e=[],t=this.completedPaths.map(function(a){let n=a.buildDeletionEdges(r),d=a.buildSubstitutionEdges(r);return n.concat(d)});this.completedPaths=[],this.returnedValues={},t.forEach(function(a){e=e.concat(a)});let o=new xr(this.tierOrdering.length,e);this.tierOrdering.push(o),this.selectionQueue.enqueue(o)}removeLastInput(){}hasNextMatchEntry(){let r=this.selectionQueue.peek();return r?r.correctionQueue.count>0:!1}handleNextNode(){if(!this.hasNextMatchEntry())return{type:"none"};let r=this.selectionQueue.dequeue(),e=r.correctionQueue.dequeue(),t={type:"intermediate",cost:e.currentCost};if(this.processedEdgeSet[e.pathKey])return this.selectionQueue.enqueue(r),t;this.processedEdgeSet[e.pathKey]=!0;let o=!1;if(e.knownCost>2)return t;e.knownCost==2&&(o=!0);let a=0;for(let n=0;n<=r.index;n++)a+=this.minInputCost[n];if(e.currentCost>a+2.5*U.EDIT_DISTANCE_COST_SCALE)return t;if(!o){let n=e.buildInsertionEdges();r.correctionQueue.enqueueAll(n)}if(r.index==this.tierOrdering.length-1)return this.completedPaths.push(e),this.selectionQueue.enqueue(r),{type:"complete",cost:e.currentCost,finalNode:e};{let n=this.tierOrdering[r.index+1],d=n.index,p=[];o||(p=e.buildDeletionEdges(this.inputSequence[d-1]));let s=e.buildSubstitutionEdges(this.inputSequence[d-1]);n.correctionQueue.enqueueAll(p.concat(s)),this.selectionQueue=new m(this.QUEUE_SPACE_COMPARATOR,this.tierOrdering)}return t}getBestMatches(r){return me(this,null,function*(){let e={},t=Object.values(this.returnedValues);if(t.length>0){let o=new m(Cr,t);for(;o.count>0;){let a=r.time(()=>{let n=o.dequeue();return n.isFullReplacement?null:(e[n.resultKey]=n,new lr(n))},0);if(a){let n=r.start(1);yield a,n.end(),r.timeSinceLastDefer>Or&&(yield new cr(r.defer()))}}}do{let o=r.time(()=>{var n,d;let a=this.handleNextNode();if(a.type=="none")return null;if(a.type=="complete"){if(a.finalNode.isFullReplacement)return null;let s=a.finalNode;if(((d=(n=e[s.resultKey])==null?void 0:n.currentCost)!=null?d:Number.MAX_VALUE)>s.currentCost)return e[s.resultKey]=s,this.returnedValues[s.resultKey]=s,new lr(s)}return null},2);if(o){let a=r.start(1);yield o,a.end()}r.timeSinceLastDefer>Or&&(yield new cr(r.defer()))}while(!r.elapsed&&this.hasNextMatchEntry());return null})}};x(U,"SearchSpace"),U.EDIT_DISTANCE_COST_SCALE=5,U.MIN_KEYSTROKE_PROBABILITY=1e-4,U.DEFAULT_ALLOTTED_CORRECTION_TIME_INTERVAL=33;var O=U;var ne=class ne{static isWhitespace(r){let e=/^[\\u0009\\u000A\\u000D\\u0020\\u00a0\\u1680\\u2000\\u2001\\u2002\\u2003\\u2004\\u2005\\u2006\\u2007\\u2008\\u2009\\u200a\\u200b\\u2028\\u2029\\u202f\\u205f\\u3000]+$/i;return r.insert.match(e)!=null}static isBackspace(r){return r.insert==""&&r.deleteLeft>0&&!r.deleteRight}static isEmpty(r){return r.insert==""&&r.deleteLeft==0&&!r.deleteRight}};x(ne,"TransformUtils");var f=ne;function Se(i,r){let e=[];for(let t=0;t<i.kmwLength();t++){let a={insert:i.kmwCharAt(t),deleteLeft:0,id:r};e.push(a)}return e}x(Se,"textToCharTransforms");var pe=class pe{};x(pe,"TrackedContextSuggestion");var ie=pe,se=class se{constructor(){this.transformDistributions=[];this.activeReplacementId=-1}get currentText(){return this.replacementText===void 0||this.replacementText===null?this.raw:this.replacementText}get replacement(){let r=this.activeReplacementId;return this.replacements.find(function(e){return e.suggestion.id==r})}revert(){delete this.activeReplacementId}};x(se,"TrackedContextToken");var T=se,Fr=class Fr{constructor(r){this.searchSpace=[];if(r instanceof Fr){let e=r;this.tokens=e.tokens.map(function(o){let a=new T;return a.raw=o.raw,a.replacements=[].concat(o.replacements),a.activeReplacementId=o.activeReplacementId,a.transformDistributions=[].concat(o.transformDistributions),o.replacementText&&(a.replacementText=o.replacementText),a}),this.indexOffset=0;let t=this.model=r.model;this.taggedContext=r.taggedContext,t!=null&&t.traverseFromRoot&&(this.searchSpace=r.searchSpace.map(o=>new O(o)))}else{let e=r;this.tokens=[],this.indexOffset=Number.MIN_SAFE_INTEGER,this.model=e,e&&e.traverseFromRoot&&(this.searchSpace=[new O(e)])}}get head(){return this.tokens[0]}get tail(){return this.tokens[this.tokens.length-1]}popHead(){this.tokens.splice(0,2),this.indexOffset-=1}pushTail(r){this.model&&this.model.traverseFromRoot?this.searchSpace=[new O(this.model)]:this.searchSpace=[],this.tokens.push(r);let e=this;e.searchSpace.length>0&&r.transformDistributions.forEach(t=>e.searchSpace[0].addInput(t))}pushWhitespaceToTail(r=null){let e=new T;e.transformDistributions=r?[r]:[],e.raw=null,this.tokens.push(e)}replaceTailForBackspace(r,e){this.tokens.pop();let t=Se(r,e).map(function(a){return[{sample:a,p:1}]}),o=new T;o.raw=r,o.transformDistributions=t,this.pushTail(o)}updateTail(r,e){let t=this.tail;e=e||(e===""?"":t.raw),r&&r.length>0&&(t.transformDistributions.push(r),this.searchSpace&&this.searchSpace.forEach(o=>o.addInput(r))),t.raw=e}toRawTokenization(){let r=[];for(let e of this.tokens)e.currentText!==null&&r.push(e.currentText);return r}};x(Fr,"TrackedContextState");var X=Fr,Br=class Br{constructor(r=Br.DEFAULT_ARRAY_SIZE){this.currentHead=0;this.currentTail=0;this.circle=Array(r)}get count(){let r=this.currentHead-this.currentTail;return r<0&&(r=r+this.circle.length),r}get maxCount(){return this.circle.length}get oldest(){if(this.count!=0)return this.item(0)}get newest(){if(this.count!=0)return this.item(this.count-1)}enqueue(r){var e=null;let t=(this.currentHead+1)%this.maxCount;return t==this.currentTail&&(e=this.circle[this.currentTail],this.currentTail=(this.currentTail+1)%this.maxCount),this.circle[this.currentHead]=r,this.currentHead=t,e}dequeue(){if(this.currentTail==this.currentHead)return null;{let r=this.circle[this.currentTail];return this.currentTail=(this.currentTail+1)%this.maxCount,r}}popNewest(){if(this.currentTail==this.currentHead)return null;{let r=this.circle[this.currentHead];return this.currentHead=(this.currentHead-1+this.maxCount)%this.maxCount,r}}item(r){if(r>=this.count)throw"Invalid array index";let e=(this.currentTail+r)%this.maxCount;return this.circle[e]}};x(Br,"CircularArray"),Br.DEFAULT_ARRAY_SIZE=5;var de=Br,kr=class kr extends de{static attemptMatchContext(r,e,t){let o=e.toRawTokenization(),n=K.computeDistance(o.map(W=>({key:W})),r.map(W=>({key:W})),1).editPath(),d=!1,p=!1;if(n.length>1){if(n[0]=="insert"&&!(n[1]=="substitute"&&n.length==2)||n[0].indexOf("transpose")>=0)return null;n[0]=="delete"&&(d=!0)}let s=n.length-1,l=!1;if(n[s]=="delete"||n[0].indexOf("transpose")>=0||(n[s]=="insert"?p=!0:s>0&&n[s-1]=="insert"&&n[s]=="substitute"&&(p=!0,l=!0),s>0&&n[s-1]=="delete"&&n[s]=="substitute"))return null;for(let W=1;W<n.length-(l?2:1);W++)if(n[W]!="match")return null;let B;p?(l&&(e.tail.replacementText=r[r.length-2]),B=new X(e)):B=t?new X(e):e;let k=t&&Array.isArray(t)?t[0].sample:null;k&&k.insert==""&&k.deleteLeft==0&&!k.deleteRight&&(k=null);let c=k&&f.isWhitespace(k),L=k&&f.isBackspace(k),F=r[r.length-1];function Pr(){c&&n[s]=="match"||(L?B.replaceTailForBackspace(F,k.id):B.updateTail(k?t:null,F))}if(x(Pr,"maintainLastToken"),n.length>1)if(d&&B.popHead(),p){let W=r[r.length-1],I=new T;I.raw=W,c||!k?(B.pushWhitespaceToTail(t!=null?t:[]),I.transformDistributions=[]):(B.pushWhitespaceToTail(),I.transformDistributions=t?[t]:[]),B.pushTail(I)}else Pr();else if(n[s]=="insert"){let W=new T;W.raw=r[0],W.transformDistributions=[t],B.pushTail(W)}else Pr();return B}static modelContextState(r,e,t){let o=r.map(function(n){let d=new T;return d.raw=n,d.raw?d.transformDistributions=Se(d.raw).map(function(p){return[{sample:p,p:1}]}):d.transformDistributions=[],d}),a=new X(t);for(o.length>0&&a.pushTail(o.splice(0,1)[0]);o.length>0;)a.pushWhitespaceToTail(),a.pushTail(o.splice(0,1)[0]);if(a.tokens.length==0){let n=new T;n.raw="",a.pushTail(n)}return a}analyzeState(r,e,t){if(!r.traverseFromRoot)throw"This lexical model does not provide adequate data for correction algorithms and context reuse";let o=q(r.wordbreaker||C,e);if(o.left.length>0)for(let n=this.count-1;n>=0;n--){let d=this.item(n),p=d.taggedContext;if(p&&t&&t.length>0){if(g(t[0].sample,p).left!=e.left)continue}else if((p==null?void 0:p.left)!=e.left)continue;let s=kr.attemptMatchContext(o.left,this.item(n),t);if(s)return this.newest!=s&&this.newest!=d&&this.enqueue(d),s.taggedContext=e,s!=this.item(n)&&this.enqueue(s),s}let a=kr.modelContextState(o.left,t,r);return a.taggedContext=e,this.enqueue(a),a}clearCache(){for(;this.count>0;)this.dequeue()}};x(kr,"ContextTracker");var ur=kr;var b=class b{constructor(r,e){this.SUGGESTION_ID_SEED=0;this.testMode=!1;this.verbose=!0;this.lexicalModel=r,r.traverseFromRoot&&(this.contextTracker=new ur),this.punctuation=b.determinePunctuationFromModel(r),this.testMode=!!e}predictFromCorrections(r,e){let t=[];for(let o of r){let a=this.lexicalModel.predict(o.sample,e),{sample:n,p:d}=o,p=this.wordbreak(g(o.sample,e)),s=a.map(l=>(n.id!==void 0&&(l.sample.transformId=n.id),{prediction:l,correction:{sample:p,p:d},totalProb:l.p*d}),this);t=t.concat(s)}return t}predict(r,e){return V(this,null,function*(){var xe;let t=[],o=this.lexicalModel,a=this.punctuation;(xe=this.activeTimer)==null||xe.terminate(),r instanceof Array?r.length==0&&r.push({sample:{insert:"",deleteLeft:0},p:1}):r=[{sample:r,p:1}];let n=r.sort(function(u,y){return y.p-u.p})[0].sample,d=f.isWhitespace(n),p=f.isBackspace(n),s=g(n,e),l=this.wordbreak(s),B=null,h=[],k,c=null;if(this.contextTracker){let u=this.contextTracker.analyzeState(this.lexicalModel,e,null);c=this.contextTracker.analyzeState(this.lexicalModel,s,f.isEmpty(n)?null:r);let y=c.searchSpace[0],A=0,E=c.tokens,Z=E.length,w=E.length-u.tokens.length;Z==0||w>0?(A=0,f.isWhitespace(n)&&(k=n,e=s,u=c)):w<0?A=this.wordbreak(s).kmwLength()+n.deleteLeft:A=this.wordbreak(e).kmwLength();let Dr=E[E.length-1].transformDistributions.length<=1,Be=O.DEFAULT_ALLOTTED_CORRECTION_TIME_INTERVAL,ke=this.activeTimer=new sr(this.testMode?Number.MAX_VALUE:Be,this.testMode?Number.MAX_VALUE:Be*1.5),Wr,ue={};try{for(var fo=fe(y.getBestMatches(ke)),Eo,go,Oo;Eo=!(go=yield fo.next()).done;Eo=!1){let J=go.value;let De={insert:J.matchString,deleteLeft:A,id:n.id},he=J.totalCost;Dr&&(he*=b.SINGLE_CHAR_KEY_PROB_EXPONENT);let ye={sample:De,p:Math.exp(-he)},Tr=this.predictFromCorrections([ye],e);Tr.length>0&&Wr===void 0&&(Wr=-Math.log(ye.p));let Pe=ue[J.matchString];Pe&&(h=h.filter($=>!Pe.find(wr=>$.prediction.sample==wr.sample))),ue[J.matchString]=Tr.map($=>$.prediction),h=h.concat(Tr);let br=J.totalCost;if(br>=Wr+8)break;if(h.length>=b.MAX_SUGGESTIONS){if(br>=Wr+4)break;if(h.sort(function($,wr){return wr.totalProb-$.totalProb}),h[b.MAX_SUGGESTIONS-1].totalProb>Math.exp(-br))break}}}catch(go){Oo=[go]}finally{try{Eo&&(go=fo.return)&&(yield go.call(fo))}finally{if(Oo)throw Oo[0]}}this.activeTimer==ke&&(this.activeTimer=null)}else{let u;d?(u=[{sample:n,p:1}],k=n):u=r.map(y=>{let A=y.sample;return f.isWhitespace(A)&&!d||f.isBackspace(A)&&!p?null:y}),u=u.filter(y=>!!y),h=this.predictFromCorrections(u,e)}let L={},F=null;o.languageUsesCasing&&(F=this.detectCurrentCasing(s));let Pr=this.wordbreak(e);for(let u of h){let y=u.prediction.sample,A=u.totalProb,E=y.displayAs,Z=E==l;if(this.lexicalModel.languageUsesCasing&&(Z=Z||E==this.lexicalModel.applyCasing("lower",l)),Z)if(B)B.p&&A&&(B.p+=A);else{let w=y.transform,le={insert:l,deleteLeft:w.deleteLeft,deleteRight:w.deleteRight,id:w.id},Dr=_(le,A);B=this.toAnnotatedSuggestion(Dr,"keep",G.noQuotes),B.matchesModel=!0,B.transformId=y.transformId}else{F&&F!="lower"&&(this.applySuggestionCasing(y,Pr,F),E=y.displayAs);let w=L[E];w?w.totalProb+=A:L[E]=u}}if(!B&&l!=""){let u=v({},n),y=_(u,1);y.displayAs=l,B=this.toAnnotatedSuggestion(y,"keep"),B.matchesModel=!1}for(let u in L){let y=L[u];t.push(y)}t=t.sort(function(u,y){return y.totalProb-u.totalProb}),B&&B.matchesModel?B.autoAccept=!0:this.predictionAutoSelect(t);let W=t.splice(0,b.MAX_SUGGESTIONS).map(u=>{let y=u.prediction;return this.verbose?Nr(v({},y.sample),{p:u.totalProb,"lexical-p":y.p,"correction-p":u.correction.p}):Nr(v({},y.sample),{p:u.totalProb})});B&&(W=[B].concat(W));let I=this;return W.forEach(function(u){let y=I.tokenize(e);if(y&&y.caretSplitsToken?u.transform.insert+=a.insertAfterWord:e.right?a.insertAfterWord!=""&&e.right.indexOf(a.insertAfterWord)!=0&&(u.transform.insert+=a.insertAfterWord):u.transform.insert+=a.insertAfterWord,k){let A=tr(k,u.transform);A.id=u.transformId;let E=u;E.transform=A}u.id=I.SUGGESTION_ID_SEED,I.SUGGESTION_ID_SEED++}),c&&(c.tail.replacements=W.map(function(u){return{suggestion:u,tokenWidth:1}})),W})}predictionAutoSelect(r){if(r.length==0)return;if(r.length==1){r[0].prediction.sample.autoAccept=!0;return}let e=r[0];if(e.correction.sample.length==0||r.reduce((d,p)=>(d==null?void 0:d.correction.p)>p.correction.p?d:p,null).correction.p>e.correction.p)return;let a=r.reduce((d,p)=>d+p.totalProb,0);e.totalProb/a<.66||(e.prediction.sample.autoAccept=!0)}applySuggestionCasing(r,e,t){let o=e.kmwLength()-r.transform.deleteLeft;o>0&&(r.transform.deleteLeft+=o,r.transform.insert=e.kmwSubstr(0,o)+r.transform.insert),r.transform.insert=this.lexicalModel.applyCasing(t,r.transform.insert),r.displayAs=this.lexicalModel.applyCasing(t,r.displayAs)}toAnnotatedSuggestion(r,e,t=G.default){let o=G,a=o.noQuotes;return(e=="keep"||e=="revert")&&(a=o.useQuotes),{transform:r.transform,transformId:r.transformId,displayAs:o.apply(t,r.displayAs,this.punctuation,a),tag:e,p:r.p}}static determinePunctuationFromModel(r){let e=Ue;if(!r.punctuation)return e;let t=r.punctuation,o=t.insertAfterWord;o!==""&&!o&&(o=e.insertAfterWord);let a=t.quotesForKeepSuggestion;a||(a=e.quotesForKeepSuggestion);let n=t.isRTL;return{insertAfterWord:o,quotesForKeepSuggestion:a,isRTL:n}}acceptSuggestion(r,e,t){let o=r.transform,a=e.left.kmwSubstr(-o.deleteLeft,o.deleteLeft),n=o.insert.kmwLength(),d={insert:a,deleteLeft:n},p=e;t&&(d=tr(d,t),p=g(t,p));let s,l=this.tokenize(p);l?(l.left.length>0?s=l.left[l.left.length-1]:s="",s+=l.caretSplitsToken?l.right[0]:""):s=this.wordbreak(p);let B=_(d);B.displayAs=s;let h=this.toAnnotatedSuggestion(B,"revert");if(r.transformId!=null&&(h.transformId=-r.transformId),r.id!=null?h.id=-r.id:(h.id=-this.SUGGESTION_ID_SEED,this.SUGGESTION_ID_SEED++),this.contextTracker){let k=this.contextTracker.newest;k||(k=this.contextTracker.analyzeState(this.lexicalModel,e)),k.tail.activeReplacementId=r.id;let c=g(r.transform,e);this.contextTracker.analyzeState(this.lexicalModel,c)}return h}applyReversion(r,e){return V(this,null,function*(){let t=this,o=x(function(){return V(this,null,function*(){let d=g(r.transform,e),p=yield t.predict({insert:"",deleteLeft:0},d);return p.forEach(function(s){s.transformId=-r.transformId}),p})},"fallbackSuggestions");if(!this.contextTracker)return o();let a=!1;for(let d=this.contextTracker.count-1;d>=0;d--)if(this.contextTracker.item(d).tail.activeReplacementId==-r.id){a=!0;break}if(!a)return o();for(;this.contextTracker.newest.tail.activeReplacementId!=-r.id;)this.contextTracker.popNewest();this.contextTracker.newest.tail.revert();let n=this.contextTracker.newest.tail.replacements.map(function(d){return d.suggestion});return n.forEach(function(d){d.transformId=-r.transformId}),n})}wordbreak(r){let e=this.lexicalModel;if(e.wordbreaker||!e.wordbreak){let t=e.wordbreaker||C;return z(t,r)}else return e.wordbreak(r)}tokenize(r){let e=this.lexicalModel;return e.wordbreaker?q(e.wordbreaker,r):null}resetContext(r){var e;(e=this.activeTimer)==null||e.terminate(),this.contextTracker&&(this.contextTracker.clearCache(),this.contextTracker.analyzeState(this.lexicalModel,r,null))}detectCurrentCasing(r){var o;let e=this.lexicalModel,t=this.wordbreak(r);if(!e.languageUsesCasing)throw"Invalid attempt to detect casing: languageUsesCasing is set to false";if(!e.applyCasing)throw"Invalid LMLayer state:  languageUsesCasing is set to true, but no applyCasing function exists";return r.casingForm=="upper"||r.casingForm=="initial"?r.casingForm:e.applyCasing("lower",t)==t?"lower":e.applyCasing("upper",t)==t?t.kmwLength()>1?"upper":"initial":e.applyCasing("initial",t)==t?"initial":(o=r.casingForm)!=null?o:null}};x(b,"ModelCompositor"),b.MAX_SUGGESTIONS=12,b.SINGLE_CHAR_KEY_PROB_EXPONENT=16;var yr=b,Ue={quotesForKeepSuggestion:{open:"\\u201C",close:"\\u201D"},insertAfterWord:" "};N();var Sr=class Sr{constructor(r={importScripts:null,postMessage:null}){this._testMode=!1;this._postMessage=r.postMessage||postMessage,this._importScripts=r.importScripts||importScripts,this.setupConfigState()}error(r,e){this.cast("error",{log:r,error:e&&e.stack?e.stack:void 0})}onMessage(r){let{message:e}=r.data;if(!e)throw new Error(\`Missing required 'message' property: \${r.data}\`);let t=r.data;if(t.message=="load"){let o=t,a=!1;if(this._currentModelSource&&o.source.type==this._currentModelSource.type&&(o.source.type=="file"&&o.source.file==this._currentModelSource.file||o.source.type=="raw"&&o.source.code==this._currentModelSource.code)&&(a=!0),a){typeof console!="undefined"&&console.warn("Duplicate model load message detected - squashing!");return}else this._currentModelSource=o.source}else t.message=="unload"&&(this._currentModelSource=null);this.state.handleMessage(t)}cast(r,e){let t=this._postMessage;t(v({message:r},e))}loadModel(r){try{let e=r.configure(this._platformCapabilities);e.leftContextCodePoints||(e.leftContextCodePoints=e.leftContextCodeUnits),e.rightContextCodePoints||(e.rightContextCodePoints=e.rightContextCodeUnits),e.leftContextCodePoints||(e.leftContextCodePoints=this._platformCapabilities.maxLeftContextCodePoints),e.rightContextCodePoints||(e.rightContextCodePoints=this._platformCapabilities.maxRightContextCodePoints||0),r.languageUsesCasing&&!r.applyCasing&&(r.applyCasing=mr);let t=this.transitionToReadyState(r);e.wordbreaksAfterSuggestions===void 0&&(e.wordbreaksAfterSuggestions=t.punctuation.insertAfterWord!=""),this.cast("ready",{configuration:e})}catch(e){this.error("loadModel failed!",e)}}loadModelFile(r){try{this._importScripts(r)}catch(e){this.error("Error occurred when attempting to load dictionary",e)}}unloadModel(){this.transitionToLoadingState()}setupConfigState(){this.state={name:"unconfigured",handleMessage:r=>{if(r.message!=="config")throw new Error(\`invalid message; expected 'config' but got \${r.message}\`);this._platformCapabilities=r.capabilities,this._testMode=!!r.testMode,this.transitionToLoadingState()}}}transitionToLoadingState(){let r=this;this.state={name:"modelless",handleMessage:e=>{if(e.message!=="load")throw new Error(\`invalid message; expected 'load' but got \${e.message}\`);if(e.source.type=="file")r.loadModelFile(e.source.file);else{let t=e.source.code;new Function("LMLayerWorker","models","correction","wordBreakers",t)(r,gr,hr,nr)}}}}transitionToReadyState(r){let e=new yr(r,this._testMode);return this.state={name:"ready",handleMessage:t=>{switch(t.message){case"predict":var{transform:o,context:p}=t;e.predict(o,p).then(l=>{this.cast("suggestions",{token:t.token,suggestions:l})});break;case"wordbreak":let s=z(r.wordbreaker||C,t.context);this.cast("currentword",{token:t.token,word:s});break;case"unload":this.unloadModel();break;case"accept":var{suggestion:a,context:p,postTransform:n}=t,d=e.acceptSuggestion(a,p,n);this.cast("postaccept",{token:t.token,reversion:d});break;case"revert":var{reversion:d,context:p}=t;e.applyReversion(d,p).then(l=>{this.cast("postrevert",{token:t.token,suggestions:l})});break;case"reset-context":var{context:p}=t;e.resetContext(p);break;default:throw new Error(\`invalid message; expected one of {'predict', 'wordbreak', 'accept', 'revert', 'reset-context', 'unload'} but got \${t.message}\`)}},compositor:e},e}static install(r){let e=new Sr({postMessage:r.postMessage,importScripts:r.importScripts.bind(r)});return r.onmessage=e.onMessage.bind(e),e.self=r,r.LMLayerWorker=e,r.models=gr,r.correction=hr,r.wordBreakers=nr,e}};x(Sr,"LMLayerWorker");var Y=Sr;typeof self!="undefined"&&"postMessage"in self&&"importScripts"in self?Y.install(self):window.LMLayerWorker=Y;})();
//# sourceMappingURL=worker-main.min.js.map
`,Ir="";var MB=class MB{static constructInstance(){return new Worker(this.asBlobURI(yr))}static asBlobURI(e){let t=js(e);t+=`
`+Ir;let n=new Blob([t],{type:"text/javascript"});return URL.createObjectURL(n)}};r(MB,"DefaultWorker");var Pe=MB;var YB=class YB{constructor(e,t){this.suggestions=e,this.transcriptionID=t}};r(YB,"ReadySuggestions");var _s=YB,OB=class OB extends X.default{constructor(t,n,s=!1){super();this._mayPredict=!0;this._mayCorrect=!0;this._state="inactive";this.recentTranscriptions=n;let i={maxLeftContextCodePoints:64,maxRightContextCodePoints:s?0:64};t&&(this.lmEngine=new Ke(i,t))}get activeModel(){return this.currentModel}get isConfigured(){return!!this.configuration}get state(){return this._state}unloadModel(){this.lmEngine.unloadModel(),delete this.currentModel,delete this.configuration,this._state="inactive",this.emit("statechange","inactive")}loadModel(t){if(!t)throw new Error("Null reference not allowed.");let n=t.path?"file":"raw",s=n=="file"?t.path:t.code;return this.currentModel=t,this.mayPredict&&(this._state="active",this.emit("statechange","active")),this.lmEngine.loadModel(s,n).then(i=>{this.configuration=i,this.mayPredict&&(this._state="configured",this.emit("statechange","configured"))}).catch(i=>{let B;i instanceof Error?B=i.message:B=String(i),console.error("Could not load model '"+t.id+"': "+B),this.currentModel=null,this._state="inactive",this.emit("statechange","inactive")})}invalidateContext(t,n){if(this.emit("invalidatesuggestions","context"),!this.currentModel||!this.configuration)return Promise.resolve([]);if(this.isActive)if(t){let s=t.buildTranscriptionFrom(t,null,!1);return this.predict_internal(s,!0,n)}else return Promise.resolve([]);else return Promise.resolve([])}wordbreak(t,n){if(!this.isActive)return null;let s=new Ut(W.from(t,!1),this.configuration,n);return this.lmEngine.wordbreak(s)}predict(t,n){return!this.isActive||!this.currentModel||!this.configuration?null:(this.emit("invalidatesuggestions","new"),this.predict_internal(t,!1,n))}applySuggestion(t,n,s){if(!n)throw"Accepting suggestions requires a destination OutputTarget instance.";if(!this.isConfigured)return console.warn("Could not apply suggestion; the corresponding model has been unloaded"),null;let i=this.getPredictionState(t.transformId);if(i){let B=W.from(i.preInput,!1);B.apply(t.transform);let c=B.buildTransformFrom(n);n.apply(c),this.emit("suggestionapplied",n),W.from(i.preInput,!1).apply(i.transform);let a=new Ut(i.preInput,this.configuration,s()),F=this.lmEngine.acceptSuggestion(t,a,i.transform);return F=F.then(o=>{let d={transform:i.transform,transformId:-i.token,displayAs:o.displayAs,id:o.id,tag:o.tag};return this.predictFromTarget(n,s()),d}),F}else return console.warn("Could not apply the Suggestion!"),null}applyReversion(t,n){if(!n)throw"Accepting suggestions requires a destination OutputTarget instance.";let s=this.getPredictionState(-t.transformId);if(!s)return console.warn("Could not apply the Suggestion!"),Promise.resolve([]);let i=W.from(s.preInput,!1);i.apply(t.transform);let B=i.buildTransformFrom(n);return n.apply(B),this.lmEngine.revertSuggestion(t,new Ut(s.preInput,this.configuration,null)).then(l=>{let a=new _s(l,B.id);return this.emit("suggestionsready",a),this.currentPromise=null,l})}predictFromTarget(t,n){if(!t)return null;let s=t.buildTranscriptionFrom(t,null,!1);return this.predict(s,n)}predict_internal(t,n,s){if(!t)return null;let i=new Ut(t.preInput,this.configuration,s);this.recordTranscription(t),n&&this.lmEngine.resetContext(i);let B=t.alternates;(!B||B.length==0)&&(B=[{sample:t.transform,p:1}]);let c=t.transform;var l=this.currentPromise=this.lmEngine.predict(B,i);return l.then(a=>{if(l==this.currentPromise){let F=new _s(a,c.id);this.emit("suggestionsready",F),this.currentPromise=null}return a})}recordTranscription(t){this.recentTranscriptions.save(t)}getPredictionState(t){return this.recentTranscriptions.get(t)}shutdown(){this.lmEngine.shutdown()}get isActive(){return this.canEnable()?(this.activeModel||!1)&&this._mayPredict:(this._mayPredict=!1,!1)}canEnable(){return!!this.lmEngine}get mayPredict(){return this._mayPredict}set mayPredict(t){if(!this.canEnable())return;let n=this._mayPredict;if(this._mayPredict=t,n!=t&&this.activeModel){let s=t?"active":"inactive";this._state=s,this.emit("statechange",s),t&&this.isConfigured&&(this._state="configured",this.emit("statechange","configured"))}}get mayCorrect(){return this._mayCorrect}set mayCorrect(t){this._mayCorrect=t}get wordbreaksAfterSuggestions(){return this.configuration.wordbreaksAfterSuggestions}tryAcceptSuggestion(t){var s;let n={shouldSwallow:!1};return this.emit("tryaccept",t,n),(s=n.shouldSwallow)!=null?s:!1}tryRevertSuggestion(){return this.emit("tryrevert"),!1}};r(OB,"LanguageProcessor");var je=OB;var IQ=10,wB=class wB{constructor(){this.map=new Map}get(e){let t=this.map.get(e);return t&&this.save(t),t}save(e){let t=e.token>=0?e.token:-e.token;this.map.delete(t),this.map.set(t,e),this.map.size>IQ&&this.map.delete(this.map.keys().next().value)}};r(wB,"TranscriptionCache");var On=wB;var wn=class wn{constructor(e,t,n){this.contextCache=new On;if(!e)throw new Error("device must be defined");n||(n=wn.DEFAULT_OPTIONS),this.contextDevice=e,this.kbdProcessor=new Oe(e,n),this.lngProcessor=new je(t,this.contextCache)}get languageProcessor(){return this.lngProcessor}get keyboardProcessor(){return this.kbdProcessor}get keyboardInterface(){return this.keyboardProcessor.keyboardInterface}get activeKeyboard(){return this.keyboardInterface.activeKeyboard}set activeKeyboard(e){this.keyboardInterface.activeKeyboard=e,this.resetContext()}get activeModel(){return this.languageProcessor.activeModel}processKeyEvent(e,t){let n=e.srcKeyboard&&this.activeKeyboard!=e.srcKeyboard,s=this.activeKeyboard;try{if(n&&(this.keyboardInterface.activeKeyboard=e.srcKeyboard),e.baseTranscriptionToken){let i=this.contextCache.get(e.baseTranscriptionToken);i?(!me(i.transform)||!i.preInput.isEqual(W.from(t)))&&t.restoreTo(i.preInput):console.warn("The base context for the multitap could not be found")}return this._processKeyEvent(e,t)}finally{n&&(this.keyboardInterface.activeKeyboard=s)}}_processKeyEvent(e,t){var d;let n=e.device.formFactor,s=e.isSynthetic;if((n==S.FormFactor.Desktop||!this.activeKeyboard||this.activeKeyboard.usesDesktopLayoutOnDevice(e.device))&&s&&this.keyboardProcessor.selectLayer(e))return new tt;if(this.keyboardProcessor.doModifierPress(e,t,!s)&&!s)return new tt;if(this.languageProcessor.isActive){if((e.kName=="K_BKSP"||e.Lcode==y.keyCodes.K_BKSP)&&this.languageProcessor.tryRevertSuggestion())return new tt;if((e.kName=="K_SPACE"||e.Lcode==y.keyCodes.K_SPACE)&&this.languageProcessor.tryAcceptSuggestion("space"))return new tt}let i=W.from(t,!0),B=this.keyboardProcessor.layerId,c=this.keyboardProcessor.processKeystroke(e,t);e.kNextLayer&&this.keyboardProcessor.selectLayer(e);let l=y.isFrameKey(e.kName);me((d=c==null?void 0:c.transcription)==null?void 0:d.transform)&&e.kNextLayer&&(l=!0);let a=c!=null;if(a){let U=l?null:this.buildAlternates(c,e,i);c.finalize(this.keyboardProcessor,t,!1),U&&U.length>0&&(c.transcription.alternates=U)}else c=new tt,c.transcription=t.buildTranscriptionFrom(t,null,!1),c.triggersDefaultCommand=!0;this.contextCache.save(c.transcription);let F=c.setStore[33]||e.kNextLayer;this.keyboardProcessor.newLayerStore.set(F?this.keyboardProcessor.layerId:""),this.keyboardProcessor.oldLayerStore.set(F?B:"");let o=this.keyboardProcessor.processPostKeystroke(this.contextDevice,t);return o&&o.finalize(this.keyboardProcessor,t,!0),c.predictionPromise=this.languageProcessor.predict(c.transcription,this.keyboardProcessor.layerId),c.triggersDefaultCommand||t.doInputEvent(),a?c:null}buildAlternates(e,t,n){let s;if(this.languageProcessor.isActive&&!e.triggersDefaultCommand){let i=t.keyDistribution,c=new Ut(n,Ut.ENGINE_RULE_WINDOW,this.keyboardProcessor.layerId).toMock();if(this.languageProcessor.isActive&&i&&t.kbdLayer){let l=Number.MAX_VALUE,a=We(),F;a.performance&&a.performance.now&&(F=r(function(){return a.performance.now()},"timer"),l=F()+16);let o=Math.exp(-5);i.sort((U,u)=>u.p-U.p),s=[];let d=0;for(let U of i){if(U.p<o){d+=U.p;break}else if(F&&F()>=l)break;let u=W.from(c,!1),g=U.keySpec;if(!g){console.warn("Internal error:  failed to properly filter set of keys for corrections");continue}let I=this.keyboardProcessor.activeKeyboard.constructKeyEvent(g,t.device,this.keyboardProcessor.stateKeys),C=this.keyboardProcessor.processKeystroke(I,u);if(C&&!C.beep&&U.p>0){let x=C.transcription.transform;x.id=e.transcription.token,s.push({sample:x,p:U.p}),d+=U.p}}s.forEach(function(U){U.p/=d})}}return s}resetContext(e){this.keyboardProcessor.resetContext(e),this.languageProcessor.invalidateContext(e,this.keyboardProcessor.layerId)}};r(wn,"InputProcessor"),wn.DEFAULT_OPTIONS={baseLayout:"us"};var _e=wn;var zB=class zB extends X.default{constructor(t,n){super();this.initNewContext=!0;this._currentSuggestions=[];this.swallowPrediction=!1;this.doRevert=!1;this.recentRevert=!1;this.doTryAccept=r((t,n)=>{let s=this.recentAcceptCause;if(!s&&this.selected)this.accept(this.selected),n.shouldSwallow=!0,this.recentAcceptCause="key";else if(s&&t=="space"){if(this.recentAcceptCause=null,s=="key"){n.shouldSwallow=!1;return}n.shouldSwallow=!!this.langProcessor.wordbreaksAfterSuggestions}else n.shouldSwallow=!1},"doTryAccept");this.doTryRevert=r(()=>{this.doRevert?(this.doRevert=!1,this.recentAcceptCause=null):this.recentAcceptCause&&(this.showRevert(),this.swallowPrediction=!0)},"doTryRevert");this.invalidateSuggestions=r(t=>{this.initNewContext=!1,this.selected=null,(!this.swallowPrediction||t=="context")&&(this.recentAcceptCause=null,this.doRevert=!1,this.recentRevert=!1,t=="context"&&(this.swallowPrediction=!1,this.initNewContext=!0)),t!="new"&&this.clearSuggestions()},"invalidateSuggestions");this.updateSuggestions=r(t=>{let n=t.suggestions;this._currentSuggestions=n,this.selected=null,this.keepSuggestion=null;for(let s of n)s.tag=="keep"&&(this.keepSuggestion=s),s.autoAccept&&!this.selected&&(this.selected=s);this.keepSuggestion&&this._currentSuggestions.splice(this._currentSuggestions.indexOf(this.keepSuggestion),1),this.swallowPrediction?this.swallowPrediction=!1:(this.recentAcceptCause=null,this.doRevert=!1,this.recentRevert=!1),this.sendUpdateEvent()},"updateSuggestions");this.onModelStateChange=r(t=>{(t=="configured"||t=="inactive")&&this.resetContext()},"onModelStateChange");this.langProcessor=t,this.kbdProcessor=n;let s=r(()=>this.currentTarget&&t.state=="configured","validSuggestionState");this.suggestionApplier=i=>s()?t.applySuggestion(i,this.currentTarget,()=>n.layerId):null,this.suggestionReverter=i=>{s()&&t.applyReversion(i,this.currentTarget)},this.postApplicationHandler=()=>{var i;n.newLayerStore.set(""),n.oldLayerStore.set(""),(i=n.processPostKeystroke(n.contextDevice,this.currentTarget))==null||i.finalize(n,this.currentTarget,!0)},this.connect()}get currentTarget(){return this._currentTarget}setCurrentTarget(t){let n=this._currentTarget;return this._currentTarget=t,n!=t?this.resetContext():Promise.resolve([])}get modelState(){return this.langProcessor.state}connect(){this.langProcessor.addListener("invalidatesuggestions",this.invalidateSuggestions),this.langProcessor.addListener("suggestionsready",this.updateSuggestions),this.langProcessor.addListener("tryaccept",this.doTryAccept),this.langProcessor.addListener("tryrevert",this.doTryRevert),this.langProcessor.addListener("statechange",this.onModelStateChange),this.langProcessor.addListener("suggestionapplied",this.postApplicationHandler)}disconnect(){this.langProcessor.removeListener("invalidatesuggestions",this.invalidateSuggestions),this.langProcessor.removeListener("suggestionsready",this.updateSuggestions),this.langProcessor.removeListener("tryaccept",this.doTryAccept),this.langProcessor.removeListener("tryrevert",this.doTryRevert),this.langProcessor.removeListener("statechange",this.onModelStateChange),this.langProcessor.removeListener("suggestionapplied",this.postApplicationHandler),this.clearSuggestions()}get currentSuggestions(){let t=[];return this.activateKeep()&&this.keepSuggestion&&this.keepSuggestion.matchesModel?t.push(this.keepSuggestion):this.doRevert&&t.push(this.revertSuggestion),t.concat(this._currentSuggestions)}acceptInternal(t){return t?t.tag=="revert"?(this.suggestionReverter(t),null):this.suggestionApplier(t):null}accept(t){let n=this;return this.selected=null,this.doRevert=!1,this.revertAcceptancePromise=this.acceptInternal(t),this.revertAcceptancePromise?(this.revertAcceptancePromise.then(function(s){s&&(n.revertSuggestion=s)}),this.recentAcceptCause="banner",this.recentRevert=!1,this.swallowPrediction=!0,this.revertAcceptancePromise):(t&&t.tag=="revert"&&(this.recentAcceptCause=null,this.recentRevert=!0),Promise.resolve(null))}showRevert(){this.doRevert=!0,this.sendUpdateEvent()}clearSuggestions(){this.updateSuggestions({suggestions:[],transcriptionID:0})}activateKeep(){return!this.recentAcceptCause&&!this.recentRevert&&!this.initNewContext}sendUpdateEvent(){this.emit("update",this.currentSuggestions)}resetContext(){let t=this.currentTarget;return t?this.langProcessor.invalidateContext(t,this.kbdProcessor.layerId):Promise.resolve([])}};r(zB,"PredictionContext");var qe=zB;var qs="Keyboard_";function et(Q){return Q.startsWith(qs)?Q:qs+Q}r(et,"prefixed");function Mt(Q){return Q.startsWith(qs)?Q.substring(qs.length):Q}r(Mt,"withoutPrefix");var DB=class DB extends X.default{constructor(t){super();this.stubSetTable={};this.keyboardTable={};this.keyboardLoader=t}getKeyboardForStub(t){return t?this.getKeyboard(t.KI):null}getKeyboard(t){if(!t)return null;let n=this.keyboardTable[et(t)];return n instanceof Promise?null:n}get defaultStub(){function t(s){let i=Object.keys(s);if(i.length!=0)return s[i[0]]}r(t,"getFirstValue");let n=t(this.stubSetTable);if(n)return t(n)}addKeyboard(t){let n=et(t.id);this.keyboardTable[n]=t,this.emit("keyboardadded",t)}fetchKeyboardForStub(t){return this.fetchKeyboard(t.KI)}isFetchingKeyboard(t){if(!t)throw new Error("Keyboard ID must be specified");return t=et(t),this.keyboardTable[t]instanceof Promise}fetchKeyboard(t){if(!t)throw new Error("Keyboard ID must be specified");if(!this.keyboardLoader)throw new Error("Cannot load keyboards; this cache was configured without a loader");t=et(t);let n=this.keyboardTable[t];if(n instanceof T)return Promise.resolve(n);if(n instanceof Promise)return n;let s=this.getStub(t,null);if(!s)throw new Error(`No stub for ${Mt(t)} has been registered`);if(!s.filename)throw new Error(`The registered stub for ${Mt(t)} lacks a path to the main keyboard file`);let i=this.keyboardLoader.loadKeyboardFromStub(s);return this.keyboardTable[t]=i,i.then(B=>{B.scriptObject.KI=t,this.addKeyboard(B)}).catch(B=>{throw delete this.keyboardTable[t],B}),i}addStub(t){var i;let n=et(t.KI),s=this.stubSetTable[n]=(i=this.stubSetTable[n])!=null?i:{};s[t.KLC]=t,this.emit("stubadded",t)}findMatchingStub(t){return this.getStub(t.KI,t.KLC)}getStub(t,n){var c;let s,i=n||"---";t instanceof T?s=t.id:s=t,s&&(s=et(s));let B=(c=this.stubSetTable[s])!=null?c:{};if(i!="---")return B[i];{let l=Object.keys(B);return l.length==0?null:B[l[0]]}}forgetKeyboard(t,n=!1){let s=t instanceof T?t.id:et(t);this.stubSetTable[s]&&delete this.stubSetTable[s],n&&this.keyboardTable[s]&&delete this.keyboardTable[s]}getStubList(){let t=[],n=Object.keys(this.stubSetTable);for(let s of n){let i=this.stubSetTable[s],B=Object.keys(i);for(let c of B)t.push(i[c])}return t}};r(DB,"StubAndKeyboardCache");var $e=DB;var KB=["World","Africa","Asia","Europe","South America","North America","Oceania","Central America","Middle East"],PB=["un","af","as","eu","sa","na","oc","ca","me"],hQ=RegExp("^(([\\.]/)|([\\.][\\.]/)|(/))|(:)");function hr(Q,e){return e=e||"",Q&&!hQ.test(Q)?e+Q:Q}r(hr,"configureFilePathing");var $s=class $s extends kt{constructor(t,n,s){var e=(...args)=>{super(...args)};if(typeof t!="string")if(t.id!==void 0){let i=t;i.id=et(i.id),e(i,s),this.KF=hr(i.filename,n),this.mapRegion(i.languages)}else{let i=t;i.KI=et(i.KI),e(i,s),this.KF=hr(i.KF,n),this.KP=i.KP,this.KR=i.KR,this.KRC=i.KRC;return}else e(et(t),n)}mapRegion(t){let n=t.region,s=0;if(typeof n=="number")n<1||n>9?s=0:s=n-1;else if(typeof n=="string"){let i=n.length==2?PB:KB;for(let B=0;B<i.length;B++)if(n.toLowerCase()==i[B].toLowerCase()){s=B;break}}this.KR=KB[s],this.KRC=PB[s]}get region(){return this.KR}get regionCode(){return this.KRC}get filename(){return this.KF}static toStubs(t,n,s){let i="";if(typeof t.language!="undefined"&&console.warn("The 'language' property for keyboard stubs has been deprecated.  Please use the 'languages' property instead."),t.languages||(t.languages=t.language),t?t.id?t.languages||(i="KeyboardStub has undefined languages"):i="KeyboardStub has undefined id":i="Stub undefined",i!="")return[{error:new Error(i)}];let B=[];Array.isArray(t.languages)?B=B.concat(t.languages):B.push(t.languages);let c=[];return B.forEach(l=>{let a=V(h({},t),{languages:l,language:void 0}),F=new $s(a,n,s);c.push(F)}),c}merge(t){this.KL||(this.KL=t.KL),this.KR||(this.KR=t.KR),this.KRC||(this.KRC=t.KRC),this.KN||(this.KN=t.KN),this.KF||(this.KF=t.KF),this.KFont||(this.KFont=t.KFont),this.KOskFont||(this.KOskFont=t.KOskFont),t._displayName&&(this._displayName||(this._displayName=t._displayName))}validateForCustomKeyboard(){return super.validateForCustomKeyboard()||!this.KF||!this.KR?new Error("To use a custom keyboard, you must specify file name, keyboard id, keyboard name, language, language code, and region."):null}};r($s,"KeyboardStub");var j=$s;function zn(Q,e){if(e.length==0)return Promise.resolve(Q);if(Q.length==0)return Promise.reject(e);{let t=Q;return Promise.resolve(t.concat(e))}}r(zn,"mergeAndResolveStubPromises");var br="The Cloud API request timed out.",jB="Could not find a keyboard with that ID.",Cr="The Cloud API failed to find an appropriate keyboard.",bQ="Error occurred while registering keyboards: ",CQ=r(function(Q){return Q+" keyboard not found."},"MISSING_KEYBOARD"),Dn=class Dn extends X.default{constructor(t,n){super();this.cloudResolutionPromises=new Map;this.languageFetchStarted=!1;this.registerFromCloud=r(t=>{let n=Number.parseInt(t.timerid),s;try{s=this._registerCore(t)}catch(i){s=new Error(bQ+i)}if(n){let i=this.cloudResolutionPromises.get(n);if(i)try{s instanceof Error?i.reject(s):i.resolve(s)}finally{this.cloudResolutionPromises.delete(n)}else{this.emit("unboundregister",s);return}}else{this.emit("unboundregister",s);return}},"registerFromCloud");this.requestEngine=t,this.pathConfig=n,this._languageListPromise=new E}get languageListPromise(){return this.languageFetchStarted||(this.languageFetchStarted=!0,this.keymanCloudRequest("",!0).catch(t=>{this.languageFetchStarted=!1,this._languageListPromise.reject(t),this._languageListPromise=new E})),this._languageListPromise.corePromise}keymanCloudRequest(t,n){let s="https://api.keyman.com/cloud/4.0/"+(arguments.length>1&&n?"languages":"keyboards"),i="?jsonp=keyman.register&languageidtype=bcp47&version="+N.CURRENT.toString(),B=s+i+t,{promise:c,queryId:l}=this.requestEngine.request(B);return this.cloudResolutionPromises.set(l,c),c.finally(()=>{this.cloudResolutionPromises.delete(l)}),c.corePromise}_registerCore(t){let n=t.options,s=n.fontBaseUri;if(this.pathConfig.fonts!=""?s=this.pathConfig.fonts:this.pathConfig.updateFontPath(s),typeof t.error=="string"){var i="";if(typeof t.options.keyboardid=="string"){let c=t.options.keyboardid;i=c.substring(0,1).toUpperCase()+c.substring(1)}return new Error(CQ(i))}if(typeof n=="undefined"||typeof n.context=="undefined")return new Error(jB);let B=[];if(n.context=="keyboard"){let c,l=t.keyboard;if(Array.isArray(l))for(c=0;c<l.length;c++)B=B.concat(Dn.registerLanguagesForKeyboard(l[c],n,c));else B=B.concat(Dn.registerLanguagesForKeyboard(l,n,0))}else if(n.context=="language"){let c=t.languages;return this._languageListPromise.resolve(c),c}return B}static registerLanguagesForKeyboard(t,n,s){let i="";if(typeof t=="undefined")return[];if(typeof n.keyboardid=="string"&&(i=n.keyboardid.split(",")[s]),Array.isArray(t))if(t.length==1||i.substr(-1,1)=="$"||i==""){let B=[];for(let c=0;c<t.length;c++)B=B.concat(this.registerLanguagesForKeyboard(t[c],n,s));return B}else{let B=0;for(let c=0;c<t.length;c++){let l=t[c].id.toLowerCase();if(l=="us"&&(l="english"),Array.isArray(t[c].languages)){let a=t[c].languages;for(let F=0;F<a.length;F++)if(l==a[F].name.toLowerCase()){B=c;break}}}return this.registerLanguagesForKeyboard(t[B],n,s)}else{let B=n.fontBaseUri||"",c=j.toStubs(t,n.keyboardBaseUri,B),l=i.split("@")[1];if(c.length==1&&typeof c[0].error!="undefined")throw c[0].error;return typeof l!="string"?c:(l=l.replace(/\$$/,""),[c.find(a=>a.KLC==l)])}}fetchCloudStubs(t){return L(this,null,function*(){if(t.length==0)return Promise.resolve([]);let n="&keyboardid=",s="";for(let B=0;B<t.length;B++)n=n+s+t[B].toString(),s=",";let i=[];try{let B=yield this.keymanCloudRequest(n,!1);return zn(B,i)}catch(B){console.error(B);let c={error:B};return i.push(c),Promise.reject(i)}})}};r(Dn,"CloudQueryEngine");var tn=Dn;var $B=class $B{constructor(e,t){this.id=e,this.language=t}toString(){let e=this.id;return this.language?(e=e+"@"+this.language,this.version&&(e=e+"@"+this.version)):this.version&&(e=e+"@@"+this.version),e}};r($B,"CloudRequestEntry");var qB=$B;function _B(Q,e){return{keyboard:{id:Q.id,name:Q.name},error:typeof e=="string"?new Error(e):e}}r(_B,"convertToErrorStub");function mr(Q,e,t){let n=new qB(Q,e);return t&&(n.version=t),n}r(mr,"toQuerySpecs");function xr(Q,e,t){if(Q.getStub(t.id,t.language)==null){for(let n=0;n<e.length;n++)if(e[n].id==t.id&&e[n].language==t.language)return!1;return!0}else return!1}r(xr,"isUniqueRequest");var tc=class tc{constructor(e,t,n){this.pathConfig=n,this.cache=new $e(e),this.cloudQueryEngine=new tn(t,this.pathConfig),this.cloudQueryEngine.on("unboundregister",s=>{Array.isArray(s)&&s.forEach(i=>{i instanceof j&&this.cache.addStub(i)})})}addKeyboardArray(e){let t=[],n=[],s=[],i=[],B=[];for(let a of e)if(typeof a=="string")a.length>0&&i.push(a);else if(a.KI||a.KL||a.KLC||a.KFont||a.KOskFont)s.push(new j(a));else{let F=a;if(typeof F.language!="undefined"&&console.warn("The 'language' property for keyboard stubs has been deprecated.  Please use the 'languages' property instead."),F.languages||(F.languages=F.language),typeof F.languages=="undefined"){let o="To use keyboard '"+F.id+"', you must specify languages.";B.push(_B(F,o))}else if(Array.isArray(F.languages)){let o=j.toStubs(F,this.pathConfig.keyboards,this.pathConfig.fonts);for(let d of o)d instanceof j?s.push(d):B.push(d)}else{let o=F;s.push(new j(o,this.pathConfig.keyboards,this.pathConfig.fonts))}}for(let a of s)if(a.KF){let F=a.validateForCustomKeyboard();F?B.push(_B(a,F)):t.push(a)}else n.push(a);let c=[];for(let a of n){if(!a.KI&&!a.KLC){B.push(_B(a,"Cannot fetch keyboard information without a keyboard ID or language code."));continue}let F=mr(Mt(a.id),a.langId);xr(this.cache,c,F)&&c.push(F)}for(let a of i){let F=a.split("@"),o=[""];F[0].toLowerCase()=="english"&&(F[0]="us"),F.length>1&&(o=F[1].split(","));for(let d=0;d<o.length;d++){if(d>0&&o[d]=="")continue;let U=mr(F[0],o[d],F[2]);xr(this.cache,c,U)&&c.push(U)}}return t.forEach(a=>this.cache.addStub(a)),this.cloudQueryEngine.fetchCloudStubs(c.map(a=>a.toString())).then(a=>{for(let F of a)F instanceof j?(this.cache.addStub(F),t.push(F)):B.push(F);return[].concat(B).concat(t)})}addLanguageKeyboards(e){return L(this,null,function*(){let t=[],n=[];try{n=yield this.cloudQueryEngine.languageListPromise}catch(B){return console.error(B),t.push({error:B}),t}let s=n,i="";for(let B=0;B<e.length;B++){let c=e[B].toLowerCase(),l=c.substr(-1,1)=="$";l&&(c=c.substr(0,c.length-1));let a=!1;for(let F=0;F<s.length;F++)if(c==s[F].name.toLowerCase()){i!=""&&(i=i+","),i=i+"@"+s[F].id,l&&(i=i+"$"),a=!0;break}if(!a){let F={language:{name:c},error:new Error(this.alertLanguageUnavailable(c))};t.push(F)}}return i==""?Promise.reject(t):this.cloudQueryEngine.keymanCloudRequest("&keyboardid="+i,!1).then(B=>L(this,null,function*(){let c=yield zn(B,t);for(let l of c)typeof l.error=="undefined"&&this.cache.addStub(l);return c}),B=>{console.error(B);let c={error:B};return t.push(c),Promise.reject(t)})})}fetchCloudCatalog(){return L(this,null,function*(){try{let e=yield this.cloudQueryEngine.keymanCloudRequest("",!1);return e.forEach(t=>this.cache.addStub(t)),e}catch(e){return Promise.reject([{error:e}])}})}alertLanguageUnavailable(e){return"No keyboards are available for "+e+". Does it have another language name?"}};r(tc,"KeyboardRequisitioner");var en=tc;var ec=class ec{constructor(){this.registeredModels={};this.languageModelMap={}}modelForLanguage(e){return this.languageModelMap[e]}register(e){if(e.id=e.id.toLowerCase(),JSON.stringify(e)==JSON.stringify(this.registeredModels[e.id]))return;this.registeredModels[e.id]=e;let t=this;e.languages.forEach(function(n){if(!n){console.warn("Null / undefined language codes are not permitted for registration.");return}t.languageModelMap[n]=e})}unregister(e){let t;if(e=e.toLowerCase(),this.registeredModels[e])t=this.registeredModels[e],delete this.registeredModels[e];else return null;let n=this;return t.languages.forEach(function(s){n.languageModelMap[s].id==e&&delete n.languageModelMap[s]}),t}isRegistered(e){return!!this.registeredModels[e.id.toLowerCase()]}};r(ec,"ModelManager");var nn=ec;function ti(Q){let e=[];for(let t=0;t<Q.length;t++)e.push(Q[t]);return e}r(ti,"arrayFromNodeList");function A(Q){let e=document.createElement(Q);return e.style.userSelect="none",e.style.webkitUserSelect="none",e}r(A,"createUnselectableElement");var nc=class nc{constructor(e,t){this.fontStyleDefinitions={};this.linkedSheets=[];this.fontPromises=[];if(!e){let n=document.getElementsByTagName("HEAD");n.length>0?e=n[0]:e=document.body}this.linkNode=e,this.doCacheBusting=t||!1}get sheets(){return this.linkedSheets.map(e=>e.sheet)}linkStylesheet(e){if(!(e instanceof HTMLLinkElement)&&!e.innerHTML)return;let t=new E;e instanceof HTMLLinkElement?e.onload=()=>t.resolve():t.resolve(),this.linkedSheets.push({sheet:e,load:t}),this.linkNode.appendChild(e)}allLoadedPromise(){return L(this,null,function*(){let e=this.linkedSheets.map(t=>t.load.corePromise);Promise.allSettled?yield Promise.allSettled(e):yield Promise.all(e)})}addStyleSheetForFont(e,t,n){if(!e||typeof e.files=="undefined")return null;let s=e.family,i,B,c="",l="",a=[],F="";n||(n=S.OperatingSystem.Other);let o=this.fontStyleDefinitions[n]=this.fontStyleDefinitions[n]||{};if(o[s]){let C=o[s];return C.parentNode||this.linkStylesheet(C),null}for(typeof e.files=="string"?a[0]=e.files:a=e.files,B=0;B<a.length;B++)a[B].toLowerCase().indexOf("data:font")==0&&(F=a[B]),a[B].toLowerCase().indexOf(".otf")>0&&(c=a[B]),a[B].toLowerCase().indexOf(".ttf")>0&&(c=a[B]),a[B].toLowerCase().indexOf(".woff")>0&&(l=a[B]);c!=""&&c.indexOf("/")<0&&(c=t+c),l!=""&&l.indexOf("/")<0&&(l=t+l);var d=`@font-face {
font-family:`+e.family+`;
font-style:normal;
font-weight:normal;
`;if(F){let x=F.substring(10,F.indexOf(";",10));d+=`src:url('${F}'), format('${x}');`}else n==S.OperatingSystem.iOS?c!=""&&(this.doCacheBusting&&(c=this.cacheBust(c)),i="url('"+encodeURI(c)+"') format('truetype')"):(l!=""&&(i="url('"+encodeURI(l)+"') format('woff')"),c!=""&&(i="url('"+encodeURI(c)+"') format('truetype')"));if(!i)return null;d+="src:"+i+";",d=d+`
}
`;let U=ie(d);o[s]=U;let g=new FontFace(e.family,i).load(),I=r(()=>{this.fontPromises=this.fontPromises.filter(C=>C!=g)},"clearPromise");return this.fontPromises.push(g.then(I).catch(I)),this.linkStylesheet(U),U}cacheBust(e){return e+"?v="+new Date().getTime()}linkExternalSheet(e,t){try{if(!t&&document.querySelector("link[href="+JSON.stringify(e)+"]")!=null)return null}catch(s){return null}let n=document.createElement("link");return n.type="text/css",n.rel="stylesheet",n.href=e,this.linkStylesheet(n),n}unlink(e){let t=this.linkedSheets.findIndex(n=>n.sheet==e);return t>-1?(this.linkedSheets.splice(t,1)[0].load.resolve(),e.parentNode.removeChild(e),!0):!1}unlinkAll(){for(let e of this.linkedSheets){let t=e.sheet;t.parentNode&&t.parentNode.removeChild(t),e.load.resolve()}this.linkedSheets.splice(0,this.linkedSheets.length)}};r(nc,"StylesheetManager");var rt=nc;function ie(Q){var e=document.createElement("style");return e.type="text/css",e.appendChild(document.createTextNode(Q)),e}r(ie,"createStyleSheet");function dt(){var Q;return typeof window.orientation!="undefined"?Q=window.orientation:typeof window.screen.orientation!="undefined"&&(Q=window.screen.orientation.angle),Q!==void 0?Math.abs(Q/90)==1:!1}r(dt,"landscapeView");var sc=class sc{constructor(e){this.name=e}load(e){return this.loadCookie(this.name,e||(t=>t))}save(e,t){this.saveCookie(this.name,e,t||(n=>n))}_loadRawCookies(){let e={};if(typeof document.cookie!="undefined"&&document.cookie!=""){let t=document.cookie.split(/;\s*/);for(let n=0;n<t.length;n++){let s=t[n].split("=");s.length==2&&(e[s[0]]=s[1])}}return e}loadCookie(e,t){let n={},i=this._loadRawCookies()[e];if(i){let B=decodeURIComponent(i).split(";");for(let c=0;c<B.length&&!(c==B.length-1&&!B[c]);c++){let l=B[c].split("=");if(l.length>1){let[a,F]=l;n[a]=t(F,a)}else n[l[0]]=""}}return n}saveCookie(e,t,n){let s="";for(let c in t)s+=c+"="+n(t[c],c)+";";let B=" path=/; expires="+new Date(new Date().valueOf()+1e3*60*60*24*30).toUTCString();document.cookie=`${e}=${encodeURIComponent(s)}; ${B}`}};r(sc,"CookieSerializer");var nt=sc;function M(Q){var e;if(!Q)return 0;var t=Q.offsetLeft?Q.offsetLeft:0;if(e=Q,e.offsetParent){for(;e.offsetParent;)e=e.offsetParent,t+=e.offsetLeft;let s=e.ownerDocument;e.style.position=="fixed"&&s&&s.scrollingElement&&(t+=s.scrollingElement.scrollLeft)}if(e&&e.ownerDocument&&Q.ownerDocument!=window.document){var n=e.ownerDocument;if(n&&n.defaultView&&n.defaultView.frameElement)return t+M(n.defaultView.frameElement)-n.documentElement.scrollLeft}return t}r(M,"getAbsoluteX");function Y(Q){var e;if(!Q)return 0;var t=Q.offsetTop?Q.offsetTop:0;if(e=Q,e.ownerDocument&&e instanceof e.ownerDocument.defaultView.HTMLElement){for(;e.offsetParent;)e=e.offsetParent,t+=e.offsetTop;let s=e.ownerDocument;e.style.position=="fixed"&&s&&s.scrollingElement&&(t+=s.scrollingElement.scrollTop)}if(e&&e.ownerDocument&&Q.ownerDocument!=window.document){var n=e.ownerDocument;if(n&&n.defaultView&&n.defaultView.frameElement)return t+Y(n.defaultView.frameElement)}return t}r(Y,"getAbsoluteY");var ic=class ic extends nt{constructor(e,t){super(`KeymanWeb_${e}_Option_${t}`)}load(){return super.load(decodeURIComponent)}save(e){super.save(e,encodeURIComponent)}};r(ic,"VarStoreSerializer");var ei=ic,Bc=class Bc{loadStore(e,t){return new ei(e,t).load()}saveStore(e,t,n){new ei(e,t).save(n)}};r(Bc,"VariableStoreCookieSerializer");var Kn=Bc;var cc=class cc extends Nt{constructor(t,n,s){super(t,n,new Kn);this.insertText=r((t,n)=>{this.resetContextCache(),this.engine.contextManager.insertText(this,t,n)},"insertText");this.KT=this.insertText;this.engine=n,this.stubNamespacer=s}preserveID(t){var n;if(document.currentScript)n=document.currentScript.id;else{var s=document.getElementsByTagName("script"),i=s[s.length-1];n=i.id}if(n)n.indexOf(Mt(t.KI))!=-1?t.KI=n:console.error("Error when registering keyboard:  current SCRIPT tag's ID does not match!");else return}registerKeyboard(t){super.registerKeyboard(t);let n=this.loadedKeyboard;this.preserveID(t),this.engine.config.deferForInitialization.then(()=>{this.engine.keyboardRequisitioner.cache.isFetchingKeyboard(n.id)||(this.engine.keyboardRequisitioner.cache.addKeyboard(n),this.loadedKeyboard=null)})}registerStub(t){var s;this.stubNamespacer&&this.stubNamespacer(t);let n=r(()=>{let i=this.engine.config.paths;return new j(t,i.keyboards,i.fonts)},"buildStub");if(!this.engine.config.deferForInitialization.isResolved)this.engine.config.deferForInitialization.then(()=>this.engine.keyboardRequisitioner.cache.addStub(n()));else{let i=n();if((s=this.engine.keyboardRequisitioner)!=null&&s.cache.findMatchingStub(i))return 1;this.engine.keyboardRequisitioner.cache.addStub(i)}return null}};r(cc,"KeyboardInterface");var Ge=cc;(function(){Ge.__publishShorthandAPI()})();var lc=class lc extends Ne{constructor(t,n){var e=(...args)=>{super(...args)};t&&t._jsGlobal!=window&&(t._jsGlobal.String=window.String),e(t||new Ie(window,An)),this.performCacheBusting=n||!1}loadKeyboardInternal(t,n,s){let i=new E;this.performCacheBusting&&(t=this.cacheBust(t));try{let B=this.harness._jsGlobal.document,c=B.createElement("script");s&&(c.id=s),B.head.appendChild(c),c.onerror=l=>{i.reject(n.missingError(l))},c.onload=()=>{if(this.harness.loadedKeyboard){let l=this.harness.loadedKeyboard;this.harness.loadedKeyboard=null,i.resolve(l)}else i.reject(n.scriptError())},i.then(()=>{c.remove()}).catch(()=>{c.remove()}),c.src=t}catch(B){return Promise.reject(B)}return i.corePromise}cacheBust(t){return t+"?v="+new Date().getTime()}};r(lc,"DOMKeyboardLoader");var ni=lc;var rc=class rc{constructor(e,t,n,s){this.Pelem=e,this.Peventname=t.toLowerCase(),this.Phandler=n,this.PuseCapture=s}equals(e){return this.Pelem==e.Pelem&&this.Peventname==e.Peventname&&this.Phandler==e.Phandler&&this.PuseCapture==e.PuseCapture}};r(rc,"DomEventTracking");var si=rc,Qc=class Qc{constructor(){this.domEvents=[]}attachDOMEvent(e,t,n,s){this.detachDOMEvent(e,t,n,s),e.addEventListener(t,n,!!s);var i=new si(e,t,n,s);this.domEvents.push(i)}detachDOMEvent(e,t,n,s){e.removeEventListener(t,n,s);for(var i=new si(e,t,n,s),B=0;B<this.domEvents.length;B++)if(this.domEvents[B].equals(i)){this.domEvents.splice(B,1);break}}shutdown(){for(let e of this.domEvents)this.detachDOMEvent(e.Pelem,e.Peventname,e.Phandler,e.PuseCapture)}};r(Qc,"DomEventTracker");var Gt=Qc;var ac=class ac extends X.default{constructor(e){super(),e instanceof X.default?(e.on=this.listenerRegistrationSpy("listeneradded",e,e.on),e.addListener=this.listenerRegistrationSpy("listeneradded",e,e.addListener),e.off=this.listenerRegistrationSpy("listenerremoved",e,e.off),e.removeListener=this.listenerRegistrationSpy("listenerremoved",e,e.off)):(e.addEventListener=this.listenerRegistrationSpy("listeneradded",e,e.addEventListener),e.removeEventListener=this.listenerRegistrationSpy("listenerremoved",e,e.removeEventListener))}listenerRegistrationSpy(e,t,n){return(s,i)=>{let B=n.apply(t,[s,i]);return this.emit(e,s),B}}};r(ac,"EmitterListenerSpy");var sn=ac;var Fc=class Fc{constructor(){this.events={};this.currentEvents=[]}addEventListener(e,t){return this._removeEventListener(e,t),this.events[e].push(t),!0}removeEventListener(e,t){return this._removeEventListener(e,t)}_removeEventListener(e,t){typeof this.events[e]=="undefined"&&(this.events[e]=[]);for(var n=0;n<this.events[e].length;n++)if(this.events[e][n]==t)return this.events[e].splice(n,1),!0;return!1}callEvent(e,t){if(typeof this.events[e]=="undefined")return!0;if(this.currentEvents.indexOf(e)!=-1)return!1;this.currentEvents.push(e);for(var n=0;n<this.events[e].length;n++){var s=this.events[e][n],i=!1;try{i=s(t)}catch(B){console.error(B),i=!1}if(i===!1)return this.currentEvents.pop(),!1}return this.currentEvents.pop(),!0}listenerCount(e){let t=this.events[e];return t?t.length:0}shutdown(){this.events={}}};r(Fc,"LegacyEventEmitter");var Bn=Fc;var oc=class oc{constructor(e=!1){this.fileLocal=e}request(e){let t=new E,n=window.setTimeout(()=>{t.reject(new Error(br))},1e4),s="&timerid="+n,i=e+s,B=document.createElement("script");B.onload=c=>{window.clearTimeout(n),t.isResolved||t.reject(new Error(Cr))},B.onerror=(c,l,a,F,o)=>{window.clearTimeout(n);let d=jB;o&&(d=d+": "+o.message),t.reject(new Error(d))},this.fileLocal?B.src=e:B.src=i;try{document.body.appendChild(B)}catch(c){document.getElementsByTagName("head")[0].appendChild(B)}return t.finally(()=>{clearTimeout(n)}),{promise:t,queryId:n}}};r(oc,"DOMCloudRequester");var Pn=oc;function mQ(){return typeof window.KeymanWeb_BaseLayout!="undefined"?window.KeymanWeb_BaseLayout:"us"}r(mQ,"determineBaseLayout");var Uc=class Uc{constructor(e,t,n,s){this.legacyAPIEvents=new Bn;this.keyEventListener=r((e,t)=>{var i;let n=this.contextManager.activeTarget;if(!this.contextManager.activeKeyboard||!n){t&&t(null,null);return}if(this.keyEventRefocus&&this.keyEventRefocus(),n.invalidateSelection(),n.deadkeys().deleteMatched(),e.isSynthetic){let B=this.osk.vkbd.layerId;B&&B!=this.core.keyboardProcessor.layerId&&(this.core.keyboardProcessor.layerId=B)}let s=this.core.processKeyEvent(e,n);s&&((i=s.transcription)!=null&&i.transform)&&this.config.onRuleFinalization(s,this.contextManager.activeTarget),t&&t(s,null)},"keyEventListener");this.config=t,this.contextManager=n;let i=s(this);i.baseLayout=mQ(),this.interface=i.keyboardInterface,this.core=new _e(t.hostDevice,e,i),this.core.languageProcessor.on("statechange",B=>{var c,l;(c=this.osk)==null||c.bannerController.selectBanner(B),(l=this.osk)==null||l.refreshLayout()}),this.core.keyboardProcessor.on("statekeychange",B=>{var c,l;(l=(c=this.osk)==null?void 0:c.vkbd)==null||l.updateStateKeys(B)}),this.contextManager.on("beforekeyboardchange",B=>{this.legacyAPIEvents.callEvent("beforekeyboardchange",{internalName:B==null?void 0:B.id,languageCode:B==null?void 0:B.langId})}),this.contextManager.on("keyboardchange",B=>{B||this.osk.startHide(!1);let c=r(()=>{var l,a;this.refreshModel(),this.core.activeKeyboard=B==null?void 0:B.keyboard,this.legacyAPIEvents.callEvent("keyboardchange",{internalName:(l=B==null?void 0:B.metadata.id)!=null?l:"",languageCode:(a=B==null?void 0:B.metadata.langId)!=null?a:""})},"prepareKeyboardSwap");this.osk?this.osk.batchLayoutAfter(()=>{c(),this.osk.activeKeyboard=B,this.contextManager.resetContext(),this.osk.present()}):(c(),this.contextManager.resetContext())}),this.contextManager.on("keyboardasyncload",B=>{var c,l;this.config.hostDevice.touchable&&((c=this.osk)!=null&&c.activationModel)&&(this.osk.activationModel.enabled=!0),(l=this.osk)==null||l.startHide(!1)})}init(e){return L(this,null,function*(){let t=this.config;if(t.deferForInitialization.isResolved)return Promise.resolve();t.initialize(e),String.kmwEnableSupplementaryPlane(!0);let n=new ni(this.interface,t.applyCacheBusting);this.keyboardRequisitioner=new en(n,new Pn,this.config.paths),this.modelCache=new nn;let s=this.keyboardRequisitioner.cache;this.contextManager.configure({resetContext:i=>{this.osk?this.osk.batchLayoutAfter(()=>{this.core.resetContext(i)}):this.core.resetContext(i)},predictionContext:new qe(this.core.languageProcessor,this.core.keyboardProcessor),keyboardCache:this.keyboardRequisitioner.cache}),this.config.on("spacebartext",()=>{var i;(i=this.osk)==null||i.refreshLayout()}),s.on("stubadded",i=>{let B=r(()=>{this.legacyAPIEvents.callEvent("keyboardregistered",{internalName:i.KI,language:i.KL,keyboardName:i.KN,languageCode:i.KLC,package:i.KP}),this.config.activateFirstKeyboard&&this.keyboardRequisitioner.cache.defaultStub==i&&this.contextManager.activateKeyboard(i.id,i.langId,!0)},"eventRaiser");this.config.deferForInitialization.isResolved?B():this.config.deferForInitialization.then(B)}),s.on("keyboardadded",i=>{let B=r(()=>{this.legacyAPIEvents.callEvent("keyboardloaded",{keyboardName:i.id})},"eventRaiser");this.config.deferForInitialization.isResolved?B():this.config.deferForInitialization.then(B)}),this.keyboardRequisitioner.cache.on("keyboardadded",i=>{this.legacyAPIEvents.callEvent("keyboardloaded",{keyboardName:i.id})})})}get build(){return Number.parseInt($t.VERSION_PATCH,10)}get version(){return $t.VERSION_RELEASE}get hardKeyboard(){return this._hardKeyboard}set hardKeyboard(e){this._hardKeyboard&&this._hardKeyboard.off("keyevent",this.keyEventListener),this._hardKeyboard=e,e.on("keyevent",this.keyEventListener)}get osk(){return this._osk}set osk(e){var t;this._osk&&(this._osk.off("keyevent",this.keyEventListener),this.core.keyboardProcessor.layerStore.handler=this.osk.layerChangeHandler),this._osk=e,this.core.keyboardProcessor.contextDevice=(t=e.targetDevice)!=null?t:this.config.softDevice,e&&(this.contextManager.activeKeyboard&&(e.activeKeyboard=this.contextManager.activeKeyboard),e.on("keyevent",this.keyEventListener),this.core.keyboardProcessor.layerStore.handler=e.layerChangeHandler)}getDebugInfo(){var n,s,i,B,c,l,a,F,o,d,U,u,g,I;let e=(n=this.contextManager)==null?void 0:n.activeKeyboard;return{configReport:(s=this.config)==null?void 0:s.debugReport(),keyboard:{id:Mt((B=(i=e==null?void 0:e.metadata)==null?void 0:i.id)!=null?B:""),langId:((c=e==null?void 0:e.metadata)==null?void 0:c.langId)||"",version:(a=(l=e==null?void 0:e.keyboard)==null?void 0:l.version)!=null?a:""},model:{id:((o=(F=this.core)==null?void 0:F.activeModel)==null?void 0:o.id)||""},osk:{banner:(u=(U=(d=this.osk)==null?void 0:d.banner)==null?void 0:U.banner.type)!=null?u:"",layer:((I=(g=this.osk)==null?void 0:g.vkbd)==null?void 0:I.layerId)||""}}}refreshModel(){let e=this.contextManager.activeKeyboard,t=this.modelCache.modelForLanguage(e==null?void 0:e.metadata.langId);return this.core.activeModel!=t&&(this.core.activeModel&&this.core.languageProcessor.unloadModel(),t)?this.core.languageProcessor.loadModel(t).then(()=>t):Promise.resolve(t)}addEventListener(e,t){this.legacyAPIEvents.addEventListener(e,t)}removeEventListener(e,t){this.legacyAPIEvents.removeEventListener(e,t)}shutdown(){var e;this.legacyAPIEvents.shutdown(),(e=this.osk)==null||e.shutdown()}addModel(e){var n;this.modelCache.register(e);let t=(n=this.contextManager.activeKeyboard)==null?void 0:n.metadata;return t&&e.languages.indexOf(t.langId)!=-1?this.refreshModel().then(()=>{}):Promise.resolve()}removeModel(e){this.modelCache.unregister(e),this.core.activeModel&&this.core.activeModel.id==e&&this.core.languageProcessor.unloadModel()}setActiveKeyboard(e,t){return L(this,null,function*(){return this.contextManager.activateKeyboard(e,t,!0)})}getActiveKeyboard(){var e,t;return(t=(e=this.contextManager.activeKeyboard)==null?void 0:e.metadata.id)!=null?t:""}getActiveLanguage(e){var n,s,i;let t=(n=this.contextManager.activeKeyboard)==null?void 0:n.metadata;return e?(i=t==null?void 0:t.langName)!=null?i:"":(s=t==null?void 0:t.langId)!=null?s:""}isChiral(e){let t;if(e){if(typeof e=="string"){let n=this.keyboardRequisitioner.cache.getKeyboard(e);if(n)e=n;else throw new Error(`Keyboard '${e}' has not been loaded.`)}t=e}else t=this.core.activeKeyboard;return t.isChiral}resetContext(){this.contextManager.resetContext()}setNumericLayer(){this.core.keyboardProcessor.setNumericLayer(this.config.softDevice)}};r(Uc,"KeymanEngine");var cn=Uc;var Be=class Be{get height(){return this._height}set height(e){this._height=e>0?e:0,this.update()}get width(){return this._width}set width(e){this._width=e,this.update()}update(){let e=this.div.style,t=e.height,n=e.display;return this._height>0?(e.height=this._height+"px",e.display="block"):(e.height="0px",e.display="none"),t!==e.height||n!==e.display}constructor(e){let t=A("div");t.id=Be.BANNER_ID,t.className=Be.BANNER_CLASS,this.div=t,this.height=e,this.update()}appendStyleSheet(){}getDiv(){return this.div}configureForKeyboard(e,t){}shutdown(){}};r(Be,"Banner"),Be.DEFAULT_HEIGHT=37,Be.BANNER_CLASS="kmw-banner-bar",Be.BANNER_ID="kmw-banner-bar";var Qt=Be;var Yt=class Yt{constructor(e){let t=typeof e=="string"?Yt.parseLengthStyle(e):e;this.val=t.val,this.absolute=t.absolute,t.special&&(this.special=t.special)}get styleString(){return this.absolute?this.val+"px":this.special?this.val+this.special:this.val*100+"%"}scaledBy(e){return new Yt({val:e*this.val,absolute:this.absolute})}static inPixels(e){return new Yt({val:e,absolute:!0})}static inPercent(e){return new Yt({val:e/100,absolute:!1})}static forScalar(e){return new Yt({val:e,absolute:!1})}static special(e,t){return new Yt({val:e,absolute:!1,special:t})}static parseLengthStyle(e){if(e=="")return Gr;let t=parseFloat(e);return isNaN(t)?(console.error("Could not properly parse specified length style info: '"+e+"'."),Gr):e.indexOf("px")!=-1?{val:t,absolute:!0}:e.indexOf("pt")!=-1?{val:4*t/3,absolute:!0}:e.indexOf("%")!=-1?{val:t/100,absolute:!1}:e.indexOf("rem")!=-1?{val:t,absolute:!1,special:"rem"}:e.indexOf("em")!=-1?{val:t,absolute:!1,special:"em"}:{val:4*t/3,absolute:!0}}};r(Yt,"ParsedLengthStyle");var G=Yt,Gr=new G("1em");var dc=class dc extends Qt{constructor(){super(0);this.type="blank"}};r(dc,"BlankBanner");var ce=dc;var gc=class gc{constructor(){this._activeBannerHeight=Qt.DEFAULT_HEIGHT;this.events=new X.default;this.constructContainer()}constructContainer(){let e=A("div");return e.id="keymanweb_banner_container",e.className="kmw-banner-container",this.bannerContainer=e}get element(){return this.bannerContainer}appendStyles(){this.currentBanner&&this.currentBanner.appendStyleSheet()}get banner(){return this.currentBanner}set banner(e){if(this.currentBanner){if(e==this.currentBanner)return;{let t=this.currentBanner;this.currentBanner=e,this.bannerContainer.replaceChild(e.getDiv(),t.getDiv()),t.shutdown()}}else this.currentBanner=e,e&&this.bannerContainer.appendChild(e.getDiv());e instanceof ce||(e.height=this.activeBannerHeight),this.events.emit("bannerchange")}get height(){return this.currentBanner?this.currentBanner.height:0}get activeBannerHeight(){return this._activeBannerHeight}set activeBannerHeight(e){this._activeBannerHeight=e,this.currentBanner&&!(this.currentBanner instanceof ce)&&(this.currentBanner.height=e)}get layoutHeight(){return G.inPixels(this.height)}get width(){var e;return(e=this.currentBanner)==null?void 0:e.width}set width(e){this.currentBanner&&(this.currentBanner.width=e)}refreshLayout(){var e,t;(t=(e=this.currentBanner).refreshLayout)==null||t.call(e)}};r(gc,"BannerView");var ii=gc;var uc=class uc extends Qt{constructor(t,n){var e=(...args)=>{super(...args)};t.length>0?(e(),n&&(this.height=n)):e(0),this.type="image",t.indexOf("base64")>=0?console.log("Loading img from base64 data"):console.log("Loading img with src '"+t+"'"),this.img=document.createElement("img"),this.img.setAttribute("src",t);let s=this.img.style;s.width="100%",s.height="100%",this.getDiv().appendChild(this.img),console.log("Image loaded.")}setImagePath(t){this.img&&this.img.setAttribute("src",t)}};r(uc,"ImageBanner");var Bi=uc;function Jt(Q,e){e instanceof Error?console.error(`${Q}: ${e.message}

${e.stack}`):(console.error(Q),console.error(e))}r(Jt,"reportError");var yc=class yc{constructor(e){this.queue=[],this.defaultWaitFactory=e||(()=>lt(0))}get defaultWait(){return this.defaultWaitFactory()}get ready(){return this.queue.length==0&&!this.waitLock}triggerNextClosure(){return L(this,null,function*(){if(this.queue.length==0)return;let e=this.queue.shift();this.waitLock=Promise.resolve();let t;try{t=e()}catch(n){Jt("Error from queued closure",n)}t=t!=null?t:this.defaultWaitFactory(),this.waitLock=t;try{yield t}catch(n){Jt("Async error from queued closure",n)}this.waitLock=null,this.triggerNextClosure()})}runAsync(e){let t=this.ready;this.queue.push(e),t&&this.triggerNextClosure()}};r(yc,"AsyncClosureDispatchQueue");var ci=yc;function pr(Q){return"targetX"in Q&&"targetY"in Q&&"t"in Q}r(pr,"isAnInputSample");var le=class le{constructor(e){this.rawLinearSums={x:0,y:0,t:0};this.coordArcSum=0;this._sampleCount=0;if(e)if(e instanceof le)Object.assign(this,e),this.rawLinearSums=h({},e.rawLinearSums);else if(pr(e))Object.assign(this,this.extend(e));else throw new Error("A constructor for this input pattern has not yet been implemented")}extend(e){return this._extend(new le(this),e)}_extend(e,t){e._initialSample||(e._initialSample=t,e.baseSample=t);let n=e.baseSample;this.followingSample=t;let s=t.targetX-n.targetX,i=t.targetY-n.targetY,B=t.t-n.t;if(e.rawLinearSums.x+=s,e.rawLinearSums.y+=i,e.rawLinearSums.t+=B,this.lastSample){let c=t.targetX-this.lastSample.targetX,l=t.targetY-this.lastSample.targetY,a=c*c+l*l,F=Math.sqrt(a);e.coordArcSum+=F}return e._lastSample=t,e.sampleCount=this.sampleCount+1,e}deaccumulate(e){let t=new le(this);return this._deaccumulate(t,e)}_deaccumulate(e,t){if(!t)return e;if(!t.followingSample||!t.lastSample)throw"Invalid argument:  stats missing necessary tracking variable.";for(let n in e.rawLinearSums){let s=n;e.rawLinearSums[s]-=t.rawLinearSums[s]}if(t.followingSample&&t.lastSample){let n=t.followingSample.targetX-t.lastSample.targetX,s=t.followingSample.targetY-t.lastSample.targetY,i=n*n+s*s,B=Math.sqrt(i);e.coordArcSum-=B,e.coordArcSum-=t.coordArcSum}return e.sampleCount-=t.sampleCount,e._initialSample=t.followingSample,e}translateCoordSystem(e){let t=new le(this);return this._translateCoordSystem(t,e)}_translateCoordSystem(e,t){if(this.sampleCount==0)return e;let n=e.initialSample==e.lastSample;return e._initialSample=t(e.initialSample),e.baseSample=t(e.baseSample),e._lastSample=n?e._initialSample:t(e.lastSample),e}replaceInitialSample(e){let t=new le(this);return this._replaceInitialSample(t,e)}_replaceInitialSample(e,t){if(this.sampleCount==0)throw new Error("no sample available to replace");let n=e.initialSample;if(e._initialSample=t,this.sampleCount>1){let s=t.targetX-n.targetX,i=t.targetY-n.targetY,B=t.t-n.t;e.rawLinearSums.x+=s,e.rawLinearSums.y+=i,e.rawLinearSums.t+=B;let c=s*s+i*i,l=Math.sqrt(c);e.coordArcSum+=l}else e._lastSample=t;return e}get lastSample(){return this._lastSample}get lastTimestamp(){var e;return(e=this.lastSample)==null?void 0:e.t}get sampleCount(){return this._sampleCount}set sampleCount(e){this._sampleCount=e}get initialSample(){return this._initialSample}mappingConstant(e){if(this.baseSample)return e=="t"?this.baseSample.t:e=="x"?this.baseSample.targetX:e=="y"?this.baseSample.targetY:0}mean(e){return this.rawLinearSums[e]/this.sampleCount+this.mappingConstant(e)}get netDistance(){if(!this.lastSample||!this.initialSample)return 0;let e=this.lastSample.targetX-this.initialSample.targetX,t=this.lastSample.targetY-this.initialSample.targetY;return Math.sqrt(e*e+t*t)}get duration(){return!this.lastSample||!this.initialSample?0:this.lastSample.t-this.initialSample.t}get angle(){if(this.sampleCount==1||!this.lastSample||!this.initialSample)return;if(this.netDistance<1)return;let e=this.lastSample.targetX-this.initialSample.targetX,t=this.lastSample.targetY-this.initialSample.targetY,n=Math.acos(-t/this.netDistance);return e<0?2*Math.PI-n:n}get angleInDegrees(){return this.angle*180/Math.PI}get cardinalDirection(){if(this.sampleCount==1||!this.lastSample||!this.initialSample||isNaN(this.angle)||this.angle===null||this.angle===void 0)return;let e=["n","ne","e","se","s","sw","w","nw","n"],t=Math.ceil((this.angleInDegrees-22.5)/45);return e[t]}get speed(){return this.duration?this.netDistance/this.duration:0}get rawDistance(){return this.coordArcSum}toJSON(){return{angle:this.angle,cardinal:this.cardinalDirection,netDistance:this.netDistance,duration:this.duration,sampleCount:this.sampleCount,rawDistance:this.rawDistance}}};r(le,"CumulativePathStats");var Rt=le;function pe(Q,e){let t=Q.gestures.find(n=>n.id==e);if(!t)throw new Error(`Could not find spec for gesture with id '${e}'`);return t}r(pe,"getGestureModel");function Ic(Q,e){let t=Q.sets[e];if(!t)throw new Error(`Could not find a defined gesture-set with id '${e}'`);let n=Q.gestures.filter(i=>!!t.find(B=>i.id==B)),s=t.filter(i=>!n.find(B=>B.id==i));if(s.length>0)throw new Error(`Set '${e}' cannot find definitions for gestures with ids ${s}`);return n}r(Ic,"getGestureModelSet");var hc={gestures:[],sets:{default:[]}};var bc=class bc{constructor(){}getBoundingClientRect(){return new DOMRect(0,0,Math.max(document.documentElement.clientWidth||0,window.innerWidth||0),Math.max(document.documentElement.clientHeight||0,window.innerHeight||0))}};r(bc,"ViewportZoneSource");var li=bc;var Cc=class Cc{get edgePadding(){return this._edgePadding}constructor(e,t){Array.isArray(e)&&(t=e,e=new li),this.root=e,t=t||[0,0,0,0],this.updatePadding(t)}updatePadding(e){switch(e.length){case 1:let t=e[0];this._edgePadding={x:t,y:t,w:2*t,h:2*t};break;case 2:this._edgePadding={x:e[1],y:e[0],w:2*e[1],h:2*e[0]};break;case 3:this._edgePadding={x:e[1],y:e[0],w:2*e[1],h:e[0]+e[2]};break;case 4:this._edgePadding={x:e[3],y:e[0],w:e[1]+e[3],h:e[0]+e[2]};break;default:throw new Error("Invalid values for PaddedZoneSource's edgePadding - must be between 1 to 4 `number` values.")}}getBoundingClientRect(){let e=this.root.getBoundingClientRect();return new DOMRect(e.left+this.edgePadding.x,e.top+this.edgePadding.y,e.width-this.edgePadding.w,e.height-this.edgePadding.h)}};r(Cc,"PaddedZoneSource");var at=Cc;function ri(Q){var t,n,s,i,B,c,l;let e=h({},Q);if(e.mouseEventRoot=(t=e.mouseEventRoot)!=null?t:e.targetRoot,e.touchEventRoot=(n=e.touchEventRoot)!=null?n:e.targetRoot,e.inputStartBounds=(s=e.inputStartBounds)!=null?s:e.targetRoot,e.maxRoamingBounds=(i=e.maxRoamingBounds)!=null?i:e.targetRoot,e.safeBounds=(B=e.safeBounds)!=null?B:new at([2]),e.itemIdentifier=(c=e.itemIdentifier)!=null?c:()=>null,e.recordingMode=!!e.recordingMode,e.historyLength=((l=e.historyLength)!=null?l:0)>0?e.historyLength:0,Q.paddedSafeBounds)delete e.safeBoundPadding;else{let a=Q.safeBoundPadding;typeof a=="number"&&(a=[a]),a=a!=null?a:[3],e.paddedSafeBounds=new at(e.safeBounds,a)}return e}r(ri,"preprocessRecognizerConfig");var Qi=class Qi extends X.default{constructor(){super();this._isComplete=!1;this._stats=new Rt}get stats(){return this._stats}clone(){let t=new Qi;return t._isComplete=this._isComplete,t._wasCancelled=this._wasCancelled,t._stats=new Rt(this._stats),t}get isComplete(){return this._isComplete}get wasCancelled(){return this._wasCancelled}translateCoordSystem(t){this._stats=this._stats.translateCoordSystem(t)}replaceInitialSample(t){this._stats=this._stats.replaceInitialSample(t)}extend(t){if(this._isComplete)throw new Error("Invalid state:  this GesturePath has already terminated.");this._stats=this._stats.extend(t),this.emit("step",t)}terminate(t=!1){this._isComplete||(this._wasCancelled=t,this._isComplete=!0,t?this.emit("invalidated"):this.emit("complete"),this.removeAllListeners())}toJSON(){return{stats:this.stats,wasCancelled:this.wasCancelled}}};r(Qi,"GesturePath");var ln=Qi;var jn=class jn extends ln{constructor(){super(...arguments);this.samples=[]}clone(){let t=new jn;return t.samples=[].concat(this.samples),t._isComplete=this._isComplete,t._wasCancelled=this._wasCancelled,t._stats=new Rt(this._stats),t}static deserialize(t){let n=new jn;n.samples=[].concat(t.coords.map(i=>h({},i))),n._isComplete=!0,n._wasCancelled=t.wasCancelled;let s=n.samples.reduce((i,B)=>i.extend(B),new Rt);return n._stats=s,n}extend(t){if(this.isComplete)throw new Error("Invalid state:  this GesturePath has already terminated.");this.samples.push(t),super.extend(t)}translateCoordSystem(t){super.translateCoordSystem(t);for(let n=0;n<this.samples.length;n++)this.samples[n]=t(this.samples[n])}get coords(){return this.samples}toJSON(){let t={coords:[].concat(this.samples.map(n=>({targetX:n.targetX,targetY:n.targetY,t:n.t,item:n.item}))),wasCancelled:this.wasCancelled,stats:this.stats};for(let n of t.coords)delete n.clientX,delete n.clientY,n.item===void 0&&delete n.item;return t}};r(jn,"GestureDebugPath");var re=jn;var mc=class mc{constructor(e,t,n,s){this.stateToken=null;this.rawIdentifier=e,this.isFromTouch=n,this._path=s?new s:new ln,this.recognizerConfigStack=Array.isArray(t)?t:[t]}get path(){return this._path}setGestureMatchInspector(e){if(this._matchInspectionClosure)throw new Error("Invalid state:  the match-inspection closure has already been set");this._matchInspectionClosure=e}update(e){this.path.extend(e),this._baseItem||(this._baseItem=e.item)}get baseItem(){return this._baseItem}set baseItem(e){this._baseItem=e}get currentSample(){return this.path.stats.lastSample}get potentialModelMatchIds(){return this._matchInspectionClosure(this)}constructSubview(e,t,n){return new st(this,this.recognizerConfigStack,e,t,n)}terminate(e){this.path.terminate(e)}get isPathComplete(){return this.path.isComplete}get identifier(){return`${this.isFromTouch?"touch":"mouse"}:${this.rawIdentifier}`}pushRecognizerConfig(e){let t=V(h({},e),{mouseEventRoot:this.recognizerConfigStack[0].mouseEventRoot,touchEventRoot:this.recognizerConfigStack[0].touchEventRoot});this.recognizerConfigStack.push(ri(t))}popRecognizerConfig(){if(this.recognizerConfigStack.length==1)throw new Error("Cannot 'pop' the original recognizer-configuration for this GestureSource.");return this.recognizerConfigStack.pop()}get currentRecognizerConfig(){return this.recognizerConfigStack[this.recognizerConfigStack.length-1]}toJSON(){return{identifier:this.identifier,isFromTouch:this.isFromTouch,path:this.path.toJSON(),stateToken:this.stateToken}}};r(mc,"GestureSource");var gt=mc,_n=class _n extends gt{constructor(t,n,s,i,B){let c=0,l=t.path.stats.sampleCount;t instanceof _n&&(c=t._baseStartIndex);super(t.rawIdentifier,n,t.isFromTouch,Object.getPrototypeOf(t.path).constructor);let a=this._baseSource=t instanceof _n?t._baseSource:t;this.stateToken=B!=null?B:t.stateToken;let F=r(g=>{let I=this.recognizerTranslation,C=V(h({},g),{targetX:g.targetX-I.x,targetY:g.targetY-I.y});return this.stateToken&&(C.stateToken=this.stateToken),(this.stateToken!=a.stateToken||this.stateToken!=t.stateToken)&&(C.item=this.currentRecognizerConfig.itemIdentifier(C,null)),C},"translateSample"),o=t.path.stats.lastSample;s?(this._baseStartIndex=c=Math.max(c+l-1,0),l=l>0?1:0):this._baseStartIndex=c,s?t.path.stats.sampleCount&&this._path.extend(t.path.stats.lastSample):this._path=t.path.clone(),this._path.translateCoordSystem(F),i?this._baseItem=t.baseItem:this._baseItem=o==null?void 0:o.item;let d=r(()=>this.path.terminate(!1),"completeHook"),U=r(()=>this.path.terminate(!0),"invalidatedHook"),u=r(g=>{super.update(F(g))},"stepHook");a.path.on("complete",d),a.path.on("invalidated",U),a.path.on("step",u),this.subviewDisconnector=()=>{a.path.off("complete",d),a.path.off("invalidated",U),a.path.off("step",u)},a.isPathComplete&&(this.path.terminate(a.path.wasCancelled),this.disconnect())}get recognizerTranslation(){if(this.recognizerConfigStack.length==1||!this.currentRecognizerConfig)return{x:0,y:0};let n=this.currentRecognizerConfig.targetRoot.getBoundingClientRect(),s=this.recognizerConfigStack[0].targetRoot.getBoundingClientRect();return{x:n.left-s.left,y:n.top-s.top}}get baseSource(){return this._baseSource}disconnect(){this.subviewDisconnector&&(this.subviewDisconnector(),this.subviewDisconnector=null)}pushRecognizerConfig(t){throw new Error("Pushing and popping of recognizer configurations should only be called on the base GestureSource")}popRecognizerConfig(){throw new Error("Pushing and popping of recognizer configurations should only be called on the base GestureSource")}update(t){throw new Error("Updates should be provided through the base GestureSource.")}terminate(t){this.baseSource.terminate(t)}};r(_n,"GestureSourceSubview");var st=_n;var Fi=class Fi extends gt{constructor(t,n,s){super(t,n,s,re);this.stateToken=null}initPath(){return new re}static deserialize(t,n){let s=n!==void 0?n:this._jsonIdSeed++,i=t.isFromTouch,B=re.deserialize(t.path),c=new Fi(s,null,i);return c._path=B,c}};r(Fi,"GestureDebugSource");var ai=Fi;var qn=class qn extends X.default{constructor(t){var n;super();this._activeTouchpoints=[];this.identifierMap={};this.config=t,this.sourceConstructor=(n=t==null?void 0:t.recordingMode)==null||n?ai:gt}createTouchpoint(t,n){let s=qn.IDENTIFIER_SEED++;this.identifierMap[t]=s;let i=new this.sourceConstructor(s,this.config,n);return i.stateToken=this.stateToken,i}fulfillInputStart(t){}maintainTouchpoints(t){t||(t=[]),this._activeTouchpoints.filter(n=>!t.includes(n)).forEach(n=>n.terminate(!0))}hasActiveTouchpoint(t){return this.identifierMap[t]!==void 0}getTouchpointWithId(t){let n=this.identifierMap[t];return this._activeTouchpoints.find(s=>s.rawIdentifier==n)}getConfigForId(t){return this.getTouchpointWithId(t).currentRecognizerConfig}getStateTokenForId(t){var n;return(n=this.getTouchpointWithId(t).stateToken)!=null?n:null}dropTouchpoint(t){let n=t.rawIdentifier;this._activeTouchpoints=this._activeTouchpoints.filter(s=>t!=s);for(let s of Object.keys(this.identifierMap)){let i=Number.parseInt(s,10);this.identifierMap[i]==n&&delete this.identifierMap[i]}}addTouchpoint(t){this._activeTouchpoints.push(t)}get activeSources(){return[].concat(this._activeTouchpoints)}};r(qn,"InputEngineBase"),qn.IDENTIFIER_SEED=0;var oi=qn;function xc(Q,e,t){let n=Q.targetRoot.getBoundingClientRect();return{clientX:e,clientY:t,targetX:e-n.left,targetY:t-n.top}}r(xc,"processSampleClientCoords");var Gc=class Gc extends oi{buildSampleFor(e,t,n,s,i){var a,F;let B=V(h({},xc(this.config,e,t)),{t:s,stateToken:(a=i==null?void 0:i.stateToken)!=null?a:this.stateToken}),l=((F=i==null?void 0:i.currentRecognizerConfig.itemIdentifier)!=null?F:this.config.itemIdentifier)(B,n);return B.item=l,B}onInputStart(e,t,n,s){let i=this.createTouchpoint(e,s);i.update(t),this.addTouchpoint(i),i.path.on("invalidated",()=>{this.dropTouchpoint(i)}),i.path.on("complete",()=>{this.dropTouchpoint(i)});try{this.emit("pointstart",i)}catch(B){Jt("Engine-internal error while initializing gesture matching for new source",B)}return i}onInputMove(e,t,n){if(e)try{e.update(t)}catch(s){Jt("Error occurred while updating source",s)}}onInputMoveCancel(e,t,n){if(e)try{e.update(t),e.path.terminate(!0)}catch(s){Jt("Error occurred while cancelling further input for source",s)}}onInputEnd(e,t){if(e)try{e.path.terminate(!1)}catch(n){Jt("Error occurred while finalizing input for source",n)}}};r(Gc,"InputEventEngine");var rn=Gc;var pt=class pt{constructor(){}static getCoordZoneBitmask(e,t){let n=t.getBoundingClientRect(),s=0;return s|=e.clientX<n.left?pt.FAR_LEFT:0,s|=e.clientX>n.right?pt.FAR_RIGHT:0,s|=e.clientY<n.top?pt.FAR_TOP:0,s|=e.clientY>n.bottom?pt.FAR_BOTTOM:0,s}static inputStartOutOfBoundsCheck(e,t){return!!this.getCoordZoneBitmask(e,t.inputStartBounds)}static inputStartSafeBoundProximityCheck(e,t){return this.getCoordZoneBitmask(e,t.paddedSafeBounds)}static inputMoveCancellationCheck(e,t,n){return n=n||0,this.getCoordZoneBitmask(e,t.maxRoamingBounds)?!0:!!(this.getCoordZoneBitmask(e,t.safeBounds)&~n)}};r(pt,"ZoneBoundaryChecker"),pt.FAR_TOP=8,pt.FAR_LEFT=4,pt.FAR_BOTTOM=2,pt.FAR_RIGHT=1;var At=pt;var pc=class pc extends rn{constructor(t){super(t);this.hasActiveClick=!1;this.disabledSafeBounds=0;this.currentSource=null;this.activeIdentifier=0;this._mouseStart=n=>this.onMouseStart(n),this._mouseMove=n=>this.onMouseMove(n),this._mouseEnd=n=>this.onMouseEnd(n)}get eventRoot(){return this.config.mouseEventRoot}registerEventHandlers(){this.eventRoot.addEventListener("mousedown",this._mouseStart,!0),this.eventRoot.addEventListener("mousemove",this._mouseMove,!1),this.eventRoot.addEventListener("mouseup",this._mouseEnd,!0)}unregisterEventHandlers(){this.eventRoot.removeEventListener("mousedown",this._mouseStart,!0),this.eventRoot.removeEventListener("mousemove",this._mouseMove,!1),this.eventRoot.removeEventListener("mouseup",this._mouseEnd,!0)}preventPropagation(t){t.preventDefault(),t.cancelBubble=!0,t.returnValue=!1,typeof t.stopImmediatePropagation=="function"?t.stopImmediatePropagation():typeof t.stopPropagation=="function"&&t.stopPropagation()}buildSampleFromEvent(t){return this.buildSampleFor(t.clientX,t.clientY,t.target,performance.now(),this.currentSource)}onMouseStart(t){if(!this.config.targetRoot.contains(t.target))return;this.preventPropagation(t);let n=this.buildSampleFromEvent(t);At.inputStartOutOfBoundsCheck(n,this.config)||(this.disabledSafeBounds=At.inputStartSafeBoundProximityCheck(n,this.config));let s=this.onInputStart(this.activeIdentifier,n,t.target,!1);this.currentSource=s;let i=r(()=>{this.currentSource=null},"cleanup");s.path.on("complete",i),s.path.on("invalidated",i)}onMouseMove(t){let n=this.currentSource;if(!n)return;let s=this.buildSampleFromEvent(t);if(!t.buttons){this.hasActiveClick&&(this.hasActiveClick=!1,this.onInputMoveCancel(n,s,t.target));return}this.preventPropagation(t);let i=n.currentRecognizerConfig;At.inputMoveCancellationCheck(s,i,this.disabledSafeBounds)?this.onInputMoveCancel(n,s,t.target):this.onInputMove(n,s,t.target)}onMouseEnd(t){let n=this.currentSource;n&&(t.buttons||(this.hasActiveClick=!1),this.onInputEnd(n,t.target))}};r(pc,"MouseEventEngine");var Ui=pc;function Xr(Q){let e=[];for(let t=0;t<Q.length;t++)e.push(Q.item(t));return e}r(Xr,"touchListToArray");var Xc=class Xc extends rn{constructor(t){super(t);this.eventDispatcher=new ci;this.safeBoundMaskMap={};this.pendingSourcePromises=new Map;this.inputStartSignalMap=new Map;this._touchStart=n=>this.onTouchStart(n),this._touchMove=n=>this.onTouchMove(n),this._touchEnd=n=>this.onTouchEnd(n)}get eventRoot(){return this.config.touchEventRoot}registerEventHandlers(){this.eventRoot.addEventListener("touchstart",this._touchStart,{capture:!0,passive:!1}),this.eventRoot.addEventListener("touchmove",this._touchMove,{capture:!1,passive:!1}),this.eventRoot.addEventListener("touchend",this._touchEnd,{capture:!0,passive:!1})}unregisterEventHandlers(){this.eventRoot.removeEventListener("touchstart",this._touchStart,!0),this.eventRoot.removeEventListener("touchmove",this._touchMove,!1),this.eventRoot.removeEventListener("touchend",this._touchEnd,!0)}preventPropagation(t){t.cancelable&&t.preventDefault(),typeof t.stopImmediatePropagation=="function"?t.stopImmediatePropagation():typeof t.stopPropagation=="function"&&t.stopPropagation()}dropTouchpoint(t){super.dropTouchpoint(t);for(let n of Object.keys(this.safeBoundMaskMap)){let s=Number.parseInt(n,10);this.getTouchpointWithId(s)==t&&delete this.safeBoundMaskMap[s]}}fulfillInputStart(t){let n=this.inputStartSignalMap.get(t);n&&(this.inputStartSignalMap.delete(t),n.resolve())}hasActiveTouchpoint(t){return super.hasActiveTouchpoint(t)||!!this.pendingSourcePromises.has(t)}buildSampleFromTouch(t,n,s){return this.buildSampleFor(t.clientX,t.clientY,t.target,n,s)}onTouchStart(t){if(!this.config.targetRoot.contains(t.target))return;this.preventPropagation(t);let n=Xr(t.touches),s=Xr(t.changedTouches),B=n.filter(l=>s.findIndex(a=>l.identifier==a.identifier)==-1).map(l=>this.pendingSourcePromises.get(l.identifier));this.eventDispatcher.runAsync(()=>L(this,null,function*(){let l=yield Promise.all(B);return this.maintainTouchpoints(l),this.eventDispatcher.defaultWait}));let c=new Map;for(let l=0;l<t.changedTouches.length;l++){let a=t.changedTouches.item(l),F=new E;this.pendingSourcePromises.set(a.identifier,F),c.set(a.identifier,F)}this.eventDispatcher.runAsync(()=>{let l=performance.now(),a=null;for(let F=0;F<t.changedTouches.length;F++){let o=t.changedTouches.item(F),d=o.identifier,U=this.buildSampleFromTouch(o,l,null);if(!At.inputStartOutOfBoundsCheck(U,this.config))this.safeBoundMaskMap[d]=At.inputStartSafeBoundProximityCheck(U,this.config);else{c.get(d).resolve(null);continue}a=this.onInputStart(d,U,t.target,!0);let u=c.get(d);u.resolve(a);let g=r(()=>{this.pendingSourcePromises.get(d)==u&&this.pendingSourcePromises.delete(d)},"cleanup");a.path.on("complete",g),a.path.on("invalidated",g)}if(a){let F=new E;return this.inputStartSignalMap.set(a,F),F.corePromise}else return Promise.resolve()})}onTouchMove(t){var s;for(let i=0;i<t.touches.length;i++){let B=t.touches.item(i);if(this.hasActiveTouchpoint(B.identifier)){this.preventPropagation(t);break}}let n=new Map;for(let i=0;i<t.touches.length;i++){let B=t.touches.item(i).identifier;n.set(B,(s=this.pendingSourcePromises.get(B))==null?void 0:s.corePromise)}this.eventDispatcher.runAsync(()=>L(this,null,function*(){let i=yield Promise.all(n.values());return this.maintainTouchpoints(i),this.eventDispatcher.defaultWait})),this.eventDispatcher.runAsync(()=>L(this,null,function*(){let i=performance.now();for(let B=0;B<t.touches.length;B++){let c=t.touches.item(B),l=c.identifier,a=yield n.get(l);if(!a||a.isPathComplete)continue;let F=a.currentRecognizerConfig,o=this.buildSampleFromTouch(c,i,a);At.inputMoveCancellationCheck(o,F,this.safeBoundMaskMap[l])?this.onInputMoveCancel(a,o,c.target):this.onInputMove(a,o,c.target)}return this.eventDispatcher.defaultWait}))}onTouchEnd(t){var s;for(let i=0;i<t.changedTouches.length;i++){let B=t.changedTouches.item(i);if(this.hasActiveTouchpoint(B.identifier)){this.preventPropagation(t);break}}let n=new Map;for(let i=0;i<t.changedTouches.length;i++){let B=t.changedTouches.item(i).identifier,c=(s=this.pendingSourcePromises.get(B))==null?void 0:s.corePromise;n.set(B,c)}this.eventDispatcher.runAsync(()=>L(this,null,function*(){for(let i=0;i<t.changedTouches.length;i++){let B=t.changedTouches.item(i),c=yield n.get(B.identifier);!c||c.isPathComplete||this.onInputEnd(c,t.target)}return this.eventDispatcher.defaultWait}))}};r(Xc,"TouchEventEngine");var di=Xc;var Sc=class Sc{get promise(){return this.publishedPromise.corePromise}constructor(e,t,n){if(!e||!t)throw new Error("A gesture-path source and contact-path model must be specified.");if(this.model=e,this.publishedPromise=new E,this.source=t,this.inheritedStats=n,this.lastStats=null,e.timer){let s=e.timer.inheritElapsed?Math.min(t.path.stats.duration,e.timer.duration):0;this.timerPromise=new Tt(e.timer.duration-s),this.publishedPromise.then(()=>{this.timerPromise.resolve(!1)}),this.timerPromise.then(i=>{let B=t instanceof st?t.baseSource:t,c=performance.now();!B.isPathComplete&&B.currentSample.t!=c&&B.path.extend(V(h({},B.currentSample),{t:c})),i!=e.timer.expectedResult&&this.finalize(!1,"timer"),this.finalize(!0,"timer")})}}finalize(e,t){if(this.publishedPromise.isFulfilled)return this._result;let n=this.model;n.validateItem&&e&&(e=n.validateItem(this.source.path.stats.lastSample.item,this.baseItem));let s;return e?s={type:n.pathResolutionAction,cause:t}:s={type:"reject",cause:t},this.publishedPromise.resolve(s),this._result=s,s}get stats(){return this.source.path.stats}get baseItem(){return this.source.baseItem}get lastItem(){return this.source.currentSample.item}update(){let e=this.model,t=this.source;if(t.path.wasCancelled)return this.finalize(!1,"path");if(e.itemChangeAction&&t.path.stats.sampleCount>0&&t.currentSample.item!=t.baseItem){let n=e.itemChangeAction=="resolve";return this.finalize(n,"item")}else{let n=e.pathModel.evaluate(t.path,this.lastStats,t.baseItem,this.inheritedStats)||"continue";return this.lastStats=t.path.stats,n!="continue"?this.finalize(n=="resolve","path"):t.path.isComplete?this.finalize(!1,"path"):{type:"continue"}}}};r(Sc,"PathMatcher");var Qn=Sc;var Vc=class Vc{constructor(e,t){this._isCancelled=!1;var c;if(!e||!t)throw new Error("Construction of GestureMatcher requires a gesture-model spec and a source for related contact points.");if(!e.sustainTimer&&!t)throw new Error("If the provided gesture-model spec lacks a sustain timer, there must be an active contact point.");let n=t instanceof gt?null:t,s=n?null:t;this.predecessor=n,this.publishedPromise=new E,this.model=e,e.sustainTimer&&(this.sustainTimerPromise=new Tt(e.sustainTimer.duration),this.sustainTimerPromise.then(l=>{let a=e.sustainTimer.expectedResult==l;this.finalize(a,"timer")})),this.pathMatchers=[];let B=(s?[s]:n.sources).map(l=>s&&l==s?s:l.isPathComplete?null:l).reduce((l,a)=>a?l.concat(a):l,[]);if(e.sustainTimer&&B.length>0){this.finalize(!1,"path");return}else!e.sustainTimer&&B.length==0&&this.finalize(!1,"path");for(let l=0;l<B.length;l++){let a=B[l];a instanceof st&&a.disconnect();let F=e.contacts[l];if(!F)throw new Error(`No contact model for inherited path: gesture "${e.id}', entry ${l}`);let o=(c=F==null?void 0:F.model.pathInheritance)!=null?c:"chop",d=!1,U;switch(o){case"reject":this.finalize(!1,"path");return;case"full":U=a.constructSubview(!1,!0),this.addContactInternal(U,a.path.stats,!0);continue;case"partial":d=!0;case"chop":U=a.constructSubview(!0,d),this.addContactInternal(U,a.path.stats,!0);break}}}get sources(){return this.pathMatchers.map((e,t)=>{if(!this.model.contacts[t].resetOnInstantFulfill)return e.source}).filter(e=>!!e)}get promise(){return this.publishedPromise.corePromise}cancel(){this._isCancelled=!0,this._result||this.finalize(!1,"cancelled")}get isCancelled(){return this._isCancelled}finalize(e,t){var n,s;if(this.publishedPromise.isFulfilled)return this._result;try{let i;e?i=this.model.resolutionAction:(t!="cancelled"&&((n=this.model.rejectionActions)!=null&&n[t])&&(i=this.model.rejectionActions[t],i.item="none"),i=i||{type:"none",item:"none"});let B;switch((s=i.item)!=null?s:"current"){case"none":B=null;break;case"base":B=this.primaryPath.baseItem;break;case"current":B=this.primaryPath.currentSample.item;break}let l={matched:e,action:V(h({},i),{item:B})};return this.publishedPromise.resolve(l),this._result=l,l}catch(i){return this.publishedPromise.reject(i),{matched:!1,action:{type:"none",item:null}}}}finalizeSources(){if(!this._result)throw Error("Invalid state for source-finalization - the matcher's evaluation of the gesture model is not yet complete");let e=this._result.matched;for(let t=0;t<this.pathMatchers.length;t++){let n=this.pathMatchers[t],s=this.model.contacts[t];n.source.isPathComplete||(e&&s.endOnResolve||!e&&s.endOnReject)&&n.source.terminate(!1)}}get primaryPath(){let e,t=Number.NEGATIVE_INFINITY;for(let n of this.pathMatchers)n.model.itemPriority>t&&(t=n.model.itemPriority,e=n);return!e&&this.predecessor?this.predecessor.primaryPath:e==null?void 0:e.source}get baseItem(){return this.primaryPath.baseItem}get currentItem(){return this.primaryPath.currentSample.item}get allSourceIds(){let e=this.sources.map(n=>n.identifier),t=this.predecessor?this.predecessor.allSourceIds:[];return e=e.filter(n=>t.indexOf(n)==-1),e.concat(t)}mayAddContact(){return this.pathMatchers.length<this.model.contacts.length}addContact(e){let t=this.pathMatchers.length;if(!this.mayAddContact())throw new Error(`The specified gesture model does not support more than ${t} contact points.`);this.addContactInternal(e.constructSubview(!1,!0),null)}get result(){return this._result}addContactInternal(e,t,n){var F;let s=this.pathMatchers.length,i=this.model.contacts[s],B=new Qn(i.model,e,new Rt(t));this.pathMatchers.push(B);let c=null,l=null;if(!s&&this.predecessor&&this.model.sustainTimer){c=this.predecessor.primaryPath;let o=(F=this.model.sustainTimer.baseItem)!=null?F:"result",d;switch(o){case"none":l=null;break;case"base":l=this.predecessor.primaryPath.baseItem,d=this.predecessor.primaryPath.stateToken;break;case"result":l=this.predecessor.result.action.item,d=this.predecessor.primaryPath.currentSample.stateToken;break}e.baseItem=l!=null?l:e.baseItem,e.stateToken=d,e.currentSample.stateToken=d,e.currentRecognizerConfig&&(e.currentSample.item=e.currentRecognizerConfig.itemIdentifier(e.currentSample,null))}else l=this.primaryPath.baseItem,c=this.primaryPath;if(i.model.baseCoordReplacer){let o=e.path.stats,d=i.model.baseCoordReplacer(o,l);if(d){let U=V(h({},xc(e.currentRecognizerConfig,d.clientX,d.clientY)),{t:d.t||d.t===0?d.t:o.initialSample.t,item:l,stateToken:e.stateToken});e.path.replaceInitialSample(U)}}if(i.model.allowsInitialState&&!i.model.allowsInitialState(e.currentSample,c.currentSample,l,c.stateToken)){this.pathMatchers.pop(),this.finalize(!1,"cancelled");return}let a=B.update();if((a==null?void 0:a.type)=="reject"){this.finalize(!1,n?"cancelled":"path");return}B.promise.then(o=>{this.finalize(o.type=="resolve",o.cause)})}update(){this.pathMatchers.forEach(e=>{try{e.update()}catch(t){console.error(t),this.finalize(!1,"cancelled")}})}};r(Vc,"GestureMatcher");var Xe=Vc;var Lc=class Lc extends X.default{constructor(t){super();this._sourceSelector=[];this.potentialMatchers=[];this.sustainMode=!1;this.attemptSynchronousUpdate=r(()=>{let n=this._sourceSelector.filter(i=>!i.source.isPathComplete).map(i=>i.source.currentSample.t),s=n[0];n.find(i=>s!=i)||this.potentialMatchers.forEach(i=>i.update())},"attemptSynchronousUpdate");this.baseGestureSetId=t||"default"}potentialMatchersForSource(t){return this.potentialMatchers.filter(n=>n.allSourceIds.find(s=>s==t.identifier))}cascadeTermination(){let t=this.potentialMatchers,n=t.filter(c=>!c.model.sustainWhenNested),s=t.filter(c=>c.model.sustainWhenNested);this.potentialMatchers=s;let i=s.map(c=>c.allSourceIds).reduce((c,l)=>{for(let a of l)c.indexOf(a)==-1&&c.push(a);return c},[]);return this._sourceSelector.filter(c=>!i.find(l=>l==c.source.identifier)).forEach(c=>{c.matchPromise.resolve({matcher:null,result:{matched:!1,action:{type:"complete",item:null}}});let l=this._sourceSelector.indexOf(c);l>-1&&this._sourceSelector.splice(l,1)}),n.forEach(c=>c.cancel()),this.sustainMode=!0,this._sourceSelector.map(c=>c.source)}matchGesture(t,n){return L(this,null,function*(){let s=t instanceof gt,i=r(U=>{let u=U.sources.map(g=>g.baseSource);return u&&u.length>0?u:U.predecessor?i(U.predecessor):[]},"determinePredecessorSources"),B=s?[t instanceof st?t.baseSource:t]:i(t),c=s?t:null,l=s?null:t;if(this.pendingMatchSetup){let U=this.pendingMatchSetup,u=new E;this.pendingMatchSetup=u.corePromise,yield U,this.pendingMatchSetup==u.corePromise&&(this.pendingMatchSetup=null),u.resolve()}s&&c.path.on("invalidated",()=>{this.dropSourcesWithIds([c.identifier])});let a=new E,F=B.map(U=>{let u={source:U,matchPromise:a,preserve:!0};return this._sourceSelector.push(u),u}),o=F.map(U=>U.matchPromise);if(s){let U=this.potentialMatchers.filter(u=>u.mayAddContact());if(U.forEach(u=>{u.addContact(c),u.promise.then(this.matcherSelectionFilter(u,o))}),U.length>0){let u=this.stateToken,g=new E;this.pendingMatchSetup=g.corePromise,yield lt(0),yield lt(0),this.pendingMatchSetup==g.corePromise&&(this.pendingMatchSetup=null),g.resolve();let I=this.stateToken;if(u!=I){let x=c.currentSample;c.stateToken=I,x.stateToken=I,x.item=t.currentRecognizerConfig.itemIdentifier(x,null),c.baseItem=x.item}let C=U.find(x=>x.result);if(C&&C.allSourceIds.includes(t.identifier))return a.resolve({matcher:null,result:{matched:!1,action:{type:"complete",item:null}}}),{selectionPromise:a.corePromise}}}if(F.forEach(U=>{U.preserve=!1}),this.sustainMode&&c)return a.resolve({matcher:null,result:{matched:!1,action:{type:"complete",item:null}}}),{selectionPromise:a.corePromise,sustainModeWithoutMatch:!0};let d=n.map(U=>{try{return new Xe(U,c||l)}catch(u){return console.error(u),null}}).filter(U=>!!U);d=d.filter(U=>!U.result||U.result.matched!==!1);for(let U of d)U.promise.then(this.matcherSelectionFilter(U,o));return d.length>0?this.potentialMatchers=this.potentialMatchers.concat(d):a.resolve({matcher:null,result:{matched:!1,action:{type:"complete",item:null}}}),this.potentialMatchers.sort((U,u)=>u.model.resolutionPriority-U.model.resolutionPriority),this.resetSourceHooks(),{selectionPromise:a.corePromise}})}resetSourceHooks(){let t=r(n=>{let s=n;s.path.off("step",this.attemptSynchronousUpdate),s.path.off("complete",this.attemptSynchronousUpdate),s.path.off("invalidated",this.attemptSynchronousUpdate),s.path.on("step",this.attemptSynchronousUpdate),s.path.on("complete",this.attemptSynchronousUpdate),s.path.on("invalidated",this.attemptSynchronousUpdate)},"resetHooks");this._sourceSelector.forEach(n=>t(n.source))}dropSourcesWithIds(t){for(let n of t){let s=this._sourceSelector.findIndex(i=>i.source.identifier==n);s>-1&&this._sourceSelector.splice(s,1)[0].matchPromise.resolve({matcher:null,result:{matched:!1,action:{type:"none",item:null}}})}}matchersForSource(t){return this.potentialMatchers.filter(n=>!!n.sources.find(s=>s.identifier==t.identifier))}matcherSelectionFilter(t,n){return s=>L(this,null,function*(){t.isCancelled?s={matched:!1,action:{type:"none",item:null}}:t.finalizeSources();let B=t.allSourceIds.map(l=>this._sourceSelector.find(a=>a.source.identifier==l)).filter(l=>!!l),c=this.potentialMatchers.indexOf(t);if(c!=-1){if(this.potentialMatchers.splice(c,1),s.action.type=="none"){this.finalizeMatcherlessTrackers(B);return}if(s.matched)for(let l of B){let a=this.matchersForSource(l.source);this.potentialMatchers=this.potentialMatchers.filter(F=>!a.find(o=>F==o)),a.forEach(F=>{F.cancel()}),this._sourceSelector=this._sourceSelector.filter(F=>!B.find(o=>F==o)),l.matchPromise.resolve({matcher:t,result:s})}else{let l=r(a=>{if(this.sustainMode&&!a.sustainWhenNested){this.finalizeMatcherlessTrackers(B);return}let F=new Xe(a,t);if(F.result&&F.result.matched==!1){this.finalizeMatcherlessTrackers(B);return}F.promise.then(this.matcherSelectionFilter(F,B.map(o=>o.matchPromise))),this.potentialMatchers.push(F),this.resetSourceHooks()},"replacer");this.emit("rejectionwithaction",{matcher:t,result:s},l);return}}})}finalizeMatcherlessTrackers(t){let n=t.map(s=>({tracker:s,pendingCount:this.potentialMatchers.filter(i=>!!i.allSourceIds.find(B=>s.source.identifier==B)).length}));for(let s of n)s.pendingCount==0&&!s.tracker.preserve&&s.tracker.matchPromise.resolve({matcher:null,result:{matched:!1,action:{type:"complete",item:null}}})}};r(Lc,"MatcherSelector");var Qe=Lc;var Zc=class Zc{constructor(e,t){var i,B;let{matcher:n,result:s}=e;this.gestureSetId=t,this.matchedId=n==null?void 0:n.model.id,this.linkType=s.action.type,this.item=s.action.item,this.sources=n==null?void 0:n.sources,(i=this.sources)==null||i.forEach(c=>c.disconnect()),(B=this.sources)==null||B.sort((c,l)=>(n==null?void 0:n.primaryPath)==c?-1:(n==null?void 0:n.primaryPath)==l?1:0),this.allSourceIds=(n==null?void 0:n.allSourceIds)||[]}};r(Zc,"GestureStageReport");var $n=Zc,Jc=class Jc extends X.default{constructor(t,n,s,i){super();this.markedComplete=!1;this.selectionHandler=r(t=>L(this,null,function*(){var F,o,d,U,u,g,I,C,x,m;let n=((F=this.pushedSelector)==null?void 0:F.baseGestureSetId)||((o=this.selector)==null?void 0:o.baseGestureSetId),s=new $n(t,n);t.matcher&&this.stageReports.push(s);let i=(d=t.matcher)!=null?d:this.stageReports[this.stageReports.length-1],B=(U=i==null?void 0:i.sources.map(b=>b instanceof st?b.baseSource:b))!=null?U:[],c=t.result.action.type;if((c=="complete"||c=="none")&&(B.forEach(b=>{b.isPathComplete||b.terminate(c=="none")}),!t.result.matched)){this.markedComplete||(this.markedComplete=!0,this.emit("complete"));return}if(c=="complete"&&this.touchpointCoordinator&&this.pushedSelector){let p=((u=this.touchpointCoordinator)==null?void 0:u.sustainSelectorSubstack(this.pushedSelector)).map(J=>{let Z=new E;return J.path.on("invalidated",()=>Z.resolve()),J.path.on("complete",()=>Z.resolve()),Z.corePromise});p.length>0&&t.result.action.awaitNested&&(yield Promise.all(p),yield lt(0)),(g=this.touchpointCoordinator)==null||g.popSelector(this.pushedSelector),this.pushedSelector=null}this.emit("stage",s,b=>{b.type=="pop"?B.forEach(p=>p.popRecognizerConfig()):B.forEach(p=>p.pushRecognizerConfig(b.config))});let l=!1;this.touchpointCoordinator&&(l=!this.touchpointCoordinator.selectorStackIncludes(this.selector));let a=Ec(t.result.action,this.gestureConfig,this.baseGestureSetId);if(l&&(a=a.filter(b=>b.sustainWhenNested)),a.length>0){if(!(c=="chain"&&t.result.action.selectionMode==((I=this.pushedSelector)==null?void 0:I.baseGestureSetId))){if(this.pushedSelector&&(this.pushedSelector.off("rejectionwithaction",this.modelResetHandler),(C=this.touchpointCoordinator)==null||C.popSelector(this.pushedSelector),this.pushedSelector=null),c=="chain"){let J=t.result.action.selectionMode;if(J){let Z=new Qe(J);Z.on("rejectionwithaction",this.modelResetHandler),this.pushedSelector=Z,(x=this.touchpointCoordinator)==null||x.pushSelector(Z)}}}((m=this.pushedSelector)!=null?m:this.selector).matchGesture(t.matcher,a).then(J=>L(this,null,function*(){return this.selectionHandler(yield J.selectionPromise)}))}else this.markedComplete||(this.markedComplete=!0,this.emit("complete"))}),"selectionHandler");this.modelResetHandler=r((t,n)=>{let s=t.matcher.allSourceIds;if(!this.allSourceIds.find(i=>s.indexOf(i)==-1))if(t.result.action.type=="replace")n(pe(this.gestureConfig,t.result.action.replace));else throw new Error("Missed a case in implementation!")},"modelResetHandler");this.stageReports=[],this.selector=s,this.selector.on("rejectionwithaction",this.modelResetHandler),this.once("complete",()=>{var B;this.pushedSelector&&((B=this.touchpointCoordinator)==null||B.popSelector(this.pushedSelector),this.pushedSelector=null),this.selector.off("rejectionwithaction",this.modelResetHandler),this.selector.dropSourcesWithIds(this.allSourceIds),this.selector=null}),this.gestureConfig=n,this.touchpointCoordinator=i,Promise.resolve().then(()=>this.selectionHandler(t))}get allSourceIds(){var t,n;return(n=(t=this.stageReports[this.stageReports.length-1])==null?void 0:t.allSourceIds)!=null?n:[]}get baseGestureSetId(){var t,n;return(n=(t=this.selector)==null?void 0:t.baseGestureSetId)!=null?n:null}get potentialModelMatchIds(){if(!this.selector)return[];let t=[this.selector];return this.pushedSelector&&t.push(this.pushedSelector),this.stageReports[this.stageReports.length-1].sources.map(B=>t.map(c=>c.potentialMatchersForSource(B).map(l=>l.model.id))).reduce((B,c)=>B.concat(c)).reduce((B,c)=>{for(let l of c)B.indexOf(l)==-1&&B.push(l);return B},[])}cancel(){this.stageReports[this.stageReports.length-1].sources.forEach(n=>n.baseSource.isPathComplete||n.baseSource.terminate(!0)),this.markedComplete||(this.markedComplete=!0,this.emit("complete"))}toJSON(){return this.stageReports}};r(Jc,"GestureSequence");var an=Jc;function Ec(Q,e,t){switch(Q.type){case"none":case"complete":return[];case"replace":return[pe(e,Q.replace)];case"chain":return[pe(e,Q.next)];default:throw new Error("Unexpected case arose within `processGestureAction` method")}}r(Ec,"modelSetForAction");var Rc=class Rc extends X.default{constructor(t,n,s){super();this.selectorStack=[new Qe];this._activeSources=[];this._activeGestures=[];this._history=[];this.modelResetHandler=r((t,n)=>{let s=t.matcher.allSourceIds;if(!this.activeGestures.find(i=>i.allSourceIds.find(B=>s.indexOf(B)!=-1)))if(t.result.action.type=="replace")n(pe(this.gestureModelDefinitions,t.result.action.replace));else throw new Error("Missed a case in implementation!")},"modelResetHandler");this.onNewTrackedPath=r(t=>L(this,null,function*(){this.addSimpleSourceHooks(t);let n=this.gestureModelDefinitions,s,i;do{s=this.currentSelector;let d=yield s.matchGesture(t,Ic(n,s.baseGestureSetId));if(d.sustainModeWithoutMatch){let U=r(u=>{u.stateToken=this.stateToken,u.item=t.currentRecognizerConfig.itemIdentifier(u,null)},"correctSample");t.path instanceof re&&t.path.coords.forEach(U),t.stateToken=this.stateToken,t.baseItem=t.path.stats.initialSample.item,U(t.path.stats.initialSample),U(t.path.stats.lastSample);continue}else{i=d.selectionPromise;break}}while(s!=this.currentSelector);let B=this.currentSelector;t.setGestureMatchInspector(this.buildGestureMatchInspector(B));let c=r(()=>{this.recordHistory(t)},"preGestureScribe");try{t.path.on("invalidated",c),this.emit("inputstart",t)}catch(o){Jt("Error from 'inputstart' event listener",o)}this.inputEngines.forEach(o=>{o.fulfillInputStart(t)});let l=yield i;if(!l||l.result.matched==!1)return;let a=l.matcher.allSourceIds;for(let o of this._activeGestures)if(o.allSourceIds.find(d=>!!a.find(U=>d==U)))return;let F=new an(l,n,this.currentSelector,this);this._activeGestures.push(F),F.on("complete",()=>{let o=this._activeGestures.indexOf(F);o!=-1&&this._activeGestures.splice(o,1)}),t.path.wasCancelled||(t.path.off("invalidated",c),F.on("complete",()=>this.recordHistory(F))),this.emit("recognizedgesture",F)}),"onNewTrackedPath");if(this.historyMax=s>0?s:0,this.gestureModelDefinitions=t,this.inputEngines=[],n)for(let i of n)this.addEngine(i);this.selectorStack[0].on("rejectionwithaction",this.modelResetHandler)}pushSelector(t){this.selectorStack.push(t),t.on("rejectionwithaction",this.modelResetHandler)}sustainSelectorSubstack(t){if(!t)return[];let n=this.selectorStack.indexOf(t);if(n==-1)return[];if(this.selectorStack.length<=1)throw new Error("May not force the original, base gesture selector into sustain mode.");let s=[];for(let i=n;i<this.selectorStack.length;i++)t=this.selectorStack[i],s=s.concat(t.cascadeTermination());return s}popSelector(t){if(!t)return;let n=this.selectorStack.indexOf(t);if(n!=-1){if(this.selectorStack.length<=1)throw new Error("May not pop the original, base gesture selector.");for(;n<this.selectorStack.length;)t=this.selectorStack[n],t.off("rejectionwithaction",this.modelResetHandler),this.selectorStack.splice(n,1);this.currentSelector.stateToken=this.stateToken}}selectorStackIncludes(t){return this.selectorStack.includes(t)}get currentSelector(){return this.selectorStack[this.selectorStack.length-1]}buildGestureMatchInspector(t){return n=>{let s=this.selectorStack.indexOf(t);return this.selectorStack.slice(s).map(B=>B.potentialMatchersForSource(n).map(c=>c.model.id)).reduce((B,c)=>B.concat(c))}}addEngine(t){t.on("pointstart",this.onNewTrackedPath),this.inputEngines.push(t)}recordHistory(t){let n=this.historyMax;n>0&&(this._history.length==n&&this._history.shift(),this._history.push(t))}get activeGestures(){return[].concat(this._activeGestures)}get activeSources(){return[].concat(this.inputEngines.map(t=>t.activeSources).reduce((t,n)=>t.concat(n),[]))}get history(){return this._history}get historyJSON(){let t=r(function(n,s){return n=="item"?s==null?void 0:s.id:s},"sanitizingReplacer");return JSON.stringify(this.history,t,2)}get stateToken(){return this._stateToken}set stateToken(t){this._stateToken=t,this.inputEngines.forEach(n=>n.stateToken=t),this.currentSelector.stateToken=t}addSimpleSourceHooks(t){t.path.on("invalidated",()=>{let n=this.activeGestures.find(i=>i.allSourceIds.includes(t.identifier));n&&n.cancel();let s=this._activeSources.indexOf(t);this._activeSources=this._activeSources.splice(s,1)}),t.path.on("complete",()=>{let n=this._activeSources.indexOf(t);this._activeSources=this._activeSources.splice(n,1)})}};r(Rc,"TouchpointCoordinator");var gi=Rc;var ui={};Vn(ui,{EMPTY_GESTURE_DEFS:()=>hc,getGestureModel:()=>pe,getGestureModelSet:()=>Ic});var Ac=class Ac extends gi{constructor(t,n){let s=ri(n);t=t||hc;super(t,null,s.historyLength);this.config=s,this.mouseEngine=new Ui(this.config),this.touchEngine=new di(this.config),this.mouseEngine.registerEventHandlers(),this.touchEngine.registerEventHandlers(),this.addEngine(this.mouseEngine),this.addEngine(this.touchEngine)}destroy(){this.activeGestures.forEach(t=>t.cancel()),this.activeSources.forEach(t=>t.terminate(!0)),this.mouseEngine.unregisterEventHandlers(),this.touchEngine.unregisterEventHandlers(),this.mouseEngine=null,this.touchEngine=null}};r(Ac,"GestureRecognizer");var Se=Ac;var Hc={};Vn(Hc,{matchers:()=>yi,specs:()=>ui});var yi={};Vn(yi,{GestureMatcher:()=>Xe,GestureSequence:()=>an,GestureStageReport:()=>$n,MatcherSelector:()=>Qe,PathMatcher:()=>Qn,modelSetForAction:()=>Ec});var Wc=["n","ne","e","se","s","sw","w","nw"],Sr=Math.PI,vc=(()=>{let Q=new Map,e=Sr/4;for(let t=0;t<Wc.length;t++)Q.set(Wc[t],[e*t,1]);return Q})();function Ii(Q){return Math.PI/4*Wc.indexOf(Q)}r(Ii,"lockedAngleForDir");function es(Q,e){let t=Ii(e),n=Q.initialSample,s=Q.lastSample.targetX-n.targetX,i=Q.lastSample.targetY-n.targetY,B=Math.max(0,-i*Math.cos(t));return Math.max(0,s*Math.sin(t))+B}r(es,"calcLockedDistance");function xQ(Q,e,t,n){return s=>{let i=Ii(e),B=n.flick.triggerDist-n.flick.dirLockDist,c=Math.max(0,es(Q.path.stats,e)-n.flick.dirLockDist),a=Math.min(1,.7*c/B),F=Math.sin(i)*a,o=-Math.cos(i)*a;t==null||t.scrollFlickPreview(F,o)}}r(xQ,"buildFlickScroller");var hi=Math.PI/3,fc=class fc{constructor(e,t,n,s,i,B){this.directlyEmitsKeys=!0;this.sequence=e,this.gestureParams=i,this.baseSpec=s.key.spec,this.baseKeyDistances=n.getSimpleTapCorrectionDistances(e.stageReports[0].sources[0].path.stats.initialSample,this.baseSpec);let c=e.stageReports[0].sources[0].baseSource,l=c;e.on("complete",()=>{B==null||B.cancel()}),this.sequence.on("stage",F=>{var u;let o=l.path.stats;this.computedFlickDistribution=this.flickDistribution(o,!0);let d=this.computedFlickDistribution[0].keySpec;if(F.matchedId=="flick-restart"){l.path.replaceInitialSample(F.sources[0].path.stats.initialSample);return}if(F.matchedId=="flick-reset-centering"){l=c.constructSubview(!0,!0);return}else if(F.matchedId=="flick-reset-end"){this.emitKey(n,this.baseSpec,l.path.stats);return}else if(F.matchedId=="flick-reset"){this.flickScroller&&(this.flickScroller(l.currentSample),l.path.off("step",this.flickScroller)),this.lockedDir=null,this.lockedSelectable=null,l instanceof st&&l.disconnect();return}else if(F.matchedId=="flick-mid"){if(d==this.baseSpec)return;let g=Object.keys(this.baseSpec.flick).find(I=>this.baseSpec.flick[I]==d);this.lockedDir=g,this.lockedSelectable=d,this.flickScroller&&l.path.off("step",this.flickScroller),this.flickScroller=xQ(l,g,B,this.gestureParams),this.flickScroller(l.currentSample),l.path.on("step",this.flickScroller);return}let U=(u=this.lockedSelectable)!=null?u:d;this.emitKey(n,U,o)});let a=this.buildPopupRecognitionConfig(n);t({type:"push",config:a})}emitKey(e,t,n){let s;es(n,this.lockedDir)>this.gestureParams.flick.triggerDist?s=e.keyEventFromSpec(t):s=e.keyEventFromSpec(this.baseSpec),s.keyDistribution=this.currentStageKeyDistribution(this.baseKeyDistances),e.raiseKeyEvent(s,null)}buildPopupRecognitionConfig(e){let t={getBoundingClientRect(){let n=Number.MAX_SAFE_INTEGER;return new DOMRect(-n,-n,2*n,2*n)}};return V(h({},e.gestureEngine.config),{maxRoamingBounds:t,safeBounds:t})}cancel(){}flickDistribution(e,t){let n=this.baseSpec.flick,s=[{spec:this.baseSpec,coord:[NaN,0]}];s=s.concat(Object.keys(n).map(d=>({spec:n[d],coord:vc.get(d)})));let i=e.angle,B=this.gestureParams.flick.triggerDist,l=Math.min(B,t?B:e.netDistance)/B,a=0,F=s.map(d=>{let U=0,u=d.coord;if(!isNaN(u[0])){let x=i-u[0],m=2*Sr+u[0]-i;U=Math.min(x*x,m*m)}let g=hi*(u[1]-l),I=g*g,C=1/(U+I+1e-6);return a+=C,{keySpec:d.spec,p:C}}),o=1/a;return F.forEach(d=>d.p*=o),F.sort((d,U)=>U.p-d.p)}currentStageKeyDistribution(e){let t=this.baseSpec,n=this.baseKeyDistances,s=this.computedFlickDistribution;if(!n.get(t))return[{keySpec:s[0].keySpec,p:1}];let B=s.findIndex(a=>a.keySpec==t),c=s.splice(B,1)[0].p,l=ne(n);return s.concat(l.map(a=>({keySpec:a.keySpec,p:a.p*c})))}};r(fc,"Flick");var ts=fc;var bi=gQ.TouchLayoutKeySp,Tc={longpress:{permitsFlick:()=>!0,flickDistStart:8,flickDistFinal:40,waitLength:500,noiseTolerance:10},multitap:{waitLength:300,holdLength:150},flick:{startDist:10,dirLockDist:25,triggerDist:40}};function Vr(Q){let e=Q.getBoundingClientRect();return{clientX:e.left+e.width/2,clientY:e.top+e.height/2}}r(Vr,"getKeyCentroid");function Lr(Q){let e=Vr(Q);return t=>{let n=t.lastSample.clientX-e.clientX,s=t.lastSample.clientY-e.clientY;return Math.sqrt(n*n+s*s)}}r(Lr,"buildDistFromKeyCentroidFunctor");function ns(Q){let e=Q.key.spec;if(e.sk)return!1;let t=["K_SHIFT","K_ALT","K_CTRL","K_NUMERALS","K_SYMBOLS","K_CURRENCIES"];for(let n of t)if(e.id==n)return!0;if(e.nextlayer)switch(e.sp){case bi.special:case bi.specialActive:case bi.customSpecial:case bi.customSpecialActive:return!0;default:return!1}else return!1}r(ns,"keySupportsModipress");function kc(Q,e){let t=r((d,U)=>{if(!d)return!1;let u=d.key.spec;switch(U){case"modipress-start":return ns(d);case"special-key-start":return["K_LOPT","K_ROPT","K_BKSP"].indexOf(u.baseKeyID)!=-1;case"longpress":return!0;case"multitap-start":case"modipress-multitap-start":return Q.hasMultitaps?!!u.multitap:!1;case"flick-start":return!!u.flick;default:return!0}},"gestureKeyFilter"),n=e.roamingEnabled||(e.roamingEnabled=!Q.hasFlicks),s=Bt(n?MQ(e):Hr(e)),i=Bt(n?Mc(e):Wr(e)),B=Bt(Rr(e,!0,n));function c(d,U){d=Bt(d);let u=d.id;return typeof U=="number"&&(U=[U]),d.contacts.forEach((g,I)=>{var C;if(U.indexOf(I)!=-1){let x=(C=g.model.allowsInitialState)!=null?C:()=>!0;g.model=V(h({},g.model),{allowsInitialState:(m,b,p)=>t(p,u)&&x(m,b,p)})}}),d}r(c,"withKeySpecFiltering");let l=EQ(),a=OQ(),F=[c(B,0),c(kQ(e),0),NQ(e),s,i,c(l,0),ZQ(e),YQ(),c(a,0),wQ(e),DQ(),zQ(),c(KQ(e),0),PQ(e),jQ()],o=[B.id,s.id,a.id,l.id];return n?(F.push(c(JQ(e),0)),F.push(RQ())):(F.push(c(Ar(e),0)),F.push(HQ(e)),F.push(WQ(e)),F.push(vQ(e)),F.push(AQ(e)),F.push(fQ()),F.push(TQ(e)),o.push("flick-start")),{gestures:F,sets:{default:o,modipress:o.filter(d=>d!=a.id),none:[]}}}r(kc,"gestureSetForLayout");function Nc(){return{itemPriority:0,pathResolutionAction:"reject",pathModel:{evaluate:Q=>"resolve"}}}r(Nc,"instantContactRejectionModel");function Ot(){return{itemPriority:0,pathResolutionAction:"resolve",pathModel:{evaluate:Q=>"resolve"}}}r(Ot,"instantContactResolutionModel");function GQ(Q){let e=Q.flick;return{itemPriority:1,pathModel:{evaluate:(t,n,s)=>{let i=t.stats,B=s==null?void 0:s.key.spec;if(B&&B.sk){let c=B.flick;if(!(c.nw||c.n||c.ne)){let a=i.netDistance,F=i.angle;if(a*Math.cos(F)>Q.longpress.flickDistStart)return"reject"}}return i.netDistance>e.startDist?"resolve":null}},pathResolutionAction:"resolve",pathInheritance:"partial"}}r(GQ,"flickStartContactModel");function Er(Q,e){let t=e.key.spec.flick,n=Object.keys(t),s,i=0;for(let B of n){let c=es(Q,B);c>i&&(i=c,s=B)}return{dir:s,dist:i}}r(Er,"determineLockFromStats");function pQ(Q){return{itemPriority:1,pathModel:{evaluate:(e,t,n)=>{let{dir:s,dist:i}=Er(e.stats,n);if(i>Q.flick.dirLockDist){let B=e.stats.angle,c=Ii(s),l=Math.abs(B-c),a=Math.abs(2*Math.PI+c-B);if(l<=hi||a<=hi)return"resolve"}else if(e.isComplete)return"reject"}},pathResolutionAction:"resolve",pathInheritance:"full"}}r(pQ,"flickMidContactModel");function XQ(Q){return{itemPriority:1,pathModel:{evaluate:(e,t,n,s)=>{if(e.isComplete)return"resolve";{let{dir:i}=Er(s,n);if(es(e.stats,i)<Q.flick.dirLockDist)return"reject"}}},pathResolutionAction:"resolve",pathInheritance:"full"}}r(XQ,"flickEndContactModel");function SQ(Q,e,t){let n=Q.longpress;return{itemPriority:0,pathResolutionAction:"resolve",timer:{duration:n.waitLength,expectedResult:!0},validateItem:(s,i)=>!!(i!=null&&i.key.spec.sk),pathModel:{evaluate:s=>{var B;let i=s.stats;if(e&&n.permitsFlick(i.lastSample.item)&&((B=i.cardinalDirection)==null?void 0:B.indexOf("n"))!=-1){let c=i.netDistance,l=i.angle;if(c*Math.cos(l)>n.flickDistFinal)return"resolve"}else if(t){if(i.rawDistance>n.noiseTolerance||i.lastSample.item!=i.initialSample.item)return"reject"}else if(i.lastSample.item!=i.initialSample.item)return"reject";return s.isComplete?"reject":null}}}}r(SQ,"longpressContactModel");function Zr(){return{itemPriority:-1,pathResolutionAction:"resolve",pathModel:{evaluate:Q=>"resolve"}}}r(Zr,"modipressContactStartModel");function VQ(){return{itemPriority:-1,itemChangeAction:"resolve",pathResolutionAction:"resolve",pathModel:{evaluate:Q=>{if(Q.isComplete)return"reject"}}}}r(VQ,"modipressContactHoldModel");function Jr(){return{itemPriority:-1,itemChangeAction:"resolve",pathResolutionAction:"resolve",pathModel:{evaluate:Q=>{if(Q.isComplete)return"resolve"}}}}r(Jr,"modipressContactEndModel");function Ci(Q,e){var n;let t=(n=Q==null?void 0:Q.roamingEnabled)!=null?n:!0;return{itemPriority:0,itemChangeAction:t?"reject":void 0,pathResolutionAction:"resolve",pathInheritance:!t&&e?"full":"chop",pathModel:{evaluate:s=>{if(s.isComplete&&!s.wasCancelled)return"resolve"}}}}r(Ci,"simpleTapContactModel");function LQ(){return{itemPriority:0,pathResolutionAction:"resolve",pathModel:{evaluate:Q=>{if(Q.isComplete&&!Q.wasCancelled)return"resolve"}}}}r(LQ,"subkeySelectContactModel");function EQ(){return{id:"special-key-start",resolutionPriority:0,contacts:[{model:h({},Ot()),endOnResolve:!1}],resolutionAction:{type:"chain",next:"special-key-end",item:"current"}}}r(EQ,"specialKeyStartModel");function ZQ(Q){return{id:"special-key-end",resolutionPriority:0,contacts:[{model:V(h({},Ci(Q)),{itemChangeAction:"resolve"}),endOnResolve:!0}],resolutionAction:{type:"complete",item:"none"}}}r(ZQ,"specialKeyEndModel");function Rr(Q,e,t){let n={id:"longpress",resolutionPriority:4,contacts:[{model:V(h({},SQ(Q,e,t)),{itemPriority:1,pathInheritance:"chop"}),endOnResolve:!1},{model:Nc(),resetOnInstantFulfill:!0}],resolutionAction:{type:"chain",next:"subkey-select",selectionMode:"none",item:"none"}};return t?V(h({},n),{rejectionActions:{path:{type:"replace",replace:"longpress-roam"},timer:{type:"replace",replace:"longpress-roam-restore"}}}):n}r(Rr,"longpressModel");function JQ(Q){let e=Rr(Q,!1,!0);return V(h({},e),{id:"longpress-roam"})}r(JQ,"longpressModelAfterRoaming");function RQ(){return{id:"longpress-roam-restore",contacts:[{model:{pathModel:{evaluate:Q=>null},itemChangeAction:"reject",pathInheritance:"full",pathResolutionAction:"reject",itemPriority:0}}],resolutionPriority:-1,rejectionActions:{item:{type:"replace",replace:"longpress-roam"}},resolutionAction:{type:"chain",next:"longpress-roam"}}}r(RQ,"longpressRoamRestoration");function Ar(Q){return{id:"flick-start",resolutionPriority:3,contacts:[{model:GQ(Q)}],resolutionAction:{type:"chain",item:"none",next:"flick-mid"}}}r(Ar,"flickStartModel");function AQ(Q){let e=Ar(Q);return V(h({},e),{contacts:[V(h({},e.contacts[0]),{model:V(h({},e.contacts[0].model),{baseCoordReplacer:(t,n)=>{let s=Vr(n),i=Lr(n),B=t.initialSample,c=i(t);if(c>Q.flick.triggerDist)return s;let l=Q.flick.dirLockDist;if(c<l)return B;let a=l/c,F=B.clientX-s.clientX,o=B.clientY-s.clientY;return{clientX:s.clientX+F*a,clientY:s.clientY+o*a}}})})],id:"flick-restart",sustainWhenNested:!0,rejectionActions:{path:{type:"replace",replace:"flick-reset-end"}}})}r(AQ,"flickRestartModel");function HQ(Q){return{id:"flick-mid",resolutionPriority:0,contacts:[{model:pQ(Q),endOnReject:!0},{model:Nc(),resetOnInstantFulfill:!0}],rejectionActions:{path:{type:"replace",replace:"flick-reset-end"}},resolutionAction:{type:"chain",item:"none",next:"flick-end"},sustainWhenNested:!0}}r(HQ,"flickMidModel");function WQ(Q){return{id:"flick-reset",resolutionPriority:1,contacts:[{model:V(h({},Ot()),{pathInheritance:"partial"})}],resolutionAction:{type:"chain",next:"flick-reset-centering"},sustainWhenNested:!0}}r(WQ,"flickResetModel");function vQ(Q){return{id:"flick-reset-centering",resolutionPriority:1,contacts:[{model:{pathModel:{evaluate(e,t,n){t||(t=e.stats);let s=Lr(n),i=s(e.stats);if(s(t)<i)return"resolve"}},itemPriority:0,pathResolutionAction:"resolve",pathInheritance:"full"}}],resolutionAction:{type:"chain",next:"flick-restart"},sustainWhenNested:!0}}r(vQ,"flickResetCenteringModel");function fQ(){return{id:"flick-reset-end",resolutionPriority:1,contacts:[],sustainTimer:{duration:0,expectedResult:!0},resolutionAction:{type:"complete",item:"base"},sustainWhenNested:!0}}r(fQ,"flickResetEndModel");function TQ(Q){return{id:"flick-end",resolutionPriority:0,contacts:[{model:XQ(Q)},{model:Ot(),resetOnInstantFulfill:!0}],rejectionActions:{path:{type:"replace",replace:"flick-reset"}},resolutionAction:{type:"complete",item:"current"},sustainWhenNested:!0}}r(TQ,"flickEndModel");function kQ(Q){return{id:"multitap-start",resolutionPriority:2,contacts:[{model:V(h({},Ot()),{itemPriority:1,pathInheritance:"reject",allowsInitialState(e,t,n){return e.item==n}})}],sustainTimer:{duration:Q.multitap.waitLength,expectedResult:!1,baseItem:"base"},resolutionAction:{type:"chain",next:"multitap-end",item:"current"}}}r(kQ,"multitapStartModel");function NQ(Q){return{id:"multitap-end",resolutionPriority:2,contacts:[{model:V(h({},Ci(Q)),{itemPriority:1,timer:{duration:Q.multitap.holdLength,expectedResult:!1}}),endOnResolve:!0},{model:Ot(),resetOnInstantFulfill:!0}],rejectionActions:{timer:{type:"replace",replace:"simple-tap"}},resolutionAction:{type:"chain",next:"multitap-start",item:"none"}}}r(NQ,"multitapEndModel");function Hr(Q){return{id:"initial-tap",resolutionPriority:1,contacts:[{model:V(h({},Ci(Q)),{pathInheritance:"chop",itemPriority:1,timer:{duration:Q.multitap.holdLength,expectedResult:!1}}),endOnResolve:!0},{model:Ot(),resetOnInstantFulfill:!0}],sustainWhenNested:!0,rejectionActions:{timer:{type:"replace",replace:"simple-tap"}},resolutionAction:{type:"chain",next:"multitap-start",item:"base"}}}r(Hr,"initialTapModel");function Wr(Q){return{id:"simple-tap",resolutionPriority:1,contacts:[{model:V(h({},Ci(Q,!0)),{itemPriority:1}),endOnResolve:!0},{model:Ot(),resetOnInstantFulfill:!0}],sustainWhenNested:!0,resolutionAction:{type:"complete",item:"base"}}}r(Wr,"simpleTapModel");function MQ(Q){let e=Hr(Q);return V(h({},e),{rejectionActions:V(h({},e.rejectionActions),{item:{type:"replace",replace:"initial-tap"}})})}r(MQ,"initialTapModelWithReset");function Mc(Q){let e=Wr(Q);return V(h({},e),{rejectionActions:V(h({},e.rejectionActions),{item:{type:"replace",replace:"simple-tap"}})})}r(Mc,"simpleTapModelWithReset");function YQ(){return{id:"subkey-select",resolutionPriority:0,contacts:[{model:V(h({},LQ()),{pathInheritance:"full",itemPriority:1}),endOnResolve:!0,endOnReject:!0}],resolutionAction:{type:"complete",item:"current"},sustainWhenNested:!0}}r(YQ,"subkeySelectModel");function OQ(){return{id:"modipress-start",resolutionPriority:5,contacts:[{model:V(h({},Zr()),{allowsInitialState(Q,e,t){return ns(t)},itemChangeAction:"reject",itemPriority:1})}],resolutionAction:{type:"chain",next:"modipress-hold",selectionMode:"modipress",item:"current"}}}r(OQ,"modipressStartModel");function wQ(Q){return{id:"modipress-hold",resolutionPriority:5,contacts:[{model:V(h({},VQ()),{itemChangeAction:"reject",pathInheritance:"full",timer:{duration:Q.multitap.holdLength,expectedResult:!0,inheritElapsed:!0}})},{model:h({},Ot()),resetOnInstantFulfill:!0}],resolutionAction:{type:"chain",next:"modipress-end",selectionMode:"modipress",item:"none"},rejectionActions:{path:{type:"replace",replace:"modipress-end-multitap-transition"}}}}r(wQ,"modipressHoldModel");function zQ(){return{id:"modipress-end-multitap-transition",resolutionPriority:5,contacts:[],sustainTimer:{duration:0,expectedResult:!0},resolutionAction:{type:"chain",next:"modipress-multitap-start",item:"none"}}}r(zQ,"modipressMultitapTransitionModel");function DQ(){return{id:"modipress-end",resolutionPriority:5,contacts:[{model:V(h({},Jr()),{itemChangeAction:"reject",pathInheritance:"full"})}],resolutionAction:{type:"complete",item:"none",awaitNested:!0}}}r(DQ,"modipressEndModel");function KQ(Q){return{id:"modipress-multitap-start",resolutionPriority:6,contacts:[{model:V(h({},Zr()),{pathInheritance:"reject",allowsInitialState(e,t,n){return e.item!=n?!1:ns(n)},itemChangeAction:"reject",itemPriority:1})}],sustainTimer:{duration:Q.multitap.waitLength,expectedResult:!1,baseItem:"base"},resolutionAction:{type:"chain",next:"modipress-multitap-end",selectionMode:"modipress",item:"current"}}}r(KQ,"modipressMultitapStartModel");function PQ(Q){return{id:"modipress-multitap-end",resolutionPriority:5,contacts:[{model:V(h({},Jr()),{itemChangeAction:"reject",pathInheritance:"full",timer:{duration:Q.multitap.holdLength,expectedResult:!1}})},{model:h({},Nc()),resetOnInstantFulfill:!0}],resolutionAction:{type:"chain",next:"modipress-multitap-start",item:"none"},rejectionActions:{timer:{type:"replace",replace:"modipress-multitap-lock-transition"},path:{type:"replace",replace:"modipress-multitap-lock-transition"}}}}r(PQ,"modipressMultitapEndModel");function jQ(){return{id:"modipress-multitap-lock-transition",resolutionPriority:5,contacts:[{model:V(h({},Ot()),{pathResolutionAction:"resolve"})}],resolutionAction:{type:"chain",next:"modipress-end",selectionMode:"modipress",item:"none"}}}r(jQ,"modipressMultitapLockModel");var vr=V(h({},Bt(Mc(null))),{resolutionAction:{type:"complete",item:"current"}}),fr={gestures:[vr],sets:{default:[vr.id]}};function mi(Q){var e;return typeof Q=="string"?e=Q:(e=Q.style.fontSize,e||(e=getComputedStyle(Q).fontSize)),new G(e)}r(mi,"getFontSizeStyle");function Tr(Q,e,t){if(Q.touchable){let n=Q.formFactor=="phone"?1.6*(t?.65:.6)*1.2:2;return G.special(n,"em")}else return e?G.inPixels(e/8):void 0}r(Tr,"defaultFontSize");var ss;function xi(Q,e,t){t={fontFamily:t.fontFamily,fontSize:t.fontSize},t.fontFamily||(t.fontFamily=getComputedStyle(document.body).fontFamily),(!t.fontSize||t.fontSize=="")&&(t.fontSize="1em");let n=t.fontFamily,s=mi(t.fontSize);var i;s.absolute?i=s.val+"px":i=s.val*e+"px",ss=ss!=null?ss:document.createElement("canvas");var B=ss.getContext("2d");B.font=i+" "+n;var c=B.measureText(Q);return c}r(xi,"getTextMetrics");var _Q=10,Yc=class Yc{constructor(e,t){this.totalLength=0;this.baseCoord=e,this.curCoord=e,this.baseScrollLeft=t,this.totalLength=0}updateTo(e){let t=this.curCoord;this.curCoord=e;let n=this.baseCoord.targetX-this.curCoord.targetX+this.baseScrollLeft;return this.totalLength+=Math.abs(this.curCoord.targetX-t.targetX),n}get hasScrolled(){return this.totalLength>_Q}};r(Yc,"BannerScrollState");var Gi=Yc;var kr="kmw-suggest-touched",qQ="kmw-suggest-banner-scroller",Nr=.666,Mr="swallow-fade-transition",is=class is{constructor(e,t){this.index=e,this.rtl=t!=null?t:!1,this.constructRoot();let n=this.display=A("span");n.className="kmw-suggestion-text",this.container.appendChild(n)}get computedStyle(){return getComputedStyle(this.display)}constructRoot(){let e=this.div=A("div");e.className="kmw-suggest-option",e.id=is.BASE_ID+this.index,this.div.suggestion=this;let t=this.container=document.createElement("div");t.className="kmw-suggestion-container";let s=(100-Ht.MARGIN*(Ht.LONG_SUGGESTION_DISPLAY_LIMIT-1))/Ht.LONG_SUGGESTION_DISPLAY_LIMIT;t.style.minWidth=s+"%",e.appendChild(t)}matchKeyboardProperties(e){let t=this.div;if(e){e.KLC&&(t.lang=e.KLC);let n=e.KFont;n&&n.family&&n.family!=""&&(t.style.fontFamily=n.family)}}get suggestion(){return this._suggestion}update(e,t){this._suggestion=e;let n=this.generateSuggestionText(this.rtl);if(this.container.replaceChild(n,this.display),this.display=n,t.minWidth!==void 0&&(this._minWidth=t.minWidth),this._paddingWidth=t.paddingWidth,this._collapsedWidth=t.collapsedWidth,e&&e.displayAs){let s=xi(e.displayAs,t.emSize,t.styleForFont);this._textWidth=s.width}else this._textWidth=0;this.currentWidth=this.collapsedWidth,this.highlight(e==null?void 0:e.autoAccept),this.updateLayout()}updateLayout(){if(!this.suggestion&&this.index!=0){this.div.style.width="0px";return}else this.div.style.width="";let e=this.container.style;e.minWidth=this.collapsedWidth+"px",this.rtl?e.marginRight=this.collapsedWidth-this.expandedWidth+"px":e.marginLeft=this.collapsedWidth-this.expandedWidth+"px",this.updateFade()}updateFade(){this.div.classList.add(Mr),window.requestAnimationFrame(()=>{this.div.classList.remove(Mr)}),this.div.classList.add(`kmw-hide-fade-${this.rtl?"left":"right"}`);let e=`kmw-hide-fade-${this.rtl?"right":"left"}`;this.expandedWidth-this.collapsedWidth?this.div.classList.remove(e):this.div.classList.add(e)}get targetCollapsedWidth(){return this._collapsedWidth}get textWidth(){return this._textWidth}get paddingWidth(){return this._paddingWidth}get minWidth(){return this._minWidth}set minWidth(e){this._minWidth=e}get expandedWidth(){return this.minWidth>this.spanWidth?this.minWidth:this.spanWidth}get spanWidth(){var t,n;let e=(t=this.textWidth)!=null?t:0;return e&&(e+=(n=this.paddingWidth)!=null?n:0),e}get collapsedWidth(){let e=this.spanWidth<this.targetCollapsedWidth?this.spanWidth:this.targetCollapsedWidth,t=e<this.expandedWidth?e:this.expandedWidth;return this.minWidth>t?this.minWidth:t}get currentWidth(){return this.div.offsetWidth}set currentWidth(e){e<this.collapsedWidth?e=this.collapsedWidth:e>this.expandedWidth&&(e=this.expandedWidth),this.rtl?this.container.style.marginRight=`${e-this.expandedWidth}px`:this.container.style.marginLeft=`${e-this.expandedWidth}px`}highlight(e){let t=this.div;e?t.classList.add(kr):t.classList.remove(kr)}isEmpty(){return!this._suggestion}generateSuggestionText(e){let t=this._suggestion;var n,s=A("span");if(s.className="kmw-suggestion-text",t==null)return s;if(t.displayAs==null||t.displayAs=="")n="\xA0";else{let i=e?8238:8237;n=String.fromCharCode(i)+t.displayAs}return s.innerHTML=n,s}};r(is,"BannerSuggestion"),is.BASE_ID="kmw-suggestion-";var Oc=is,O=class O extends Qt{constructor(t,n){super(n||Qt.DEFAULT_HEIGHT);this.type="suggestion";this.currentSuggestions=[];this.options=[];this.separators=[];this.isRTL=!1;this.onSuggestionUpdate=r(t=>{var d;this.currentSuggestions=t,(d=this.highlightAnimation)==null||d.cancel();let n=this.options[0].computedStyle,s={fontSize:n.fontSize,fontFamily:n.fontFamily},i=getComputedStyle(document.body).fontSize,B=mi(i).val,c=getComputedStyle(this.options[0].container.firstChild),l=this.width/O.LONG_SUGGESTION_DISPLAY_LIMIT,a=new G(c.paddingLeft||"4px"),F=new G(c.paddingRight||"4px"),o={paddingWidth:a.val+F.val,emSize:B,styleForFont:s,collapsedWidth:l,minWidth:0};for(let U=0;U<O.SUGGESTION_LIMIT;U++){let u=this.options[U];if(t.length>U){let g=t[U];u.update(g,o)}else u.update(null,o)}this.refreshLayout()},"onSuggestionUpdate");this.refreshLayout=r(()=>{let t=[],n=0,s=Math.min(this.currentSuggestions.length,8);for(let i=0;i<s;i++){let B=this.options[i];B.minWidth=0,n+=B.collapsedWidth,B.collapsedWidth<B.expandedWidth&&t.push(B)}if(s=s||1,n<this.width){let i=this.width*.01*(s-1);for(;n<this.width&&t.length>0;){let c=(this.width-n-i)/t.length;t.sort((o,d)=>o.expandedWidth-d.expandedWidth);let l=t[0],a=l.expandedWidth-l.collapsedWidth,F=Math.min(a,c);F>0&&(t.forEach(o=>o.minWidth=o.collapsedWidth+F),n+=F*t.length),t.splice(0,1)}let B=(this.width-n-i)/s;for(let c=0;c<s;c++){let l=this.options[c];l.minWidth=l.collapsedWidth+B,l.updateLayout()}}for(let i=0;i<O.SUGGESTION_LIMIT-1;i++)this.separators[i].style.display=i<s-1?"":"none"},"refreshLayout");this.getDiv().className=this.getDiv().className+" "+O.BANNER_CLASS,this.container=document.createElement("div"),this.container.className=qQ,this.getDiv().appendChild(this.container),this.buildInternals(!1),this.gestureEngine=this.setupInputHandling()}shutdown(){this.gestureEngine.destroy()}buildInternals(t){this.isRTL=t,this.options.length>0&&(this.options=[],this.separators=[]);for(var n=0;n<O.SUGGESTION_LIMIT;n++){let s=new Oc(n,t);this.options[n]=s}for(var n=0;n<O.SUGGESTION_LIMIT;n++){let i=t?O.SUGGESTION_LIMIT-n-1:n;if(this.container.appendChild(this.options[i].div),t&&(this.container.scrollLeft=this.container.scrollWidth),n!=O.SUGGESTION_LIMIT-1){let B=A("div");B.className="kmw-banner-separator";let c=B.style;c.marginLeft=`calc(${O.MARGIN/2}% - 0.5px)`,c.marginRight=`calc(${O.MARGIN/2}% - 0.5px)`,this.container.appendChild(B),this.separators[i-(t?1:0)]=B}}}setupInputHandling(){let t=new at(this.getDiv(),[-Number.MAX_SAFE_INTEGER]);this.selectionBounds=new at(this.getDiv(),[-Nr*this.height,-Number.MAX_SAFE_INTEGER]);let n={targetRoot:this.getDiv(),maxRoamingBounds:t,safeBounds:t,itemIdentifier:l=>{let a=this.selectionBounds.getBoundingClientRect();if(l.clientX<a.left||l.clientX>a.right||l.clientY<a.top||l.clientY>a.bottom)return null;let F=null,o=Number.MAX_VALUE;for(let d of this.options){let U=d.div.getBoundingClientRect();if(U.left<=l.clientX&&l.clientX<U.right)return d.suggestion?d:null;{let u=(l.clientX<U.left?-1:1)*(l.clientX-U.left);u<o&&(o=u,F=d)}}return F.suggestion?F:null}},s=new Se(fr,n),i={source:null,scrollingHandler:null,suggestion:null},B=r(l=>{l.highlight(!0),this.highlightAnimation&&(this.highlightAnimation.cancel(),this.highlightAnimation.decouple()),this.highlightAnimation=new pi(this.container,l,!1),this.highlightAnimation.expand()},"markSelection"),c=r(l=>{l.highlight(!1),this.highlightAnimation||(this.highlightAnimation=new pi(this.container,l,!1)),this.highlightAnimation.collapse()},"clearSelection");return s.on("inputstart",l=>{if(i.source){l.terminate(!0);return}let a=this._predictionContext.selected;this._predictionContext.selected=null,a&&this.options.forEach(d=>{d.suggestion==a&&d.highlight(!1)}),this.scrollState=new Gi(l.currentSample,this.container.scrollLeft);let F=l.baseItem;i.source=l,i.scrollingHandler=d=>{var g;let U=this.scrollState.updateTo(d);(g=this.highlightAnimation)==null||g.setBaseScroll(U);let u=d.item?F:null;u!=i.suggestion&&(i.suggestion&&c(i.suggestion),i.suggestion=u,u&&B(u))},i.suggestion=l.currentSample.item,i.suggestion&&B(i.suggestion);let o=r(()=>{let d=this.currentSuggestions;lt(0).then(()=>L(this,null,function*(){if(d==this.currentSuggestions&&(this._predictionContext.selected=a,a)){for(let U of this.options)if(U.suggestion==a){U.highlight(!0);break}}})),i.suggestion&&(c(i.suggestion),i.suggestion=null),i.source=null,i.scrollingHandler=null},"terminationHandler");l.path.on("complete",o),l.path.on("invalidated",o),l.path.on("step",i.scrollingHandler)}),s.on("recognizedgesture",l=>{l.once("stage",a=>{let F=a.item;F&&!this.scrollState.hasScrolled&&this.currentSuggestions.length>0&&(this.currentSuggestions=[],this.predictionContext.accept(F.suggestion).then(()=>{this.container.scrollLeft=this.isRTL?this.container.scrollWidth:0})),this.scrollState=null})}),s}update(){var n;let t=super.update();return(n=this.selectionBounds)==null||n.updatePadding([-Nr*this.height,-Number.MAX_SAFE_INTEGER]),t}configureForKeyboard(t,n){let s=t.isRTL;this.container.textContent="",this.buildInternals(s),this.options.forEach(i=>i.matchKeyboardProperties(n)),this.onSuggestionUpdate(this.currentSuggestions)}get predictionContext(){return this._predictionContext}set predictionContext(t){this._predictionContext&&this._predictionContext.off("update",this.onSuggestionUpdate),this._predictionContext=t,t&&(t.on("update",this.onSuggestionUpdate),this.onSuggestionUpdate(t.currentSuggestions))}};r(O,"SuggestionBanner"),O.SUGGESTION_LIMIT=8,O.LONG_SUGGESTION_DISPLAY_LIMIT=3,O.MARGIN=1;var Ht=O,ut=class ut{constructor(e,t,n){this.setScrollOffset=r(()=>{if(!this.scrollContainer)return;let e=this.option.currentWidth-this.option.collapsedWidth,t=this.option.rtl,n=Math.max(this.rootScrollOffset-this.option.div.offsetLeft,0),s=Math.max(this.option.div.offsetLeft+this.option.collapsedWidth-(this.rootScrollOffset+this.scrollContainer.offsetWidth)),i=Math.max(t?s:n,0),B=Math.max(this.collapsedScrollOffset+(t?0:1)*e,0)+(t?0:-1)*i,c=Math.max(this.rootScrollOffset+(t?0:1)*e,0)+(t?0:-1)*i,l=t?Math.max(B,c):Math.min(B,c),a=Math.max(t?this.option.div.offsetLeft+this.option.currentWidth-(l+this.scrollContainer.offsetWidth):l-this.option.div.offsetLeft,0),F=Math.min(e,a),o=B+(t?1:-1)*F+(t?0:1)*i;if(this.scrollContainer.scrollLeft=o,this.pendingAnimation){let d=this.scrollContainer.scrollLeft-o;this.option.currentWidth+=d}},"setScrollOffset");this._expand=r(e=>{if(this.startTimestamp===void 0)return;let t=e-this.startTimestamp,n=t>ut.TRANSITION_TIME;n&&(t=ut.TRANSITION_TIME);let s=this.option.expandedWidth-this.option.collapsedWidth,i=t/ut.TRANSITION_TIME,B=s*i;this.option.currentWidth=B+this.option.collapsedWidth,n?this.clear():this.pendingAnimation=window.requestAnimationFrame(this._expand),this.setScrollOffset()},"_expand");this._collapse=r(e=>{if(this.startTimestamp===void 0)return;let t=e-this.startTimestamp,n=t>ut.TRANSITION_TIME;n&&(t=ut.TRANSITION_TIME);let s=this.option.expandedWidth-this.option.collapsedWidth,i=1-t/ut.TRANSITION_TIME,B=s*i;this.option.currentWidth=B+this.option.collapsedWidth,n?this.clear():this.pendingAnimation=window.requestAnimationFrame(this._collapse),this.setScrollOffset()},"_collapse");this.scrollContainer=e,this.option=t,this.collapsedScrollOffset=e.scrollLeft,this.rootScrollOffset=e.scrollLeft}setBaseScroll(e){this.collapsedScrollOffset=e,this.option.rtl?e>this.rootScrollOffset&&(this.rootScrollOffset=e):e<this.rootScrollOffset&&(this.rootScrollOffset=e),window.requestAnimationFrame(this.setScrollOffset)}decouple(){this.cancel(),this.scrollContainer=null}clear(){this.startTimestamp=null,window.cancelAnimationFrame(this.pendingAnimation),this.pendingAnimation=null}cancel(){this.clear(),this.option.currentWidth=this.option.collapsedWidth}expand(){this.clear(),this.startTimestamp=performance.now();let e=this.option.currentWidth-this.option.collapsedWidth,t=this.option.expandedWidth-this.option.collapsedWidth;e!=0&&(this.startTimestamp-=e/t*ut.TRANSITION_TIME),this.pendingAnimation=window.requestAnimationFrame(this._expand)}collapse(){this.clear(),this.startTimestamp=performance.now();let e=this.option.expandedWidth-this.option.currentWidth,t=this.option.expandedWidth-this.option.collapsedWidth;e!=0&&(this.startTimestamp-=e/t*ut.TRANSITION_TIME),this.pendingAnimation=window.requestAnimationFrame(this._collapse)}};r(ut,"SuggestionExpandContractAnimation"),ut.TRANSITION_TIME=250;var pi=ut;var wc=class wc extends Qt{constructor(t){super();this.type="html";let n=this.getDiv(),s=document.createElement("div");s.style.userSelect="none",s.style.height="100%",s.style.width="100%",n.appendChild(s),this.container=s.attachShadow?s.attachShadow({mode:"closed"}):s,this.container.innerHTML=t}get innerHTML(){return this.container.innerHTML}set innerHTML(t){this.container.innerHTML=t}};r(wc,"HTMLBanner");var Xi=wc;var zc=class zc{constructor(e,t,n){this.ImageBanner=Bi;this.HTMLBanner=Xi;this.hostDevice=t,this.container=e,this.predictionContext=n,this.inactiveBanner=new ce}get inactiveBanner(){return this._inactiveBanner}set inactiveBanner(e){this._inactiveBanner=e!=null?e:new ce,this.container.banner instanceof Ht||(this.container.banner=this._inactiveBanner)}activateBanner(e){let t=this.container.banner;if(t instanceof Ht&&(t.predictionContext=null),!e)this.container.banner=this.inactiveBanner;else{let n=new Ht(this.hostDevice,this.container.activeBannerHeight);n.predictionContext=this.predictionContext,this.container.banner=n}}selectBanner(e){this.activateBanner(e=="active"||e=="configured"),this.keyboard&&this.container.banner.configureForKeyboard(this.keyboard,this.keyboardStub)}configureForKeyboard(e,t){this.keyboard=e,this.keyboardStub=t,this.container.banner.configureForKeyboard(e,t)}shutdown(){this.container.banner instanceof Ht&&(this.container.banner.predictionContext=null)}};r(zc,"BannerController");var Bs=zc;var Dc=class Dc{constructor(){let e=this.element=document.createElement("div");e.style.userSelect="none",e.className="kmw-osk-none"}postInsert(){}updateState(){}refreshLayout(){}get layoutHeight(){return G.inPixels(0)}};r(Dc,"EmptyView");var ae=Dc;var Fn=class Fn{constructor(e){this.kbd=e;var t=this.element=document.createElement("div");t.style.userSelect="none",t.className="kmw-osk-static",t.id=Fn.ID,t.innerHTML=e.helpText}postInsert(){if(!this.element.parentElement||!document.getElementById(Fn.ID))throw new Error("The HelpPage root element has not yet been inserted into the DOM.");this.kbd.hasScript&&this.kbd.embedScript(this.element.parentElement)}updateState(){}refreshLayout(){}get layoutHeight(){return G.inPercent(100)}};r(Fn,"HelpPageView"),Fn.ID="kmw-osk-help-page";var cs=Fn;var $Q={"*Shift*":8,"*Enter*":5,"*Tab*":6,"*BkSp*":4,"*Menu*":11,"*Hide*":10,"*Alt*":25,"*Ctrl*":1,"*Caps*":3,"*ABC*":16,"*abc*":17,"*123*":19,"*Symbol*":21,"*Currency*":20,"*Shifted*":9,"*AltGr*":2,"*TabLeft*":7,"*LAlt*":86,"*RAlt*":87,"*LCtrl*":88,"*RCtrl*":89,"*LAltCtrl*":96,"*RAltCtrl*":97,"*LAltCtrlShift*":98,"*RAltCtrlShift*":99,"*AltShift*":100,"*CtrlShift*":101,"*AltCtrlShift*":102,"*LAltShift*":103,"*RAltShift*":104,"*LCtrlShift*":105,"*RCtrlShift*":112,"*LTREnter*":5,"*LTRBkSp*":4,"*RTLEnter*":113,"*RTLBkSp*":114,"*ShiftLock*":115,"*ShiftedLock*":116,"*ZWNJ*":117,"*ZWNJiOS*":117,"*ZWNJAndroid*":118,"*ZWNJGeneric*":121,"*Sp*":128,"*NBSp*":130,"*NarNBSp*":131,"*EnQ*":132,"*EmQ*":133,"*EnSp*":134,"*EmSp*":135,"*PunctSp*":140,"*ThSp*":141,"*HSp*":142,"*ZWSp*":129,"*ZWJ*":119,"*WJ*":120,"*CGJ*":122,"*LTRM*":144,"*RTLM*":145,"*SH*":161,"*HTab*":162},Kc=$Q;var ta=["default","shift","shift-on","special","special-on","","","","deadkey","blank","hidden"],Ve=ta;function Le(Q,e){switch(Q){case"*ZWNJ*":Q=e.device.OS==S.OperatingSystem.Android?"*ZWNJAndroid*":"*ZWNJiOS*";break;case"*Enter*":Q=e.isRTL?"*RTLEnter*":"*LTREnter*";break;case"*BkSp*":Q=e.isRTL?"*RTLBkSp*":"*LTRBkSp*";break;default:}let t=Kc[Q],n=57344+t;return t?String.fromCharCode(n):Q}r(Le,"renameSpecialKey");var wt=class wt{constructor(e,t){this.spec=e,this.layer=t}setButtonClass(){var s;let e=this.spec,t=this.btn;var n=0;typeof e.dk=="string"&&e.dk=="1"&&(n=8),n=(s=e.sp)!=null?s:n,(n<0||n>10)&&(n=0),t.className="kmw-key kmw-key-"+Ve[n]}setToggleState(e){let t;switch(t=this.spec.sp,Ve[t]){case"shift":case"shift-on":e===void 0&&(e=Ve[t]=="shift"),this.spec.sp=1+(e?1:0);break;case"special":case"special-on":e===void 0&&(e=Ve[t]=="special"),this.spec.sp=3+(e?1:0);break;default:return}this.setButtonClass()}isFrameKey(){let e=this.spec.sp||0;switch(Ve[e]){case"default":case"deadkey":return!1;default:return!0}}allowsKeyTip(){return this.isFrameKey()?!1:!this.btn.classList.contains("kmw-spacebar")}highlight(e){var t=this.btn.classList;e?t.contains(wt.HIGHLIGHT_CLASS)||t.add(wt.HIGHLIGHT_CLASS):t.remove(wt.HIGHLIGHT_CLASS)}getIdealFontSize(e,t,n){if(!this._fontFamily)return new G("1em");n!=null||(n=1);let s=t.keyWidth,i=t.keyHeight,B=t.baseEmFontSize.scaledBy(t.layoutFontSize.val),c=this._fontSize;c.absolute||(c=B.scaledBy(c.val));let l={fontFamily:this._fontFamily,fontSize:c.styleString,height:t.keyHeight},a=xi(e,B.scaledBy(n).val,l),F=.9,o=.9,d=2;var U;a.fontBoundingBoxAscent&&(U=a.fontBoundingBoxAscent+a.fontBoundingBoxDescent);let u=U!=null?U:0,g=s*F/(a.width+d),I=u&&i?i*o/u:void 0;var C=g;return I&&I<g&&(C=I),G.forScalar(n*Math.min(C,1))}get keyText(){let e=this.spec,t="\xA0",n=null;return e.text==null||e.text==""?n=t:(n=e.text,n=="*Tab*"&&this.layer=="shift"&&(n="*TabLeft*")),n}generateKeyText(e){let t=this.spec,n=document.createElement("span"),s=n.style;n.className="kmw-key-text";let i=this.keyText,B=Le(i,e);B!=i&&(i=B,t.font="SpecialOSK"),typeof t.font=="string"&&t.font!=""&&(s.fontFamily=t.font),typeof t.fontsize=="string"&&t.fontsize!=""&&(s.fontSize=t.fontsize);let c={fontSize:s.fontSize};return s.fontFamily?c.fontFamily=s.fontFamily:c.fontFamily=e.fontFamily,e.isRTL&&(i="\u200F"+i),n.innerText=i,n}resetFontPrecalc(){this._fontFamily=void 0,this._fontSize=void 0,this.label.style.fontSize=""}detectStyles(e){if(!(this.spec.sp==H.spacer||this.spec.sp==H.blank)&&this._fontFamily===void 0){let t=getComputedStyle(this.label);if(!t.fontFamily)return;this._fontFamily=t.fontFamily;let n=new G(t.fontSize),s=e.layoutFontSize;if(s.absolute)this._fontSize=n;else{let i=e.baseEmFontSize,B=s.scaledBy(i.val),c=n.val/B.val;this._fontSize=G.forScalar(c)}}}refreshLayout(e){if(this.label)if(this.label.classList.contains("kmw-spacebar-caption")){let t=this.getIdealFontSize(this.keyText,e);this.label.style.setProperty("font-size",t.styleString,"important")}else{let t=this.label.textContent,n=this.getIdealFontSize(t,e);this.label.style.fontSize=n.styleString}}};r(wt,"OSKKey"),wt.specialCharacters=Kc,wt.BUTTON_CLASSES=Ve,wt.HIGHLIGHT_CLASS="kmw-key-touched";var Xt=wt;var Pc=class Pc{constructor(e,t){this.key=e,this.keyId=t}};r(Pc,"KeyData");var on=Pc;function Si(Q,e){let t=Q;for(let n in e)t.hasOwnProperty(n)||(t[n]=e[n]);return t}r(Si,"link");function ea(Q){return Q&&"key"in Q&&Q.key instanceof Xt}r(ea,"isKey");function Vi(Q){return ea(Q)?Q:null}r(Vi,"getKeyFrom");var jc=class jc extends Xt{constructor(t,n,s){super(t,n);this.row=s}getId(){return this.spec.elementID}getCoreId(){return this.spec.coreID}getBaseId(){return this.spec.baseKeyID}generateKeyCapLabel(){var t=y.keyCodes[this.spec.baseKeyID];switch(t){case 186:t=59;break;case 187:t=61;break;case 188:t=44;break;case 189:t=45;break;case 190:t=46;break;case 191:t=47;break;case 192:t=96;break;case 219:t=91;break;case 220:t=92;break;case 221:t=93;break;case 222:t=39;break;default:(t<48||t>90)&&(t=0)}let n=document.createElement("div");return n.className="kmw-key-label",t>0&&(n.innerText=String.fromCharCode(t)),n}processSubkeys(t,n){var s,i=t.subKeys=this.spec.sk;for(s=0;s<i.length;s++){if(i[s].sp==1||i[s].sp==2){var B=i[s].text;i[s].text=Le(B,n)}i[s].layer||(i[s].layer=t.key.layer)}}construct(t){let n=this.spec,s=document.createElement("div");s.className="kmw-key-square";let i=document.createElement("div"),B=this.btn=Si(i,new on(this,n.id));this.setButtonClass();let c=this.capLabel=this.generateKeyCapLabel();B.appendChild(c),B.id=this.getId(),B.appendChild(this.label=this.generateKeyText(t)),typeof n.sk!="undefined"&&n.sk!=null?this.processSubkeys(B,t):B.subKeys=null;let l=this.generateHint(t);return B.appendChild(l),s.appendChild(B),this.preview=document.createElement("div"),this.preview.style.display="none",B.appendChild(this.preview),this.square=s}generateHint(t){let n=document.createElement("div");n.className="kmw-key-popup-icon";let s=this.spec.hintSrc;if(!s)return n;if(s.font&&s.font!="SpecialOSK"?n.style.fontFamily=s.font:n.classList.add("kmw-key-text"),s.fontsize){let c=new G(s.fontsize);n.style.fontSize=c.scaledBy(.5).styleString}let i=s==this.spec?this.spec.hint:s.text,B=Le(i,t);return B=="\u2022"&&(n.style.fontWeight="bold"),i!=B&&(n.style.fontFamily="SpecialOSK"),n.textContent=B,n}setPreview(t){let n=this.preview;t?(this.previewHost=t,this.preview=this.previewHost.element):(this.previewHost=null,this.preview=document.createElement("div"),this.preview.style.display="none"),t==null||t.setCancellationHandler(()=>{this.setPreview(null)}),this.btn.replaceChild(this.preview,n)}refreshLayout(t){super.refreshLayout(t),t.baseEmFontSize.val<12?this.capLabel.style.fontSize="6px":this.capLabel.style.fontSize=G.forScalar(.5).styleString}get displaysKeyCap(){return this.capLabel&&this.capLabel.style.display=="block"}set displaysKeyCap(t){if(!this.capLabel)throw new Error("Key element not yet constructed; cannot display key cap");this.capLabel.style.display=t?"block":"none"}};r(jc,"OSKBaseKey");var ls=jc;var Li=.15,_c=class _c{constructor(e,t,n){let s=this.element=document.createElement("div");s.className="kmw-key-row",this.heightFraction=1/t.row.length;let i=n.key;this.spec=n,this.keys=[];for(let l=0;l<i.length;l++){let a=i[l];var B=new ls(a,t.id,this),c=B.construct(e);this.keys.push(B),s.appendChild(c)}}get displaysKeyCaps(){if(this.keys.length>0)return this.keys[0].displaysKeyCap}set displaysKeyCaps(e){for(let t of this.keys)t.displaysKeyCap=e}refreshLayout(e){let t=this.element.style,n=e.heightStyle.scaledBy(this.heightFraction);t.maxHeight=t.lineHeight=t.height=n.styleString;let s=e.heightStyle.absolute?n:G.forScalar(1),i=s.scaledBy(Li/2),B=s.scaledBy(1-Li);this.keys.forEach(c=>{let l=c.square,a=c.btn,F=l.style;F.height=F.minHeight=s.styleString;let o=a.style;o.top=i.styleString,o.height=o.lineHeight=o.minHeight=B.styleString})}buildKeyLayout(e,t){let n=e.widthStyle.scaledBy(t.spec.proportionalWidth),s=e.heightStyle.scaledBy(this.heightFraction).scaledBy(1-Li);return{keyWidth:n.val*(n.absolute?1:e.keyboardWidth),keyHeight:s.val*(s.absolute?1:e.keyboardHeight),baseEmFontSize:e.baseEmFontSize,layoutFontSize:e.layoutFontSize}}detectStyles(e){this.keys.forEach(t=>{t.detectStyles(this.buildKeyLayout(e,t))})}refreshKeyLayouts(e){this.keys.forEach(t=>{var o;let n=t.btn,s=e.widthStyle,i=e.heightStyle,B=s.scaledBy(t.spec.proportionalWidth),c=s.scaledBy(t.spec.proportionalPad),l=i.scaledBy(this.heightFraction).scaledBy(1-Li),a=i.absolute?l.styleString:"100%",F=this.buildKeyLayout(e,t);(o=n.key)==null||o.refreshLayout(F),t.square.style.width=B.styleString,t.square.style.marginLeft=c.styleString,t.btn.style.width=s.absolute?B.styleString:"100%",t.square.style.height=a})}};r(_c,"OSKRow");var rs=_c;var qc=class qc{get rowHeight(){return this._rowHeight}get id(){return this.spec.id}constructor(e,t,n){this.spec=n;let s=this.element=document.createElement("div"),i=s.style;s.className="kmw-key-layer";var B=n.row.length;B>4&&e.device.formFactor=="phone"&&(s.className=s.className+" kmw-5rows"),i.fontFamily="font"in t?t.font:"",this.nextlayer=n.id,s.layer=n.id,typeof n.nextlayer=="string"&&(s.nextLayer=this.nextlayer=n.nextlayer);let c=n.row;this.rows=[];for(let l=0;l<c.length;l++){let a=new rs(e,n,c[l]);a.displaysKeyCaps=t.displayUnderlying,s.appendChild(a.element),this.rows.push(a)}if(e.device.touchable&&(this.globeKey=this.findKey("K_LOPT"),this.hideKey=this.findKey("K_ROPT")),this.spaceBarKey=this.findKey("K_SPACE"),this.capsKey=this.findKey("K_CAPS"),this.numKey=this.findKey("K_NUMLOCK"),this.scrollKey=this.findKey("K_SCROLL"),this.spaceBarKey){let l=this.spaceBarKey.label,a=this.spaceBarKey.btn;typeof a.className=="undefined"||a.className==""?a.className="kmw-spacebar":a.className.indexOf("kmw-spacebar")==-1&&(a.className+=" kmw-spacebar"),l.className!="kmw-spacebar-caption"&&(l.className="kmw-spacebar-caption")}}findKey(e){for(let t of this.rows)for(let n of t.keys)if(n.getBaseId()==e)return n;return null}showLanguage(e){if(this.spaceBarKey)try{let t=this.spaceBarKey.label;this.spaceBarKey.spec.text=e,(t.innerText!=e||e=="")&&(t.innerText=e)}catch(t){}}refreshLayout(e){this.rows.forEach(B=>B.detectStyles(e));let t=e.keyboardHeight,n=this.rows.length,s=this._rowHeight=Math.floor(t/(n==0?1:n)),i=e.widthStyle.absolute;i&&(this.element.style.height=t+"px"),this.showLanguage(e.spacebarText);for(let B=0;B<n;B++){let c=this.rows[B],l=(n-B-1)*s+1;i&&(this.spec.row[B].proportionalY=(t-l-s/2)/t),c.refreshLayout(e),B==n-1&&(c.element.style.bottom="1px")}for(let B of this.rows)B.refreshKeyLayouts(e)}};r(qc,"OSKLayer");var Qs=qc;var na=.06,$c=class $c{constructor(e,t,n){this._layers={};this._activeLayerId="default";let s=t.layout(n);this.spec=s,this.vkbd=e;let i=this.element=document.createElement("div"),B=i.style;if(i.className="kmw-key-layer-group",s==null)return;let c=s.fontsize;typeof c=="undefined"||c==null||c==""?B.fontSize="1em":B.fontSize=s.fontsize,B.width="100%",B.height="100%",this.activeLayerId="default"}buildLayer(e){let t=this.spec,n=t.getLayer(e);if(!n)return null;let s=new Qs(this.vkbd,t,n);return this._layers[e]=s,this.element.appendChild(s.element),s}getLayer(e){let t=this._layers[e];return t||(t=this.buildLayer(e),t&&(this._layers[e]=t,t.element.style.display="none")),t}get activeLayer(){return this.activeLayerId?this._layers[this.activeLayerId]:null}get layers(){let t=this.spec.layer.map(n=>n.id);for(let n of t)this.buildLayer(n);return this._layers}get activeLayerId(){return this._activeLayerId}set activeLayerId(e){this._activeLayerId=e,this.getLayer(e);for(let t of Object.keys(this._layers)){let n=this._layers[t],s=n.element;n.id==e?s.style.display="block":s.style.display="none"}}findNearestKey(e){if(!e)return null;let t=e.stateToken;if(!t)throw new Error("Layer id not set for input coordinate");let n=this._layers[t];if(!n)throw new Error(`Layer id ${t} could not be found`);return this.nearestKey(e,n)}blinkLayer(e){if(typeof e=="string"){let n=e;if(e=this.getLayer(n),!e)throw new Error(`Layer id ${n} could not be found`)}let t=e;if(t.element.style.display!="block")for(let n in this._layers){if(this._layers[n].element.style.display=="block"){let s=this._layers[n];s.element.style.display="none"}this._layers[n].element.style.display="none"}t.element.style.display="block",Promise.resolve().then(()=>{let n=this._layers[this._activeLayerId];(t.element.style.display=="block"||n.element.style.display!="block")&&(t.element.style.display="none",n.element.style.display="block")})}nearestKey(e,t){if(t.rows.length==0)return null;let n={x:e.targetX/this.computedWidth,y:e.targetY/this.computedHeight};if(!isFinite(n.x)||!isFinite(n.y))return null;let s=Math.max(0,Math.min(t.rows.length-1,Math.floor(n.y*t.rows.length))),i=t.rows[s],B=null,c=Number.MAX_VALUE;for(let l of i.keys){let a=l.spec;if(a.sp==H.blank||a.sp==H.spacer)continue;let F=a.proportionalWidth/2,o=Math.abs(n.x-a.proportionalX);if(o-F<=0)return l.btn;{let d=o-F;d<c&&(c=d,B=l)}}return c<=na?B.btn:null}resetPrecalcFontSizes(){for(let e of Object.values(this._layers))for(let t of e.rows)for(let n of t.keys)n.resetFontPrecalc();this._heightPadding=void 0}refreshLayout(e){if(!(isNaN(e.keyboardWidth)||isNaN(e.keyboardHeight))){if(this.computedWidth=e.keyboardWidth,this.computedHeight=e.keyboardHeight,this._heightPadding===void 0){let t=getComputedStyle(this.element),n=parseInt(t.paddingTop,10)||0,s=parseInt(t.paddingBottom,10)||0;this._heightPadding=n+s}this.activeLayer&&this.activeLayer.refreshLayout(e)}}get verticalPadding(){var e;return(e=this._heightPadding)!=null?e:0}};r($c,"OSKLayerGroup");var as=$c;var Yr="kmw-",Or="top",tl=class tl{constructor(e,t){this.state=!1;this.orientation=Or;this.vkbd=e;let n=this.element=document.createElement("div");n.className="kmw-keytip",n.id="kmw-keytip",n.style.pointerEvents="none",n.style.display="none",n.appendChild(this.tip=document.createElement("div")),n.appendChild(this.cap=document.createElement("div")),this.tip.appendChild(this.preview=document.createElement("div")),this.tip.className="kmw-keytip-tip",this.cap.className="kmw-keytip-cap",this.constrain=t,this.reorient=s=>{this.orientation=s,this.show(this.key,this.state,this.previewHost)}}show(e,t,n){var c;let s=this.vkbd;if(t&&s.layerGroup.blinkLayer(e.key.spec.displayLayer),t&&e.offsetParent){let l=e.key.row.element,a=e.getClientRects()[0],F=l.getClientRects()[0],o=a.left-F.left,d=a.width,U=a.height,u=1.8,g=this.element.style,C=s.topContainer.getBoundingClientRect(),x=e.getBoundingClientRect(),m,b=this.orientation,p=x.bottom-C.top;m=p+(b=="top"?1:-1);let J=m-Math.floor(m),Z=d+Math.ceil(d*.3)*2,it=Math.ceil(2.3*U)+J;b=="bottom"&&(m+=it-U),g.top="auto";let jt=b=="top"?"bottom":"top";this.tip.classList.remove(`${Yr}${jt}`),this.tip.classList.add(`${Yr}${b}`),g.bottom=Math.floor(C.height-m)+"px",g.textAlign="center",g.overflow="visible",g.width=Z+"px",g.height=it+"px";let Rs=this.vkbd.currentLayer.element.style.fontFamily,bt=getComputedStyle(s.element);g.fontFamily=e.key.spec.font||Rs||bt.fontFamily;var i=parseInt(bt.fontSize,10);if(i==Number.NaN&&(i=0),i!=0){let qt={keyWidth:1.6*d,keyHeight:1.6*U,baseEmFontSize:s.getKeyEmFontSize(),layoutFontSize:new G(s.kbdDiv.style.fontSize)};g.fontSize=e.key.getIdealFontSize(e.key.keyText,qt,u).styleString}var B=(Z-d)/2;o<B?(this.cap.style.left="1px",o+=B-1):o>window.innerWidth-d-B?(this.cap.style.left=Z-d-1+"px",o-=B-1):this.cap.style.left=B+"px",g.left=o-B+"px";let Wt=getComputedStyle(this.element),Gn=C.height,ge=parseFloat(Wt.bottom),pn=parseFloat(Wt.height),_t=Math.ceil(it/2);this.cap.style.width=d+"px",this.tip.style.height=_t+"px";let Ae=3,Xn=_t-Ae+"px";b=="top"?(this.cap.style.top=Xn,this.cap.style.bottom=""):(this.cap.style.top="",this.cap.style.bottom=Xn);let Sn=p-Math.floor(m)+it-(b=="top"?_t:-Ae*2);if(this.cap.style.height=Sn+"px",this.constrain&&pn+ge>Gn){let qt=pn+ge-Gn;g.height=it-qt+"px";let eQ=Math.max(0,it-qt-it/2+2);this.cap.style.height=eQ+"px"}else ge<0&&(g.bottom="0px",this.cap.style.height=Math.max(0,Sn+ge)+"px");if(g.display="block",this.previewHost==n)return;let vt=this.preview;this.previewHost&&this.previewHost.off("preferredOrientation",this.reorient),this.previewHost=n,n&&(this.previewHost.on("preferredOrientation",this.reorient),this.preview=this.previewHost.element,this.tip.replaceChild(this.preview,vt),n.setCancellationHandler(()=>this.show(null,!1,null)),n.on("startFade",()=>{this.element.classList.remove("kmw-preview-fade"),this.element.offsetWidth,this.element.classList.add("kmw-preview-fade")}))}else{this.element.style.display="none",(c=this.previewHost)==null||c.off("preferredOrientation",this.reorient),this.previewHost=null;let l=this.preview;this.preview=document.createElement("div"),this.tip.replaceChild(this.preview,l),this.element.classList.remove("kmw-preview-fade"),this.orientation=Or}this.key=e,this.state=t}};r(tl,"KeyTip");var Fs=tl;var el="kmw-keypreview",sa="kmw-preview-overlay",ia="kmw-keytip",nl=class nl{constructor(e){this.state=!1;this.vkbd=e;let t=this.element=document.createElement("div");t.className=el,t.id="kmw-keytip",t.style.pointerEvents="none",t.style.display="none",this.preview=document.createElement("div"),t.appendChild(this.preview)}show(e,t,n){let s=this.vkbd,i=e==null?void 0:e.key.spec.displayLayer;if(t&&s.layerGroup.blinkLayer(i),t&&(e!=null&&e.offsetParent)){let B=this.vkbd.topContainer.getBoundingClientRect(),c=e.getBoundingClientRect(),l=i!=s.layerId?sa:"";this.element.className=`${el} ${e.className} ${l}`,this.element.id=`${ia}-${e.id}`;let a=this.element.style,F=this.vkbd.currentLayer.element.style.fontFamily;if(a.fontFamily=e.key.spec.font||F,a.left=c.left-B.left+"px",a.top=c.top-B.top+"px",a.width=c.width+"px",a.height=c.height+"px",this.element.style.display="block",this.previewHost==n)return;let o=this.preview;this.previewHost=n,n&&(this.preview=this.previewHost.element,this.element.replaceChild(this.preview,o),n.setCancellationHandler(()=>this.show(null,!1,null)),n.on("startFade",()=>{this.element.classList.remove("kmw-preview-fade"),this.element.offsetWidth,this.element.classList.add("kmw-preview-fade")}))}else{this.element.style.display="none",this.element.className=el,this.previewHost=null;let B=this.preview;this.preview=document.createElement("div"),this.element.replaceChild(this.preview,B),this.element.classList.remove("kmw-preview-fade")}this.key=e,this.state=t}};r(nl,"TabletKeyTip");var Ei=nl;function St(Q){try{if(Q=="desktop")return 1;var e=document.documentElement.clientWidth;if(screen.width>e)return 1;var t=screen.width;return dt()?screen.width<screen.height&&(t=screen.height):screen.width>screen.height&&(t=screen.height),Math.round(100*t/e)/100}catch(n){return 1}}r(St,"getViewportScale");var Ee=class Ee{constructor(e,t){this.directlyEmitsKeys=!0;this.hasModalVisualization=!1;this.deleteRepeater=r(()=>{this.repeatClosure(),this.timerHandle=window.setTimeout(this.deleteRepeater,Ee.REPEAT_DELAY)},"deleteRepeater");this.source=e;let n=e.stageReports[0].item;n.key.highlight(!0),this.repeatClosure=()=>{t(),n.key.highlight(!0)},this.timerHandle=window.setTimeout(this.deleteRepeater,Ee.INITIAL_DELAY),this.source.on("complete",()=>{window.clearTimeout(this.timerHandle),this.timerHandle=void 0,n.key.highlight(!1)})}cancel(){this.deleteRepeater(),this.source.cancel()}currentStageKeyDistribution(){return null}};r(Ee,"HeldRepeater"),Ee.INITIAL_DELAY=500,Ee.REPEAT_DELAY=100;var Zi=Ee;var sl=class sl extends Xt{constructor(e,t){if(typeof t!="string"||t=="")throw"The 'layer' parameter for subkey construction must be properly defined.";super(e,t)}getId(){return"popup-"+this.spec.elementID}construct(e,t,n,s){let i=this.spec,B=document.createElement("div"),c=B.style;B.className="kmw-key-square-ex",s&&(c.marginTop="5px"),c.width=n+"px",c.height=t.offsetHeight+"px";let l=document.createElement("div"),a=this.btn=Si(l,new on(this,i.id));this.setButtonClass(),a.id=this.getId();let F=a.style;return F.height=c.height,F.lineHeight=t.style.lineHeight,F.width=c.width,F.position="absolute",a.appendChild(this.label=this.generateKeyText(e)),B.appendChild(a),this.square=B}allowsKeyTip(){return!1}};r(sl,"OSKSubKey");var os=sl;var wr=.2,Ba=1.2,Dr=3,Un=5,zr=6+Dr,il=class il{constructor(e,t,n,s,i){this.directlyEmitsKeys=!0;this.shouldLockLayer=!1;var x;this.baseKey=s,this.source=e,this.gestureParams=i,n.layerLocked&&(this.shouldLockLayer=!0),e.on("complete",()=>{var m;(m=this.currentSelection)==null||m.key.highlight(!1),this.clear()}),e.on("stage",()=>{let m=this.currentSelection;if(m){let b=n.keyEventFromSpec(m.key.spec);b.keyDistribution=this.currentStageKeyDistribution(),n.raiseKeyEvent(b,m)}});let B=e.stageReports[0].sources[0].constructSubview(!0,!1);B.path.on("step",m=>{var b,p;B.path.stats.netDistance>=4&&((b=this.currentSelection)==null||b.key.highlight(!1),(p=m.item)==null||p.key.highlight(!0),this.currentSelection=m.item)}),this.currentSelection=s,s.key.highlight(!0);let c=s.subKeys,l=this.element=document.createElement("div");l.id="kmw-popup-keys";var a=l.style;a.fontFamily=n.fontFamily;let F=getComputedStyle(s);a.fontSize=F.fontSize,a.visibility="hidden";let o=s.key.layer;(typeof o!="string"||o=="")&&(o=n.layerId);let d=c.length,U=Math.ceil(d/9),u=Math.ceil(d/U);this.subkeys=[];let g=Un,I=0;for(let m=0,b=0;m<d;m++,b++){let p=typeof c[m].width!="undefined"?c[m].width*s.offsetWidth/100:s.offsetWidth;p>n.width-2*Un&&(p=n.width-2*Un),(g+p+Un>n.width||b>=u)&&(I++,b=0,g=Un);let Z=new os(c[m],o).construct(n,s,p,I>0);g+=p+Un,this.menuWidth=Math.max((x=this.menuWidth)!=null?x:0,g),this.subkeys.push(Z.firstChild),l.appendChild(Z)}a.width=this.menuWidth+"px",this.shim=document.createElement("div"),this.shim.id="kmw-popup-shim",n.device.formFactor==S.FormFactor.Phone&&this.selectDefaultSubkey(s,l),n.element.appendChild(this.element),n.topContainer.appendChild(this.shim),this.reposition(n);let C=this.buildPopupRecognitionConfig(n);t({type:"push",config:C})}buildPopupRecognitionConfig(e){let t=this.element.getBoundingClientRect(),n=this.baseKey.getBoundingClientRect(),s=this.subkeys[0].style,B=-.666*Number.parseInt(s.height,10),c=3,l=n.bottom-t.bottom,a=new at(this.element,[B*c,B,-l<B?-l:B]),F={getBoundingClientRect(){let o=Number.MAX_SAFE_INTEGER;return new DOMRect(-o,-o,2*o,2*o)}};return{targetRoot:this.element,inputStartBounds:e.element,maxRoamingBounds:F,safeBounds:F,itemIdentifier:(o,d)=>{let U=a.getBoundingClientRect(),u=null,g=Number.MAX_VALUE,I=Number.MAX_VALUE;if(o.clientX<U.left||o.clientX>U.right||o.clientY<U.top||o.clientY>U.bottom)return null;for(let C of this.subkeys){let x=C.getBoundingClientRect(),m=Number.MAX_VALUE,b=Number.MAX_VALUE;if(x.left<=o.clientX&&o.clientX<x.right?m=0:m=x.left>=o.clientX?x.left-o.clientX:o.clientX-x.right,x.top<=o.clientY&&o.clientY<x.bottom?b=0:b=x.top>=o.clientY?x.top-o.clientY:o.clientY-x.bottom,m==0&&b==0)return C;(m<I||m==I&&b<g)&&(I=m,u=C,g=b)}return u}}}reposition(e){let t=this.element,n=this.baseKey,s=e.topContainer,i=n.key.row.element,B=t.style,c=n.offsetParent?n.offsetParent.offsetLeft:0;var l=n.offsetLeft+c+.5*(n.offsetWidth-t.offsetWidth),a=e.width-t.offsetWidth;l>a&&(l=a),l<0&&(l=0),B.left=l+"px";let F=s.getBoundingClientRect(),o=i.getBoundingClientRect();B.top=o.top-F.top-t.offsetHeight-Dr+"px",B.visibility="visible";let d=e.isEmbedded,U=getComputedStyle(t),u=parseFloat(U.top),g=0,I=0;u<g&&d&&(I=g-u,B.top=g+"px"),this.callout=this.addCallout(n,I,e.element,e.topContainer,e.device.formFactor=="tablet")}addCallout(e,t,n,s,i){t=t||0;let B=getComputedStyle(this.element),c=Math.max(Number.parseInt(B.borderRadius),0),l=e.getBoundingClientRect(),a=s.getBoundingClientRect(),F=Math.floor(Number.parseInt(B.top,10)+Number.parseInt(B.height,10)+Number.parseInt(B.paddingTop,10)/2+Number.parseInt(B.paddingBottom,10)),o=wr*(l.height-t),d=wr*l.height,U=o+zr,u=U/(d+zr),g=l.bottom-a.top-F-1,I=g<U?g:U;if(I>0){let C=document.createElement("div"),x=C.style;C.id="kmw-popup-callout",n.appendChild(C),x.top=F+"px",x.borderTopWidth=I+"px";let m=Ba*u,b=l.width*m,p=this.menuWidth-2*c,J=p<b?p:b,Z=l.left-a.left-(J-l.width)/2,it=Math.max(0,Z+J-(a.right-c)),jt=Math.max(0,c-Z);return x.left=l.left-a.left-(J-l.width)/2+jt+"px",x.borderLeftWidth=J/2-jt+"px",x.borderRightWidth=J/2-it+"px",C}else return null}selectDefaultSubkey(e,t){var i;var n;let s=e.subKeys;for(let B=0;B<s.length;B++){let c=s[B],l=t.childNodes[B].firstChild;if(c.default){n=l;break}else if(!e.key||!e.key.spec)continue;c.elementID==e.key.spec.elementID&&(n=l)}n&&((i=this.currentSelection)==null||i.key.highlight(!1),this.currentSelection=n,n.key.highlight(!0))}get hasModalVisualization(){return this.element.style.visibility=="visible"}buildCorrectiveLayout(){let e=this.element.getBoundingClientRect(),t=e.width/e.height;return{keys:this.subkeys.map(s=>{let i=s.getBoundingClientRect();return{keySpec:s.key.spec,centerX:(i.right-i.width/2-e.left)/e.width,centerY:(i.bottom-i.height/2-e.top)/e.height,width:i.width/e.width,height:i.height/e.height}}),kbdScaleRatio:t}}currentStageKeyDistribution(){let e=this.source.stageReports[this.source.stageReports.length-1],t=this.source.stageReports[0],n=e.sources[0],s=n.currentSample,i=this.element.getBoundingClientRect(),B={x:s.targetX/i.width,y:s.targetY/i.height};B.x=B.x<0?0:B.x>1?1:B.x,B.y=B.y<0?0:B.y>1?1:B.y;let c=Ks(B,this.buildCorrectiveLayout()),l=c.get(s.item.key.spec),a=Math.min(n.path.stats.duration-t.sources[0].path.stats.duration,this.gestureParams.longpress.waitLength)/(2*this.gestureParams.longpress.waitLength),F=Math.min(n.path.stats.rawDistance,this.gestureParams.longpress.noiseTolerance*4)/(this.gestureParams.longpress.noiseTolerance*8),o=Math.min(a*a,F*F),d=l+o,U=new Map,u=this.subkeys.find(g=>g.keyId==this.baseKey.keyId);return u?U.set(u.key.spec,d):U.set(this.baseKey.key.spec,d),ne([c,U])}cancel(){this.clear(),this.source.cancel()}clear(){this.element.parentNode&&this.element.parentNode.removeChild(this.element),this.shim.parentNode&&this.shim.parentNode.removeChild(this.shim),this.callout&&this.callout.parentNode&&this.callout.parentNode.removeChild(this.callout)}};r(il,"SubkeyPopup");var dn=il;var Bl=class Bl{constructor(e,t,n){this.directlyEmitsKeys=!0;this.shouldRestore=!1;this.hasModalVisualization=!1;let s=e.stageReports[0];this.originalLayer=s.sources[0].stateToken,this.source=e,this.completionCallback=()=>{t.lockLayer(!1),this.shouldRestore&&(t.layerId=this.originalLayer,t.updateState()),n==null||n()},t.lockLayer(!0),e.on("stage",i=>{let B=i.matchedId;B.includes("modipress")&&B.includes("-end")?this.clear():B.includes("modipress")&&B.includes("-hold")&&(this.shouldRestore=!0)}),e.on("complete",()=>this.cancel())}get isLocked(){return this.shouldRestore}setLocked(){this.shouldRestore=!0}get completed(){return this.completionCallback===null}clear(){let e=this.completionCallback;this.completionCallback=null,e==null||e()}cancel(){this.clear(),this.source.cancel()}currentStageKeyDistribution(e){return null}};r(Bl,"Modipress");var Fe=Bl;var cl=class cl{constructor(e,t,n,s,i){this.directlyEmitsKeys=!0;this.hasModalVisualization=!1;this.tapIndex=0;this.baseKey=n,this.baseContextToken=s,this.multitaps=[n.key.spec].concat(n.key.spec.multitap),this.sequence=e;let B=r(o=>{var U;(U=this.modipress)==null||U.clear();let d=new Fe(e,t,()=>{this.modipress=t.activeModipress=null});this.modipress=t.activeModipress=d},"startModipress");this.originalLayer=t.layerId;let c=r(o=>(this.tapIndex+o)%this.multitaps.length,"tapLookahead"),l=r(()=>{i==null||i.setMultitapHint(this.multitaps[c(0)],this.multitaps[c(1)],t)},"updatePreview");e.on("complete",()=>{var o;(o=this.modipress)==null||o.cancel(),this.clear()});let a=r(o=>{var I;switch(o.matchedId){case"modipress-hold":this.clear(),e.off("stage",a);return;case"modipress-end-multitap-transition":case"modipress-multitap-end":case"modipress-end":case"multitap-end":case"simple-tap":return;case"modipress-multitap-lock-transition":(I=this.modipress)==null||I.setLocked();return;case"modipress-multitap-start":case"multitap-start":break;default:throw new Error(`Unsupported gesture state encountered during multitap: ${o.matchedId}`)}this.tapIndex=c(1);let d=this.multitaps[this.tapIndex];l();let U=t.keyEventFromSpec(d);U.baseTranscriptionToken=this.baseContextToken;let u=o.sources[0].currentSample,g=t.getSimpleTapCorrectionDistances(u,this.baseKey.key.spec);if(u.stateToken!=t.layerId&&!o.matchedId.includes("modipress")){let C=t.layerGroup.findNearestKey(V(h({},u),{stateToken:t.layerId})),x=g.get(C.key.spec);x==null&&console.warn("Could not find current layer's key"),g.delete(C.key.spec),g.set(u.item.key.spec,x)}U.keyDistribution=this.currentStageKeyDistribution(g),U.kNextLayer||(U.kNextLayer=this.originalLayer),t.raiseKeyEvent(U,null),o.matchedId=="modipress-multitap-start"&&B(o)},"stageHandler");e.on("stage",a),e.stageReports[0].matchedId=="modipress-start"&&B(e.stageReports[0]),l()}currentStageKeyDistribution(e){let t=ne(e),n=t.findIndex(l=>l.keySpec==this.baseKey.key.spec);if(n==-1)return ns(this.baseKey)||console.warn("Could not find base key's probability for multitap correction"),t;let s=t.splice(n,1)[0].p,i=0,B=[];for(let l=0;l<this.multitaps.length;l++){let a=this.multitaps[l],F=Math.abs(l-this.tapIndex)%this.multitaps.length,o=(l+this.multitaps.length-this.tapIndex)%this.multitaps.length,d=F<o?F:o,U=1/((1+d)*(1+d));i+=U,B.push({keySpec:a,p:U})}let c=s/i;return B.forEach(l=>{l.p=c*l.p}),t.concat(B).sort((l,a)=>a.p-l.p)}cancel(){this.clear(),this.sequence.cancel()}clear(){}};r(cl,"Multitap");var Us=cl;var ds=1.4142,ll=r(Q=>Math.abs(Q)<1e-10?0:Q,"coerceZeroes"),rl=class rl extends X.default{constructor(t,n,s,i){var d;super();this.flickPreviews=new Map;this.orientation="top";let B=t.key.spec,c=this.flickEdgeLength=Math.max(s,i),l=this.div=document.createElement("div");l.className=l.id="kmw-gesture-preview",l.style.pointerEvents="none";let a=this.previewImgContainer=document.createElement("div");this.previewImgContainer.id="kmw-preview-img-container";let F=this.label=document.createElement("span");if(F.className="kmw-gesture-base-label kmw-key-text",F.id="kmw-gesture-base-label",a.appendChild(F),F.textContent=t.key.label.textContent,this.div.appendChild(this.previewImgContainer),B.flick){let U=B.flick||{};Object.keys(U).forEach(u=>{let g=document.createElement("div");g.className="kmw-flick-preview kmw-key-text",g.textContent=U[u].text;let I=g.style,C=vc.get(u),x=ll(-Math.sin(C[0])),m=ll(Math.cos(C[0]));I.width="100%",I.textAlign="center",x<0?I.right=-x*ds*c+"px":x>0?I.left=x*ds*c+"px":I.left="0px",I.height="100%",I.lineHeight="100%",m<0?I.bottom=-m*ds*c+"px":m>0?I.top=m*ds*c+"px":I.top="0px",this.flickPreviews.set(u,g),a.appendChild(g)})}let o=this.hintLabel=document.createElement("div");o.className="kmw-key-popup-icon",n||(o.textContent=B==B.hintSrc?B.hint:(d=B.hintSrc)==null?void 0:d.text,o.style.fontWeight=o.textContent=="\u2022"?"bold":""),l.appendChild(o)}get element(){return this.div}refreshLayout(){let t=getComputedStyle(this.div),n=Number.parseInt(t.height,10);this.flickPreviews.forEach(s=>{s.style.lineHeight=s.style.height=`${n}px`})}cancel(){var t;(t=this.onCancel)==null||t.call(this),this.onCancel=null}setCancellationHandler(t){this.onCancel=t}setMultitapHint(t,n,s){var c,l;let i=Le(t.text,s),B=Le(n.text,s);this.label.textContent=i,this.hintLabel.textContent=B,this.label.style.fontFamily=i!=t.text?"SpecialOSK":(c=t.font)!=null?c:this.label.style.fontFamily,this.hintLabel.style.fontFamily=B!=n.text?"SpecialOSK":(l=n.font)!=null?l:this.hintLabel.style.fontFamily,this.emit("startFade"),this.clearFlick()}scrollFlickPreview(t,n){this.clearHint();let s=this.previewImgContainer.style,i=this.flickEdgeLength*ds;s.marginLeft=`${i*t}px`,s.marginTop=`${i*n}px`;let B=ll(n)<0?"bottom":"top";this.orientation!=B&&(this.orientation=B,this.emit("preferredOrientation",B))}clearFlick(){this.previewImgContainer.style.marginTop="0px",this.previewImgContainer.style.marginLeft="0px",this.previewImgContainer.classList.add("kmw-flick-clear")}clearHint(){this.hintLabel.classList.add("kmw-hint-clear")}clearAll(){this.clearFlick()}};r(rl,"GesturePreviewHost");var Ji=rl;var Kr=$t.TIER!="stable"||$t.VERSION_ENVIRONMENT!="",ca=Kr?10:0,gs=class gs extends X.default{constructor(t){var a,F;super();this.gestureParams=h({},Tc);this.layerLocked=!1;this.layerIndex=0;this.isStatic=!1;this._fixedWidthScaling=!1;this._fixedHeightScaling=!0;this._borderWidth=0;this.stateKeys={K_CAPS:!1,K_NUMLOCK:!1,K_SCROLL:!1};this.activeGestures=[];this.activeModipress=null;this.repeatDelete=function(){this.deleting&&(this.modelKeyClick(this.deleteKey),this.deleting=window.setTimeout(this.repeatDelete,100))}.bind(this);this.config=t,this.config.device=t.device||t.hostDevice,this.config.isEmbedded=t.isEmbedded||!1,t.isStatic&&(this.isStatic=t.isStatic),this._fixedWidthScaling=this.device.touchable&&!this.isStatic,this._fixedHeightScaling=this.device.touchable&&!this.isStatic;var n=document.createElement("div");this.config.styleSheetManager=t.styleSheetManager||new rt(n);let s;if(t.keyboard)s=this.kbdLayout=t.keyboard.layout(t.device.formFactor),this.layoutKeyboardProperties=t.keyboardMetadata,this.isRTL=t.keyboard.isRTL;else{let o=f.buildDefaultLayout(null,null,t.device.formFactor);s=this.kbdLayout=Te.polyfill(o,null,t.device.formFactor),this.layoutKeyboardProperties=null,this.isRTL=!1}"font"in s?this.fontFamily=s.font:this.fontFamily="";let i=t.device.formFactor;this.layoutKeyboard=t.keyboard,this.layoutKeyboard||(this.layoutKeyboard=new T(null)),this.layerGroup=new as(this,this.layoutKeyboard,i),this.layoutKeyboard.markLayoutCalibrated(i),n.appendChild(this.layerGroup.element),this.kbdDiv=n,this.isStatic||(this.gestureEngine=this.constructGestureEngine()),n.classList.add(t.device.formFactor,"kmw-osk-inner-frame");let B=(F=(a=this.layoutKeyboard)==null?void 0:a.id.replace("Keyboard_",""))!=null?F:"",c=B.indexOf("::");c!=-1&&(B=B.substring(c+2));let l="kmw-keyboard-"+B;this.element.classList.add(l)}get layerId(){var t,n;return(n=(t=this.layerGroup)==null?void 0:t.activeLayerId)!=null?n:"default"}set layerId(t){let n=t!=this.layerId;if(this.layerGroup.getLayer(t))this.layerGroup.activeLayerId=t,this.gestureEngine&&(this.gestureEngine.stateToken=t);else throw new Error(`Keyboard ${this.layoutKeyboard.id} does not have a layer with id ${t}`);n&&!this.deferLayout&&(this.updateState(),this.layerGroup.refreshLayout(this.constructLayoutParams()))}get currentLayer(){var t;return(t=this.layerGroup)==null?void 0:t.activeLayer}get lgKey(){var t,n;return(n=(t=this.currentLayer)==null?void 0:t.globeKey)==null?void 0:n.btn}get hkKey(){var t,n;return(n=(t=this.currentLayer)==null?void 0:t.hideKey)==null?void 0:n.btn}get spaceBar(){var t,n;return(n=(t=this.currentLayer)==null?void 0:t.spaceBarKey)==null?void 0:n.btn}constructGestureEngine(){let t={targetRoot:this.element,mouseEventRoot:document.body,maxRoamingBounds:new at(this.topContainer,[NaN]),itemIdentifier:(c,l)=>this.layerGroup.findNearestKey(c),recordingMode:Kr,historyLength:ca};this.gestureParams.longpress.permitsFlick=c=>{let l=c==null?void 0:c.key.spec.flick;return!l||!(l.n||l.nw||l.ne)};let n=new Se(kc(this.kbdLayout,this.gestureParams),t);n.stateToken=this.layerId;let s={},i=r(c=>{for(let l of Object.keys(s)){if(l==c)continue;s[l].source.terminate(!0)}},"clearActiveGestures"),B=new Map;return n.on("inputstart",c=>{var o;let l=this.highlightKey(c.currentSample.item,!0);l&&((o=this.gesturePreviewHost)==null||o.cancel(),this.gesturePreviewHost=l),s[c.identifier]={source:c,roamingHighlightHandler:null,key:c.currentSample.item,previewHost:l};let a=s[c.identifier],F=r(()=>{lt(0).then(()=>{let d=a.previewHost;d&&(d.cancel(),this.gesturePreviewHost=null,a.previewHost=null),a.key&&(this.highlightKey(a.key,!1),a.key=null)})},"endHighlighting");a.roamingHighlightHandler=d=>{var g;let U=d.item,u=s[c.identifier].key;if(!this.kbdLayout.hasFlicks&&U!=u){this.highlightKey(u,!1),(g=this.gesturePreviewHost)==null||g.cancel(),this.gesturePreviewHost=null,a.previewHost=null;let I=this.highlightKey(U,!0);I&&(this.gesturePreviewHost=I,a.previewHost=I),s[c.identifier].key=U}},c.path.on("invalidated",F),c.path.on("complete",F),c.path.on("step",a.roamingHighlightHandler)}),n.on("recognizedgesture",c=>{var l;(l=this.activeModipress)==null||l.setLocked(),c.on("complete",()=>{var a;for(let F of c.allSourceIds)(a=s[F])!=null&&a.previewHost&&(this.gesturePreviewHost=null,s[F].previewHost.cancel()),delete s[F]}),c.on("stage",(a,F)=>{let o=c.allSourceIds.map(b=>{var p;return(p=s[b])==null?void 0:p.previewHost}).find(b=>!!b),d=r(()=>{o&&(o.cancel(),this.gesturePreviewHost=null)},"clearPreviewHost"),U=B.get(c);!U&&o&&!a.matchedId.includes("flick")&&o.clearFlick();let u;for(let b of a.allSourceIds){let p=r(J=>{J.key&&(this.highlightKey(J.key,!1),J.key=null),J.source.path.off("step",J.roamingHighlightHandler)},"clearRoaming");if(u=s[b],u)p(u);else{let J=b;lt(0).then(()=>{let Z=s[J];Z&&p(Z)})}}let g=a.item,I=a.sources[0],C=I?I.currentSample:null,x=null;if(g&&!(U&&U[0].directlyEmitsKeys)){let b,p=this.getSimpleTapCorrectionDistances(I.currentSample,g.key.spec);U&&(b=U[0].currentStageKeyDistribution(p)),b||(b=ne(p));let J=!this.layerLocked&&U&&U[0]instanceof dn&&U[0].shouldLockLayer;try{J&&this.lockLayer(!0),x=this.modelKeyClick(a.item,C,b)}finally{J&&this.lockLayer(!1)}}if(c.stageReports.length>1&&a.matchedId!="modipress-end")return;let m=c.stageReports[0].item;if(a.matchedId=="special-key-start")g.key.spec.baseKeyID=="K_BKSP"?(d(),U=[new Zi(c,()=>this.modelKeyClick(g,C))]):g.key.spec.baseKeyID=="K_LOPT"&&(c.on("complete",()=>{g.key.highlight(!1),this.emit("globekey",g,!1)}),i(I.identifier),g.key.highlight(!0));else if(a.matchedId.indexOf("longpress")>-1)d(),U=[new dn(c,F,this,c.stageReports[0].sources[0].baseItem,this.gestureParams)];else if(m!=null&&m.key.spec.multitap&&(a.matchedId=="initial-tap"||a.matchedId=="multitap"||a.matchedId=="modipress-start"))u.previewHost=null,c.on("complete",()=>{d()}),U=[new Us(c,this,m,x.contextToken,o)];else if(a.matchedId.indexOf("flick")>-1)U=[new ts(c,F,this,c.stageReports[0].sources[0].baseItem,this.gestureParams,o)];else if(a.matchedId.includes("modipress")&&a.matchedId.includes("-start"))if(d(),this.layerLocked)console.warn("Unexpected state:  modipress start attempt during an active modipress");else{U||(U=[]);let b=new Fe(c,this,()=>{let p=U.indexOf(b);p>-1&&U.splice(p,1),this.activeModipress=null});U.push(b),this.activeModipress=b}else d();U&&(this.activeGestures=this.activeGestures.concat(U),B.set(c,U),c.on("complete",()=>{let b=this.activeGestures.filter(p=>U.includes(p));this.activeGestures=this.activeGestures.filter(p=>!U.includes(p)),b.forEach(p=>{p instanceof Fe&&p.cancel()})}))})}),n}get element(){return this.kbdDiv}get device(){return this.config.device}get hostDevice(){return this.config.hostDevice}get fontRootPath(){return this.config.pathConfig.fonts}get styleSheetManager(){return this.config.styleSheetManager}get topContainer(){return this.config.topContainer}get isEmbedded(){return this.config.isEmbedded}postInsert(){}get width(){return this._width}get height(){return this._height}get layoutWidth(){if(this.usesFixedWidthScaling){let t=this.width;return t-=this._borderWidth*2,G.inPixels(t)}else return G.forScalar(1)}get layoutHeight(){if(this.usesFixedHeightScaling){let t=this.height;return t-=this._borderWidth*2,G.inPixels(t)}else return G.forScalar(1)}get internalHeight(){return this.usesFixedHeightScaling?G.inPixels(this.layoutHeight.val-this._borderWidth*2-this.layerGroup.verticalPadding):G.forScalar(1)}get fontSize(){return this._fontSize||(this._fontSize=new G("1em")),this._fontSize}set fontSize(t){this._fontSize=t,this.kbdDiv.style.fontSize=t.styleString}get usesFixedWidthScaling(){return this._fixedWidthScaling}set usesFixedWidthScaling(t){this._fixedWidthScaling=t}get usesFixedHeightScaling(){return this._fixedHeightScaling}set usesFixedHeightScaling(t){this._fixedHeightScaling=t}get usesFixedPositioning(){let t=this.element;for(;t;){if(getComputedStyle(t).position=="fixed")return!0;t=t.offsetParent}return!1}setSize(t,n,s){this._width=t,this._height=n,this.kbdDiv&&(this.kbdDiv.style.width=t?this._width+"px":"",this.kbdDiv.style.height=n?this._height+"px":"",!this.device.touchable&&n&&(this.fontSize=new G(this._height/8+"px")),s||this.refreshLayout())}getTouchCoordinatesOnKeyboard(t){let n={x:t.targetX,y:t.targetY};return n.x/=this.layerGroup.element.offsetWidth,n.y/=this.kbdDiv.offsetHeight,n}getSimpleTapCorrectionDistances(t,n){let s=this.getTouchCoordinatesOnKeyboard(t),B=this.layerGroup.element.offsetWidth,c=this.kbdDiv.offsetHeight;if(!B||!c)return new Map;let l=B/c,a=ur(this.kbdLayout.getLayer(this.layerId),l);return Ks(s,a)}keyTarget(t){let n=t;try{if(n){if(n.classList.contains("kmw-key"))return Vi(n);if(n.parentNode&&n.parentNode.classList.contains("kmw-key"))return Vi(n.parentNode);if(n.firstChild&&n.firstChild.classList.contains("kmw-key"))return Vi(n.firstChild)}}catch(s){}return null}cancelDelete(){this.deleting&&window.clearTimeout(this.deleting),this.deleting=0}modelKeyClick(t,n,s){let i=this.initKeyEvent(t);return n&&(i.source=n),s&&(i.keyDistribution=s),this.raiseKeyEvent(i,t)}initKeyEvent(t){this.highlightKey(t,!1);let n=t.key?t.key.spec:null;return n?this.keyEventFromSpec(n):null}keyEventFromSpec(t){let n=this.layoutKeyboard.constructKeyEvent(t,this.device,this.stateKeys);return n.srcKeyboard=this.layoutKeyboard,n}_UpdateVKShiftStyle(t){var c;var n;t||(t=this.layerId);let s=this.layerGroup.getLayer(t);if(!s||(this.gestureEngine&&(this.gestureEngine.stateToken=t),!((c=this.layoutKeyboard)!=null&&c.usesDesktopLayoutOnDevice(this.device))))return;let i=["K_CAPS","K_NUMLOCK","K_SCROLL"],B=[s.capsKey,s.numKey,s.scrollKey];for(n=0;n<B.length;n++)B[n]!=null&&B[n].setToggleState(this.stateKeys[i[n]])}updateStateKeys(t){for(let n of Object.keys(this.stateKeys))this.stateKeys[n]=t[n];this._UpdateVKShiftStyle()}highlightKey(t,n){if(!t||!t.key||t.className==""||t.className.indexOf("kmw-key-row")>=0)return null;let s=t.key.allowsKeyTip();return n=this.activeGestures.find(B=>B.hasModalVisualization)?!1:n,t.key.highlight(n),n&&s?this.gesturePreviewHost?null:this.showGesturePreview(t):null}getKeyEmFontSize(){if(!this.fontSize)return new G("0px");if(this.device.formFactor=="desktop"){let t=.8;return this.fontSize.scaledBy(t)}else{let t=getComputedStyle(document.body).fontSize,n=new G(t),s=1;if(!this.isStatic){if(this.fontSize.absolute)return this.fontSize;s=this.fontSize.val}return n.scaledBy(s)}}updateState(){this.currentLayer&&(this.nextLayer=this.layerId,this.currentLayer.nextlayer&&(this.nextLayer=this.currentLayer.nextlayer),this.layerGroup.activeLayerId=this.layerId,this._UpdateVKShiftStyle())}refreshLayout(){if(this.deferLayout)return;let t=this.device;var n=1;t.OS==S.OperatingSystem.iOS&&!this.isEmbedded&&(n=n/St(this.device.formFactor));let s=this.kbdDiv.style;this.usesFixedHeightScaling&&this.height&&(s.height=s.maxHeight=this.height+"px"),s.fontSize=this.fontSize.scaledBy(n).styleString;let i=this.width&&this.height,B=getComputedStyle(this.kbdDiv),c=getComputedStyle(this.layerGroup.element),l=B.height!=""&&B.height!="auto";if(B.border&&(this._borderWidth=new G(B.borderWidth).val),i)this._computedWidth=this.width,this._computedHeight=this.height;else if(l)this._computedWidth=parseInt(B.width,10),this._computedWidth||(this._computedWidth=parseInt(c.width,10)),this._computedHeight=parseInt(B.height,10);else return;this.layerGroup.refreshLayout(this.constructLayoutParams()),this.isStatic||(this.gestureEngine.config.maxRoamingBounds.updatePadding([-.333*this.currentLayer.rowHeight]),this.gestureParams.longpress.flickDistStart=.24*this.currentLayer.rowHeight,this.gestureParams.flick.startDist=.3*this.currentLayer.rowHeight,this.gestureParams.flick.dirLockDist=.35*this.currentLayer.rowHeight,this.gestureParams.flick.triggerDist=.75*this.currentLayer.rowHeight,this.gestureParams.longpress.flickDistFinal=.75*this.currentLayer.rowHeight)}constructLayoutParams(){var t,n;return{keyboardWidth:this._computedWidth-2*this._borderWidth,keyboardHeight:this._computedHeight-2*this._borderWidth-this.layerGroup.verticalPadding,widthStyle:this.layoutWidth,heightStyle:this.internalHeight,baseEmFontSize:this.getKeyEmFontSize(),layoutFontSize:new G(this.layerGroup.element.style.fontSize),spacebarText:(n=(t=this.layoutKeyboardProperties)==null?void 0:t.displayName)!=null?n:"(System keyboard)"}}computedAdjustedOskHeight(t){if(!this.layerGroup)return t;let n=this.layerGroup.spec.layer,s=0;for(let c in n){let a=n[c].row.length,F=Math.floor(t/(a==0?1:a)),o=a*F;o>s&&(s=o)}return s+0}appendStyleSheet(){var t=this.layoutKeyboard,n=this.layoutKeyboardProperties;this.styleSheet&&this.styleSheet.parentNode&&this.styleSheet.parentNode.removeChild(this.styleSheet);var s=n==null?void 0:n.textFont,i=n==null?void 0:n.oskFont;this.styleSheetManager.addStyleSheetForFont(s,this.fontRootPath,this.device.OS),this.styleSheetManager.addStyleSheetForFont(i,this.fontRootPath,this.device.OS),this.config.specialFont&&this.styleSheetManager.addStyleSheetForFont(this.config.specialFont,"",this.device.OS);var B=this.addFontStyle(s,i);t!=null&&typeof t.oskStyling=="string"&&(B=B+t.oskStyling),B&&(this.styleSheet=ie(B),this.styleSheetManager.linkStylesheet(this.styleSheet)),this.styleSheetManager.allLoadedPromise().then(()=>{this.layerGroup.resetPrecalcFontSizes(),this.refreshLayout()})}addFontStyle(t,n){let s="",i=r(B=>B.family.replace(/\u0022/g,"").replace(/,/g,'","'),"family");return(t||n)&&(s=`
.kmw-key-text {
  font-family: "${i(n||t)}";
}

.kmw-suggestion-text {
  font-family: "${i(t||n)}";
}
`),s}static buildDocumentationKeyboard(t,n,s,i,B,c){if(!t)return null;var l=typeof i=="undefined"?"desktop":i,a=typeof B=="undefined"?"default":B,F={};F.formFactor=l,l!="desktop"?(F.OS=S.OperatingSystem.iOS,F.touchable=!0):(F.OS=S.OperatingSystem.Windows,F.touchable=!1);let o=t.layout(l),d=new S("other",F.formFactor,F.OS,F.touchable),U=new gs({keyboard:t,keyboardMetadata:n,hostDevice:d,isStatic:!0,topContainer:null,pathConfig:s,styleSheetManager:null,specialFont:{family:"SpecialOSK",files:[`${s.resources}/osk/keymanweb-osk.ttf`],path:""}});U.layerGroup.element.className=U.kbdDiv.className,U.layerGroup.element.classList.add(F.formFactor+"-static");let u=U.kbdDiv.childNodes[0],g=document.createElement("div");g.classList.add(F.OS.toLowerCase(),F.formFactor),o!=null?(U.layerId=a,U.layerGroup.activeLayerId=a,U.setSize(800,c),U.fontSize=Tr(d,c,!1),g.style.fontSize=U.element.style.fontSize,U.refreshLayout(),u.style.height=U.kbdDiv.style.height,u.style.maxHeight=U.kbdDiv.style.maxHeight):u.innerHTML="<p style='color:#c40; font-size:0.5em;margin:10px;'>No "+l+" layout is defined for "+t.name+".</p>",u.style.border="1px solid #ccc",U.updateState();let I=r(()=>L(this,null,function*(){if(document.contains(u))try{yield U.styleSheetManager.allLoadedPromise();let x=U.styleSheet;x&&u.appendChild(x);let m=[].concat(U.styleSheetManager.sheets);for(let b of m)b!=x&&(b.href||(U.styleSheetManager.unlink(b),document.head.appendChild(b)));U.refreshLayout(),U.styleSheet=null,U.shutdown()}finally{C.disconnect()}}),"detectAndHandleInsertion"),C=new MutationObserver(I);C.observe(document.body,{childList:!0,subtree:!0}),g.append(u);for(let x of It.STYLESHEET_FILES){let m=`${s.resources}/osk/${x}`,b=U.styleSheetManager.linkExternalSheet(m,!0);b.parentNode.removeChild(b),g.appendChild(b)}return U.appendStyleSheet(),g}onHide(){this.hkKey&&this.highlightKey(this.hkKey,!1)}optionKey(t,n,s){n.indexOf("K_LOPT")>=0?this.emit("globekey",t,s):n.indexOf("K_ROPT")>=0&&s&&this.emit("hiderequested",t)}showGesturePreview(t){let n=this.keytip,s=this.constructLayoutParams(),i=s.keyboardWidth*t.key.spec.proportionalWidth,B=s.keyboardHeight/this.currentLayer.rows.length,c=new Ji(t,this.device.formFactor=="phone",i,B);return n==null?t.key.setPreview(c):n.show(t,!0,c),c.refreshLayout(),c}createKeyTip(){if(this.keytip==null)if(this.device.formFactor=="phone"){let t=this.isEmbedded;this.keytip=new Fs(this,t)}else this.keytip=new Ei(this);this.keytip&&this.keytip.element&&this.element.appendChild(this.keytip.element)}createGlobeHint(){return this.config.embeddedGestureConfig.createGlobeHint?this.config.embeddedGestureConfig.createGlobeHint(this):null}shutdown(){var t;this.styleSheet&&this.styleSheet.parentNode&&this.styleSheet.parentNode.removeChild(this.styleSheet),this.activeGestures.forEach(n=>n.cancel()),this.gestureEngine&&this.gestureEngine.destroy(),this.deleting&&window.clearTimeout(this.deleting),(t=this.keytip)==null||t.show(null,!1,null)}lockLayer(t){this.layerLocked=t}raiseKeyEvent(t,n){if(t.kName=="K_LOPT"||t.kName=="K_ROPT")return this.optionKey(n,t.kName,!0),{};let s={},i=r((B,c)=>{var a,F;s.contextToken=(a=B==null?void 0:B.transcription)==null?void 0:a.token;let l=(F=B==null?void 0:B.transcription)==null?void 0:F.transform;s.alteredText=B&&(!l||me(l))},"keyEventCallback");return this.layerLocked&&(t.kNextLayer=this.layerId),this.emit("keyevent",t,i),s}};r(gs,"VisualKeyboard"),gs.specialCharacters=Xt.specialCharacters;var yt=gs;var Ql=class Ql extends X.default{};r(Ql,"Activator");var zt=Ql,al=class al extends zt{get enabled(){return!0}set enabled(e){}get activate(){return!0}get conditionsMet(){return!0}};r(al,"StaticActivator");var Ze=al;var Fl=class Fl{constructor(){this.map=new Map}promiseForTouchpoint(e){return this.map.get(e)||this.map.set(e,new E),this.map.get(e)}maintainTouches(e){let t=Array.from(this.map.keys());for(let n=0;n<e.length;n++){let s=t.indexOf(e.item(n).identifier);s!=-1&&t.splice(s,1)}for(let n of t)this.map.get(n).resolve(),this.map.delete(n)}};r(Fl,"TouchEventPromiseMap");var us=Fl;function Pr(Q){let e="osk/";return Q.isEmbedded&&(e=""),`${Q.pathConfig.resources}/${e}`}r(Pr,"getResourcePath");var gn=class gn extends X.default{constructor(t){var i;super();this.legacyEvents=new Bn;this.needsLayout=!0;this.touchEventPromiseManager=new us;this.activationListener=r(t=>{if(!this.mayDisable&&!this.activationModel.enabled){this.activationModel.off("activate",this.activationListener);try{this.activationModel.enabled=!0}finally{this.activationModel.on("activate",this.activationListener)}}this.commonCheckAndDisplay()},"activationListener");this.layerChangeHandler=r((t,n)=>{var s,i;return this.vkbd&&this.vkbd._UpdateVKShiftStyle(n),(this.vkbd&&this.vkbd.layerId!=n||t.value!=n)&&(s=this.vkbd)!=null&&s.layerGroup.getLayer(n)&&!((i=this.vkbd)!=null&&i.layerLocked)&&(this.vkbd.layerId=n),!1},"layerChangeHandler");this._Visible=!1;this.config=t=h({},t),this.config.allowHideAnimations===void 0&&(this.config.allowHideAnimations=!0),this.config.device=t.device||t.hostDevice,this.config.isEmbedded=t.isEmbedded||!1,this.config.embeddedGestureConfig=t.embeddedGestureConfig||{},this.config.activator.on("activate",this.activationListener),this._Box=A("div"),this.kbdStyleSheetManager=new rt(this._Box,this.config.doCacheBusting||!1),this.uiStyleSheetManager=new rt(this._Box),this.bannerView=new ii,this.bannerView.events.on("bannerchange",()=>this.refreshLayout()),this._Box.appendChild(this.bannerView.element),this._bannerController=new Bs(this.bannerView,this.hostDevice,this.config.predictionContextManager),this.keyboardView=new ae,this._Box.appendChild(this.keyboardView.element);let n=Pr(this.config);for(let B of gn.STYLESHEET_FILES){let c=`${n}${B}`;this.uiStyleSheetManager.linkExternalSheet(c)}this.activeKeyboard=this.config.keyboardToActivate;let s=(i=this.config.predictionContextManager)==null?void 0:i.modelState;s&&this.bannerController.selectBanner(s),this.setBaseMouseEventListeners(),this.hostDevice.touchable&&this.setBaseTouchEventListeners(),this._Box.style.display="none",this.initialized=!0}get keyCodes(){return y.keyCodes}get modifierCodes(){return y.modifierCodes}get modifierBitmasks(){return y.modifierBitmasks}get stateBitmasks(){return y.stateBitmasks}get configuration(){return this.config}get bannerController(){return this._bannerController}get hostDevice(){return this.config.hostDevice}get fontRootPath(){return this.config.pathConfig.fonts}get isEmbedded(){return this.config.isEmbedded}setBaseMouseEventListeners(){this._Box.onmouseenter=t=>{this.mouseEnterPromise&&this.mouseEnterPromise.resolve(),this.mouseEnterPromise=new E,this.emit("pointerinteraction",this.mouseEnterPromise.corePromise)},this._Box.onmouseleave=t=>{this.mouseEnterPromise.resolve(),this.mouseEnterPromise=null}}removeBaseMouseEventListeners(){this._Box.onmouseenter=null,this._Box.onmouseleave=null}setBaseTouchEventListeners(){let t=r(function(n){return n.cancelable&&n.preventDefault(),n.stopPropagation(),!1},"commonPrevention");this._boxBaseTouchEventCancel=n=>(this.touchEventPromiseManager.maintainTouches(n.touches),t(n)),this._boxBaseTouchStart=n=>{for(let s=0;s<n.changedTouches.length;s++){let i=this.touchEventPromiseManager.promiseForTouchpoint(n.changedTouches[s].identifier);this.emit("pointerinteraction",i.corePromise)}return this.touchEventPromiseManager.maintainTouches(n.touches),t(n)},this._Box.addEventListener("touchstart",this._boxBaseTouchStart,!1),this._Box.addEventListener("touchmove",this._boxBaseTouchEventCancel,!1),this._Box.addEventListener("touchend",this._boxBaseTouchEventCancel,!1),this._Box.addEventListener("touchcancel",this._boxBaseTouchEventCancel,!1)}removeBaseTouchEventListeners(){this._boxBaseTouchEventCancel&&(this._Box.removeEventListener("touchstart",this._boxBaseTouchStart,!1),this._Box.removeEventListener("touchmove",this._boxBaseTouchEventCancel,!1),this._Box.removeEventListener("touchend",this._boxBaseTouchEventCancel,!1),this._Box.removeEventListener("touchcancel",this._boxBaseTouchEventCancel,!1),this._boxBaseTouchEventCancel=null,this._boxBaseTouchStart=null)}get targetDevice(){return this.config.device}set targetDevice(t){this.allowsDeviceChange(t)?(this.config.device=t,this.loadActiveKeyboard()):console.error("May not change target device for this OSKView type.")}allowsDeviceChange(t){return!1}get activationModel(){return this.config.activator}set activationModel(t){if(!t)throw new Error("The activation model may not be set to null or undefined!");this.config.activator.off("activate",this.activationListener),t.on("activate",this.activationListener),this.config.activator=t,this.commonCheckAndDisplay()}get mayDisable(){var t;return!(this.hostDevice.touchable||(t=this.activeKeyboard)!=null&&t.keyboard.isCJK)}get displayIfActive(){return this.activationModel.enabled}commonCheckAndDisplay(){this.activationModel.activate&&this.activeKeyboard?this.present():this.startHide(!1)}get vkbd(){return this.keyboardView instanceof yt?this.keyboardView:null}get banner(){return this.bannerView}get width(){return this._width}get height(){return this._height}get computedWidth(){return this.needsLayout&&this.refreshLayout(),this._computedWidth}get computedHeight(){return this.needsLayout&&this.refreshLayout(),this._computedHeight}get baseFontSize(){var t;return((t=this.parsedBaseFontSize)==null?void 0:t.styleString)||""}get parsedBaseFontSize(){return this._baseFontSize||(this._baseFontSize=gn.defaultFontSize(this.targetDevice,this.computedHeight,this.isEmbedded)),this._baseFontSize}static defaultFontSize(t,n,s){if(t.touchable){let i=t.formFactor=="phone"?1.6*(s?.65:.6)*1.2:2;return G.special(i,"em")}else return n?G.inPixels(n/8):void 0}get activeKeyboard(){return this.keyboardData}set activeKeyboard(t){var n,s,i;this.initialized&&((n=this.keyboardData)==null?void 0:n.keyboard)==(t==null?void 0:t.keyboard)&&((s=this.keyboardData)==null?void 0:s.metadata)==(t==null?void 0:t.metadata)||(this.keyboardData=t,this.loadActiveKeyboard(),(i=this.keyboardData)!=null&&i.keyboard.isCJK&&(this.activationModel.enabled=!0))}computeFrameHeight(){var t,n;return(((t=this.headerView)==null?void 0:t.layoutHeight.val)||0)+(((n=this.footerView)==null?void 0:n.layoutHeight.val)||0)}setSize(t,n,s){let i=!1,B,c;!t&&t!==0||!n&&n!==0||(Number.isFinite(t)?B=G.inPixels(t):B=new G(t),Number.isFinite(n)?c=G.inPixels(n):c=new G(n),t&&n&&(i=!this._width||!this._height,i=i||B.styleString!=this._width.styleString,i=i||c.styleString!=this._height.styleString,this._width=B,this._height=c),this.needsLayout=this.needsLayout||i,this.refreshLayoutIfNeeded(s))}setNeedsLayout(){this.needsLayout=!0}batchLayoutAfter(t){if(this.deferLayout){t();return}try{this.deferLayout=!0,this.vkbd&&(this.vkbd.deferLayout=!0),t()}finally{this.deferLayout=!1,this.vkbd&&(this.vkbd.deferLayout=!1),this.refreshLayout()}}refreshLayout(t){var c,l;if(!this.keyboardView||this.deferLayout||!(this.width&&this.height))return;let s=this.width.absolute&&this.height.absolute,i=getComputedStyle(this._Box),B=i.height!=""&&i.height!="auto";if(s)this._computedWidth=this.width.val,this._computedHeight=this.height.val;else if(B){let a=this._Box.parentElement;this._computedWidth=this.width.val*(this.width.absolute?1:a.offsetWidth),this._computedHeight=this.height.val*(this.height.absolute?1:a.offsetHeight)}else{console.warn("Unable to properly perform layout - specification uses a relative spec, thus relies upon insertion into the DOM for layout.");return}if(this.needsLayout=!1,this.banner.element.style.fontSize=this.baseFontSize,this.vkbd&&(this.vkbd.fontSize=this.parsedBaseFontSize),t||((c=this.headerView)==null||c.refreshLayout(),this.bannerView.width=this.computedWidth,this.bannerView.refreshLayout(),(l=this.footerView)==null||l.refreshLayout()),this.vkbd){let a=this.computedHeight-this.computeFrameHeight();this.bannerView.height>0&&(a-=this.bannerView.height+5),this.vkbd.setSize(this.computedWidth,a,t);let F=this._Box.style;F.width=F.maxWidth=this.computedWidth+"px",F.height=F.maxHeight=this.computedHeight+"px"}else{let a=this._Box.style;a.width="auto",a.height="auto",a.maxWidth=a.maxHeight=""}}refreshLayoutIfNeeded(t){this.needsLayout&&this.refreshLayout(t)}postKeyboardLoad(){this._Visible=!1,this.postKeyboardAdjustments(),this.displayIfActive&&this.present()}loadActiveKeyboard(){var i,B,c,l,a;this.setBoxStyling(),this.needsLayout=!0;let t=this.keyboardView,n=this.kbdStyleSheetManager;this.kbdStyleSheetManager=new rt(this._Box,this.config.doCacheBusting||!1);let s=this.keyboardView=this._GenerateKeyboardView((i=this.keyboardData)==null?void 0:i.keyboard,(B=this.keyboardData)==null?void 0:B.metadata);if(this._Box.replaceChild(s.element,t.element),s.postInsert(),(a=this.bannerController)==null||a.configureForKeyboard((c=this.keyboardData)==null?void 0:c.keyboard,(l=this.keyboardData)==null?void 0:l.metadata),t instanceof yt&&t.shutdown(),n.unlinkAll(),this.banner.appendStyles(),this.vkbd){this.vkbd.createKeyTip();let F=this.vkbd.createGlobeHint();F&&this._Box.appendChild(F.element),this.vkbd.appendStyleSheet()}this.postKeyboardLoad()}_GenerateKeyboardView(t,n){let s=this.targetDevice;return this._Box.className="",t==null&&!s.touchable?new ae:t&&t.layout(s.formFactor)?this._GenerateVisualKeyboard(t,n):!t||!n?this._GenerateVisualKeyboard(null,null):new cs(t)}_GenerateVisualKeyboard(t,n){let s=this.targetDevice,i=Pr(this.config),B=new yt({keyboard:t,keyboardMetadata:n,device:s,hostDevice:this.hostDevice,topContainer:this._Box,styleSheetManager:this.kbdStyleSheetManager,pathConfig:this.config.pathConfig,embeddedGestureConfig:this.config.embeddedGestureConfig,isEmbedded:this.config.isEmbedded,specialFont:{family:"SpecialOSK",files:[`${i}/keymanweb-osk.ttf`],path:""}});return B.on("keyevent",(c,l)=>this.emit("keyevent",c,l)),B.on("globekey",(c,l)=>this.emit("globekey",c,l)),B.on("hiderequested",c=>{this.doHide(!0),this.emit("hiderequested",c)}),this._Box.className=s.formFactor+" "+s.OS.toLowerCase()+" kmw-osk-frame",B}present(){if(this.mayShow()){if(this.keyboardView.updateState(),this._Box.style.display="block",this.refreshLayoutIfNeeded(),this._Visible=!0,this._Box.style.opacity="1",this._Box.style.visibility=="hidden"){let t=this;window.setTimeout(function(){t._Box.style.visibility="visible"},0)}this.setDisplayPositioning()}}startHide(t){if(!this.mayHide(t))return;t&&(this.activationModel.enabled=!!(this.keyboardData.keyboard.isCJK||this.hostDevice.touchable));let n=null;this._Box&&this.hostDevice.touchable&&!(this.keyboardView instanceof ae)&&this.config.allowHideAnimations?n=this.useHideAnimation():n=Promise.resolve(!0);let s=this;n.then(function(i){i&&s.finalizeHide()}),this.doHide(t)}finalizeHide(){if(!(document.body.className.indexOf("osk-always-visible")>=0&&this.hostDevice.formFactor=="desktop")){if(this._Box){let t=this._Box.style;t.display="none",t.transition="",t.opacity="1",this._Visible=!1}this.vkbd&&this.vkbd.onHide()}}mayShow(){return!(!this.activationModel.conditionsMet||!this.keyboardView||this.keyboardView instanceof ae||!this.activationModel.enabled||!this._Box)}mayHide(t){return!(this.activationModel.conditionsMet&&!this.mayDisable||this.activationModel instanceof Ze||!t&&this.hostDevice.formFactor=="desktop"&&document.body.className.indexOf("osk-always-visible")>=0)}useHideAnimation(){let t=this._Box.style,n=this;return new Promise(function(s){let i=r(function(){return n._Box.removeEventListener("transitionend",i,!1),n._Box.removeEventListener("webkitTransitionEnd",i,!1),n._Box.removeEventListener("transitioncancel",i,!1),n._Box.removeEventListener("webkitTransitionCancel",i,!1),n._animatedHideTimeout!=0&&window.clearTimeout(n._animatedHideTimeout),n._animatedHideTimeout=0,n._Visible&&n.activationModel.conditionsMet?(t.transition="",t.opacity="1",s(!1),!1):(s(!0),!0)},"cleanup"),B=r(function(){n._Box.removeEventListener("transitionrun",B,!1),n._Box.removeEventListener("webkitTransitionRun",B,!1),n._Box.addEventListener("transitionend",i,!1),n._Box.addEventListener("webkitTransitionEnd",i,!1),n._Box.addEventListener("transitioncancel",i,!1),n._Box.addEventListener("webkitTransitionCancel",i,!1)},"startup");n._Box.addEventListener("transitionrun",B,!1),n._Box.addEventListener("webkitTransitionRun",B,!1),t.transition="opacity 0.5s linear 0",t.opacity="0",n._animatedHideTimeout=window.setTimeout(i,200)})}hideNow(){if(!this.mayHide(!1)||!this._Box)return;this._animatedHideTimeout&&(window.clearTimeout(this._animatedHideTimeout),this._animatedHideTimeout=0);let t=this._Box.style;t.transition="",t.opacity="0",this.finalizeHide()}shutdown(){this.removeBaseMouseEventListeners(),this.removeBaseTouchEventListeners();var t=this._Box;t.parentElement&&t.parentElement.removeChild(t),this.kbdStyleSheetManager.unlinkAll(),this.uiStyleSheetManager.unlinkAll(),this.bannerController.shutdown()}getRect(){var t={};return t.left=t.left=M(this._Box),t.top=t.top=Y(this._Box),t.width=this.computedWidth,t.height=this.computedHeight,t}isEnabled(){return this.displayIfActive}isVisible(){return this._Visible}hide(){this.activationModel.enabled=!1,this.startHide(!0)}show(t){arguments.length>0?this.activationModel.enabled=t:this.activationModel.conditionsMet&&(this.activationModel.enabled=!this.activationModel.enabled)}doShow(t){this.legacyEvents.callEvent("show",t)}doHide(t){let n={HiddenByUser:t};this.legacyEvents.callEvent("hide",n)}addEventListener(t,n){this.legacyEvents.addEventListener(t,n)}removeEventListener(t,n){this.legacyEvents.removeEventListener(t,n)}};r(gn,"OSKView"),gn.STYLESHEET_FILES=["kmwosk.css","globe-hint.css"];var It=gn;var ys=class ys extends X.default{constructor(t){super();this.mouseCancellingHandler=r(function(t){return t.preventDefault(),t.cancelBubble=!0,!1},"mouseCancellingHandler");this._element=this.buildTitleBar(),this.helpEnabled=!1,this.configEnabled=!1,t&&(this.element.onmousedown=t.mouseDownHandler)}get helpEnabled(){return this._helpEnabled}set helpEnabled(t){this._helpEnabled=t,this._helpButton.style.display=t?"inline":"none"}get configEnabled(){return this._configEnabled}set configEnabled(t){this._configEnabled=t,this._configButton.style.display=t?"inline":"none"}get layoutHeight(){return ys.DISPLAY_HEIGHT}get element(){return this._element}setPinCJKOffset(){this._unpinButton.style.left="15px"}showPin(t){this._unpinButton.style.display=t?"block":"none"}setTitle(t){this._caption.innerHTML=t}setTitleFromKeyboard(t){let n="<span style='font-weight:bold'>"+(t==null?void 0:t.name)+"</span>";this._caption.innerHTML=n}buildTitleBar(){let t=A("div");t.id="keymanweb_title_bar",t.className="kmw-title-bar";var n=this._caption=A("span");n.className="kmw-title-bar-caption",n.style.color="#fff",t.appendChild(n);var s=this._closeButton=this.buildCloseButton();return this._closeButton.onclick=()=>(this.emit("close"),!1),t.appendChild(s),s=this._helpButton=this.buildHelpButton(),this._helpButton.onclick=()=>(this.emit("help"),!1),t.appendChild(s),s=this._configButton=this.buildConfigButton(),this._configButton.onclick=()=>(this.emit("config"),!1),t.appendChild(s),s=this._unpinButton=this.buildUnpinButton(),this._unpinButton.onclick=()=>(this.emit("unpin"),!1),t.appendChild(s),t}buildCloseButton(){var t=A("div");return t.id="kmw-close-button",t.className="kmw-title-bar-image",t.onmousedown=this.mouseCancellingHandler,t}buildHelpButton(){let t=A("div");return t.id="kmw-help-image",t.className="kmw-title-bar-image",t.title="KeymanWeb Help",t.onmousedown=this.mouseCancellingHandler,t}buildConfigButton(){let t=A("div");return t.id="kmw-config-image",t.className="kmw-title-bar-image",t.title="KeymanWeb Configuration Options",t.onmousedown=this.mouseCancellingHandler,t}buildUnpinButton(){let t=A("div");return t.id="kmw-pin-image",t.className="kmw-title-bar-image",t.title="Pin the On Screen Keyboard to its default location on the active text box",t.onmousedown=this.mouseCancellingHandler,t}refreshLayout(){}};r(ys,"TitleBar"),ys.DISPLAY_HEIGHT=G.inPixels(20);var un=ys;var Is=class Is extends X.default{constructor(t){super();this.mouseCancellingHandler=r(function(t){return t.preventDefault(),t.cancelBubble=!0,!1},"mouseCancellingHandler");this._element=this.buildResizeBar(),t&&(this._resizeHandle.onmousedown=t.mouseDownHandler)}get layoutHeight(){return Is.DISPLAY_HEIGHT}get element(){return this._element}get handle(){return this._resizeHandle}allowResizing(t){this._resizeHandle.style.display=t?"block":"none"}buildResizeBar(){var t=A("div");t.className="kmw-footer",t.onmousedown=this.mouseCancellingHandler;var n=A("div");n.className="kmw-footer-caption",n.innerHTML='<a href="https://keyman.com/developer/keymanweb/">KeymanWeb</a>',n.id="keymanweb-osk-footer-caption",n.addEventListener("dblclick",i=>(this.emit("showbuild"),!1),!1),t.appendChild(n);var s=A("div");return s.className="kmw-footer-resize",t.appendChild(s),this._resizeHandle=s,t}refreshLayout(){}};r(Is,"ResizeBar"),Is.DISPLAY_HEIGHT=G.inPixels(16);var hs=Is;var yn=class yn{constructor(e,t,n){this.x=e,this.y=t}static fromEvent(e){let t;if(window.TouchEvent&&e instanceof TouchEvent||e.changedTouches?t=e.changedTouches[0]:t=e,t.pageX)return new yn(t.pageX,t.pageY,e);if(t.clientX){let n=t.clientX+document.body.scrollLeft,s=t.clientY+document.body.scrollTop;return new yn(n,s,e)}else return new yn(null,null,e)}};r(yn,"InputEventCoordinate");var Ri=yn,Ul=class Ul{constructor(e){this._VPreviousMouseMove=document.onmousemove,this._VPreviousMouseUp=document.onmouseup,this._VPreviousCursor=document.body.style.cursor,this._VPreviousMouseButton=typeof e.which=="undefined"?e.button:e.which}restore(){document.onmousemove=this._VPreviousMouseMove,document.onmouseup=this._VPreviousMouseUp,document.body.style.cursor&&(document.body.style.cursor=this._VPreviousCursor)}matchesCausingClick(e){return this._VPreviousMouseButton==(typeof e.which=="undefined"?e.button:e.which)}};r(Ul,"MouseStartSnapshot");var ol=Ul,dl=class dl{constructor(e){this.startHandler=this._VMoveMouseDown.bind(this),this.cursorType=e}get enabled(){return this._enabled}set enabled(e){this._enabled=e}get isActive(){return!!this._mouseStartSnapshot}get mouseDownHandler(){return this.startHandler}_VMoveMouseDown(e){return!e||!this._enabled?!0:(this._mouseStartSnapshot||(this._mouseStartSnapshot=new ol(e)),this._startCoord=Ri.fromEvent(e),document.onmousemove=this._VMoveMouseMove.bind(this),document.onmouseup=this._VMoveMouseUp.bind(this),document.body.style.cursor&&(document.body.style.cursor=this.cursorType),e.preventDefault(),e.cancelBubble=!0,this.onDragStart(),!1)}_VMoveMouseMove(e){if(!e||!this.enabled)return!0;if(e.preventDefault(),e.cancelBubble=!0,this._mouseStartSnapshot.matchesCausingClick(e)){let t=Ri.fromEvent(e),n=t.x-this._startCoord.x,s=t.y-this._startCoord.y;return this.onDragMove(n,s),!1}else return this._VMoveMouseUp(e)}_VMoveMouseUp(e){return e?(this._mouseStartSnapshot.restore(),this._mouseStartSnapshot=null,e.preventDefault(),e.cancelBubble=!0,this.onDragRelease(),!1):!0}};r(dl,"MouseDragOperation");var In=dl;var gl=class gl extends zt{constructor(){super(...arguments);this._enabled=!0;this.actValue=null}get activate(){return this._enabled&&!!this.actValue}checkState(t){this.activate!=t&&this.emit("activate",this.activate)}get enabled(){return this._enabled}set enabled(t){let n=this.activate;this._enabled=t,this.checkState(n)}get activationTrigger(){return this.actValue}set activationTrigger(t){let n=this.activate,s=this.actValue;this.actValue=t,this.checkState(n),s!=t&&this.emit("triggerchange",t)}get conditionsMet(){return!!this.activationTrigger}};r(gl,"TwoStateActivator");var oe=gl;var ul=class ul extends nt{constructor(){super("KeymanWeb_OnScreenKeyboard")}loadWithDefaults(e){return h(h({},e),this.load())}load(){let e=super.load((t,n)=>{switch(n){case"version":return t;default:return Number.parseInt(t,10)}});return e.width||delete e.width,e.height||delete e.height,e}save(e){super.save(e)}};r(ul,"FloatingOSKCookieSerializer");var Ai=ul;var yl=class yl extends It{constructor(t){t.activator=t.activator||new oe;super(t);this.userPositioned=!1;this.specifiedPosition=!1;this.noDrag=!1;this.layoutSerializer=new Ai;this.restorePosition=function(t){let n=this._Visible,s=new E;this.emit("dragmove",s.corePromise),this.loadPersistedLayout(),this.userPositioned=!1,t||(delete this.dfltX,delete this.dfltY),this.savePersistedLayout(),n&&this.present(),this.titleBar.showPin(!1),s.resolve(),this.doResizeMove()}.bind(this);this.typedActivationModel.on("triggerchange",()=>this.setDisplayPositioning()),document.body.appendChild(this._Box),this.titleBar=new un(this.titleDragHandler),this.titleBar.on("help",()=>{this.legacyEvents.callEvent("helpclick",{})}),this.titleBar.on("config",()=>{this.legacyEvents.callEvent("configclick",{})}),this.titleBar.on("close",()=>this.startHide(!0)),this.titleBar.on("unpin",()=>this.restorePosition(!0)),this.resizeBar=new hs(this.resizeDragHandler),this.resizeBar.on("showbuild",()=>this.emit("showbuild")),this.headerView=this.titleBar,this._Box.insertBefore(this.headerView.element,this._Box.firstChild);let n=r(B=>{let c=this.headerView;if(c&&c instanceof un)switch(B){case"configclick":c.configEnabled=this.legacyEvents.listenerCount("configclick")>0;break;case"helpclick":c.helpEnabled=this.legacyEvents.listenerCount("helpclick")>0;break;default:return}},"onListenedEvent"),s=new sn(this),i=new sn(this.legacyEvents);for(let B of[s,i])B.on("listeneradded",n),B.on("listenerremoved",n);this.activeKeyboard&&this.postKeyboardAdjustments(),this.loadPersistedLayout()}get typedActivationModel(){return this.activationModel}_Unload(){this.keyboardView=null,this.bannerView=null,this._Box=null}setBoxStyling(){let t=this._Box.style;t.zIndex="9999",t.display="none",t.width="auto",t.position="absolute"}postKeyboardAdjustments(){this.titleBar&&(this.enableMoveResizeHandlers(),this.activeKeyboard&&this.titleBar.setTitleFromKeyboard(this.activeKeyboard.keyboard),this.vkbd?(this.footerView=this.resizeBar,this._Box.appendChild(this.footerView.element)):(this.footerView&&this._Box.removeChild(this.footerView.element),this.footerView=null),this.loadPersistedLayout(),this.setNeedsLayout())}isEnabled(){return this.displayIfActive}isVisible(){return this._Visible}savePersistedLayout(){var t=this.getPos();let n={visible:this.displayIfActive?1:0,userSet:this.userPositioned?1:0,left:t.left,top:t.top,_version:N.CURRENT.toString()};this.vkbd&&(n.width=this.width.val,n.height=this.height.val),this.layoutSerializer.save(n)}loadPersistedLayout(){if(!this.layoutSerializer)return;let t=this.layoutSerializer.loadWithDefaults({visible:1,userSet:0,left:-1,top:-1,_version:void 0,width:.3*screen.width,height:.15*screen.height});this.activationModel.enabled=t.visible==1,this.userPositioned=t.userSet==1,this.x=t.left,this.y=t.top;let n=t._version,s=n===void 0,i=t.width,B=t.height;i<.2*screen.width&&(i=.2*screen.width),B<.1*screen.height&&(B=.1*screen.height),i>.9*screen.width&&(i=.9*screen.width),B>.5*screen.height&&(B=.5*screen.height),(s||!n)&&(this.headerView&&this.headerView.layoutHeight.absolute&&(B+=this.headerView.layoutHeight.val),this.footerView&&this.footerView.layoutHeight.absolute&&(B+=this.footerView.layoutHeight.val)),this.setSize(i,B),(this.x==-1||this.y==-1||!this._Box)&&(this.userPositioned=!1),this.x<window.pageXOffset-.8*i&&(this.x=window.pageXOffset-.8*i),this.y<0&&(this.x=-1,this.y=-1,this.userPositioned=!1),this.userPositioned&&this._Box&&this.setPos({left:this.x,top:this.y})}getDefaultKeyboardHeight(){if(this.configuration.heightOverride)return this.configuration.heightOverride();var t=Math.floor(Math.min(screen.availHeight,screen.availWidth)/2),n=t;if(this.targetDevice.formFactor=="phone"){var s=Math.min(screen.height,screen.width),i=Math.max(screen.height,screen.width);dt()?n=n*(i/s)/1.6:n=Math.floor(Math.max(screen.availHeight,screen.availWidth)/3)}return this.targetDevice.OS==S.OperatingSystem.iOS&&(n=n/St(this.targetDevice.formFactor)),n}getDefaultWidth(){if(this.configuration.widthOverride)return this.configuration.widthOverride();var t;if(this.targetDevice.OS==S.OperatingSystem.iOS)t=window.innerWidth;else if(this.targetDevice.OS==S.OperatingSystem.Android)try{t=document.documentElement.clientWidth}catch(n){t=screen.availWidth}else t=screen.width;return t}doResizeMove(t){this.legacyEvents.callEvent("resizemove",t)}setRect(t){if(!(this._Box==null||this.targetDevice.formFactor!="desktop")){var n=this._Box,s=n.style;if("left"in t&&(this.x=t.left-M(n)+n.offsetLeft,s.left=this.x+"px",this.dfltX=s.left),"top"in t&&(this.y=t.top-Y(n)+n.offsetTop,s.top=this.y+"px",this.dfltY=s.top),this.vkbd!=null){var i=this.vkbd.kbdDiv,B=i.style;if("width"in t){var c=t.width-(n.offsetWidth-i.offsetWidth);c<.2*screen.width&&(c=.2*screen.width),c>.9*screen.width&&(c=.9*screen.width),B.width=c+"px",this.setSize(c,this.computedHeight,!0)}if("height"in t){var l=t.height-(n.offsetHeight-i.offsetHeight);l<.1*screen.height&&(l=.1*screen.height),l>.5*screen.height&&(l=.5*screen.height),B.height=l+"px",B.fontSize=l/8+"px",this.setSize(this.computedWidth,l,!0)}"nosize"in t&&(this.resizingEnabled=!t.nosize)}"nomove"in t&&(this.noDrag=t.nomove,this.movementEnabled=!this.noDrag),this.savePersistedLayout()}}getPos(){var t=this._Box,n={left:this._Visible?t.offsetLeft:this.x,top:this._Visible?t.offsetTop:this.y};return n}setPos(t){if(typeof this._Box!="undefined"){if(this.userPositioned){var n=t.left,s=t.top;typeof n!="undefined"&&(n<-.8*this._Box.offsetWidth&&(n=-.8*this._Box.offsetWidth),this.userPositioned&&(this._Box.style.left=n+"px",this.x=n)),typeof s!="undefined"&&(s<0&&(s=0),this.userPositioned&&(this._Box.style.top=s+"px",this.y=s))}this.titleBar.showPin(this.userPositioned)}}setDisplayPositioning(){var t=this._Box.style;if(t.position="absolute",this.activationModel.activate&&(t.display="block"),t.left="0px",this.specifiedPosition||this.userPositioned)t.left=this.x+"px",t.top=this.y+"px";else{let n=this.typedActivationModel.activationTrigger||null;this.dfltX?t.left=this.dfltX:typeof n!="undefined"&&n!=null&&(t.left=M(n)+"px"),this.dfltY?t.top=this.dfltY:typeof n!="undefined"&&n!=null&&(t.top=Y(n)+n.offsetHeight+"px")}this.specifiedPosition=!1}presentAtPosition(t,n){this.mayShow()&&(this.specifiedPosition=t>=0||n>=0,this.specifiedPosition&&(this.x=t,this.y=n),this.specifiedPosition=this.specifiedPosition||this.userPositioned,this.present())}present(){this.mayShow()&&(this.titleBar.showPin(this.userPositioned),super.present(),this.doShow({x:this._Box.offsetLeft,y:this._Box.offsetTop,userLocated:this.userPositioned}))}startHide(t){super.startHide(t),t&&this.savePersistedLayout()}show(t){t!==void 0?super.show(t):super.show(),this.savePersistedLayout()}userLocated(){return this.userPositioned}get movementEnabled(){return this.titleDragHandler.enabled}set movementEnabled(t){this.titleDragHandler.enabled=t,this.titleBar.showPin(t&&this.userPositioned)}get resizingEnabled(){return this.resizeDragHandler.enabled}set resizingEnabled(t){this.resizeDragHandler.enabled=t,this.resizeBar.allowResizing(t)}get isBeingMoved(){return this.titleDragHandler.isActive}get isBeingResized(){return this.resizeDragHandler.isActive}enableMoveResizeHandlers(){this.titleDragHandler.enabled=!this.noDrag,this.resizeDragHandler.enabled=!0}get titleDragHandler(){let t=this;return this._moveHandler?this._moveHandler:(this._moveHandler=new class extends In{constructor(){super("move")}onDragStart(){this.startX=t._Box.offsetLeft,this.startY=t._Box.offsetTop,t.activeKeyboard.keyboard.isCJK&&t.titleBar.setPinCJKOffset(),this.dragPromise&&this.dragPromise.resolve(),this.dragPromise=new E,t.emit("dragmove",this.dragPromise.corePromise)}onDragMove(s,i){t.titleBar.showPin(!0),t.userPositioned=!0,t._Box.style.left=this.startX+s+"px",t._Box.style.top=this.startY+i+"px";var B=t.getRect();t.setSize(B.width,B.height,!0),t.x=B.left,t.y=B.top}onDragRelease(){t.vkbd&&(t.vkbd.currentKey=null),this.dragPromise.resolve(),this.dragPromise.then(()=>{t.userPositioned=!0,t.doResizeMove(),t.savePersistedLayout()}),this.dragPromise=null}},this._moveHandler)}get resizeDragHandler(){let t=this;return this._resizeHandler?this._resizeHandler:(this._resizeHandler=new class extends In{constructor(){super("se-resize")}onDragStart(){this.startWidth=t.computedWidth,this.startHeight=t.computedHeight,this.dragPromise&&this.dragPromise.resolve(),this.dragPromise=new E,t.emit("resizemove",this.dragPromise.corePromise)}onDragMove(s,i){let B=this.startWidth+s,c=this.startHeight+i;B<.2*screen.width&&(B=.2*screen.width),c<.1*screen.height&&(c=.1*screen.height),B>.9*screen.width&&(B=.9*screen.width),c>.5*screen.height&&(c=.5*screen.height),t.setSize(B,c,!0)}onDragRelease(){t.vkbd&&(t.vkbd.currentKey=null),t.vkbd&&(this.startWidth=t.computedWidth,this.startHeight=t.computedHeight),t.refreshLayout(),this.dragPromise.resolve(),this.dragPromise.then(()=>{t.doResizeMove(),t.savePersistedLayout()}),this.dragPromise=null}},this._resizeHandler)}};r(yl,"FloatingOSKView");var Dt=yl;var Il=class Il extends It{constructor(t){t.isEmbedded?t.activator=t.activator||new Ze:t.activator=t.activator||new oe;super(t);this.isResizing=!1;this.restorePosition=function(t){}.bind(this);document.body.appendChild(this._Box)}_Unload(){this.keyboardView=null,this.bannerView=null,this._Box=null}setBoxStyling(){let t=this._Box.style;t.zIndex="9999",t.display="none",t.width="100%",t.position="fixed"}refreshLayout(t){if(!this.isResizing){try{this.isResizing=!0,this.doResize()}finally{this.isResizing=!1}super.refreshLayout(t)}}doResize(){if(this.vkbd){let t=this.getDefaultKeyboardHeight();this.setSize(this.getDefaultWidth(),t+this.banner.height)}}postKeyboardAdjustments(){this.doResize()}getDefaultKeyboardHeight(){var c,l;let t=this.targetDevice;if(this.configuration.heightOverride)return this.configuration.heightOverride();let n=(c=document==null?void 0:document.documentElement)==null?void 0:c.clientWidth,s=(l=document==null?void 0:document.documentElement)==null?void 0:l.clientHeight;if(typeof n=="undefined"&&(n=Math.min(screen.height,screen.width),s=Math.max(screen.height,screen.width),dt())){let a=n;n=s,s=a}var i=Math.floor(Math.min(s,n)/2),B=i;return t.formFactor=="phone"&&(dt()?B=Math.floor(s/1.6):B=Math.floor(s/2.4)),this.targetDevice.OS==S.OperatingSystem.iOS&&(B=B/St(this.targetDevice.formFactor)),B}getDefaultWidth(){var s;let t=this.targetDevice;if(this.configuration.widthOverride)return this.configuration.widthOverride();var n;return n=(s=document==null?void 0:document.documentElement)==null?void 0:s.clientWidth,typeof n=="undefined"&&(this.targetDevice.OS==S.OperatingSystem.iOS?n=window.innerWidth:t.OS==S.OperatingSystem.Android?n=screen.availWidth:n=screen.width),n}setRect(t){}getPos(){var t=this._Box,n={left:this._Visible?t.offsetLeft:this.x,top:this._Visible?t.offsetTop:this.y};return n}setPos(t){}setDisplayPositioning(){let t=this._Box.style;this.vkbd&&(t.position="fixed",t.left=t.bottom="0px",t.border="none",t.borderTop="1px solid gray")}present(){super.present(),this.legacyEvents.callEvent("show",{})}};r(Il,"AnchoredOSKView");var hn=Il;var hl=class hl extends zt{constructor(){super(...arguments);this.flag=!0}get enabled(){return this.flag}set enabled(t){this.activate=t}get activate(){return this.flag}set activate(t){this.flag!=t&&(this.flag=t,this.emit("activate",t))}get conditionsMet(){return!0}};r(hl,"SimpleActivator");var bn=hl;var bl=class bl extends It{constructor(t){t.activator=t.activator||new bn;super(t);this.restorePosition=function(t){}.bind(this)}get element(){return this._Box}_Unload(){this.keyboardView=null,this.bannerView=null,this._Box=null}setBoxStyling(){let t=this._Box.style;t.display="none",t.position="relative"}postKeyboardAdjustments(){}getDefaultKeyboardHeight(){return this.keyboardView instanceof yt?this.keyboardView.height:this.computedHeight}getDefaultWidth(){return this.computedWidth}setRect(t){}getPos(){var t=this._Box,n={left:this._Visible?t.offsetLeft:void 0,top:this._Visible?t.offsetTop:void 0};return n}setPos(t){}present(){super.present(),this.legacyEvents.callEvent("show",{})}setDisplayPositioning(){}allowsDeviceChange(t){return!0}};r(bl,"InlinedOSKView");var Cn=bl;var xl={};Vn(xl,{AnchoredOSKView:()=>bs,FloatingOSKView:()=>Cs,InlinedOSKView:()=>Cl});function ml(Q){return{hostDevice:Q.config.hostDevice,pathConfig:Q.config.paths,predictionContextManager:Q.contextManager.predictionContext,isEmbedded:!1}}r(ml,"buildBaseOskConfiguration");var Gl=class Gl extends hn{constructor(e,t){let n=h(h({},ml(e)),t||{});super(n)}};r(Gl,"PublishedAnchoredOSKView");var bs=Gl,pl=class pl extends Dt{constructor(e,t){let n=h(h({},ml(e)),t||{});super(n)}};r(pl,"PublishedFloatingOSKView");var Cs=pl,Xl=class Xl extends Cn{constructor(e,t){let n=h(h({},ml(e)),t||{});super(n)}};r(Xl,"PublishedInlineOSKView");var Cl=Xl;var Sl=class Sl extends Ce{constructor(){super(...arguments);this.events=new X.default;this.changed=!1}focus(){let t=this.getElement();t.focus&&t.focus()}isForcingScroll(){return!1}dispatchInputEventOn(t){let n;window.InputEvent&&(n=new InputEvent("input",{bubbles:!0,cancelable:!1})),t&&n&&t.dispatchEvent(n)}};r(Sl,"OutputTarget");var w=Sl;var Vl=class Vl extends w{constructor(t){super();this.root=t,this._cachedSelectionStart=-1}get isSynthetic(){return!1}static isSupportedType(t){return t=="email"||t=="search"||t=="text"||t=="url"}getElement(){return this.root}clearSelection(){this.getCaret(),this.root.value=this.root.value._kmwSubstring(0,this.processedSelectionStart)+this.root.value._kmwSubstring(this.processedSelectionEnd),this.setCaret(this.processedSelectionStart)}isSelectionEmpty(){return this.root.selectionStart==this.root.selectionEnd}hasSelection(){return!0}invalidateSelection(){this._cachedSelectionStart=-1}getCaret(){return this.root.selectionStart!=this._cachedSelectionStart&&(this._cachedSelectionStart=this.root.selectionStart,this.processedSelectionStart=this.root.value._kmwCodeUnitToCodePoint(this.root.selectionStart),this.processedSelectionEnd=this.root.value._kmwCodeUnitToCodePoint(this.root.selectionEnd)),this.root.selectionDirection=="forward"?this.processedSelectionEnd:this.processedSelectionStart}getDeadkeyCaret(){return this.getCaret()}setCaret(t){this.setSelection(t,t,"none")}setSelection(t,n,s){let i=this.root.value._kmwCodePointToCodeUnit(t),B=this.root.value._kmwCodePointToCodeUnit(n);this.root.setSelectionRange(i,B,s),this.processedSelectionStart=t,this.processedSelectionEnd=n,this.forceScroll(),this.root.setSelectionRange(i,B,s)}forceScroll(){let t=this.getElement(),n=t.selectionStart,s=t.selectionEnd;this._activeForcedScroll=!0;try{t.blur(),t.focus()}finally{t.selectionStart=n,t.selectionEnd=s,this._activeForcedScroll=!1}}isForcingScroll(){return this._activeForcedScroll}getSelectionDirection(){return this.root.selectionDirection}getTextBeforeCaret(){return this.getCaret(),this.getText()._kmwSubstring(0,this.processedSelectionStart)}getSelectedText(){return this.getCaret(),this.getText()._kmwSubstring(this.processedSelectionStart,this.processedSelectionEnd)}setTextBeforeCaret(t){this.getCaret();let n=this.processedSelectionEnd-this.processedSelectionStart,s=this.getSelectionDirection(),i=t._kmwLength();this.root.value=t+this.getText()._kmwSubstring(this.processedSelectionStart),this.setSelection(i,i+n,s)}setTextAfterCaret(t){let n=this.getSelectionDirection();this.root.value=this.getTextBeforeCaret()+t,this.setSelection(this.processedSelectionStart,this.processedSelectionEnd,n)}getTextAfterCaret(){return this.getCaret(),this.getText()._kmwSubstring(this.processedSelectionEnd)}getText(){return this.root.value}deleteCharsBeforeCaret(t){if(t>0){let n=this.getTextBeforeCaret(),s=this.processedSelectionStart;t>s&&(t=s),this.adjustDeadkeys(-t),this.setTextBeforeCaret(n.kmwSubstring(0,s-t)),this.setCaret(s-t)}}insertTextBeforeCaret(t){if(!t)return;let n=this.getCaret(),s=this.getTextBeforeCaret(),i=this.getText()._kmwSubstring(this.processedSelectionStart);this.adjustDeadkeys(t._kmwLength()),this.root.value=s+t+i,this.setCaret(n+t._kmwLength())}handleNewlineAtCaret(){let t=this.root;t&&(t.type=="search"||t.type=="submit")?(t.disabled=!1,t.form.submit()):this.events.emit("unhandlednewline",t)}doInputEvent(){this.dispatchInputEventOn(this.root)}};r(Vl,"Input");var Kt=Vl;var Ll=class Ll extends w{constructor(t){super();this.root=t,this._cachedSelectionStart=-1}get isSynthetic(){return!1}getElement(){return this.root}clearSelection(){this.getCaret(),this.root.value=this.root.value._kmwSubstring(0,this.processedSelectionStart)+this.root.value._kmwSubstring(this.processedSelectionEnd),this.setCaret(this.processedSelectionStart)}isSelectionEmpty(){return this.root.selectionStart==this.root.selectionEnd}hasSelection(){return!0}invalidateSelection(){this._cachedSelectionStart=-1}getCaret(){return this.root.selectionStart!=this._cachedSelectionStart&&(this._cachedSelectionStart=this.root.selectionStart,this.processedSelectionStart=this.root.value._kmwCodeUnitToCodePoint(this.root.selectionStart),this.processedSelectionEnd=this.root.value._kmwCodeUnitToCodePoint(this.root.selectionEnd)),this.root.selectionDirection=="forward"?this.processedSelectionEnd:this.processedSelectionStart}getDeadkeyCaret(){return this.getCaret()}setCaret(t){this.setSelection(t,t,"none")}setSelection(t,n,s){let i=this.root.value._kmwCodePointToCodeUnit(t),B=this.root.value._kmwCodePointToCodeUnit(n);this.root.setSelectionRange(i,B,s),this.processedSelectionStart=t,this.processedSelectionEnd=n,this.forceScroll(),this.root.setSelectionRange(i,B,s)}forceScroll(){let t=this.getElement(),n=t.selectionStart,s=t.selectionEnd;this._activeForcedScroll=!0;try{t.blur(),t.focus()}finally{t.selectionStart=n,t.selectionEnd=s,this._activeForcedScroll=!1}}isForcingScroll(){return this._activeForcedScroll}getSelectionDirection(){return this.root.selectionDirection}getTextBeforeCaret(){return this.getCaret(),this.getText()._kmwSubstring(0,this.processedSelectionStart)}setTextBeforeCaret(t){this.getCaret();let n=this.processedSelectionEnd-this.processedSelectionStart,s=this.getSelectionDirection(),i=t._kmwLength();this.root.value=t+this.getText()._kmwSubstring(this.processedSelectionStart),this.setSelection(i,i+n,s)}setTextAfterCaret(t){let n=this.getSelectionDirection();this.root.value=this.getTextBeforeCaret()+t,this.setSelection(this.processedSelectionStart,this.processedSelectionEnd,n)}getTextAfterCaret(){return this.getCaret(),this.getText()._kmwSubstring(this.processedSelectionEnd)}getSelectedText(){return this.getCaret(),this.getText()._kmwSubstring(this.processedSelectionStart,this.processedSelectionEnd)}getText(){return this.root.value}deleteCharsBeforeCaret(t){if(t>0){let n=this.getTextBeforeCaret(),s=this.processedSelectionStart;t>s&&(t=s),this.adjustDeadkeys(-t),this.setTextBeforeCaret(n.kmwSubstring(0,s-t)),this.setCaret(s-t)}}insertTextBeforeCaret(t){if(!t)return;let n=this.getCaret(),s=this.getTextBeforeCaret(),i=this.getText()._kmwSubstring(this.processedSelectionStart);this.adjustDeadkeys(t._kmwLength()),this.root.value=s+t+i,this.setCaret(n+t._kmwLength())}handleNewlineAtCaret(){this.insertTextBeforeCaret(`
`)}doInputEvent(){this.dispatchInputEventOn(this.root)}};r(Ll,"TextArea");var mn=Ll;var El=class El{constructor(e,t){this.node=e,this.offset=t}};r(El,"SelectionCaret");var ms=El,Zl=class Zl{constructor(e,t){this.start=e,this.end=t}};r(Zl,"SelectionRange");var xs=Zl,Jl=class Jl{constructor(e,t){this.cmd=e,this.stateType=t}};r(Jl,"StyleCommand");var Ft=Jl,Rl=class Rl extends w{constructor(t){super();if(this.root=t,t.contentWindow&&t.contentWindow.document&&t.contentWindow.document.designMode=="on")this.doc=t.contentWindow.document,this.docRoot=t.contentWindow.document.documentElement;else throw"Specified IFrame is not in design-mode!"}get isSynthetic(){return!1}getElement(){return this.root}focus(){this.doc.defaultView.focus()}isSelectionEmpty(){return this.hasSelection()?this.doc.getSelection().isCollapsed:!0}hasSelection(){let t=this.doc.getSelection(),n=document.getSelection();return n.anchorNode==t.anchorNode&&n.focusNode==t.focusNode,!0}clearSelection(){if(this.hasSelection()){let t=this.doc.getSelection();t.isCollapsed||t.deleteFromDocument()}else console.warn("Attempted to clear an unowned Selection!")}invalidateSelection(){}getCarets(){let t=this.doc.getSelection(),n=t.anchorNode.compareDocumentPosition(t.focusNode);if(t.isCollapsed){let s=new ms(t.anchorNode,t.anchorOffset);return new xs(s,s)}else{let s=new ms(t.anchorNode,t.anchorOffset),i=new ms(t.focusNode,t.focusOffset);return s.node==i.node&&(n=i.offset-s.offset>0?2:4),n&2?new xs(s,i):new xs(i,s)}}getDeadkeyCaret(){return this.getTextBeforeCaret().kmwLength()}getTextBeforeCaret(){if(!this.hasSelection())return this.getText();let t=this.getCarets().start;return t.node.nodeType!=3?"":t.node.textContent.substr(0,t.offset)}getSelectedText(){return""}getTextAfterCaret(){if(!this.hasSelection())return"";let t=this.getCarets().end;return t.node.nodeType!=3?"":t.node.textContent.substr(t.offset)}getText(){return this.docRoot.innerText}deleteCharsBeforeCaret(t){if(!this.hasSelection()||t<=0)return;let n=this.getCarets().start;if(t>n.offset&&(t=n.offset),n.node.nodeType!=3){console.warn("Deletion of characters requested without available context!");return}let s=this.doc.createRange(),i=n.offset-n.node.nodeValue.substr(0,n.offset)._kmwSubstr(-t).length;s.setStart(n.node,i),s.setEnd(n.node,n.offset),this.adjustDeadkeys(-t),s.deleteContents()}insertTextBeforeCaret(t){if(!this.hasSelection())return;let n=this.getCarets().start,s=t._kmwLength(),i=this.doc.getSelection();if(s==0)return;this.adjustDeadkeys(s);let B=this.root.ownerDocument.createRange();if(n.node.nodeType==3){let l=n.node;l.insertData(n.offset,t),B.setStart(l,n.offset+t.length)}else{var c=this.doc.createTextNode(t);let l=this.doc.createRange();l.setStart(n.node,n.offset),l.collapse(!0),l.insertNode(c),B.setStart(c,t.length)}B.collapse(!0),i.removeAllRanges();try{i.addRange(B)}catch(l){n.node.parentElement.scrollIntoView(),i.addRange(B)}i.collapseToEnd()}handleNewlineAtCaret(){}setTextAfterCaret(t){if(!this.hasSelection())return;let n=this.getCarets().end;if(t._kmwLength()!=0)if(n.node.nodeType==3){let B=n.node;B.replaceData(n.offset,B.length,t)}else{var i=n.node.ownerDocument.createTextNode(t);let B=this.root.ownerDocument.createRange();B.setStart(n.node,n.offset),B.collapse(!0),B.insertNode(i)}}saveProperties(){var t=[new Ft("backcolor",1),new Ft("fontname",1),new Ft("fontsize",1),new Ft("forecolor",1),new Ft("bold",0),new Ft("italic",0),new Ft("strikethrough",0),new Ft("subscript",0),new Ft("superscript",0),new Ft("underline",0)];this.doc.defaultView&&t.push(new Ft("hilitecolor",1));for(var n=0;n<t.length;n++){let s=t[n];s.stateType==1?s.cache=this.doc.queryCommandValue(s.cmd):s.cache=this.doc.queryCommandState(s.cmd)}this.commandCache=t}restoreProperties(t){this.commandCache||console.error("No command cache exists to restore!");for(var n=0;n<this.commandCache.length;n++){let s=this.commandCache[n];s.stateType==1?this.doc.queryCommandValue(s.cmd)!=s.cache&&(t&&t(),this.doc.execCommand(s.cmd,!1,s.cache)):this.doc.queryCommandState(s.cmd)!=s.cache&&(t&&t(),this.doc.execCommand(s.cmd,!1,null))}}doInputEvent(){this.dispatchInputEventOn(this.root)}};r(Rl,"DesignIFrame");var z=Rl;var Al=class Al{constructor(e,t){this.node=e,this.offset=t}};r(Al,"SelectionCaret");var Gs=Al,Hl=class Hl{constructor(e,t){this.start=e,this.end=t}};r(Hl,"SelectionRange");var ps=Hl,Wl=class Wl extends w{constructor(t){var e=(...args)=>{super(...args)};if(t.isContentEditable)e(),this.root=t;else throw"Specified element is not already content-editable!"}get isSynthetic(){return!1}getElement(){return this.root}isSelectionEmpty(){return this.hasSelection()?this.root.ownerDocument.getSelection().isCollapsed:!0}hasSelection(){let t=this.root.ownerDocument.getSelection();return!(this.root!=t.anchorNode&&!this.root.contains(t.anchorNode)||this.root!=t.focusNode&&!this.root.contains(t.focusNode))}clearSelection(){if(this.hasSelection()){let t=this.root.ownerDocument.getSelection();t.isCollapsed||t.deleteFromDocument()}else console.warn("Attempted to clear an unowned Selection!")}invalidateSelection(){}getCarets(){let t=this.root.ownerDocument.getSelection(),n=t.anchorNode.compareDocumentPosition(t.focusNode);if(t.isCollapsed){let s=new Gs(t.anchorNode,t.anchorOffset);return new ps(s,s)}else{let s=new Gs(t.anchorNode,t.anchorOffset),i=new Gs(t.focusNode,t.focusOffset);return s.node==i.node&&(n=i.offset-s.offset>0?2:4),n&2?new ps(s,i):new ps(i,s)}}getDeadkeyCaret(){return this.getTextBeforeCaret().kmwLength()}getTextBeforeCaret(){if(!this.hasSelection())return this.getText();let t=this.getCarets().start;return t.node.nodeType!=3?"":t.node.textContent.substr(0,t.offset)}getSelectedText(){return""}getTextAfterCaret(){if(!this.hasSelection())return"";let t=this.getCarets().end;return t.node.nodeType!=3?"":t.node.textContent.substr(t.offset)}getText(){return this.root.innerText}deleteCharsBeforeCaret(t){if(!this.hasSelection()||t<=0)return;let n=this.getCarets().start;if(t>n.offset&&(t=n.offset),n.node.nodeType!=3){console.warn("Deletion of characters requested without available context!");return}let s=this.root.ownerDocument.createRange(),i=n.offset-n.node.nodeValue.substr(0,n.offset)._kmwSubstr(-t).length;s.setStart(n.node,i),s.setEnd(n.node,n.offset),this.adjustDeadkeys(-t),s.deleteContents()}insertTextBeforeCaret(t){if(!this.hasSelection())return;let n=this.getCarets().start,s=t._kmwLength(),i=this.root.ownerDocument.getSelection();if(s==0)return;this.adjustDeadkeys(s);let B=this.root.ownerDocument.createRange();if(n.node.nodeType==3){let l=n.node;l.insertData(n.offset,t),B.setStart(l,n.offset+t.length)}else{var c=n.node.ownerDocument.createTextNode(t);let l=this.root.ownerDocument.createRange();l.setStart(n.node,n.offset),l.collapse(!0),l.insertNode(c),B.setStart(c,t.length)}B.collapse(!0),i.removeAllRanges();try{i.addRange(B)}catch(l){n.node.parentElement.scrollIntoView(),i.addRange(B)}i.collapseToEnd()}handleNewlineAtCaret(){}setTextAfterCaret(t){if(!this.hasSelection())return;let n=this.getCarets().end;if(t._kmwLength()!=0)if(n.node.nodeType==3){let B=n.node;B.replaceData(n.offset,B.length,t)}else{var i=n.node.ownerDocument.createTextNode(t);let B=this.root.ownerDocument.createRange();B.setStart(n.node,n.offset),B.collapse(!0),B.insertNode(i)}}doInputEvent(){this.dispatchInputEventOn(this.root)}};r(Wl,"ContentEditable");var Je=Wl;function D(Q,e){var t;return Q?Q.Window?e=="Window":(Q.defaultView?t=Q.defaultView[e]:Q.ownerDocument&&(t=Q.ownerDocument.defaultView[e]),t?Q instanceof t:!1):!1}r(D,"nestedInstanceOf");function Hi(Q){if(D(Q,"HTMLInputElement"))return new Kt(Q);if(D(Q,"HTMLTextAreaElement"))return new mn(Q);if(D(Q,"HTMLIFrameElement")){let e=Q;return e.contentWindow&&e.contentWindow.document&&e.contentWindow.document.designMode=="on"?new z(e):Q.isContentEditable?new Je(Q):null}else if(Q.isContentEditable)return new Je(Q);return null}r(Hi,"wrapElement");var vl=class vl{constructor(){this.pending=!1;let e=this.bg=document.createElement("div"),t=document.createElement("div"),n=this.lt=document.createElement("div"),s=this.gr=document.createElement("div"),i=this.bx=document.createElement("div");e.className="kmw-wait-background",t.className="kmw-wait-box",this.dismiss=null,n.className="kmw-wait-text",s.className="kmw-wait-graphic",i.className="kmw-alert-close";let B=t.onmousedown=t.onclick=l=>{i.style.display=="block"&&(e.style.display="none",this.dismiss&&this.dismiss())};t.addEventListener("touchstart",B,!1);let c=e.onmousedown=e.onclick=l=>{l.preventDefault(),l.stopPropagation()};e.addEventListener("touchstart",c,!1),t.appendChild(i),t.appendChild(n),t.appendChild(s),e.appendChild(t),document.body.appendChild(e)}get rootElement(){return this.bg}wait(e){let t=this.bg;typeof t=="undefined"||t==null||(e?(this.pending=!0,window.setTimeout(()=>{this.pending&&(window.scrollTo(0,0),this.bx.style.display="none",this.lt.className="kmw-wait-text",this.lt.innerHTML=e,this.gr.style.display="block",t.style.display="block")},1e3)):this.pending&&(this.lt.innerHTML="",this.pending=!1,t.style.display="none"))}alert(e,t){let n=this.bg;this.bx.style.display="block",this.lt.className="kmw-alert-text",this.lt.innerHTML=e,this.gr.style.display="none",n.style.display="block",this.dismiss=arguments.length>1?t:null}shutdown(){this.bg.parentNode.removeChild(this.bg)}};r(vl,"AlertHost");var Ue=vl;function Xs(){return document.readyState==="complete"?Promise.resolve():new Promise((Q,e)=>{let t=r(()=>{window.removeEventListener("load",t),Q()},"loadHandler");window.addEventListener("load",t)})}r(Xs,"whenDocumentReady");var fl=class fl extends Nn{initialize(t){this._options?this._options=h(h({},this._options),t):this._options=h({},t),super.initialize(t),this._options=t,this._ui=t.ui,this._attachType=t.attachType,Xs().then(()=>{var n;t.useAlerts&&!this.alertHost?this._alertHost=new Ue:!t.useAlerts&&this.alertHost&&((n=this._alertHost)==null||n.shutdown(),this._alertHost=null)})}get options(){return this._options}get attachType(){return this._attachType}get alertHost(){return this._alertHost}set signalUser(t){(!t||t!=this.alertHost)&&this.alertHost.shutdown(),this._alertHost=t}debugReport(){let t=super.debugReport();return t.attachType=this.attachType,t.ui=this._ui,t.keymanEngine="app/browser",t}onRuleFinalization(t,n){let s=t.transcription.transform;me(s)||n instanceof w&&(n.changed=!0)}};r(fl,"BrowserConfiguration");var Wi=fl,jr=h({ui:"",attachType:"",useAlerts:!0},AB);var Tl=class Tl{constructor(e,t,n){this.interface=e,this.keyboard=t}};r(Tl,"AttachmentInfo");var Ss=Tl;function Pt(Q){let e=Q==null?void 0:Q.target;return Vt(e)}r(Pt,"eventOutputTarget");function Vt(Q){var e;if(Q==null)return null;if(Q.body&&(Q=Q.body),Q.nodeType==3&&(Q=Q.parentNode),D(Q,"HTMLInputElement")){let t=Q.type.toLowerCase();if(!(t=="text"||t=="search"))return null}return(e=Q._kmwAttachment)==null?void 0:e.interface}r(Vt,"outputTargetForElement");var vi=class vi extends X.default{constructor(t,n){if(!t)throw new Error("Cannot attach to a null/undefined document");super();this.baseFont="";this.appliedFont="";this.embeddedPageContexts=[];this._inputList=[];this._sortedInputs=[];this._InputModeObserverCore=r(t=>{this.disableInputModeObserver();try{for(let n of t){let s=n.target;this.isAttached(s)&&(s._kmwAttachment.inputMode=s.inputMode,this.device.touchable&&(s.inputMode="none"))}}finally{this.enableInputModeObserver()}},"_InputModeObserverCore");this._EnablementMutationObserverCore=r(t=>{for(var n=0;n<t.length;n++){var s=t[n],i=s.oldValue?s.oldValue.indexOf("kmw-disabled")>=0:!1,B=s.target.className.indexOf("kmw-disabled")>=0;if(i&&!B?this._EnableControl(s.target):!i&&B&&this._DisableControl(s.target),!B&&s.attributeName=="readonly"){var c=s.oldValue?s.oldValue!=null:!1,l=s.target;if(l instanceof l.ownerDocument.defaultView.HTMLInputElement||l instanceof l.ownerDocument.defaultView.HTMLTextAreaElement){var a=l.readOnly;c&&!a?this._EnableControl(s.target):!c&&a&&this._DisableControl(s.target)}}}},"_EnablementMutationObserverCore");this._AutoAttachObserverCore=r(t=>{for(var n=[],s=[],i=0;i<t.length;i++){let l=t[i];for(var B=0;B<l.addedNodes.length;B++)n=n.concat(this._GetDocumentEditables(l.addedNodes[B]));for(B=0;B<l.removedNodes.length;B++)s=s.concat(this._GetDocumentEditables(l.removedNodes[B]))}for(var c=0;c<n.length;c++)this.isKMWInput(n[c])&&this._MutationAdditionObserved(n[c]);for(c=0;c<s.length;c++){let l=!1,a=s[c];if(a instanceof a.ownerDocument.defaultView.HTMLIFrameElement){for(let F=0;F<this.embeddedPageContexts.length;F++)if(this.embeddedPageContexts[F].options.owner==a){this.embeddedPageContexts[F].shutdown(),this.embeddedPageContexts.splice(F,1),l=!0;break}if(!l){for(let F=0;F<this._inputList.length;F++)if(this._inputList[F]==a){this.detachFromControl(a),this._inputList[F]==a&&this._inputList.splice(F,1);break}}}else this.isKMWInput(a)&&this._MutationRemovalObserved(a)}(n.length||s.length)&&(this.device.touchable?this.device.touchable&&window.setTimeout(()=>{this.listInputs()},1):this.listInputs())},"_AutoAttachObserverCore");this._MutationAdditionObserved=r(t=>{if(t instanceof t.ownerDocument.defaultView.HTMLIFrameElement){let n=r(()=>{window.setTimeout(()=>{this.attachToControl(t)},1)},"attachFunctor");t.addEventListener("load",n)}else this.attachToControl(t)},"_MutationAdditionObserved");this._MutationRemovalObserved=r(t=>{this.detachFromControl(t)},"_MutationRemovalObserved");this.options=n,this.document=t,this.stylesheetManager=new rt(this.document.body)}get device(){return this.options.hostDevice}get window(){return this.document.defaultView}get inputList(){let t=this.embeddedPageContexts.map(n=>n.inputList).reduce((n,s)=>n.concat(s),[]);return[].concat(this._inputList).concat(t)}get sortedInputs(){return this._sortedInputs}install(t){this.manualAttach=t,this.baseFont=this.getBaseFont(),this.manualAttach||(this._SetupDocument(this.document.documentElement),this.listInputs()),this.options.owner||this.initMutationObservers(this.document,t)}setupElementAttachment(t){if(!t._kmwAttachment){let n=Hi(t);n||D(t,"HTMLIFrameElement")||console.warn("Could not create processing interface for newly-attached element!"),t._kmwAttachment=new Ss(n,null,this.device.touchable)}}clearElementAttachment(t){t._kmwAttachment=null}isKMWInput(t){if(t instanceof t.ownerDocument.defaultView.HTMLTextAreaElement)return!0;if(t instanceof t.ownerDocument.defaultView.HTMLInputElement){if(Kt.isSupportedType(t.type))return!0}else if(t instanceof t.ownerDocument.defaultView.HTMLIFrameElement)try{if(t.contentWindow){let n=t.contentWindow.document;if(n)return!(this.device.touchable&&n.designMode.toLowerCase()=="on")}else return!!t._kmwAttachment}catch(n){console.warn("Error during attachment to / detachment from iframe: "),console.warn(n)}else if(t.isContentEditable)return!0;return!1}isAttached(t){if(t._kmwAttachment)return!0;if(D(t,"HTMLIFrameElement")){if(t.contentDocument==this.document)return!0;for(let s of this.embeddedPageContexts)if(s.isAttached(t))return!0}return!1}isKMWDisabled(t){let n=t.className;return t.readOnly?!0:!!(n&&n.indexOf("kmw-disabled")>=0)}enableInputElement(t){var n;this.isKMWDisabled(t)||(t instanceof t.ownerDocument.defaultView.HTMLIFrameElement?this._AttachToIframe(t):(this.setupElementAttachment(t),t._kmwAttachment.inputMode=(n=t.inputMode)!=null?n:"text",this.disableInputModeObserver(),t.inputMode="none",this.enableInputModeObserver(),t.classList.add("keymanweb-font"),this._inputList.push(t),this.emit("enabled",t)))}disableInputElement(t){var s;if(t)if(t.ownerDocument.defaultView&&t instanceof t.ownerDocument.defaultView.HTMLIFrameElement||t instanceof HTMLIFrameElement)this._DetachFromIframe(t);else{if(this.isAttached(t)){let B=(s=t._kmwAttachment)==null?void 0:s.inputMode;this.disableInputModeObserver(),t.inputMode=B,this.enableInputModeObserver()}t.className.indexOf("keymanweb-font")>=0&&(t.className=t.className.replace("keymanweb-font","").trim());var n=this.inputList.indexOf(t);n>-1&&this._inputList.splice(n,1),this.emit("disabled",t)}}enableTouchElement(t){return this.isKMWDisabled(t)?(this.emit("disabled",t),!1):(this.isAttached(t)||this.setupElementAttachment(t),this.enableInputElement(t),!0)}disableTouchElement(t){if(this.isAttached(t)){let n=t._kmwAttachment.inputMode;this.disableInputModeObserver(),t.inputMode=n,this.enableInputModeObserver()}}_AttachToIframe(t){try{let n=t.contentWindow.document;if(n){if(n.designMode.toLowerCase()=="on")this.setupElementAttachment(t),n.body._kmwAttachment=t._kmwAttachment,this._inputList.push(t),this.emit("enabled",t);else if(this.embeddedPageContexts.filter(s=>s.document==n).length==0){let s=new vi(n,V(h({},this.options),{owner:t}));this.embeddedPageContexts.push(s),s.on("enabled",i=>this.emit("enabled",i)),s.on("disabled",i=>this.emit("disabled",i)),s.install(this.manualAttach)}}}catch(n){}}_DetachFromIframe(t){let n=r(()=>{this.clearElementAttachment(t);let s=this._inputList.indexOf(t);s!=-1&&this._inputList.splice(s,1),this.emit("disabled",t)},"detachFromDesignIframe");try{let s=t.contentWindow.document;if(s){if(s.designMode.toLowerCase()=="on")s.body._kmwAttachment=null,n();else for(let i=0;i<this.embeddedPageContexts.length;i++)if(this.embeddedPageContexts[i].document==s){let B=this.embeddedPageContexts.splice(i,1)[0];B._ClearDocument(s.body),B.shutdown(),this.embeddedPageContexts.splice(i,1);break}}}catch(s){t._kmwAttachment&&n()}}attachToControl(t){var n=this.device.touchable;this.isAttached(t)&&!(t instanceof t.ownerDocument.defaultView.HTMLIFrameElement)||(this.isKMWInput(t)?this.isKMWDisabled(t)?this.emit("disabled",t):n?this.enableTouchElement(t):this.enableInputElement(t):n&&this.emit("disabled",t))}detachFromControl(t){(this.isAttached(t)||t instanceof t.ownerDocument.defaultView.HTMLIFrameElement)&&(this.isKMWInput(t)&&(this.isKMWDisabled(t)||this._DisableControl(t)),this.clearElementAttachment(t))}_DisableControl(t){(this.isAttached(t)||t instanceof t.ownerDocument.defaultView.HTMLIFrameElement)&&(this.device.touchable&&this.disableTouchElement(t),this.listInputs(),this.disableInputElement(t))}_EnableControl(t){this.isAttached(t)?(this.device.touchable?this.enableTouchElement(t):this.enableInputElement(t),this.listInputs()):D(t,"HTMLIFrameElement")&&this._AttachToIframe(t)}disableControl(t){this.isAttached(t)||console.warn("KeymanWeb is not attached to element "+t);var n=t.className;n.indexOf("kmw-disabled")<0&&(t.className=n?n+" kmw-disabled":"kmw-disabled")}enableControl(t){!this.isAttached(t)&&!D(t,"HTMLIFrameElement")&&console.warn("KeymanWeb is not attached to element "+t);var n=t.className,s=n.indexOf("kmw-disabled");s>=0&&(t.className=n.replace("kmw-disabled","").trim())}listInputs(){let t=[],n=document.getElementsByTagName("input"),s=document.getElementsByTagName("textarea");for(let B=0;B<n.length;B++)Kt.isSupportedType(n[B].type)&&n[B].className.indexOf("kmw-disabled")<0&&t.push({ip:n[B],x:M(n[B]),y:Y(n[B])});for(let B=0;B<s.length;B++)s[B].className.indexOf("kmw-disabled")<0&&t.push({ip:s[B],x:M(s[B]),y:Y(s[B])});t.sort((B,c)=>B.y!=c.y?B.y-c.y:B.x-c.x);let i=[];for(let B=0;B<t.length;B++)i.push(t[B].ip);this._sortedInputs=i}findNeighboringInput(t,n){var s,i=this.sortedInputs;if(i.length==0)return null;for(s=0;s<i.length&&i[s]!=t;s++);return s==i.length&&!n&&s--,s=n?s-1:s+1,s=s>=i.length?s-i.length:s,s=s<0?s+i.length:s,i[s]}_GetDocumentEditables(t){let n=[];if(t.ownerDocument&&t instanceof t.ownerDocument.defaultView.HTMLElement){let i=t.ownerDocument.defaultView;(t instanceof i.HTMLInputElement||t instanceof i.HTMLTextAreaElement||t instanceof i.HTMLIFrameElement)&&n.push(t)}if(t.getElementsByTagName){var s=r(function(i){return ti(t.getElementsByTagName(i))},"LiTmp");n=n.concat(s("INPUT"),s("TEXTAREA"),s("IFRAME"))}return t.querySelectorAll&&(n=n.concat(ti(t.querySelectorAll("[contenteditable]")))),t.ownerDocument&&t instanceof t.ownerDocument.defaultView.HTMLElement&&t.isContentEditable&&n.push(t),n}_SetupDocument(t){let n=this._GetDocumentEditables(t);for(var s=0;s<n.length;s++)this.attachToControl(n[s])}_ClearDocument(t){let n=this._GetDocumentEditables(t);for(var s=0;s<n.length;s++)this.detachFromControl(n[s])}initMutationObservers(t,n){if(typeof MutationObserver=="function"){var s=t.querySelector("body"),i;n||(i={childList:!0,subtree:!0},this.attachmentObserver=new MutationObserver(this._AutoAttachObserverCore),this.attachmentObserver.observe(s,i)),i={subtree:!0,attributes:!0,attributeOldValue:!0,attributeFilter:["class","readonly"]},this.enablementObserver=new MutationObserver(this._EnablementMutationObserverCore),this.enablementObserver.observe(s,i),this.inputModeObserver=new MutationObserver(this._InputModeObserverCore),this.enableInputModeObserver()}else console.warn("Your browser is outdated and does not support MutationObservers, a web feature needed by KeymanWeb to support dynamically-added elements.")}enableInputModeObserver(){var s;let t=document.querySelector("body"),n={subtree:!0,attributes:!0,attributeFilter:["inputmode"]};(s=this.inputModeObserver)==null||s.observe(t,n)}disableInputModeObserver(){var t;(t=this.inputModeObserver)==null||t.disconnect()}getBaseFont(){var t=document.getElementsByTagName("input"),n=document.getElementsByTagName("textarea"),s=0,i,B="Arial,sans-serif";if(t.length==0&&n.length==0)s=0;else if(t.length>0&&n.length==0)s=1;else if(t.length==0&&n.length>0)s=2;else{var c=t[0],l=n[0];c.offsetTop<l.offsetTop?s=1:c.offsetTop>l.offsetTop?s=2:c.offsetLeft<l.offsetLeft?s=1:c.offsetLeft>l.offsetLeft&&(s=2)}switch(s){case 0:i=B;break;case 1:i=getComputedStyle(t[0]).fontFamily||"";break;case 2:i=getComputedStyle(n[0]).fontFamily||"";break}return(typeof i=="undefined"||i=="monospace")&&(i=B),i}buildAttachmentFontStyle(t){let n=t,s=this.baseFont;n&&typeof n.family!="undefined"&&(s=n.family),s=s.replace(/\u0022/g,"");var i=new RegExp("\\s?"+s+",?"),B=this.appliedFont.replace(/\u0022/g,"");B=B.replace(i,""),B=B.replace(/,$/,""),B==""?B=s:B=s+","+B,B='"'+B.replace(/\,\s?/g,'","')+'"';let c=`.keymanweb-font{
font-family:`+B+` !important;
}
`;return this.appliedFont=B,c}setAttachmentFont(t,n,s){this.stylesheetManager.unlinkAll(),this.stylesheetManager.addStyleSheetForFont(t,n,s),this.stylesheetManager.linkStylesheet(ie(this.buildAttachmentFontStyle(t)))}shutdown(){var t,n,s,i;try{(t=this.enablementObserver)==null||t.disconnect(),(n=this.attachmentObserver)==null||n.disconnect(),(s=this.inputModeObserver)==null||s.disconnect(),(i=this.stylesheetManager)==null||i.unlinkAll(),this.inputModeObserver=null,this.embeddedPageContexts.forEach(B=>{try{B.shutdown()}catch(c){}});for(let B of this.inputList)try{this.detachFromControl(B)}catch(c){this.emit("disabled",B)}this._inputList=[]}catch(B){console.error("Error occurred during shutdown"),console.error(B)}}};r(vi,"PageContextAttachment");var Vs=vi;var Nl=class Nl{constructor(e,t){this.activationPending=e,this.activated=t}};r(Nl,"FocusStateAPIObject");var kl=Nl,Ml=class Ml extends X.default{constructor(t){super();this._maintainingFocus=!1;this.restoringFocus=!1;this._IgnoreNextSelChange=0;this.isTargetForcingScroll=t}get maintainingFocus(){return this._maintainingFocus}set maintainingFocus(t){let n=this._maintainingFocus;this._maintainingFocus=t,n&&!t&&this.emit("maintainingfocusend")}getUIState(){return new kl(this.maintainingFocus,this.restoringFocus)}setMaintainingFocus(t){this.maintainingFocus=!!t}setFocusTimer(){this.focusing=!0,this.focusTimer=window.setTimeout(()=>{this.focusing=!1},50)}};r(Ml,"FocusAssistant");var fi=Ml;function _r(Q,e){let t=e!=null&&e.isRTL?"rtl":"ltr";Q&&(Q instanceof Q.ownerDocument.defaultView.HTMLInputElement||Q instanceof Q.ownerDocument.defaultView.HTMLTextAreaElement?Q.value.length==0&&(Q.dir=t):typeof Q.textContent=="string"&&Q.textContent.length==0&&(Q.dir=t))}r(_r,"_SetTargDir");var Ti=class Ti extends Yn{constructor(t,n){super(t);this.cookieManager=new nt("KeymanWeb_Keyboard");this.focusAssistant=new fi(()=>{var t;return(t=this.activeTarget)==null?void 0:t.isForcingScroll()});this.domEventTracker=new Gt;this._ControlFocus=r(t=>{let n=Pt(t);return n&&this.setActiveTarget(n,!0),!0},"_ControlFocus");this._ControlBlur=r(t=>{if(this.focusAssistant._IgnoreNextSelChange)return this.focusAssistant._IgnoreNextSelChange--,t.cancelBubble=!0,t.stopPropagation(),!0;if(this.focusAssistant.isTargetForcingScroll())return t.cancelBubble=!0,t.stopPropagation(),!0;let n=Pt(t);if(n==null)return!0;this.lastActiveTarget&&this._BlurKeyboardSettings(this.lastActiveTarget.getElement());let s=this.activeTarget;this.currentTarget=null,(s||this.lastActiveTarget)&&(this.mostRecentTarget=n),this.focusAssistant.restoringFocus=!1;let i=this.activeKeyboard,B=this.focusAssistant.maintainingFocus;return!B&&i&&i.keyboard.notify(0,n,0),s&&!this.activeTarget&&this.emit("targetchange",null),this.apiEvents.callEvent("controlblurred",{target:n.getElement(),event:t,isActivating:B}),this.doChangeEvent(n),this.resetContext(),!0},"_ControlBlur");this._Click=r(t=>(this.resetContext(),!0),"_Click");this.nonKMWTouchHandler=r(t=>{this.focusAssistant.focusing=!1,clearTimeout(this.focusAssistant.focusTimer),this.forgetActiveTarget()},"nonKMWTouchHandler");this._eventsObj=n,this.page=new Vs(window.document,{hostDevice:this.engineConfig.hostDevice}),this.focusAssistant.on("maintainingfocusend",()=>{!this.activeTarget&&this.mostRecentTarget&&this.emit("targetchange",this.activeTarget)})}get apiEvents(){return this._eventsObj()}initialize(){this.on("keyboardasyncload",(t,n)=>{var s;(s=this.engineConfig.alertHost)==null||s.wait("Installing keyboard<br/>"+t.name),n.then(()=>{var i;(i=this.engineConfig.alertHost)==null||i.wait()})}),this.engineConfig.deferForInitialization.then(()=>{let t=this.engineConfig.hostDevice,n=r(s=>s.stopPropagation(),"noPropagation");this.page.on("enabled",s=>{if(!(s._kmwAttachment.interface instanceof z))t.touchable&&(this.domEventTracker.detachDOMEvent(s,"touchstart",this.nonKMWTouchHandler),this.domEventTracker.attachDOMEvent(s,"touchmove",n,!1),this.domEventTracker.attachDOMEvent(s,"touchend",n,!1)),this.domEventTracker.attachDOMEvent(s,"focus",this._ControlFocus),this.domEventTracker.attachDOMEvent(s,"blur",this._ControlBlur),this.domEventTracker.attachDOMEvent(s,"click",this._Click);else{var i=s.contentWindow.document;t.browser=="firefox"?(this.domEventTracker.attachDOMEvent(i,"focus",this._ControlFocus),this.domEventTracker.attachDOMEvent(i,"blur",this._ControlBlur)):(this.domEventTracker.attachDOMEvent(i.body,"focus",this._ControlFocus),this.domEventTracker.attachDOMEvent(i.body,"blur",this._ControlBlur))}s.ownerDocument.activeElement==s&&this.setActiveTarget(Vt(s),!0)}),this.page.on("disabled",s=>{var B;if(!D(s,"HTMLIFrameElement"))t.touchable&&this.domEventTracker.attachDOMEvent(s,"touchstart",this.nonKMWTouchHandler,!1),this.domEventTracker.detachDOMEvent(s,"focus",this._ControlFocus),this.domEventTracker.detachDOMEvent(s,"blur",this._ControlBlur),this.domEventTracker.detachDOMEvent(s,"click",this._Click);else{let c=s.contentWindow.document;t.browser=="firefox"?(this.domEventTracker.detachDOMEvent(c,"focus",this._ControlFocus),this.domEventTracker.detachDOMEvent(c,"blur",this._ControlBlur)):(this.domEventTracker.detachDOMEvent(c.body,"focus",this._ControlFocus),this.domEventTracker.detachDOMEvent(c.body,"blur",this._ControlBlur))}var i=(B=this.mostRecentTarget)==null?void 0:B.getElement();i&&i==s&&this.forgetActiveTarget()}),this.page.install(this.engineConfig.attachType=="manual")})}get activeTarget(){let t=this.focusAssistant.maintainingFocus;return this.currentTarget||(t?this.mostRecentTarget:null)}get lastActiveTarget(){return this.mostRecentTarget}deactivateCurrentTarget(){let t=this.activeTarget||this.lastActiveTarget;t&&this.page.isAttached(t.getElement())&&this._BlurKeyboardSettings(t.getElement()),this.activeTarget||this.setActiveTarget(null,!0)}forgetActiveTarget(){this.focusAssistant.maintainingFocus=!1,this.focusAssistant.restoringFocus=!1;let t=this.activeTarget||this.mostRecentTarget;t&&this._BlurKeyboardSettings(t.getElement()),this.setActiveTarget(null,!0),t==this.lastActiveTarget&&(this.mostRecentTarget=null)}setActiveTarget(t,n){var l;let s=this.mostRecentTarget,i=this.activeTarget;if(t==i){i&&(this.currentTarget=i);return}let B=!!s;if(this.currentTarget=this.mostRecentTarget=t,this.predictionContext.setCurrentTarget(t),this.focusAssistant.restoringFocus?this._BlurKeyboardSettings(t.getElement()):t&&this._FocusKeyboardSettings(t.getElement(),!B),this._CommonFocusHelper(t))return;let c=t==null?void 0:t.getElement();if(t instanceof z&&(c=t.docRoot),c&&c.ownerDocument&&c instanceof c.ownerDocument.defaultView.HTMLElement&&_r(c,(l=this.activeKeyboard)==null?void 0:l.keyboard),t!=i&&this.emit("targetchange",t),n){let a=s==null?void 0:s.getElement();s instanceof z&&(a=s.docRoot),c?this.apiEvents.callEvent("controlfocused",{target:c,activeControl:a}):a&&this.apiEvents.callEvent("controlblurred",{target:a,event:null,isActivating:this.focusAssistant.maintainingFocus})}}get activeKeyboard(){return this._activeKeyboard}restoreLastActiveTarget(){this.mostRecentTarget&&(this.focusAssistant.restoringFocus=!0,this.mostRecentTarget.focus(),this.focusAssistant.restoringFocus=!1)}insertText(t,n,s){this.restoreLastActiveTarget();let i=this.activeTarget;return i==null&&this.mostRecentTarget&&(i=this.activeTarget),i!=null?super.insertText(t,n,s):!1}currentKeyboardSrcTarget(){let t=this.currentTarget||this.mostRecentTarget;return this.isTargetKeyboardIndependent(t)?t:null}isTargetKeyboardIndependent(t){let n=t==null?void 0:t.getElement()._kmwAttachment;return!!(n!=null&&n.keyboard||(n==null?void 0:n.keyboard)==="")}activateKeyboardForTarget(t,n){var i,B;let s=n==null?void 0:n.getElement()._kmwAttachment;if(s?(s.keyboard=(i=t==null?void 0:t.metadata.id)!=null?i:"",s.languageCode=(B=t==null?void 0:t.metadata.langId)!=null?B:""):this.globalKeyboard=t,this.currentKeyboardSrcTarget()==n){this._activeKeyboard=t;let c=t==null?void 0:t.metadata;this.page.setAttachmentFont(c==null?void 0:c.KFont,this.engineConfig.paths.fonts,this.engineConfig.hostDevice.OS)}}setKeyboardForTarget(t,n,s){if(t instanceof z){console.warn("'keymanweb.setKeyboardForControl' cannot set keyboard on iframes.");return}let i=t.getElement()._kmwAttachment,B=this.currentKeyboardSrcTarget()==t;if(i){if(i.keyboard=n||null,i.languageCode=s||null,B||this.currentKeyboardSrcTarget()==t){let c=this.globalKeyboard.metadata;this.activateKeyboard(i.keyboard||c.id,i.languageCode||c.langId,!0)}}else return}getKeyboardStubForTarget(t){if(this.isTargetKeyboardIndependent(t)){let n=t.getElement()._kmwAttachment;return this.keyboardCache.getStub(n.keyboard,n.languageCode)}else return this.globalKeyboard.metadata}getFallbackStubKey(){let t={id:"",langId:""};return this.engineConfig.hostDevice.touchable&&this.keyboardCache.defaultStub||t}activateKeyboard(t,n,s){return L(this,null,function*(){var B,c,l,a,F,o;s||(s=!1);let i=this.currentKeyboardSrcTarget();this.engineConfig.deferForInitialization.isFulfilled||(yield this.engineConfig.deferForInitialization.corePromise),t||(t=this.getFallbackStubKey().id,n=this.getFallbackStubKey().langId);try{let d=yield As(Ti.prototype,this,"activateKeyboard").call(this,t,n,s);return(B=this.engineConfig.alertHost)==null||B.wait(),s&&!i&&this.cookieManager.save({current:`${t}:${n}`}),i==this.currentKeyboardSrcTarget()&&(_r((c=this.currentTarget)==null?void 0:c.getElement(),this.keyboardCache.getKeyboard(t)),this.page.setAttachmentFont((a=(l=this.activeKeyboard)==null?void 0:l.metadata)==null?void 0:a.KFont,this.engineConfig.paths.fonts,this.engineConfig.hostDevice.OS),this.restoreLastActiveTarget()),d}catch(d){let U=r(()=>L(this,null,function*(){let g=this.getFallbackStubKey();g.id!=t&&(yield this.activateKeyboard(g.id,g.langId,!0).catch(()=>{}))}),"fallback");(F=this.engineConfig.alertHost)==null||F.wait();let u=(d==null?void 0:d.message)||"Sorry, the "+t+" keyboard for "+n+" is not currently available.";throw d instanceof he?console.error(d||u):console.warn(d||u),this.engineConfig.alertHost?(o=this.engineConfig.alertHost)==null||o.alert(u,U):yield U(),d}})}_BlurKeyboardSettings(t,n,s){var c;var i=this.activeKeyboard?this.activeKeyboard.keyboard.id:"",B=(c=this.activeKeyboard)==null?void 0:c.metadata.langId;n!==void 0&&s!==void 0&&(i=n,B=s),t&&t._kmwAttachment.keyboard!=null?(t._kmwAttachment.keyboard=i,t._kmwAttachment.languageCode=B):this.globalKeyboard=this.activeKeyboard}_FocusKeyboardSettings(t,n){var B;let s=t._kmwAttachment,i=this.globalKeyboard;s.keyboard!=null?this.activateKeyboard(s.keyboard,s.languageCode,!0):!n&&(i==null?void 0:i.metadata)!=((B=this._activeKeyboard)==null?void 0:B.metadata)&&this.activateKeyboard(i==null?void 0:i.metadata.id,i==null?void 0:i.metadata.langId,!0)}_CommonFocusHelper(t){var i;let n=this.focusAssistant,s=(i=this.activeKeyboard)==null?void 0:i.keyboard;return n.restoringFocus||(t==null||t.deadkeys().clear(),s==null||s.notify(0,t,1)),!n.restoringFocus&&this.mostRecentTarget!=t&&(n.maintainingFocus=!1),n.restoringFocus=!1,this.resetContext(),!1}doChangeEvent(t){if(t.changed){let n=new Event("change",{bubbles:!0,cancelable:!1});t.getElement().dispatchEvent(n)}t.changed=!1}getSavedKeyboardRaw(){var n=new nt("KeymanWeb_Keyboard").load(decodeURIComponent);return typeof n.current!="string"||n.current=="Keyboard_us:eng"?"Keyboard_us:en":n.current}getSavedKeyboard(){let t=this.getSavedKeyboardRaw(),n=this.keyboardCache.getStubList(),s;for(let i=0;i<n.length;i++)if(s=n[i].KI+":"+n[i].KLC,s==t)return s;for(let i=0;i<n.length;i++)if(s=n[i].KI+":"+n[i].KLC,s=="Keyboard_us:en")return s;return n.length>0?n[0].KI+":"+n[0].KLC:"Keyboard_us:en"}restoreSavedKeyboard(t){let s=t.split(":");s.length<2&&(s[1]="");let i=this.keyboardCache.getStub(s[0],s[1])||this.keyboardCache.defaultStub;return i?this.activateKeyboard(i.id,i.langId):null}shutdown(){this.page.shutdown(),this.domEventTracker.shutdown()}};r(Ti,"ContextManager");var Ls=Ti;var Yl=class Yl extends Lt{constructor(t){super();this.contextManager=t}isCommand(t){switch(this.codeForEvent(t)){case y.keyCodes.K_TAB:case y.keyCodes.K_TABBACK:case y.keyCodes.K_TABFWD:return!0;default:return super.isCommand(t)}}applyCommand(t,n){let s=this.codeForEvent(t),i=r(B=>{var F;let c=this.contextManager,l=(F=c.activeTarget)==null?void 0:F.getElement(),a=c.page.findNeighboringInput(l,B);a==null||a.focus()},"moveToNext");switch(s){case y.keyCodes.K_TAB:i((t.Lmodifiers&y.modifierCodes.SHIFT)!=0);break;case y.keyCodes.K_TABBACK:i(!0);break;case y.keyCodes.K_TABFWD:i(!1);break}super.applyCommand(t,n)}};r(Yl,"DefaultBrowserRules");var Es=Yl;function Ol(Q){return Q.keyCode?Q.keyCode:Q.which?Q.which:null}r(Ol,"_GetEventKeyCode");function ki(Q,e,t){if(Q.cancelBubble===!0)return null;let n=Ol(Q);if(n==null)return null;var s=e.modStateFlags,i=0,B=!1,c=!1;let l=y.keyCodes;switch(n){case l.K_CTRL:case l.K_LCTRL:case l.K_RCTRL:case l.K_CONTROL:case l.K_LCONTROL:case l.K_RCONTROL:B=!0;break;case l.K_LMENU:case l.K_RMENU:case l.K_ALT:case l.K_LALT:case l.K_RALT:c=!0;break}i|=Q.getModifierState("Shift")?16:0;let a=y.modifierCodes;Q.getModifierState("Control")&&(i|=Q.location!=0&&B?Q.location==1?a.LCTRL:a.RCTRL:s&3),Q.getModifierState("Alt")&&(i|=Q.location!=0&&c?Q.location==1?a.LALT:a.RALT:s&12);let F=0;F|=Q.getModifierState("CapsLock")?a.CAPS:a.NO_CAPS,F|=Q.getModifierState("NumLock")?a.NUM_LOCK:a.NO_NUM_LOCK,F|=Q.getModifierState("ScrollLock")?a.SCROLL_LOCK:a.NO_SCROLL_LOCK,i|=F;let o=e.modStateFlags!=i;e.modStateFlags=i;let d=a.RALT|a.LCTRL;(s&d)==d&&(i&d)!=d&&(i&=~d),i&a.RALT&&(i&=~a.LCTRL);let U=y.modifierBitmasks,u=e.activeKeyboard,g;u&&u.isChiral?(g=i&U.CHIRAL,u.emulatesAltGr&&(g&U.ALT_GR_SIM)==U.ALT_GR_SIM&&(g^=U.ALT_GR_SIM,g|=a.RALT)):g=i&16|(i&(a.LCTRL|a.RCTRL)?32:0)|(i&(a.LALT|a.RALT)?64:0),g|=Q.metaKey?a.META:0,t.browser==S.Browser.Firefox&&q.browserMap.FF["k"+n]&&(n=q.browserMap.FF["k"+n]);let I=new _({device:t,kName:"",Lcode:n,Lmodifiers:g,Lstates:F,LmodifierChange:o,isSynthetic:!1}),C=typeof Q.charCode!="undefined"&&Q.charCode!=null&&(Q.charCode==0||(g&111)!=0);I.LisVirtualKey=C||Q.type!="keypress",I=WB(I,u,e.baseLayout);let x=new _(I);return x.source=Q,x}r(ki,"preprocessKeyboardEvent");var wl=class wl extends De{constructor(t,n,s){super();this.domEventTracker=new Gt;this.swallowKeypress=!1;this._KeyDown=r(t=>{var B;let n=this.contextManager.activeKeyboard,s=Pt(t);if(!s||n==null)return!0;let i=s.getElement();return((B=i==null?void 0:i.getAttribute("class"))==null?void 0:B.indexOf("kmw-disabled"))>=0?!0:this.keyDown(t)},"_KeyDown");this._KeyPress=r(t=>{var s;return!Pt(t)||((s=this.contextManager.activeKeyboard)==null?void 0:s.keyboard)==null?!0:this.keyPress(t)},"_KeyPress");this._KeyUp=r(t=>{let n=Pt(t);var s=ki(t,this.processor,this.hardDevice);if(s==null||n==null)return!0;var i=n.getElement();if(s.Lcode==13){var B=!1;if(D(i,"HTMLTextAreaElement")&&(B=!0),!B)return i instanceof i.ownerDocument.defaultView.HTMLInputElement&&(i.form&&(i.type=="search"||i.type=="submit")?i.form.submit():this.contextManager.page.findNeighboringInput(i,!1).focus()),!0}return this.keyUp(t)},"_KeyUp");this.hardDevice=t,this.contextManager=s,this.processor=n;let i=s.page,B=this.domEventTracker;i.on("enabled",c=>{let l=Vt(c);if(!(l instanceof z))B.attachDOMEvent(c,"keypress",this._KeyPress),B.attachDOMEvent(c,"keydown",this._KeyDown),B.attachDOMEvent(c,"keyup",this._KeyUp);else{let a=l.getElement().contentDocument;B.attachDOMEvent(a.body,"keydown",this._KeyDown),B.attachDOMEvent(a.body,"keypress",this._KeyPress),B.attachDOMEvent(a.body,"keyup",this._KeyUp)}}),i.on("disabled",c=>{let l=Vt(c);if(!(l instanceof z))B.detachDOMEvent(c,"keypress",this._KeyPress),B.detachDOMEvent(c,"keydown",this._KeyDown),B.detachDOMEvent(c,"keyup",this._KeyUp);else{let a=l.getElement().contentDocument;B.detachDOMEvent(a.body,"keydown",this._KeyDown),B.detachDOMEvent(a.body,"keypress",this._KeyPress),B.detachDOMEvent(a.body,"keyup",this._KeyUp)}})}keyDown(t){this.swallowKeypress=!1;var n=ki(t,this.processor,this.hardDevice);if(n==null)return!0;let s={LeventMatched:!1};return this.emit("keyevent",n,(i,B)=>{s.LeventMatched=i&&!i.triggerKeyDefault,s.LeventMatched?(t&&t.preventDefault&&(t.preventDefault(),t.stopPropagation()),this.swallowKeypress=!!n.Lcode,n.Lcode==8&&(this.swallowKeypress=!1)):this.swallowKeypress=!1}),!s.LeventMatched}keyUp(t){var n=ki(t,this.processor,this.hardDevice);if(n==null)return!0;let s=Pt(t);return this.processor.doModifierPress(n,s,!1)}keyPress(t){var i;var n=ki(t,this.processor,this.hardDevice);if(n==null||n.LisVirtualKey)return!0;if(!((i=this.contextManager.activeKeyboard)!=null&&i.keyboard.isMnemonic))return!this.swallowKeypress||n.Lcode<32||this.hardDevice.browser==S.Browser.Safari&&n.Lcode>63232&&n.Lcode<63744;let s={};return this.swallowKeypress||this.emit("keyevent",n,(B,c)=>{s.preventDefaultKeystroke=!!B}),this.swallowKeypress||s.preventDefaultKeystroke?(this.swallowKeypress=!1,t&&t.preventDefault&&(t.preventDefault(),t.stopPropagation()),!1):(this.swallowKeypress=!1,!0)}shutdown(){this.domEventTracker.shutdown()}};r(wl,"HardwareEventKeyboard");var Zs=wl;var zl=class zl{constructor(){this.innerWidth=window.innerWidth,this.innerHeight=window.innerHeight}equals(e){return this.innerWidth==e.innerWidth&&this.innerHeight==e.innerHeight}};r(zl,"RotationState");var Ni=zl,de=class de{constructor(e){this.idlePermutationCounter=de.IDLE_PERMUTATION_CAP;this.keyman=e}resolve(){var n;var e=this.keyman.osk;(n=this.keyman.touchLanguageMenu)==null||n.hide(),this.keyman.touchLanguageMenu=null,e.setNeedsLayout(),this.oskVisible&&e.present(),this.isActive=!1,this.updateTimer&&(window.clearInterval(this.updateTimer),this.rotState=null);let t=this.keyman.contextManager.activeTarget;t&&window.setTimeout(()=>{this.keyman.ensureElementVisibility(t.getElement())},0)}initNewRotation(){this.oskVisible=this.keyman.osk.isVisible(),this.keyman.osk.hideNow(),this.isActive=!0}init(){var e=this.keyman.config.hostDevice.OS,t=this.keyman.util;e=="ios"?(t.attachDOMEvent(window,"orientationchange",()=>(this.iOSEventHandler(),!1)),t.attachDOMEvent(window,"resize",()=>(this.iOSEventHandler(),!1))):e=="android"&&("onmozorientationchange"in screen?t.attachDOMEvent(screen,"mozorientationchange",()=>(this.initNewRotation(),!1)):t.attachDOMEvent(window,"orientationchange",()=>(this.initNewRotation(),!1)),t.attachDOMEvent(window,"resize",()=>(this.resolve(),!1)))}iOSEventHandler(){this.isActive||(this.initNewRotation(),this.rotState=new Ni,this.updateTimer=window.setInterval(this.iOSEventUpdate.bind(this),de.UPDATE_INTERVAL)),this.idlePermutationCounter=0}iOSEventUpdate(){var e=new Ni;this.rotState.equals(e)?++this.idlePermutationCounter==de.IDLE_PERMUTATION_CAP&&this.resolve():(this.rotState=e,this.idlePermutationCounter=0)}};r(de,"RotationProcessor"),de.IDLE_PERMUTATION_CAP=15,de.UPDATE_INTERVAL=20;var Mi=de;var Dl=class Dl{constructor(e,t){this.domEventTracker=new Gt;this.suppressFocusCheck=r(e=>(this.focusAssistant.isTargetForcingScroll()&&(e.stopPropagation(),e.cancelBubble=!0),!0),"suppressFocusCheck");this.pageFocusHandler=r(()=>{var e;return!this.focusAssistant.maintainingFocus&&((e=this.engine.osk)!=null&&e.vkbd)&&(this.engine.contextManager.deactivateCurrentTarget(),this.engine.contextManager.resetContext()),!1},"pageFocusHandler");this.touchStartActivationHandler=r(e=>{var s,i;let t=this.engine.osk;if(!t)return!1;let n=this.engine.config.hostDevice;if(this.deactivateOnRelease=!0,this.touchY=e.touches[0].screenY,this.deactivateOnScroll=!1,n.OS=="android"&&n.browser=="chrome"){if(typeof t._Box=="undefined"||typeof t._Box.style=="undefined")return!1;let B=e.target.parentElement;if(typeof B!="undefined"&&B!=null&&(((s=B.getAttribute("class"))==null?void 0:s.indexOf("kmw-key-"))>=0||typeof B.parentElement!="undefined"&&B.parentElement!=null&&(B=B.parentElement,((i=B.getAttribute("class"))==null?void 0:i.indexOf("kmw-key-"))>=0)))return!1;this.deactivateOnScroll=!0}return!1},"touchStartActivationHandler");this.touchMoveActivationHandler=r(e=>{this.deactivateOnScroll&&(this.focusAssistant.focusing=!1,this.engine.contextManager.deactivateCurrentTarget());let t=e.touches[0].screenY,n=this.touchY;return(t-n>5||n-t<5)&&(this.deactivateOnRelease=!1),!1},"touchMoveActivationHandler");this.touchEndActivationHandler=r(e=>(this.deactivateOnRelease&&!this.engine.touchLanguageMenu&&!this.focusAssistant.focusing&&this.engine.contextManager.deactivateCurrentTarget(),this.deactivateOnRelease=!1,!1),"touchEndActivationHandler");this._WindowLoad=r(()=>{document.body.scrollTop=0,typeof document.documentElement!="undefined"&&(document.documentElement.scrollTop=0)},"_WindowLoad");this._WindowUnload=r(()=>{this.engine.shutdown()},"_WindowUnload");this.window=e,this.engine=t,this.attachHandlers(),t.config.hostDevice.touchable&&(this.buildPageTrailer(),this.rotationProcessor=new Mi(this.engine),this.rotationProcessor.init())}buildPageTrailer(){let e=this.mobilePageTrailer=document.createElement("div"),t=e.style;t.width="100%",t.height=screen.width/2+"px",document.body.appendChild(e)}get focusAssistant(){return this.engine.contextManager.focusAssistant}attachHandlers(){let e=this.domEventTracker,t=this.engine.config.hostDevice,n=this.window.document.body;e.attachDOMEvent(this.window,"focus",this.pageFocusHandler,!1),e.attachDOMEvent(this.window,"blur",this.pageFocusHandler,!1),e.attachDOMEvent(n,"focus",this.suppressFocusCheck,!0),e.attachDOMEvent(n,"blur",this.suppressFocusCheck,!0),t.touchable&&(e.attachDOMEvent(n,"touchstart",this.touchStartActivationHandler,!1),e.attachDOMEvent(n,"touchmove",this.touchMoveActivationHandler,!1),e.attachDOMEvent(n,"touchend",this.touchEndActivationHandler,!1)),e.attachDOMEvent(window,"load",this._WindowLoad,!1),e.attachDOMEvent(window,"unload",this._WindowUnload,!1),e.attachDOMEvent(document,"keyup",this.engine.hotkeyManager._Process,!1)}shutdown(){var s;let e=this.domEventTracker,t=this.engine.config.hostDevice,n=this.window.document.body;e.detachDOMEvent(this.window,"focus",this.pageFocusHandler,!1),e.detachDOMEvent(this.window,"blur",this.pageFocusHandler,!1),e.detachDOMEvent(n,"focus",this.suppressFocusCheck,!0),e.detachDOMEvent(n,"blur",this.suppressFocusCheck,!0),t.touchable&&(e.detachDOMEvent(n,"touchstart",this.touchStartActivationHandler,!1),e.detachDOMEvent(n,"touchmove",this.touchMoveActivationHandler,!1),e.detachDOMEvent(n,"touchend",this.touchEndActivationHandler,!1),(s=this.mobilePageTrailer)==null||s.parentElement.removeChild(this.mobilePageTrailer)),e.detachDOMEvent(window,"load",this._WindowLoad,!1),e.detachDOMEvent(window,"unload",this._WindowUnload,!1),e.detachDOMEvent(document,"keyup",this.engine.hotkeyManager._Process,!1)}};r(Dl,"PageIntegrationHandlers");var Yi=Dl;function ht(Q){let e=document.createElement(Q);return e.style.userSelect="none",e.style.MozUserSelect="none",e.style.KhtmlUserSelect="none",e.style.UserSelect="none",e.style.WebkitUserSelect="none",e}r(ht,"_CreateElement");function Re(Q,e){try{if(Q&&typeof window.getComputedStyle!="undefined")return window.getComputedStyle(Q,"").getPropertyValue(e)}catch(t){}return""}r(Re,"getStyleValue");var Kl=class Kl{constructor(e){this.keyman=e,this.scrolling=!1,this.shim=this.constructShim()}constructShim(){let e=this,t=ht("div"),n=this.keyman.osk;return t.id="kmw-language-menu-background",t.addEventListener("touchstart",s=>{if(s.preventDefault(),e.hide(),s.touches.length>2){var i=s.touches[1].pageX,B=s.touches[1].pageY;let c=n.vkbd.spaceBar;i>c.offsetLeft&&i<c.offsetLeft+c.offsetWidth&&B>c.offsetTop&&B<c.offsetTop+c.offsetHeight&&this.keyman.osk.emit("showbuild")}},!1),t}show(){let e=this.keyman.config.hostDevice,t=this.keyman.keyboardRequisitioner.cache.getStubList();if(t.length<1)return;var s=this.lgList=ht("div");this.lgList.id="kmw-language-menu";let i=this;document.body.appendChild(this.shim);var B=ht("div"),c=B.style,l=ht("div");B.id="kmw-menu-scroll-container",l.id="kmw-menu-scroller","WebkitOverflowScrolling"in c&&(c.WebkitOverflowScrolling="touch"),B.appendChild(l),s.appendChild(B);let a,F=ht("div");F.id="kmw-menu-index";for(let m=1;m<=26;m++)a=ht("p"),a.innerHTML=String.fromCharCode(m+64),F.appendChild(a);if(F.addEventListener("touchstart",function(m){i.scrollToLanguage(m,B,l)},!1),F.addEventListener("touchend",function(m){m.stopPropagation()},!1),s.appendChild(F),s.addEventListener("scroll",function(m){i.scrolling=!0},!1),B.addEventListener("scroll",function(m){B.scrollTop<1&&(B.scrollTop=1),B.scrollTop>B.scrollHeight-B.offsetHeight-1&&(B.scrollTop=B.scrollHeight-B.offsetHeight-1)},!1),this.activeLgNo=this.addLanguages(l,t),this.lgList.style.visibility="hidden",document.body.appendChild(this.lgList),e.OS=="android"&&"devicePixelRatio"in window&&(this.lgList.style.fontSize=2/window.devicePixelRatio+"em"),e.OS=="android"&&e.formFactor=="tablet"&&"devicePixelRatio"in window){var o=parseInt(Re(s,"width"),10),d=s.style;isNaN(o)||(d.width=d.maxWidth=2*o/window.devicePixelRatio+"px"),o=parseInt(Re(B,"width"),10),d=B.style,isNaN(o)||(d.width=d.maxWidth=2*o/window.devicePixelRatio+"px"),o=parseInt(Re(l,"width"),10),d=l.style,isNaN(o)||(d.width=d.maxWidth=2*o/window.devicePixelRatio+"px")}this.adjust(0);var U=F.childNodes[1].offsetTop-F.childNodes[0].offsetTop,u=Math.floor(s.offsetHeight/26),g=Math.round(100*u/U)/100,I=g>.6?1:2;g>1.25&&(g=1.25);for(let m=0;m<26;m++){var C=F.childNodes[m].style;I==2&&m%2==1?C.display="none":(C.fontSize=g*I+"em",C.lineHeight=u*I+"px")}var x=B.offsetWidth;B.scrollHeight>B.offsetHeight+3?x=x+F.offsetWidth:F.style.display="none",s.style.width=x+"px",this.lgList.style.visibility="",this.scrollToIndex(this.activeLgNo,B,l)}adjust(e){let t=this.keyman.osk,n=this.keyman.config.hostDevice;var s=this.lgList,i=s.firstChild,B=i.firstChild,c=0,l=s.style,a=s.childNodes[1],F=window.innerHeight-t.vkbd.lgKey.offsetHeight-16,o=B.childNodes.length+e-1,d=B.firstChild.firstChild.offsetHeight,U=o*d;n.OS=="ios"&&(n.formFactor=="phone"?(c=dt()?36:0,F=(window.innerHeight-c-16)*St(n.formFactor)):n.formFactor=="tablet"&&(c=dt()?16:0,F=F-c)),l.left=M(t.vkbd.lgKey)+"px",U>F&&(U=F),l.height=U+"px",l.bottom="0px",a.style.height=i.style.height=l.height}scrollToLanguage(e,t,n){e.stopImmediatePropagation(),e.stopPropagation(),e.preventDefault();let s=e.touches[0].target;if(s.nodeName=="P"){var i,B,c=s.innerHTML.charCodeAt(0),l=n.childNodes;try{for(i=0;i<l.length-1&&(B=l[i].firstChild.innerHTML.toUpperCase().charCodeAt(0),!(B>=c));i++);}catch(a){}this.scrollToIndex(i,t,n)}}scrollToIndex(e,t,n){let s;try{s=n.firstChild.getBoundingClientRect().height*(e-.5)+1,t.scrollTop=s}catch(B){s=0}try{t.scrollTop<0&&(t.scrollTop=0),t.scrollTop>t.scrollHeight-t.offsetHeight-1&&(t.scrollTop=t.scrollHeight-t.offsetHeight-1)}catch(B){}}addLanguages(e,t){var F;var n=t.length;let s=this.keyman.config.hostDevice,i=[];for(let o=0;o<n;o++){let d=t[o].KL;i.indexOf(d)==-1&&i.push(d)}i.sort();var B=Math.round(100/St(s.formFactor))/100;let c=-1;for(let o=0;o<i.length;o++){let d=ht("div");d.className="kbd-list-closed";let U=ht("p");U.kList=[];for(let g=0;g<n;g++)t[g].KL==i[o]&&U.kList.push(t[g]);s.OS=="ios"&&(U.style.fontSize=B+"em"),d.appendChild(U),e.appendChild(d),i[o]==((F=this.keyman.contextManager.activeKeyboard)==null?void 0:F.metadata.langName)&&(c=o);let u=this;if(U.kList.length>1){U.className="kbd-list",U.innerHTML=i[o]+"...",U.scrolled=!1,U.ontouchend=g=>{g.stopPropagation(),U.scrolled?U.scrolled=!1:U.parentElement.className=U.parentElement.className=="kbd-list-closed"?"kbd-list-open":"kbd-list-closed",u.adjust(U.parentElement.className=="kbd-list-closed"?0:U.kList.length)},U.addEventListener("touchstart",function(g){g.stopPropagation()},!1),U.addEventListener("touchmove",function(g){U.scrolled=!0,g.stopPropagation()},!1);for(let g=0;g<U.kList.length;g++){let I=ht("p");I.className="kbd-list-entry",s.OS=="ios"&&(I.style.fontSize=B+"em"),this.addKeyboard(U.kList[g],I,!1),d.appendChild(I)}}else U.innerHTML=i[o],U.className="kbd-single-entry",this.addKeyboard(U.kList[0],U,!0);o==c&&(U.className=U.className+" current")}var l=ht("div");l.id="kmw-menu-footer";var a=r(function(o){o.cancelable&&o.preventDefault(),o.stopPropagation()},"cancelTouch");return l.addEventListener("touchstart",a,!1),l.addEventListener("touchmove",a,!1),l.addEventListener("touchend",a,!1),e.appendChild(l),c}addKeyboard(e,t,n){t.kn=e.KI,t.kc=e.KLC,t.innerHTML=n?e.KL:e.KN.replace(" Keyboard","");let s=this,i=r(()=>{if(this.originalBodyStyle)return console.error("Unexpected state:  `originalBodyStyle` was not cleared by a previous `unlockBodyScroll()` call"),!1;this.originalBodyStyle={};let o=this.originalBodyStyle,d=document.body.style;return o.overflowY=d.overflowY,o.height=d.height,d.overflowY="hidden",d.height="100%",!0},"lockBodyScroll"),B=r(()=>{if(!this.originalBodyStyle){console.error("Unexpected state:  `originalBodyStyle` is unset; cannot restore original body style");return}let o=this.originalBodyStyle,d=document.body.style;d.overflowY=o.overflowY,d.height=o.height,this.originalBodyStyle=null},"unlockBodyScroll"),c=r(function(o){o.stopPropagation(),this.className.indexOf("selected")<=0&&(this.className=this.className+" selected"),s.scrolling=!1,s.y0=o.touches[0].pageY,i()},"touchStart"),l=r(function(o){o.stopImmediatePropagation();var d=s.lgList.childNodes[0],U=d.scrollHeight-d.offsetHeight,u,g;if(typeof o.pageY!="undefined")u=o.pageY;else if(typeof o.touches!="undefined")u=o.touches[0].pageY;else return!1;if(g=u-s.y0,g<0)d.scrollTop>=U-1&&(s.y0=u);else if(g>0)d.scrollTop<2&&(s.y0=u);else return!1;return(g<-5||g>5)&&(s.scrolling=!0,this.className=this.className.replace(/\s*selected/,""),s.y0=u),!0},"touchMove"),a=r(function(o){let d=this;return typeof o.stopImmediatePropagation!="undefined"?o.stopImmediatePropagation():o.stopPropagation(),s.scrolling?this.className=this.className.replace(/\s*selected/,""):(s.keyman.contextManager.focusAssistant.setFocusTimer(),s.lgList.style.display="none",s.keyman.contextManager.activateKeyboard(d.kn,d.kc,!0),s.keyman.contextManager.restoreLastActiveTarget(),s.hide()),B(),!0},"touchEnd"),F=r(function(o){B()},"touchCancel");t.addEventListener("touchstart",c,!1),t.addEventListener("touchmove",l,!1),t.addEventListener("touchend",a,!1),t.addEventListener("touchcancel",F,!1)}hide(){let e=this.keyman.osk;this.lgList&&(e.vkbd.highlightKey(e.vkbd.lgKey,!1),this.lgList.style.visibility="hidden",window.setTimeout(()=>{this.shim.parentElement&&(document.body.removeChild(this.shim),document.body.removeChild(this.lgList))},500)),this.keyman.touchLanguageMenu=null}};r(Kl,"LanguageMenu");var Oi=Kl;function qr(Q,e,t){let n=t.focusAssistant;e.on("globekey",(s,i)=>{i&&e.hostDevice.touchable&&(Q.touchLanguageMenu=new Oi(Q),Q.touchLanguageMenu.show()),e.vkbd&&e.vkbd.highlightKey(s,!1)}),e.on("hiderequested",s=>{e&&(e.startHide(!0),t.forgetActiveTarget())}),e.addEventListener("hide",s=>{var i;s!=null&&s.HiddenByUser&&((i=t.activeTarget)==null||i.focus())}),e.on("showbuild",()=>{var s;(s=Q.config.alertHost)==null||s.alert("KeymanWeb Version "+Zn.VERSION+'<br /><br /><span style="font-size:0.8em">Copyright &copy; 2007-2023 SIL International</span>')}),e.on("dragmove",s=>L(this,null,function*(){n.restoringFocus=!0,yield s,t.restoreLastActiveTarget(),n.restoringFocus=!1,n.setMaintainingFocus(!1)})),e.on("resizemove",s=>L(this,null,function*(){n.restoringFocus=!0,yield s,t.restoreLastActiveTarget(),n.restoringFocus=!1,n.setMaintainingFocus(!1)})),e.on("pointerinteraction",s=>L(this,null,function*(){n.setMaintainingFocus(!0),yield s,n.setMaintainingFocus(!1)}))}r(qr,"setupOskListeners");function ra(Q){let e=document.createElement(Q);return e.style.userSelect="none",e}r(ra,"createUnselectableElement");var Pl=class Pl{constructor(e){this.getAbsoluteX=M;this.getAbsoluteY=Y;this._GetAbsoluteX=M;this._GetAbsoluteY=Y;this._GetAbsolute=this.getAbsolute;this.toNzString=this.nzString;this.createElement=ra;this.getStyleValue=Re;this.config=e,this.stylesheetManager=new rt(document.body,e.applyCacheBusting),this.domEventTracker=new Gt}isTouchDevice(){return this.config.hostDevice.touchable}getAbsolute(e){return{x:M(e),y:Y(e)}}getOption(e,t){return e in this.config.paths?this.config.paths[e]:e in this.config.options?this.config.options[e]:arguments.length>1?t:""}setOption(e,t){switch(e){case"attachType":break;case"ui":break;case"useAlerts":this.config.signalUser=t?new Ue:null;break;case"setActiveOnRegister":this.config.activateFirstKeyboard=!!t;break;case"spacebarText":this.config.spacebarText=t;break;default:throw new Error("Path-related options may not be changed after the engine has initialized.")}}loadCookie(e){return new nt(e).load(decodeURIComponent)}saveCookie(e,t){new nt(e).save(t,encodeURIComponent)}addStyleSheet(e){let t=ie(e);return this.stylesheetManager.linkStylesheet(t),t}removeStyleSheet(e){return this.stylesheetManager.unlink(e)}linkStyleSheet(e){this.stylesheetManager.linkExternalSheet(e)}getLanguageCodes(e){return e.indexOf("-")==-1?[e]:e.split("-")}attachDOMEvent(e,t,n,s){this.domEventTracker.attachDOMEvent(e,t,n,s)}detachDOMEvent(e,t,n,s){this.domEventTracker.detachDOMEvent(e,t,n,s)}get alertHost(){return this.config.alertHost?this.config.alertHost:(this._alertHost||(this._alertHost=new Ue),this._alertHost)}alert(e,t){this.alertHost.alert(e,t)}nzString(e,t){let n="";return arguments.length>1&&(n=t),typeof e=="undefined"||e==null||e==0||e==""?n:""+e}toNumber(e,t){let n=parseInt(e,10);return isNaN(n)?t:n}toFloat(e,t){let n=parseFloat(e);return isNaN(n)?t:n}rgba(e,t,n,s,i){let B="transparent";try{B="rgba("+t+","+n+","+s+","+i+")"}catch(c){B="rgb("+t+","+n+","+s+")"}return B}shutdown(){var e,t,n;(e=this.stylesheetManager)==null||e.unlinkAll(),(t=this.domEventTracker)==null||t.shutdown(),(n=this._alertHost)==null||n.shutdown()}};r(Pl,"UtilApiEndpoint");var wi=Pl;var _l=class _l{constructor(e,t,n){this.code=e,this.shift=t,this.handler=n}matches(e,t){return this.code==e&&this.shift==t}};r(_l,"Hotkey");var jl=_l,ql=class ql{constructor(){this.hotkeys=[];this._Process=r(e=>{e||(e=window.event);var t=Ol(e);if(t==null)return!1;for(var n=(e.shiftKey?16:0)|(e.ctrlKey?32:0)|(e.altKey?64:0),s=0;s<this.hotkeys.length;s++)if(this.hotkeys[s].matches(t,n))return this.hotkeys[s].handler(),e.returnValue=!1,e&&e.preventDefault&&e.preventDefault(),e.cancelBubble=!0,!1;return!0},"_Process")}addHotKey(e,t,n){for(var s=0;s<this.hotkeys.length;s++)if(this.hotkeys[s].code==e&&this.hotkeys[s].shift==t){this.hotkeys[s].handler=n;return}this.hotkeys.push(new jl(e,t,n))}removeHotkey(e,t){for(var n=0;n<this.hotkeys.length;n++)if(this.hotkeys[n].matches(e,t)){this.hotkeys.splice(n,1);return}}};r(ql,"HotkeyManager");var zi=ql;var tr=class tr{constructor(e){this.e=e,this.c=e.style.backgroundColor}reset(){this.e.style.backgroundColor=this.c}};r(tr,"BeepData");var $l=tr,er=class er{constructor(e){this._BeepObjects=[];this._BeepTimeout=0;this.reset=r(()=>{this.keyboardInterface.resetContextCache();var e;for(this._BeepTimeout=0,e=0;e<this._BeepObjects.length;e++)this._BeepObjects[e].reset();this._BeepObjects=[]},"reset");this.keyboardInterface=e}beep(e){if(e instanceof w){var t=e.getElement();if(e instanceof z&&(t=e.docRoot),!!t&&!(!t.style||typeof t.style.backgroundColor=="undefined")){for(var n=0;n<this._BeepObjects.length;n++)if(this._BeepObjects[n].e==t)return;this._BeepObjects.push(new $l(t)),t.style.backgroundColor="#000000",this._BeepTimeout==0&&(this._BeepTimeout=1,window.setTimeout(this.reset,50))}}}};r(er,"BeepHandler");var Di=er;var nr=class nr extends Ge{constructor(t,n){super(t,n);this.GetLastActiveElement=this.getLastActiveElement;this.FocusLastActiveElement=this.focusLastActiveElement;this.HideHelp=this.hideHelp;this.ShowHelp=this.showHelp;this.ShowPinnedHelp=this.showPinnedHelp}saveFocus(){this.engine.contextManager.focusAssistant._IgnoreNextSelChange=1}getLastActiveElement(){return this.engine.contextManager.lastActiveTarget}focusLastActiveElement(){this.engine.contextManager.restoreLastActiveTarget()}hideHelp(){this.engine.osk.startHide(!0)}showHelp(t,n){let s=this.engine.osk;s instanceof Dt?s.presentAtPosition(t,n):s.present()}showPinnedHelp(){let t=this.engine.osk;t instanceof Dt&&(!t.activeKeyboard.keyboard.isCJK||!this.ruleBehavior)&&(t.userPositioned=!0),t.present()}};r(nr,"KeyboardInterface");var xn=nr;(function(){xn.__publishShorthandAPI()})();var Ki=class Ki extends cn{constructor(t,n){let s=new Wi(n);super(t,s,new Ls(s,()=>this.legacyAPIEvents),i=>({keyboardInterface:new xn(window,i),defaultOutputRules:new Es(i.contextManager)}));this._initialized=0;this.hotkeyManager=new zi;this.getOskHeight=null;this.getOskWidth=null;this.helpURL="https://help.keyman.com/go";this.keyEventRefocus=r(()=>{this.contextManager.restoreLastActiveTarget()},"keyEventRefocus");this._GetKeyboardDetail=r(function(t,n){return{Name:t.KN,InternalName:t.KI,LanguageName:t.KL,LanguageCode:t.KLC,RegionName:t.KR,RegionCode:t.KRC,CountryName:t.KC,CountryCode:t.KCC,KeyboardID:t.KD,Font:t.KFont,OskFont:t.KOskFont,HasLoaded:!!n,IsRTL:n?n.isRTL:null}},"_GetKeyboardDetail");this._util=new wi(s),this.beepHandler=new Di(this.core.keyboardInterface),this.core.keyboardProcessor.beepHandler=()=>this.beepHandler.beep(this.contextManager.activeTarget),this.hardKeyboard=new Zs(s.hardDevice,this.core.keyboardProcessor,this.contextManager),this.contextManager.on("targetchange",i=>{let B=i==null?void 0:i.getElement();this.osk&&(this.osk.activationModel.activationTrigger=B),this.config.hostDevice.touchable&&i&&this.ensureElementVisibility(B)})}ensureElementVisibility(t){if(!t||!this.osk)return;let n=Y(t),s=window.pageYOffset,i=n-s;n>=s&&(i-=window.innerHeight-this.osk._Box.offsetHeight-t.offsetHeight-2,i<0&&(i=0)),i!=0&&window.scrollTo(0,i+s)}get util(){return this._util}get views(){return xl}get initialized(){return this._initialized}get ui(){return this._ui}set ui(t){this._ui&&this._ui.shutdown(),this._ui=t,this.config.deferForInitialization.isFulfilled&&t.initialize()}init(t){return L(this,null,function*(){let s=new ze().detect(),i=h(h({},jr),t);if(this.config.hostDevice=s,this.config.initialize(i),this._initialized=1,yield Xs(),this.config.deferForInitialization.isResolved)return Promise.resolve();yield As(Ki.prototype,this,"init").call(this,i),this.keyboardRequisitioner.cloudQueryEngine.once("unboundregister",()=>{var F;(F=this.contextManager.activeKeyboard)!=null&&F.keyboard||this.setActiveKeyboard("","")}),this.contextManager.initialize();let B=this.contextManager.getSavedKeyboardRaw();this.pageIntegration=new Yi(window,this),this.config.finalizeInit(),this.ui&&(this.ui.initialize(),this.legacyAPIEvents.callEvent("loaduserinterface",{})),this._initialized=2,yield this.config.deferForInitialization;let c=this.contextManager.restoreSavedKeyboard(B);try{yield c}catch(F){}let l={keyboardToActivate:this.contextManager.activeKeyboard},a=s.touchable?new bs(this,l):new Cs(this,l);qr(this,a,this.contextManager),this.osk=a})}get register(){return this.keyboardRequisitioner.cloudQueryEngine.registerFromCloud}getUIState(){return this.contextManager.focusAssistant.getUIState()}activatingUI(t){this.contextManager.focusAssistant.setMaintainingFocus(!!t)}setKeyboardForControl(t,n,s){if(t instanceof t.ownerDocument.defaultView.HTMLIFrameElement){console.warn("'keymanweb.setKeyboardForControl' cannot set keyboard on iframes.");return}if(!this.isAttached(t)){console.error("KeymanWeb is not attached to element "+t);return}let i=null;if(n&&(i=this.keyboardRequisitioner.cache.getStub(n,s),!i))throw new Error(`No keyboard has been registered with id ${n} and language code ${s}.`);this.contextManager.setKeyboardForTarget(t._kmwAttachment.interface,n,s)}getKeyboardForControl(t){let n=Vt(t);return this.contextManager.getKeyboardStubForTarget(n).id}getLanguageForControl(t){let n=Vt(t);return this.contextManager.getKeyboardStubForTarget(n).langId}isAttached(t){return this.contextManager.page.isAttached(t)}addKeyboards(...t){return this.config.deferForInitialization.then(()=>{if(!t||!t[0]||t[0].length==0)return this.keyboardRequisitioner.fetchCloudCatalog().catch(n=>(console.error(n[0].error),n));{let n=[];return Array.isArray(t[0])?n=n.concat(t[0]):Array.isArray(t)&&(n=n.concat(t)),this.keyboardRequisitioner.addKeyboardArray(n)}})}addKeyboardsForLanguage(t){return this.config.deferForInitialization.then(()=>typeof t=="string"?this.keyboardRequisitioner.addLanguageKeyboards(t.split(",").map(n=>n.trim())):this.keyboardRequisitioner.addLanguageKeyboards(t))}isCJK(t){let n;if(t){let s=t;s.KeyboardID?n=this.keyboardRequisitioner.cache.getKeyboard(s.KeyboardID):n=new T(t)}else n=this.core.activeKeyboard;return n&&n.isCJK}getKeyboard(t,n){let s=this.keyboardRequisitioner.cache.getStub(t,n),i=this.keyboardRequisitioner.cache.getKeyboardForStub(s);return s&&this._GetKeyboardDetail(s,i)}getKeyboards(){let t=[],n=this.keyboardRequisitioner.cache,s=n.getStubList();for(let i=0;i<s.length;i++){let B=s[i],c=n.getKeyboardForStub(B),l=this._GetKeyboardDetail(B,c);t.push(l)}return t}removeKeyboards(...t){var n;for(let s=0;s<t.length;s++)this.keyboardRequisitioner.cache.forgetKeyboard(t[s],!0),((n=this.contextManager.activeKeyboard)==null?void 0:n.metadata.id)==et(t[s])&&this.contextManager.activateKeyboard("","");return!0}getSavedKeyboard(){return this.contextManager.getSavedKeyboard()}focusLastActiveElement(){var t;(t=this.contextManager.lastActiveTarget)==null||t.focus()}getLastActiveElement(){var t;return(t=this.contextManager.lastActiveTarget)==null?void 0:t.getElement()}setActiveElement(t,n){if(typeof t=="string"){let i=t;if(t=document.getElementById(t),!t)throw new Error(`Could not find the specified element (id: ${i}`)}let s=Vt(t);if(!s)throw new Error(`KMW is not attached to the specified element (id: ${t.id}).`);this.contextManager.setActiveTarget(s,n)}moveToElement(t){typeof t=="string"&&(t=document.getElementById(t)),t.focus()}addHotKey(t,n,s){this.hotkeyManager.addHotKey(t,n,s)}removeHotKey(t,n){this.hotkeyManager.removeHotkey(t,n)}attachToControl(t){this.contextManager.page.attachToControl(t)}detachFromControl(t){this.contextManager.page.detachFromControl(t)}disableControl(t){this.contextManager.page.disableControl(t)}enableControl(t){this.contextManager.page.enableControl(t)}BuildVisualKeyboard(t,n,s,i){let B=null;t!=null&&(B=this.keyboardRequisitioner.cache.getKeyboard(t)),B=B||this.core.activeKeyboard;let c=this.keyboardRequisitioner.cache.getStub(B),l=this.getOskHeight,a=(typeof l=="function"?l():null)||this.osk.computedHeight||200;return yt.buildDocumentationKeyboard(B,c,this.config.paths,s,i,a)}shutdown(){var t,n;this.pageIntegration.shutdown(),this.contextManager.shutdown(),(t=this.osk)==null||t.shutdown(),this.core.languageProcessor.shutdown(),this.hardKeyboard.shutdown(),this.util.shutdown(),this.legacyAPIEvents.callEvent("unloaduserinterface",{}),(n=this.ui)==null||n.shutdown()}};r(Ki,"KeymanEngine");var Js=Ki;var $r=document.getElementsByTagName("script"),tQ=$r[$r.length-1].src,Qa=tQ.substr(0,tQ.lastIndexOf("/")+1);window.keyman=new Js(Pe.constructInstance(),Qa);})();
//# sourceMappingURL=keymanweb.js.map
